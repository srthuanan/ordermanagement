import{j as e}from"./vendor-pdf-DusBkRB3.js";import{R as Q,r as h}from"./vendor-react-DJ1oPbzn.js";import{h as I}from"./vendor-utils-C5S46NFB.js";import{B as M,v as $e,f as P,S as Xe,t as ie,o as Me,u as Be,q as Ie,b as Fe,A as Ae,s as Ee,w as Re,x as qe}from"./index-DpGC7eYi.js";const q=({name:t,label:s,value:c,onChange:x,type:o="text",placeholder:v,required:T,readOnly:g,pattern:b,title:u})=>e.jsxs("div",{children:[e.jsxs("label",{htmlFor:String(t),className:"block text-sm font-medium text-text-secondary",children:[s,T&&e.jsx("span",{className:"text-danger ml-1",children:"*"})]}),e.jsx("input",{type:o,name:String(t),id:String(t),value:c,onChange:x,placeholder:v,readOnly:g,pattern:b,title:u,className:`mt-1 block w-full futuristic-input p-2 text-sm ${g?"bg-surface-input cursor-not-allowed":""}`})]}),oe=({name:t,label:s,value:c,onChange:x,placeholder:o,required:v})=>e.jsxs("div",{children:[e.jsxs("label",{htmlFor:String(t),className:"block text-sm font-medium text-text-secondary",children:[s,v&&e.jsx("span",{className:"text-danger ml-1",children:"*"})]}),e.jsx("textarea",{name:String(t),id:String(t),value:c,onChange:x,placeholder:o,className:"mt-1 block w-full futuristic-input p-2 text-sm",rows:2})]}),ne=t=>{if(!t)return 0;if(t.includes("T")||t.includes(" ")){const c=I(t);if(c.isValid())return c.hour()*60+c.minute()}const s=t.split(":");if(s.length>=2){const c=parseInt(s[0],10),x=parseInt(s[1],10);if(!isNaN(c)&&!isNaN(x))return c*60+x}return 0},pe=t=>{if(!t)return"";if(/^\d{2}:\d{2}$/.test(t))return t;const s=I(t);return s.isValid()?s.format("HH:mm"):t},ye=15,Oe=({bookings:t,formData:s,conflictError:c})=>{const T=h.useMemo(()=>{if(!s.thoiGianKhoiHanh||!s.thoiGianTroVe)return null;const g=ne(s.thoiGianKhoiHanh),b=ne(s.thoiGianTroVe);return g>=b?null:{start:g,end:b}},[s.thoiGianKhoiHanh,s.thoiGianTroVe]);return!s.ngayThuXe||!s.loaiXe?e.jsx("div",{className:"p-4 text-center bg-surface-ground rounded-lg text-sm text-text-secondary",children:"Vui lòng chọn ngày và loại xe để xem lịch."}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative bg-white h-10 rounded shadow-inner-sm border border-border-secondary overflow-hidden",children:[t.map(g=>{const b=ne(g.thoiGianKhoiHanh),u=ne(g.thoiGianTroVe),p=Math.max(480,b-ye),K=Math.min(1200,u+ye),f=(p-480)/720*100,V=(K-p)/720*100,L=(b-p)/(K-p)*100,w=(u-b)/(K-p)*100;return e.jsxs("div",{className:"absolute h-full group",style:{left:`${f}%`,width:`${V}%`},title:`Đã đặt: ${pe(g.thoiGianKhoiHanh)} - ${pe(g.thoiGianTroVe)}
KH: ${g.tenKhachHang}`,children:[e.jsx("div",{className:"absolute inset-0 bg-slate-300/60 rounded"}),e.jsx("div",{className:"absolute h-full bg-slate-400/80 border-x border-slate-500",style:{left:`${L}%`,width:`${w}%`}})]},g.soPhieu)}),T&&e.jsx("div",{className:`absolute h-full rounded border-2 z-10 ${c?"bg-danger/50 border-danger":"bg-success/50 border-success"}`,style:{left:`${(T.start-480)/720*100}%`,width:`${(T.end-T.start)/720*100}%`}})]}),e.jsxs("div",{className:"flex justify-between text-xs text-text-secondary px-1",children:[e.jsx("span",{children:"8:00"}),e.jsx("span",{children:"10:00"}),e.jsx("span",{children:"12:00"}),e.jsx("span",{children:"14:00"}),e.jsx("span",{children:"16:00"}),e.jsx("span",{children:"18:00"}),e.jsx("span",{children:"20:00"})]})]})},Ue=({formData:t,handleInputChange:s,handleRadioChange:c,conflictError:x,scheduleForSelectedCar:o,suggestions:v,onSuggestionClick:T,onReset:g,onSave:b,isSubmitting:u})=>e.jsxs("aside",{className:"lg:col-span-2 print-hidden overflow-y-auto pr-4 space-y-5",children:[e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border-primary pb-2 mb-3",children:[e.jsx("h3",{className:"font-semibold text-accent-primary text-base",children:"Thông tin Lịch Hẹn"}),e.jsxs("div",{className:"flex items-center gap-2 md:hidden",children:[e.jsx(M,{onClick:g,variant:"secondary",size:"sm",className:"!py-1 !px-2 text-xs !h-auto",leftIcon:e.jsx("i",{className:"fas fa-undo"}),children:"Làm Mới"}),e.jsx(M,{onClick:b,disabled:!!x||u,isLoading:u,variant:"primary",size:"sm",className:"!py-1 !px-2 text-xs !h-auto",leftIcon:u?void 0:e.jsx("i",{className:"fas fa-save"}),children:"Lưu & In"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3",children:[e.jsx(q,{name:"ngayThuXe",label:"Ngày thử xe / Ngày cam kết",type:"date",value:t.ngayThuXe,onChange:s,required:!0}),e.jsx(q,{name:"tenTuVan",label:"Tư vấn bán hàng",value:t.tenTuVan,onChange:()=>{},readOnly:!0}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsxs("label",{htmlFor:"loaiXe",className:"block text-sm font-medium text-text-secondary",children:["Loại xe",e.jsx("span",{className:"text-danger ml-1",children:"*"})]}),e.jsxs("select",{name:"loaiXe",id:"loaiXe",value:t.loaiXe,onChange:s,className:"mt-1 block w-full futuristic-input p-2 text-sm",children:[e.jsx("option",{value:"",disabled:!0,children:"Chọn loại xe"}),Object.keys($e).map(p=>e.jsx("option",{value:p,children:p},p))]})]}),e.jsx("div",{className:"sm:col-span-2 pt-2",children:e.jsx(Oe,{bookings:o,formData:t,conflictError:x})}),e.jsx(q,{name:"thoiGianKhoiHanh",label:"Giờ khởi hành",type:"time",value:t.thoiGianKhoiHanh,onChange:s,required:!0}),e.jsx(q,{name:"thoiGianTroVe",label:"Giờ trở về",type:"time",value:t.thoiGianTroVe,onChange:s,required:!0}),e.jsx("div",{className:"sm:col-span-2",children:e.jsx(oe,{name:"loTrinh",label:"Lộ trình",value:t.loTrinh,onChange:s,required:!0})}),x&&e.jsxs("div",{className:"sm:col-span-2 mt-1 p-3 bg-danger-bg/50 border border-danger/30 rounded-lg text-sm animate-fade-in-up",children:[e.jsxs("p",{className:"text-danger font-semibold",children:[e.jsx("i",{className:"fas fa-exclamation-triangle mr-2"}),x]}),v.length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-danger/20",children:[e.jsx("p",{className:"font-semibold text-text-primary",children:"Gợi ý các khung giờ trống tiếp theo:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:v.map(p=>e.jsx(M,{onClick:()=>T(p),variant:"ghost",size:"sm",className:"text-xs bg-success/10 text-success font-semibold px-2 py-1 rounded hover:bg-success/20 transition-colors !h-auto",children:p},p))})]})]})]})]}),e.jsxs("section",{children:[e.jsx("h3",{className:"font-semibold text-accent-primary text-base border-b border-border-primary pb-2 mb-3",children:"Thông tin Khách hàng"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3",children:[e.jsx("div",{className:"sm:col-span-2",children:e.jsx(q,{name:"tenKhachHang",label:"Tên khách hàng",value:t.tenKhachHang,onChange:s,required:!0})}),e.jsx(q,{name:"dienThoai",label:"Điện thoại",type:"tel",value:t.dienThoai,onChange:s,required:!0,pattern:"0[0-9]{9,10}",title:"Số điện thoại phải bắt đầu bằng 0 và có 10 hoặc 11 chữ số."}),e.jsx(q,{name:"email",label:"Email",type:"email",value:t.email,onChange:s}),e.jsx("div",{className:"sm:col-span-2",children:e.jsx(oe,{name:"diaChi",label:"Địa chỉ",value:t.diaChi,onChange:s,required:!0})}),e.jsx(q,{name:"gplxSo",label:"Số GPLX",value:t.gplxSo,onChange:s,required:!0}),e.jsx(q,{name:"hieuLucGPLX",label:"Hiệu lực GPLX",type:"date",value:t.hieuLucGPLX,onChange:s,required:!0}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsxs("label",{className:"block text-sm font-medium text-text-secondary",children:["Tự lái thử",e.jsx("span",{className:"text-danger ml-1",children:"*"})]}),e.jsxs("div",{className:"mt-2 flex gap-6",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"tuLai",value:"co",checked:t.tuLai==="co",onChange:c,className:"h-4 w-4"})," Có"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"tuLai",value:"khong",checked:t.tuLai==="khong",onChange:c,className:"h-4 w-4"})," Không"]})]})]}),e.jsx("div",{className:"sm:col-span-2",children:e.jsx(oe,{name:"dacDiem",label:"Đặc điểm khách hàng quan tâm",value:t.dacDiem,onChange:s})})]})]})]}),De=Q.memo(Ue),ze="/ordermanagement/assets/logomd-CQh7nX_X.webp",S=({value:t,className:s="",placeholder:c})=>e.jsx("span",{className:`flex-grow border-b border-gray-400 print:border-gray-300 mx-1 text-center font-semibold ${t?"":"text-gray-400"} ${s}`,children:t||c||""}),le=({checked:t})=>e.jsx("div",{className:"w-4 h-4 border border-gray-800 print:border-gray-400 flex items-center justify-center",children:t&&e.jsx("span",{className:"font-bold text-sm",children:"✓"})}),be=t=>{if(!t)return"";if(/^\d{2}:\d{2}$/.test(t))return t;const s=I(t);return s.isValid()?s.format("HH:mm"):t},we=({data:t})=>{const[s,c,x]=t.ngayThuXe?t.ngayThuXe.split("-"):["","",""],o=t.hieuLucGPLX?new Date(t.hieuLucGPLX).toLocaleDateString("vi-VN"):"";return e.jsxs("div",{className:"print-area document-preview bg-white p-[12.5px] border border-gray-800 shadow-lg w-full font-serif text-black",style:{fontFamily:'"Times New Roman", Times, serif'},children:[e.jsxs("header",{className:"flex justify-between items-center mb-4",children:[e.jsx("div",{className:"w-12",children:e.jsx("img",{src:ze,alt:"Logo Minh Dao",className:"w-full object-contain"})}),e.jsx("h1",{className:"font-bold text-lg flex-grow text-center",children:"PHIẾU YÊU CẦU LÁI THỬ"}),e.jsx("div",{className:"w-12"})," "]}),e.jsxs("div",{className:"flex justify-between items-center mb-4 text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:"Tên showroom:"}),e.jsx("span",{className:"font-bold pl-2",children:"VF Minh Đạo Thuận An"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:"Số phiếu:"}),e.jsx(S,{value:t.soPhieu,className:"max-w-[150px]"})]})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:"Ngày thử xe:"}),e.jsx(S,{value:x,className:"max-w-[50px]"})," / ",e.jsx(S,{value:c,className:"max-w-[50px]"})," / ",e.jsx(S,{value:s,className:"max-w-[80px]"}),e.jsx("span",{className:"ml-8",children:"Loại xe:"}),e.jsx(S,{value:t.loaiXe})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:"Thời gian khởi hành:"}),e.jsx(S,{value:be(t.thoiGianKhoiHanh)}),e.jsx("span",{className:"ml-8",children:"Thời gian trở về:"}),e.jsx(S,{value:be(t.thoiGianTroVe)})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:"Lộ trình:"}),e.jsx(S,{value:t.loTrinh})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:"Tên khách hàng:"}),e.jsx(S,{value:t.tenKhachHang}),e.jsx("span",{className:"ml-8",children:"Điện thoại:"}),e.jsx(S,{value:t.dienThoai})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:"Địa chỉ hiện tại:"}),e.jsx(S,{value:t.diaChi})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:"Khách hàng muốn tự lái thử xe:"}),e.jsx("div",{className:"flex-grow"}),e.jsxs("div",{className:"flex items-center gap-2 ml-4",children:["Có ",e.jsx(le,{checked:t.tuLai==="co"})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-4",children:["Không ",e.jsx(le,{checked:t.tuLai==="khong"})]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:"Đặc điểm khách hàng quan tâm:"}),e.jsx(S,{value:t.dacDiem})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:"Giấy phép lái xe của khách hàng số:"}),e.jsx(S,{value:t.gplxSo}),e.jsx("span",{className:"ml-8",children:"Hiệu lực đến ngày:"}),e.jsx(S,{value:o})]}),e.jsx("p",{className:"text-xs italic",children:"(TVBH phô tô và lưu lại 01 bản bằng lái xe của khách hàng)"})]}),e.jsxs("table",{className:"w-full border border-gray-800 print:border-gray-400 mt-4 text-sm text-center",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-800 print:border-gray-400",children:[e.jsx("th",{className:"font-normal p-2 border-r border-gray-800 print:border-gray-400",children:"Người đề nghị"}),e.jsx("th",{className:"font-normal p-2 border-r border-gray-800 print:border-gray-400",children:"Người lập phiếu"}),e.jsx("th",{className:"font-normal p-2",children:"Người phê duyệt"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"border-r border-gray-800 print:border-gray-400 italic pt-1 pb-2",children:"Khách hàng ký tên"}),e.jsx("td",{className:"border-r border-gray-800 print:border-gray-400"}),e.jsx("td",{})]}),e.jsxs("tr",{style:{height:"60px"},children:[e.jsx("td",{className:"border-r border-gray-800 print:border-gray-400 align-bottom pb-2 font-semibold"}),e.jsx("td",{className:"border-r border-gray-800 print:border-gray-400 align-bottom pb-2 font-semibold",children:t.tenTuVan||""}),e.jsx("td",{})]})]})]})]})},ke=({data:t})=>{const s=t.hieuLucGPLX?new Date(t.hieuLucGPLX).toLocaleDateString("vi-VN"):"",[c,x,o]=t.ngayCamKet?t.ngayCamKet.split("-"):["","",""];return e.jsxs("div",{className:"print-area document-preview is-cam-ket bg-white p-8 border border-gray-400 shadow-lg w-full font-serif text-black",style:{fontFamily:'"Times New Roman", Times, serif',lineHeight:"1.5"},children:[e.jsxs("div",{className:"text-center font-bold",children:[e.jsx("p",{children:"CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM"}),e.jsx("p",{children:"Độc lập - Tự do - Hạnh phúc"})]}),e.jsx("h1",{className:"text-center font-bold text-base my-3",children:"GIẤY CAM KẾT"}),e.jsx("p",{className:"text-center font-bold",children:"Kính gửi: CÔNG TY TNHH MINH ĐẠO PHÁT"}),e.jsx("p",{className:"text-center italic mb-4",children:"(Sau đây được gọi chung là “Công ty”)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-8 gap-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-end",children:[e.jsx("span",{className:"shrink-0",children:"Tôi tên là:"}),e.jsx(S,{value:t.tenKhachHang})]}),e.jsxs("div",{className:"flex items-end",children:[e.jsx("span",{className:"shrink-0",children:"Số điện thoại:"}),e.jsx(S,{value:t.dienThoai})]}),e.jsxs("div",{className:"flex items-end",children:[e.jsx("span",{className:"shrink-0",children:"Địa chỉ:"}),e.jsx(S,{value:t.diaChi})]}),e.jsxs("div",{className:"flex items-end",children:[e.jsx("span",{className:"shrink-0",children:"Email:"}),e.jsx(S,{value:t.email})]}),e.jsxs("div",{className:"flex items-end",children:[e.jsx("span",{className:"shrink-0",children:"Số Giấy phép lái xe:"}),e.jsx(S,{value:t.gplxSo})]}),e.jsxs("div",{className:"flex items-end",children:[e.jsx("span",{className:"shrink-0",children:"Hiệu lực đến:"}),e.jsx(S,{value:s})]})]}),e.jsxs("div",{className:"flex items-center my-2 text-sm",children:[e.jsx("span",{className:"shrink-0",children:"Khách hàng muốn tự lái thử xe:"}),e.jsxs("div",{className:"flex items-center gap-2 ml-4",children:["Có ",e.jsx(le,{checked:t.tuLai==="co"})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-4",children:["Không ",e.jsx(le,{checked:t.tuLai==="khong"})]})]}),e.jsxs("p",{className:"text-sm",children:["Bằng Giấy Cam Kết này, tôi tự nguyện đăng ký tham gia lái thử xe: ",e.jsx(S,{value:t.loaiXe})," do Công ty tổ chức tại cơ sở và cam kết tuân thủ theo những điều khoản sau:"]}),e.jsxs("ol",{className:"list-decimal list-inside space-y-2 text-[12.5px] text-justify mt-2",style:{textIndent:"-1.5em",marginLeft:"1.5em"},children:[e.jsx("li",{children:"Cung cấp đầy đủ và chịu hoàn toàn mọi trách nhiệm pháp lý về các thông tin, giấy tờ cá nhân theo yêu cầu của Công ty và các bên liên quan trong thời gian tham gia chương trình."}),e.jsx("li",{children:"Tuyệt đối tuân thủ các điều lệ, nguyên tắc của Luật giao thông đường bộ và xe cơ giới. Đồng thời tuân thủ theo các hướng dẫn của nhân viên hướng dẫn lái thử xe trong khi tham gia lái thử xe, cũng như không được thực hiện bất kỳ hoạt động nào khác không nằm trong chương trình."}),e.jsx("li",{children:"Tôi đảm bảo rằng quyết định tham gia của mình trong việc tham gia lái thử xe này được đưa ra sau khi tôi đã xem xét, cân nhắc kỹ lưỡng. Tôi hiểu rằng việc lái thử xe ô tô này có thể bao gồm nguy cơ xảy ra những thương tích, tai nạn hoặc thương vong (những nguy cơ này có thể xảy ra do bất kỳ lý do gì, bao gồm nhưng không giới hạn do sự hỏng hóc, sự cố, hoặc lỗi kỹ thuật của xe, những hành động cố tình hoặc vô ý của tôi hoặc của những thành viên tham gia chương trình, v.v...). Tuy nhiên, tôi tình nguyện tham lái thử xe như vậy và chấp nhận những nguy cơ có thể xảy ra nêu trên trong suốt quá trình lái thử xe. Đồng thời, tôi xin chịu trách nhiệm về các tổn thất, hư hỏng cho xe cũng như mọi tổn thất về người hoặc về tài sản do tôi gây ra cho người thứ ba trong quá trình lái thử xe."}),e.jsx("li",{children:"Tôi đồng ý và cam kết miễn truy cứu trách nhiệm, cũng như miễn việc yêu cầu Công ty, chi nhánh, các công ty liên quan và nhân viên trực thuộc các Công ty bồi thường thiệt hại xảy ra (nếu có) trong mọi trường hợp trong quá trình hoặc có liên quan đến việc chạy thử xe này và dù vì bất kỳ nguyên nhân nào. Tôi thừa nhận rằng Công ty và các đơn vị và cá nhân nêu trên không có nghĩa vụ bồi thường nào liên quan đến bất kỳ trách nhiệm, nguyên nhân gây thiệt hại nào (bao gồm nhưng không giới hạn, thiệt hại trực tiếp và thực tế) ) trong mọi trường hợp trong quá trình hoặc có liên quan đến việc chạy thử xe này. Tôi cam kết và từ bỏ mọi quyền yêu cầu bồi thường, khiếu nại, kiện tụng (bao gồm nhưng không giới hạn, thương tích cá nhân, tai nạn về thương vong, thiệt hại về tài sản hoặc các vấn đề tương tự cho người và tài sản của tôi hoặc của bất kỳ bên thứ ba nào khác) có thể phát sinh trực tiếp hoặc gián tiếp từ việc tham gia lái thử xe này, kể cả phát sinh trong các trường hợp bất khả kháng (bao gồm nhưng không giới hạn: thiên tai, hỏa hoạn, lũ lụt, khủng bố hay chiến tranh ...) đối với Công ty, chi nhánh, các công ty liên quan và nhân viên trực thuộc các Công ty trong mọi trường hợp và dù vì bất kỳ nguyên nhân nào."}),e.jsx("li",{children:"Tôi đồng ý và ủng hộ hoàn toàn việc Công ty thu thập, sử dụng miễn phí các thông tin cá nhân, hình ảnh, video về tôi và/ hoặc do tôi tạo ra và/ hoặc được tạo ra từ trong chương trình lái thử xe này để sử dụng nội bộ và/ hoặc quảng cáo, đăng tải trên các phương tiện thông tin đại chúng. Bên cạnh đó, Công ty được phép gửi các thông tin cá nhân, tư liệu, hình ảnh, video nêu trên cho công ty mẹ của mình, các công ty thành viên trong tập đoàn Vingroup và các công ty khác cung cấp dịch vụ quảng cáo cho Công ty tại Việt Nam hoặc trên thế giới."}),e.jsx("li",{children:"Giấy Cam Kết này chịu sự điều chỉnh của Pháp luật Việt Nam. Trong trường hợp có bất kì vấn đề, tranh chấp nảy sinh thì tranh chấp đó sẽ được đưa ra giải quyết tại cơ quan Tòa án có thẩm quyền tại Việt Nam."}),e.jsx("li",{children:"Giấy Cam Kết này sẽ có hiệu lực ràng buộc với bất kỳ bên thứ ba nào là người thừa kế và/ hoặc người được ủy quyền từ tôi."})]}),e.jsx("p",{className:"text-center font-bold my-3",children:'TÔI ĐÃ ĐỌC VÀ HIỂU RÕ MỌI NỘI DUNG NÊU TRÊN CỦA "GIẤY CAM KẾT" VÀ TỰ NGUYỆN ĐỒNG Ý VỚI NHỮNG CAM KẾT NÊU TRÊN.'}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:"text-center w-64",children:[e.jsxs("p",{className:"italic",children:["..........., Ngày ",o||"....."," tháng ",x||"....."," năm ",c||"......."]}),e.jsx("p",{className:"font-bold mt-2",children:"Người đề nghị"}),e.jsx("p",{className:"italic text-xs",children:"(Ký và ghi rõ họ tên)"}),e.jsx("div",{className:"h-16"}),e.jsx("p",{className:"font-bold",children:t.tenKhachHang})]})})]})},D=({data:t})=>e.jsxs("main",{id:"print-area-wrapper",className:"print-hidden lg:col-span-3 bg-slate-100 p-4 rounded-lg overflow-y-auto flex flex-col items-center gap-4",children:[e.jsx("div",{className:"w-full max-w-[210mm]",children:e.jsx(we,{data:t})}),e.jsx("div",{className:"w-full max-w-[210mm] mt-4",children:e.jsx(ke,{data:t})})]});D.PhieuLaiThu=we;D.GiayCamKet=ke;const he=t=>{if(!t)return"";if(/^\d{2}:\d{2}$/.test(t))return t;const s=I(t);return s.isValid()?s.format("HH:mm"):t},J=t=>t.odoBefore&&t.odoAfter?"Đã hoàn tất":t.odoBefore?"Đang lái thử":"Chờ Check-in",Ye=({url:t,label:s,icon:c,onClick:x})=>{const[o,v]=h.useState(ie(t,320)),[T,g]=h.useState(!1);h.useEffect(()=>{v(ie(t,320)),g(!1)},[t]);const b=()=>{const u=ie(t,320);o===u?v(Me(t)):g(!0)};return e.jsxs("div",{className:"flex flex-col rounded border border-border-secondary bg-surface-ground cursor-pointer hover:bg-surface-hover transition-all overflow-hidden group",onClick:u=>{u.stopPropagation(),x()},children:[e.jsxs("div",{className:"h-24 bg-white flex items-center justify-center overflow-hidden relative",children:[T?e.jsx("div",{className:"w-10 h-10 rounded-full bg-surface-ground shadow-sm flex items-center justify-center text-accent-primary",children:e.jsx("i",{className:`fas ${c} text-xl opacity-50`})}):e.jsx("img",{src:o,alt:s,className:"w-full h-full object-cover transition-transform duration-500 group-hover:scale-110",onError:b}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center",children:e.jsx("i",{className:"fas fa-search-plus text-white opacity-0 group-hover:opacity-100 transform scale-50 group-hover:scale-100 transition-all duration-300 drop-shadow-md"})})]}),e.jsx("div",{className:"p-1.5 text-center border-t border-border-secondary bg-surface-ground",children:e.jsx("div",{className:"font-medium text-[10px] text-text-primary truncate",title:s,children:s})})]})},_e=({bookings:t,onSelectBooking:s,onUpdateCheckin:c,onDelete:x,currentUser:o,isAdmin:v,onOpenImagePreview:T})=>{const g=h.useMemo(()=>Array.from(new Set(t.map(d=>d.tenTuVan))).sort((d,N)=>d.localeCompare(N)).map(d=>({id:`consultant_${d}`,label:d,count:t.filter(N=>P(N.tenTuVan)===P(d)).length})),[t]),[b,u]=h.useState(()=>g.length>0?g[0].id:""),[p,K]=h.useState("all"),[f,V]=h.useState(null),[L,w]=h.useState("folders");h.useEffect(()=>{g.length>0&&!b&&u(g[0].id)},[g,b]);const k=h.useMemo(()=>t.filter(i=>{if(b.startsWith("consultant_")){const d=b.replace("consultant_","");if(!(P(i.tenTuVan)===P(d)))return!1;if(p!=="all"){const y=J(i);switch(p){case"pending":return y==="Chờ Check-in";case"ongoing":return y==="Đang lái thử";case"completed":return y==="Đã hoàn tất";default:return!0}}return!0}return!0}),[t,b,p]),l=h.useMemo(()=>t.find(i=>i.soPhieu===f),[t,f]);h.useEffect(()=>{k.length>0?V(k[0].soPhieu):V(null)},[k]);const A=h.useMemo(()=>{const i=g.find(d=>d.id===b);return(i==null?void 0:i.label)||""},[g,b]),F=i=>{u(i),K("all"),w("list")},E=i=>{V(i),w("detail");const d=t.find(N=>N.soPhieu===i);if(d){const N=J(d),y=v||P(o)===P(d.tenTuVan);N!=="Đã hoàn tất"&&y&&c(d)}};return t.length===0?e.jsxs("div",{className:"text-center py-16 text-text-secondary flex flex-col items-center justify-center h-full",children:[e.jsx("i",{className:"fas fa-calendar-times fa-3x mb-4"}),e.jsx("p",{className:"font-semibold",children:"Không tìm thấy lịch lái thử nào."}),e.jsx("p",{className:"text-sm",children:"Hãy thử thay đổi bộ lọc hoặc xóa ngày đã chọn."})]}):e.jsxs("div",{className:"flex h-full bg-surface-card rounded-xl shadow-md border border-border-primary overflow-hidden animate-fade-in relative",children:[e.jsxs("div",{className:`w-full md:w-72 flex-shrink-0 border-r border-border-primary bg-surface-ground flex flex-col absolute md:relative inset-0 z-20 md:z-auto transition-transform duration-300 ${L==="folders"?"translate-x-0":"-translate-x-full md:translate-x-0"}`,children:[e.jsx("div",{className:"p-4 border-b border-border-primary md:hidden flex items-center justify-between bg-white",children:e.jsx("span",{className:"font-bold text-lg",children:"Tư Vấn Bán Hàng"})}),e.jsx("nav",{className:"flex-1 p-2 space-y-1 overflow-y-auto",children:g.map(i=>e.jsxs("button",{onClick:()=>F(i.id),className:`w-full flex items-center justify-between px-3 py-2 rounded-lg text-xs font-medium transition-colors ${b===i.id?"bg-accent-primary/10 text-accent-primary":"text-text-secondary hover:bg-surface-hover hover:text-text-primary"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold ${b===i.id?"bg-accent-primary text-white":"bg-gray-200 text-gray-600"}`,children:i.label.charAt(0)}),e.jsx("span",{className:"truncate text-left",children:i.label})]}),i.count>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${b===i.id?"bg-accent-primary text-white":"bg-surface-hover text-text-secondary"}`,children:i.count})]},i.id))})]}),e.jsxs("div",{className:`w-full md:w-96 flex-shrink-0 border-r border-border-primary flex flex-col bg-white absolute md:relative inset-0 z-20 md:z-auto transition-transform duration-300 ${L==="list"?"translate-x-0":L==="detail"?"-translate-x-full md:translate-x-0":"translate-x-full md:translate-x-0"}`,children:[e.jsxs("div",{className:"p-3 border-b border-border-primary md:hidden flex items-center gap-3 bg-white shadow-sm",children:[e.jsx("button",{onClick:()=>w("folders"),className:"w-8 h-8 rounded-full bg-surface-ground flex items-center justify-center text-text-secondary hover:bg-surface-hover",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsx("span",{className:"font-bold text-text-primary",children:A})]}),e.jsxs("div",{className:"flex items-center gap-1 p-2 bg-surface-ground border-b border-border-primary",children:[e.jsx("button",{onClick:()=>K("all"),className:`flex-1 px-3 py-1.5 rounded text-xs font-medium transition-colors ${p==="all"?"bg-white text-accent-primary shadow-sm":"text-text-secondary hover:bg-white/50"}`,children:"Tất cả"}),e.jsx("button",{onClick:()=>K("pending"),className:`flex-1 px-3 py-1.5 rounded text-xs font-medium transition-colors ${p==="pending"?"bg-white text-accent-primary shadow-sm":"text-text-secondary hover:bg-white/50"}`,children:"Chờ Check-in"}),e.jsx("button",{onClick:()=>K("ongoing"),className:`flex-1 px-3 py-1.5 rounded text-xs font-medium transition-colors ${p==="ongoing"?"bg-white text-accent-primary shadow-sm":"text-text-secondary hover:bg-white/50"}`,children:"Đang lái"}),e.jsx("button",{onClick:()=>K("completed"),className:`flex-1 px-3 py-1.5 rounded text-xs font-medium transition-colors ${p==="completed"?"bg-white text-accent-primary shadow-sm":"text-text-secondary hover:bg-white/50"}`,children:"Hoàn tất"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:k.length===0?e.jsx("div",{className:"p-8 text-center text-text-placeholder text-sm",children:"Không tìm thấy lịch lái thử nào."}):e.jsx("div",{className:"divide-y divide-border-secondary",children:k.map((i,d)=>{const N=J(i),y=P(o)===P(i.tenTuVan);return e.jsx("div",{onClick:()=>E(i.soPhieu),className:`px-3 py-3 cursor-pointer hover:bg-surface-hover transition-colors ${f===i.soPhieu?"bg-accent-primary/5 border-l-4 border-accent-primary":"border-l-4 border-transparent"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 ${y?"bg-accent-primary text-white":"bg-gray-200 text-gray-600"}`,children:i.tenKhachHang.charAt(0)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-semibold text-sm text-text-primary truncate",children:i.tenKhachHang}),e.jsx("div",{className:"text-xs text-text-secondary truncate",children:i.loaiXe}),e.jsxs("div",{className:"text-xs text-accent-primary font-medium mt-0.5",children:[I(i.ngayThuXe).format("DD/MM")," • ",he(i.thoiGianKhoiHanh)]})]}),e.jsxs("div",{className:"flex-shrink-0",children:[N==="Chờ Check-in"&&e.jsx("i",{className:"fas fa-clock text-warning text-base"}),N==="Đang lái thử"&&e.jsx("i",{className:"fas fa-car text-blue-500 text-base"}),N==="Đã hoàn tất"&&e.jsx("i",{className:"fas fa-check-circle text-success text-base"})]})]})},`${i.soPhieu}-${d}`)})})})]}),e.jsx("div",{className:`w-full flex-1 flex flex-col bg-surface-ground min-w-0 absolute md:relative inset-0 z-30 md:z-auto transition-transform duration-300 ${L==="detail"?"translate-x-0":"translate-x-full md:translate-x-0"}`,children:l?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"px-4 py-3 bg-white border-b border-border-primary flex justify-between items-center shadow-sm z-10",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("button",{onClick:()=>w("list"),className:"md:hidden w-8 h-8 rounded-full bg-surface-ground flex items-center justify-center text-text-secondary hover:bg-surface-hover",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-base font-bold hidden sm:flex ${P(o)===P(l.tenTuVan)?"bg-accent-primary text-white":"bg-gray-200 text-gray-600"}`,children:l.tenKhachHang.charAt(0)}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h2",{className:"text-base font-bold text-text-primary leading-tight truncate",children:l.tenKhachHang}),e.jsxs("div",{className:"text-xs text-text-secondary flex items-center gap-2 mt-0.5",children:[e.jsxs("span",{className:"font-mono",children:["#",l.soPhieu]}),e.jsx("span",{children:"•"}),e.jsx(Xe,{status:J(l)})]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:(()=>{const i=v||P(o)===P(l.tenTuVan),d=J(l);return e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{i&&(d==="Đã hoàn tất"?c(l,"update"):c(l))},className:`w-9 h-9 rounded-full hover:bg-surface-hover flex items-center justify-center ${i?"":"opacity-50 cursor-not-allowed"}`,disabled:!i,title:d==="Đã hoàn tất"?"Cập nhật hình ảnh":"Check-in/out",children:e.jsx("i",{className:`fas ${d==="Đã hoàn tất"?"fa-images":"fa-camera"} text-text-secondary`})}),e.jsx("button",{onClick:()=>s(l),className:"w-9 h-9 rounded-full hover:bg-surface-hover flex items-center justify-center",title:"Xem & In phiếu",children:e.jsx("i",{className:"fas fa-print text-text-secondary"})}),e.jsx("button",{onClick:()=>x(l),className:`w-9 h-9 rounded-full hover:bg-surface-hover flex items-center justify-center ${!i||d!=="Chờ Check-in"?"opacity-50 cursor-not-allowed":""}`,disabled:!i||d!=="Chờ Check-in",title:"Xóa phiếu",children:e.jsx("i",{className:"fas fa-trash-alt text-danger"})})]})})()})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-3 shadow-sm border border-border-secondary",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center flex-shrink-0",children:e.jsx("i",{className:"fas fa-car text-sm"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-[10px] text-text-secondary uppercase font-bold",children:"Xe Lái Thử"}),e.jsx("div",{className:"text-sm font-bold text-text-primary truncate",title:l.loaiXe,children:l.loaiXe})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center flex-shrink-0",children:e.jsx("i",{className:"fas fa-user text-sm"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-[10px] text-text-secondary uppercase font-bold",children:"Khách Hàng"}),e.jsx("div",{className:"text-sm font-bold text-text-primary truncate",children:l.tenKhachHang}),e.jsx("div",{className:"text-[10px] text-text-secondary truncate",children:l.dienThoai})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center flex-shrink-0",children:e.jsx("i",{className:"fas fa-calendar-alt text-sm"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-[10px] text-text-secondary uppercase font-bold",children:"Lịch Trình"}),e.jsx("div",{className:"text-sm font-medium text-text-primary truncate",children:I(l.ngayThuXe).format("DD/MM/YYYY")}),e.jsxs("div",{className:"text-[10px] text-accent-primary font-bold",children:[he(l.thoiGianKhoiHanh)," - ",he(l.thoiGianTroVe)]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 ${P(o)===P(l.tenTuVan)?"bg-accent-primary text-white":"bg-gray-100 text-gray-500"}`,children:l.tenTuVan.charAt(0)}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-[10px] text-text-secondary uppercase font-bold",children:"Tư Vấn"}),e.jsx("div",{className:`text-sm font-medium truncate ${P(o)===P(l.tenTuVan)?"text-accent-primary":"text-text-primary"}`,children:l.tenTuVan})]})]})]}),(l.odoBefore||l.odoAfter)&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-border-secondary grid grid-cols-2 gap-4",children:[l.odoBefore&&e.jsxs("div",{className:"flex items-center justify-between bg-surface-ground px-2 py-1.5 rounded",children:[e.jsx("span",{className:"text-[10px] text-text-secondary",children:"ODO Đi"}),e.jsxs("span",{className:"text-xs font-bold text-text-primary",children:[l.odoBefore," km"]})]}),l.odoAfter&&e.jsxs("div",{className:"flex items-center justify-between bg-surface-ground px-2 py-1.5 rounded",children:[e.jsx("span",{className:"text-[10px] text-text-secondary",children:"ODO Về"}),e.jsxs("span",{className:"text-xs font-bold text-text-primary",children:[l.odoAfter," km"]})]})]})]}),(()=>{const i=[];if(l.imagesBefore)try{const d=JSON.parse(l.imagesBefore);Array.isArray(d)&&d.forEach((N,y)=>{i.push({src:N,originalUrl:N,label:`Trước khi đi ${y+1}`})})}catch(d){console.error("Failed to parse imagesBefore",d)}if(l.imagesAfter)try{const d=JSON.parse(l.imagesAfter);Array.isArray(d)&&d.forEach((N,y)=>{i.push({src:N,originalUrl:N,label:`Sau khi về ${y+1}`})})}catch(d){console.error("Failed to parse imagesAfter",d)}return i.length>0?e.jsxs("div",{className:"bg-white rounded-lg p-3 shadow-sm border border-border-secondary",children:[e.jsxs("h3",{className:"text-[10px] font-bold text-text-secondary uppercase mb-2 flex items-center gap-1.5",children:[e.jsx("i",{className:"fas fa-images"}),"Hình Ảnh (",i.length,")"]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-2",children:i.map((d,N)=>e.jsx(Ye,{url:d.src,label:d.label,icon:"fa-image",onClick:()=>T(i,N,l.tenKhachHang)},N))})]}):null})()]})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-text-placeholder",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-hand-pointer fa-3x mb-4"}),e.jsx("p",{children:"Chọn một lịch lái thử để xem chi tiết"})]})})})]})},ae=t=>new Promise((s,c)=>{const x=new FileReader;x.readAsDataURL(t),x.onload=()=>{if(typeof x.result=="string"){const o=x.result.split(",")[1];o?s(o):c(new Error("Không thể chuyển đổi file thành base64."))}else c(new Error("Không thể đọc tệp."))},x.onerror=o=>c(o)}),je=({onFilesChange:t,label:s})=>{const[c,x]=h.useState([]),[o,v]=h.useState([]),T=Q.useRef(null),g=Q.useRef(null);Q.useEffect(()=>()=>{o.forEach(f=>URL.revokeObjectURL(f))},[o]);const b=async f=>{if(!f)return;const L=Array.from(f).filter(w=>!c.some(k=>k.name===w.name&&k.size===w.size&&k.lastModified===w.lastModified));if(L.length!==0)try{const w=await Promise.all(L.map(A=>Ie(A))),k=[...c,...w];x(k);const l=w.map(A=>URL.createObjectURL(A));v(A=>[...A,...l]),t(k)}catch(w){console.error("Lỗi nén ảnh:",w),alert("Một hoặc nhiều ảnh không thể được xử lý. Vui lòng thử lại.")}},u=f=>{b(f.target.files),f.target&&(f.target.value="")},p=f=>{const V=c.filter((w,k)=>k!==f),L=o.filter((w,k)=>k!==f);URL.revokeObjectURL(o[f]),x(V),v(L),t(V)},K=()=>{o.forEach(f=>URL.revokeObjectURL(f)),x([]),v([]),t([])};return e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-text-primary mb-2",children:[s," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",onChange:u,ref:T,className:"hidden"}),e.jsx("input",{type:"file",accept:"image/*",capture:!0,onChange:u,ref:g,className:"hidden"}),e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx(M,{type:"button",onClick:()=>{var f;return(f=T.current)==null?void 0:f.click()},variant:"secondary",className:"flex-1 !py-2 !text-xs",leftIcon:e.jsx("i",{className:"fas fa-images"}),children:"Chọn từ thư viện"}),e.jsx(M,{type:"button",onClick:()=>{var f;return(f=g.current)==null?void 0:f.click()},variant:"secondary",className:"flex-1 !py-2 !text-xs",leftIcon:e.jsx("i",{className:"fas fa-camera"}),children:"Chụp ảnh"})]}),o.length>0&&e.jsxs("div",{className:"mt-2 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-3 lg:grid-cols-4 gap-2",children:[o.map((f,V)=>e.jsxs("div",{className:"relative group aspect-square",children:[e.jsx("img",{src:f,alt:`Preview ${V}`,className:"w-full h-full object-cover rounded-md border border-border-primary"}),e.jsx(M,{type:"button",onClick:()=>p(V),variant:"ghost",className:"absolute -top-1.5 -right-1.5 w-5 h-5 bg-danger text-white rounded-full text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all hover:scale-110 !p-0",title:"Xóa ảnh này",children:e.jsx("i",{className:"fas fa-times"})})]},V)),e.jsx("div",{className:"relative group aspect-square",children:e.jsx(M,{onClick:K,variant:"ghost",className:"w-full h-full bg-surface-hover rounded-md flex items-center justify-center text-text-secondary hover:bg-danger-bg hover:text-danger-hover transition-colors !p-0",title:"Xóa tất cả ảnh đã chọn",children:e.jsx("i",{className:"fas fa-trash-alt text-2xl"})})})]})]})},ve=({images:t,onImageClick:s,label:c})=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-primary mb-2",children:c}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-3 lg:grid-cols-4 gap-2",children:t.map((x,o)=>e.jsxs("div",{className:"relative group aspect-square cursor-pointer",onClick:()=>s(x,o),children:[e.jsx("img",{src:ie(x,200),alt:`${c} ${o+1}`,className:"w-full h-full object-cover rounded-md border border-border-primary"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-md",children:e.jsx("i",{className:"fas fa-search-plus text-white text-2xl"})})]},o))})]}),Ne=t=>{if(!t)return[];try{const s=JSON.parse(t);if(Array.isArray(s))return s.filter(c=>typeof c=="string")}catch(s){console.error("Failed to parse image data:",s,"Data was:",t)}return[]},We=({booking:t,mode:s,onClose:c,onSubmit:x,showToast:o,onOpenImagePreview:v,currentUser:T,isAdmin:g})=>{const[b,u]=h.useState(t.odoBefore||""),[p,K]=h.useState([]),[f,V]=h.useState(t.odoAfter||""),[L,w]=h.useState([]),[k,l]=h.useState(!1),A=Be(),F=h.useMemo(()=>g||P(T)===P(t.tenTuVan),[g,T,t.tenTuVan]),E=s==="view"||!F,i=h.useMemo(()=>Ne(t.imagesBefore),[t.imagesBefore]),d=h.useMemo(()=>Ne(t.imagesAfter),[t.imagesAfter]),N=async()=>{l(!0);try{const y={soPhieu:t.soPhieu};if(s==="checkin"){if(!b.trim()||p.length===0){o("Thiếu thông tin","Vui lòng nhập ODO và tải lên ít nhất 1 ảnh trước khi đi.","warning"),l(!1);return}y.odoBefore=b,y.imagesBefore=await Promise.all(p.map(async C=>({name:C.name,type:C.type,data:await ae(C)})))}else if(s==="checkout"){if(!f.trim()||L.length===0){o("Thiếu thông tin","Vui lòng nhập ODO và tải lên ít nhất 1 ảnh sau khi về.","warning"),l(!1);return}if(parseFloat(f)<=parseFloat(b||t.odoBefore||"0")){o("Lỗi ODO","ODO sau khi về phải lớn hơn ODO trước khi đi.","error"),l(!1);return}y.odoAfter=f,y.imagesAfter=await Promise.all(L.map(async C=>({name:C.name,type:C.type,data:await ae(C)})))}else if(s==="update"){if(p.length===0&&L.length===0){o("Không có ảnh mới","Vui lòng chọn hoặc chụp ảnh mới để cập nhật.","warning"),l(!1);return}p.length>0&&(y.imagesBefore=await Promise.all(p.map(async C=>({name:C.name,type:C.type,data:await ae(C)})))),L.length>0&&(y.imagesAfter=await Promise.all(L.map(async C=>({name:C.name,type:C.type,data:await ae(C)}))))}else{l(!1);return}await x(y)||l(!1)}catch(y){const $=y instanceof Error?y.message:"Xử lý ảnh thất bại. Vui lòng thử lại.";o("Lỗi Xử Lý Ảnh",$,"error"),l(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex flex-col justify-end md:justify-center md:items-center p-0 md:p-4",onClick:c,children:e.jsxs("div",{className:"bg-surface-card w-full md:max-w-5xl h-[85vh] md:h-auto md:max-h-[90vh] rounded-t-2xl md:rounded-2xl shadow-xl animate-fade-in-up flex flex-col",onClick:y=>y.stopPropagation(),style:A,children:[e.jsxs("header",{className:"flex-shrink-0 px-6 py-4 border-b border-border-primary/50 flex justify-between items-center bg-white/50 backdrop-blur-sm rounded-t-2xl",children:[e.jsx("h2",{className:"text-xl font-bold text-text-primary",children:s==="view"?"Chi Tiết Lái Thử":"Cập Nhật Lái Thử"}),e.jsx(M,{onClick:c,variant:"ghost",className:"text-text-secondary hover:text-text-primary !p-2",children:e.jsx("i",{className:"fas fa-times text-lg"})})]}),e.jsxs("main",{className:"p-4 md:p-6 overflow-y-auto flex-grow min-h-0 bg-surface-ground/50",children:[e.jsxs("div",{className:"p-4 bg-white rounded-xl border border-border-primary/60 shadow-sm text-sm mb-6 flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-accent-primary/10 text-accent-primary rounded-full border border-accent-primary/20",children:[e.jsx("i",{className:"fas fa-ticket-alt text-xs"}),e.jsx("span",{className:"font-bold font-mono",children:t.soPhieu})]}),e.jsx("span",{className:"text-border-primary hidden md:inline",children:"|"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-text-secondary font-medium",children:"Khách hàng:"}),e.jsx("span",{className:"font-bold text-text-primary text-base",children:t.tenKhachHang})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:`group relative bg-white rounded-xl p-5 border border-border-primary/60 shadow-sm hover:shadow-md transition-all duration-300 ${E&&s!=="update"?"opacity-80":""}`,children:[e.jsxs("div",{className:"mb-4 flex items-center gap-3 border-b border-border-primary/50 pb-3",children:[e.jsx("i",{className:"fas fa-car-side text-lg text-accent-primary"}),e.jsx("legend",{className:"font-bold text-lg text-text-primary",children:"Trước Khi Đi"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"odoBefore",className:"block text-sm font-medium text-text-secondary mb-2",children:["Số ODO (km) ",s==="checkin"&&e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",id:"odoBefore",value:b,readOnly:s!=="checkin"||E,onChange:y=>u(y.target.value),className:"w-full futuristic-input read-only:bg-surface-input read-only:cursor-not-allowed",placeholder:"Nhập số km hiện tại"}),e.jsx("span",{className:"absolute right-4 top-1/2 -translate-y-1/2 text-text-placeholder text-sm font-medium",children:"km"})]})]}),i.length>0&&e.jsx("div",{className:"bg-surface-ground rounded-xl p-3 border border-border-primary/30",children:e.jsx(ve,{images:i,label:"Ảnh đã lưu",onImageClick:(y,$)=>{const C=i.map((X,z)=>({src:X,originalUrl:X,label:`Ảnh trước khi đi ${z+1}`}));v(C,$,t.tenKhachHang)}})}),(s==="checkin"||s==="update")&&F&&e.jsx(je,{label:s==="update"?"Thêm ảnh mới":"Chụp ảnh xe",onFilesChange:K})]})]}),e.jsxs("div",{className:`group relative bg-white rounded-xl p-5 border border-border-primary/60 shadow-sm hover:shadow-md transition-all duration-300 ${E&&s!=="update"?"opacity-80":""}`,children:[e.jsxs("div",{className:"mb-4 flex items-center gap-3 border-b border-border-primary/50 pb-3",children:[e.jsx("i",{className:"fas fa-flag-checkered text-lg text-accent-secondary"}),e.jsx("legend",{className:"font-bold text-lg text-text-primary",children:"Sau Khi Về"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"odoAfter",className:"block text-sm font-medium text-text-secondary mb-2",children:["Số ODO (km) ",s==="checkout"&&e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",id:"odoAfter",value:f,readOnly:s!=="checkout"||E,onChange:y=>V(y.target.value),className:"w-full futuristic-input read-only:bg-surface-input read-only:cursor-not-allowed",placeholder:"Nhập số km sau khi lái thử"}),e.jsx("span",{className:"absolute right-4 top-1/2 -translate-y-1/2 text-text-placeholder text-sm font-medium",children:"km"})]})]}),d.length>0&&e.jsx("div",{className:"bg-surface-ground rounded-xl p-3 border border-border-primary/30",children:e.jsx(ve,{images:d,label:"Ảnh đã lưu",onImageClick:(y,$)=>{const C=d.map((X,z)=>({src:X,originalUrl:X,label:`Ảnh sau khi về ${z+1}`}));v(C,$,t.tenKhachHang)}})}),(s==="checkout"||s==="update")&&F&&e.jsx(je,{label:s==="update"?"Thêm ảnh mới":"Chụp ảnh xe",onFilesChange:w})]})]})]})]}),s!=="view"&&F&&e.jsxs("footer",{className:"flex-shrink-0 px-6 py-4 border-t border-border-primary/50 flex justify-end gap-3 bg-white rounded-b-2xl",children:[e.jsx(M,{onClick:c,disabled:k,variant:"secondary",size:"md",className:"min-w-[100px]",children:"Hủy"}),e.jsx(M,{onClick:N,disabled:k,isLoading:k,variant:"primary",size:"md",className:"min-w-[140px]",leftIcon:k?void 0:e.jsx("i",{className:"fas fa-save"}),children:s==="update"?"Cập Nhật":"Lưu Thông Tin"})]})]})})},de={soPhieu:"",ngayThuXe:"",loaiXe:"",thoiGianKhoiHanh:"",thoiGianTroVe:"",loTrinh:"",tenKhachHang:"",dienThoai:"",email:"",diaChi:"",tuLai:"co",dacDiem:"",gplxSo:"",hieuLucGPLX:"",ngayCamKet:"",tenTuVan:""},U=t=>{if(!t)return 0;if(t.includes("T")||t.includes(" ")){const c=I(t);if(c.isValid())return c.hour()*60+c.minute()}const s=t.split(":");if(s.length>=2){const c=parseInt(s[0],10),x=parseInt(s[1],10);if(!isNaN(c)&&!isNaN(x))return c*60+x}return 0},re=15,Je=({showToast:t,hideToast:s,onOpenImagePreview:c,currentUser:x,isAdmin:o,allTestDrives:v,setAllTestDrives:T,isLoading:g,refetch:b})=>{const[u,p]=h.useState(()=>{const r=sessionStorage.getItem("currentConsultant")||"";return{...de,tenTuVan:r}}),[K,f]=h.useState(""),[V,L]=h.useState([]),[w,k]=h.useState(!1),[l,A]=h.useState("create"),[F,E]=h.useState(null),[i,d]=h.useState(u),[N,y]=h.useState(null),[$,C]=h.useState(null),[X,z]=h.useState({keyword:"",dateRange:{start:"",end:""},car:[],status:[]}),[R,Ce]=h.useState({key:"ngayThuXe",direction:"desc"}),Z=h.useCallback(r=>{const a=new Date,n=(a.getMonth()+1).toString().padStart(2,"0"),m=a.getFullYear().toString().slice(-2),j=`LT/${n}${m}`;let H=1;if(r&&r.startsWith(j)){const B=r.split("/"),O=parseInt(B[B.length-1],10);isNaN(O)||(H=O+1)}return`${j}/${H.toString().padStart(3,"0")}`},[]),ee=h.useCallback(r=>{const a=`LT/${I().format("MMYY")}`,n=r.filter(m=>m.soPhieu&&m.soPhieu.startsWith(a));if(n.length!==0)return n.sort((m,j)=>{const H=parseInt(m.soPhieu.split("/").pop()||"0",10);return parseInt(j.soPhieu.split("/").pop()||"0",10)-H}),n[0].soPhieu},[]);h.useEffect(()=>{if(!g&&u.soPhieu===""){const r=ee(v),a=sessionStorage.getItem("currentConsultant")||"";p({...de,tenTuVan:a,soPhieu:Z(r)})}},[g,v,u.soPhieu,Z,ee]);const te=h.useCallback(()=>{const r=ee(v),a=sessionStorage.getItem("currentConsultant")||"";p({...de,tenTuVan:a,soPhieu:Z(r)}),E(null),A("create")},[v,Z,ee]),me=h.useCallback(r=>{d(r),t("Đang chuẩn bị...","Vui lòng chờ trong khi tài liệu in đang được tạo.","loading"),setTimeout(()=>{var O,W;const a=(O=document.getElementById("print-container"))==null?void 0:O.innerHTML;if(!a){s(),t("Lỗi In","Không tìm thấy nội dung để in.","error");return}const n=document.createElement("iframe");n.style.position="absolute",n.style.width="0",n.style.height="0",n.style.border="0",n.src="about:blank",document.body.appendChild(n);const m=(W=n.contentWindow)==null?void 0:W.document;if(!m){s(),t("Lỗi In","Không thể tạo tài liệu in.","error"),document.body.removeChild(n);return}m.open(),m.write("<html><head><title>In Phiếu Lái Thử</title>");const j=document.getElementsByTagName("link");for(let G=0;G<j.length;G++)j[G].rel==="stylesheet"&&m.write(j[G].outerHTML);const H=document.getElementsByTagName("style");for(let G=0;G<H.length;G++)m.write(H[G].outerHTML);m.write("</head><body>"),m.write('<div id="print-container">'+a+"</div>"),m.write("</body></html>"),m.close();const B=()=>{var G,se;s(),(G=n.contentWindow)==null||G.focus(),(se=n.contentWindow)==null||se.print(),setTimeout(()=>{document.body.removeChild(n),l==="create"&&te()},1e3)};n.contentWindow?n.contentWindow.onload=B:setTimeout(B,500)},200)},[l,te,s,t]),ce=h.useMemo(()=>!u.ngayThuXe||!u.loaiXe?[]:v.filter(r=>r.ngayThuXe===u.ngayThuXe&&r.loaiXe===u.loaiXe),[v,u.ngayThuXe,u.loaiXe]);h.useEffect(()=>{if(f(""),L([]),!u.thoiGianKhoiHanh||!u.thoiGianTroVe)return;const r=U(u.thoiGianKhoiHanh),a=U(u.thoiGianTroVe);if(r>=a){f("Giờ khởi hành phải trước giờ trở về.");return}const n=[...ce].sort((j,H)=>U(j.thoiGianKhoiHanh)-U(H.thoiGianKhoiHanh)),m=(j,H)=>{const B=[];let G=480;const se=j.map(Y=>({start:U(Y.thoiGianKhoiHanh)-re,end:U(Y.thoiGianTroVe)+re}));for(;G+H<=1200&&B.length<3;){const Y=G+H;let ge=!1;for(const _ of se)if(G<_.end&&Y>_.start){ge=!0,G=_.end;break}if(!ge){const _=fe=>`${String(Math.floor(fe/60)).padStart(2,"0")}:${String(fe%60).padStart(2,"0")}`;B.push(`${_(G)} - ${_(Y)}`),G=Y}}return B};for(const j of n){const H=U(j.thoiGianKhoiHanh),B=U(j.thoiGianTroVe);if(r<B+re&&a+re>H){f(`Lịch bị trùng với KH: ${j.tenKhachHang} (${I(j.thoiGianKhoiHanh,"HH:mm").format("HH:mm")} - ${I(j.thoiGianTroVe,"HH:mm").format("HH:mm")})`);const O=a-r,W=m(n,O);L(W);return}}},[u.thoiGianKhoiHanh,u.thoiGianTroVe,ce]);const Te=r=>{const{name:a,value:n}=r.target;p(m=>{const j={...m,[a]:n};return a==="ngayThuXe"&&(j.ngayCamKet=n),j})},Se=r=>{p(a=>({...a,tuLai:r.target.value}))},Le=r=>{const[a,n]=r.split(" - ");p(m=>({...m,thoiGianKhoiHanh:a,thoiGianTroVe:n}))},xe=async()=>{const a=[{key:"ngayThuXe",label:"Ngày thử xe"},{key:"loaiXe",label:"Loại xe"},{key:"thoiGianKhoiHanh",label:"Giờ khởi hành"},{key:"thoiGianTroVe",label:"Giờ trở về"},{key:"loTrinh",label:"Lộ trình"},{key:"tenKhachHang",label:"Tên khách hàng"},{key:"dienThoai",label:"Điện thoại"},{key:"diaChi",label:"Địa chỉ"},{key:"gplxSo",label:"Số GPLX"},{key:"hieuLucGPLX",label:"Hiệu lực GPLX"}].filter(({key:n})=>{var m;return!((m=u[n])!=null&&m.trim())}).map(({label:n})=>n);if(a.length>0){t("Thiếu Thông Tin",`Vui lòng điền: ${a.join(", ")}`,"warning");return}if(K){t("Lỗi Trùng Lịch",`Không thể lưu: ${K}`,"error");return}k(!0);try{const n=await Ee(u);if(n.status==="SUCCESS"&&n.newRecord)t("Lưu Thành Công","Lịch lái thử đã được lưu. Chuẩn bị in...","success"),T(m=>[...m,n.newRecord].sort((j,H)=>H.ngayThuXe.localeCompare(j.ngayThuXe))),me(u);else throw new Error(n.message||"Lưu lịch thất bại.")}catch(n){const m=n instanceof Error?n.message:"Lỗi không xác định.";t("Lưu Thất Bại",m,"error")}finally{k(!1)}},He=()=>{F&&me(F)},Ke=async r=>{t("Đang Cập Nhật","Vui lòng chờ...","loading");try{const a=await Re(r);if(a.status==="SUCCESS"&&a.updatedRecord)return t("Thành Công","Đã cập nhật thông tin lái thử.","success"),T(n=>n.map(m=>m.soPhieu===a.updatedRecord.soPhieu?a.updatedRecord:m)),(F==null?void 0:F.soPhieu)===a.updatedRecord.soPhieu&&E(a.updatedRecord),y(null),!0;throw new Error(a.message||"Cập nhật thất bại.")}catch(a){const n=a instanceof Error?a.message:"Lỗi không xác định.";return t("Cập Nhật Thất Bại",n,"error"),!1}},Ge=async()=>{if(!$)return!1;t("Đang Xóa",`Đang xóa phiếu ${$.soPhieu}...`,"loading");try{const r=await qe($.soPhieu);if(r.status==="SUCCESS")return t("Thành Công",r.message||"Đã xóa phiếu lái thử.","success"),T(a=>a.filter(n=>n.soPhieu!==$.soPhieu)),C(null),!0;throw new Error(r.message)}catch(r){const a=r instanceof Error?r.message:"Lỗi không xác định";return t("Xóa Thất Bại",a,"error"),C(null),!1}},Pe=(r,a)=>{if(a){y({booking:r,mode:a});return}let n="checkin";r.odoBefore&&r.odoAfter?n="view":r.odoBefore&&(n="checkout"),y({booking:r,mode:n})},ue=h.useMemo(()=>{let r=[...v];if(X.keyword){const a=X.keyword.toLowerCase();r=r.filter(n=>[n.soPhieu,n.tenKhachHang,n.dienThoai,n.tenTuVan,n.loaiXe,n.diaChi,n.email,n.loTrinh,n.dacDiem,n.gplxSo].map(j=>String(j||"").toLowerCase()).join(" ").includes(a))}if(X.dateRange.start&&X.dateRange.end){const a=I(X.dateRange.start).startOf("day"),n=I(X.dateRange.end).endOf("day");r=r.filter(m=>m.ngayThuXe?I(m.ngayThuXe).isBetween(a,n,"day","[]"):!1)}return X.car.length>0&&(r=r.filter(a=>X.car.includes(a.loaiXe))),R&&r.sort((a,n)=>{const m=a[R.key],j=n[R.key];if(m==null||m==="")return 1;if(j==null||j==="")return-1;if(R.key==="ngayThuXe"||R.key==="thoiGianKhoiHanh"){const H=I(`${a.ngayThuXe} ${a.thoiGianKhoiHanh}`),B=I(`${n.ngayThuXe} ${n.thoiGianKhoiHanh}`);return H.isBefore(B)?R.direction==="asc"?-1:1:H.isAfter(B)?R.direction==="asc"?1:-1:0}return String(m)<String(j)?R.direction==="asc"?-1:1:String(m)>String(j)?R.direction==="asc"?1:-1:0}),r},[v,X,R]),Ve=[{id:"td-filter-car",key:"car",label:"Loại Xe",options:h.useMemo(()=>[...new Set(v.map(r=>r.loaiXe))].sort(),[v]),icon:"fa-car"}];return F?e.jsxs("div",{className:"bg-surface-card p-4 rounded-xl border border-border-primary shadow-lg flex flex-col h-full overflow-hidden animate-fade-in-up",children:[e.jsxs("header",{className:"print-hidden flex-shrink-0 flex items-center justify-between border-b border-border-primary mb-4 pb-3 gap-2",children:[e.jsx("h2",{className:"text-lg font-bold text-text-primary",children:"Xem Lại Phiếu Lái Thử"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{onClick:()=>E(null),variant:"secondary",size:"sm",leftIcon:e.jsx("i",{className:"fas fa-arrow-left"}),children:"Quay Lại Danh Sách"}),e.jsx(M,{onClick:He,variant:"primary",size:"sm",leftIcon:e.jsx("i",{className:"fas fa-print"}),children:"In Lại"})]})]}),e.jsx(D,{data:F}),e.jsxs("div",{id:"print-container",className:"hidden",children:[e.jsx("div",{className:"print-page-break-after",children:e.jsx(D.PhieuLaiThu,{data:i})}),e.jsx("div",{children:e.jsx(D.GiayCamKet,{data:i})})]})]}):e.jsxs("div",{className:"bg-surface-card p-4 rounded-xl border border-border-primary shadow-lg flex flex-col h-full overflow-hidden animate-fade-in-up",children:[e.jsxs("header",{className:"print-hidden flex-shrink-0 flex flex-col md:flex-row items-start md:items-center justify-between mb-4 pb-3 gap-3 border-b border-border-primary/50",children:[e.jsxs("div",{className:"w-full md:w-auto flex items-center border border-border-primary rounded-lg bg-surface-ground p-1",children:[e.jsx(M,{onClick:()=>A("create"),variant:l==="create"?"secondary":"ghost",size:"sm",className:`flex-1 md:flex-none whitespace-nowrap ${l==="create"?"bg-white shadow-sm text-accent-primary":"text-text-secondary hover:text-text-primary"}`,leftIcon:e.jsx("i",{className:"fas fa-edit"}),children:"Tạo Phiếu Mới"}),e.jsx(M,{onClick:()=>A("history"),variant:l==="history"?"secondary":"ghost",size:"sm",className:`flex-1 md:flex-none whitespace-nowrap ${l==="history"?"bg-white shadow-sm text-accent-primary":"text-text-secondary hover:text-text-primary"}`,leftIcon:e.jsx("i",{className:"fas fa-list-alt"}),children:"Danh sách Lái thử"})]}),e.jsxs("div",{className:"w-full md:w-auto flex items-center justify-end gap-2 flex-1 ml-4",children:[l==="create"&&e.jsxs("div",{className:"hidden md:flex items-center gap-2",children:[e.jsx(M,{onClick:te,variant:"secondary",size:"md",title:"Xóa toàn bộ thông tin đã nhập",leftIcon:e.jsx("i",{className:"fas fa-eraser"}),children:"Làm Mới"}),e.jsx(M,{onClick:xe,disabled:!!K||w,isLoading:w,variant:"primary",size:"md",title:"Lưu & In văn bản",leftIcon:w?void 0:e.jsx("i",{className:"fas fa-print"}),children:"Lưu & In"})]}),l==="history"&&e.jsx("div",{className:"flex-1 w-full",children:e.jsx(Fe,{filters:X,onFilterChange:r=>z(a=>({...a,...r})),onReset:()=>z({keyword:"",dateRange:{start:"",end:""},car:[],status:[]}),dropdowns:Ve,searchPlaceholder:"Tìm SĐT, Tên KH, TVBH, Số phiếu...",totalCount:ue.length,onRefresh:()=>b(),isLoading:g,dateRangeEnabled:!0,plain:!0,size:"compact"})})]})]}),l==="create"&&e.jsxs("div",{className:"flex-grow grid grid-cols-1 lg:grid-cols-5 gap-6 overflow-hidden print-hidden",children:[e.jsx(De,{formData:u,handleInputChange:Te,handleRadioChange:Se,conflictError:K,scheduleForSelectedCar:ce,suggestions:V,onSuggestionClick:Le,onReset:te,onSave:xe,isSubmitting:w}),e.jsx(D,{data:u})]}),l==="history"&&e.jsx("div",{className:"flex-grow flex flex-col overflow-hidden print-hidden",children:g?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("i",{className:"fas fa-spinner fa-spin text-4xl text-accent-primary"})}):e.jsx(_e,{bookings:ue,onSelectBooking:E,onUpdateCheckin:Pe,onDelete:C,currentUser:x,isAdmin:o,onOpenImagePreview:c,sortConfig:R,onSort:r=>Ce(a=>({key:r,direction:(a==null?void 0:a.key)===r&&a.direction==="asc"?"desc":"asc"}))})}),e.jsxs("div",{id:"print-container",className:"hidden",children:[e.jsx("div",{className:"print-page-break-after",children:e.jsx(D.PhieuLaiThu,{data:i})}),e.jsx("div",{children:e.jsx(D.GiayCamKet,{data:i})})]}),N&&e.jsx(We,{booking:N.booking,mode:N.mode,onClose:()=>y(null),onSubmit:Ke,showToast:t,onOpenImagePreview:c,currentUser:x,isAdmin:o}),$&&e.jsx(Ae,{isOpen:!!$,onClose:()=>C(null),onSubmit:Ge,title:"Xác Nhận Xóa Phiếu Lái Thử",description:`Bạn có chắc chắn muốn xóa vĩnh viễn phiếu ${$.soPhieu} của KH: ${$.tenKhachHang}?`,targetId:$.soPhieu,submitText:"Xóa Phiếu",submitColor:"danger",icon:"fa-trash-alt"})]})},nt=Q.memo(Je);export{nt as default};
