const SPREADSHEET_ID = "1CzYUfDAcwt4D64UIZIUC77lZ2lOYQ257xlmVXy2nZG0";
const DRIVE_FOLDER_ID = "1jVRxCHz_mmevBb9nLTflGlCyO-ifRRPf";
const ADMIN_EMAIL = "showroomthuanan@gmail.com";
const NOTIFICATION_SHEET_NAME = "ThongBaoWebApp";
const DA_GHEP_SHEET_NAME = "DaGhep";
const CHUA_GHEP_SHEET_NAME = "ChuaGhep";
const DANG_KY_CHO_SHEET_NAME = "DangKyCho";
const STOCK_SHEET_NAME = "KhoXe";
const CANCELLED_SHEET_NAME = "HuyGhep";
const YEU_CAU_VC_SHEET_NAME = "YeuCauVC";
const MAIL_SHEET_NAME = "Mail";
const XUAT_HOA_DON_SHEET_NAME = "Xuathoadon";
const THONG_TIN_XE_SHEET_NAME = "Thongtinxe";
const NHOM_KINH_DOANH_SHEET_NAME = "NhomKinhDoanh";
const CHINH_SACH_SHEET_NAME = "Chinhsach";
const HOLD_DURATION_HOURS = 24
const USER_SHEET_NAME = 'Users';
const TEAM_SHEET_NAME = 'Teams';
const TEST_DRIVE_SHEET_NAME = 'TestDriveSchedule';
const DEFAULT_ROLE = 'T∆∞ v·∫•n b√°n h√†ng';
const OTP_EXPIRY_MINUTES = 5;
const TEST_DRIVE_IMAGE_FOLDER_ID = '1yblvOyGy18nyleEXg27-Bk071y2_NTtu'; 
const TELEGRAM_BOT_TOKEN = "8444242103:AAGupLJ1RJS3b3LD5LMEYIWMfwCFW3mzhB4";
const TELEGRAM_CHAT_ID = "5812034168";

const UI_CONFIG = {
  headerBgColor: "#4682b4",
  headerFontColor: "#ffffff",
  headerFont: "Roboto",
  headerFontSize: 12,
  headerFontWeight: "bold",
  rowBgColor: "#f5f7fa",
  altRowBgColor: "#e8eef7",
  borderColor: "#d3d9e6",
  textColor: "#333333",
  fontFamily: "Roboto",
  fontSize: 11,
  columnWidth: 180
};

const SHEET_HEADERS = {
  "NhatKyChinhSua": ["Th·ªùi gian", "Ng∆∞·ªùi s·ª≠a", "T√™n Sheet", "√î", "Gi√° tr·ªã c≈©", "Gi√° tr·ªã m·ªõi", "Action ID", "Tr·∫°ng th√°i Log"],
  "DaGhep": ["T√™n t∆∞ v·∫•n b√°n h√†ng", "T√™n kh√°ch h√†ng", "D√≤ng xe", "Phi√™n b·∫£n", "Ngo·∫°i th·∫•t", "N·ªôi th·∫•t", "S·ªë ƒë∆°n h√†ng", "Ng√†y c·ªçc", "Th·ªùi gian nh·∫≠p", "VIN", "Th·ªùi gian gh√©p", "S·ªë ng√†y gh√©p", "K·∫øt qu·∫£", "Tr·∫°ng th√°i g·ª≠i mail", "Ng√†y xu·∫•t h√≥a ƒë∆°n", "C·∫£nh b√°o qu√° h·∫°n", "C·∫£nh b√°o sai DMS", "LinkHoaDonDaXuat", "Tr·∫°ng th√°i VC"], // <-- TH√äM C·ªòT M·ªöI
  "YeuCauVC": ["S·ªë ƒë∆°n h√†ng", "T√™n kh√°ch h√†ng", "Th·ªùi gian YC", "Ng∆∞·ªùi YC", "Lo·∫°i YC", "Tr·∫°ng th√°i x·ª≠ l√Ω", "Ghi ch√∫", "FileUrls", "M√£ KH DMS", "VIN"],
  "ChuaGhep": ["T√™n t∆∞ v·∫•n b√°n h√†ng", "T√™n kh√°ch h√†ng", "D√≤ng xe", "Phi√™n b·∫£n", "Ngo·∫°i th·∫•t", "N·ªôi th·∫•t", "S·ªë ƒë∆°n h√†ng", "Ng√†y c·ªçc", "Th·ªùi gian nh·∫≠p", "K·∫øt qu·∫£", "Tr·∫°ng th√°i g·ª≠i mail"],
  "DangKyCho": ["ID Y√™u C·∫ßu", "Th·ªùi gian ƒëƒÉng k√Ω", "T√™n TVBH", "T√™n kh√°ch h√†ng", "D√≤ng xe", "Phi√™n b·∫£n", "Ngo·∫°i th·∫•t", "N·ªôi th·∫•t", "Tr·∫°ng th√°i", "VIN g·ª£i √Ω", "Ghi ch√∫"],
  "KhoXe": ["D√≤ng xe", "Phi√™n b·∫£n", "Ngo·∫°i th·∫•t", "N·ªôi th·∫•t", "VIN", "M√£ DMS", "Tr·∫°ng th√°i", "Ng√†y nh·∫≠p", "ƒê√£ th√¥ng b√°o", "Ng∆∞·ªùi Gi·ªØ Xe", "Th·ªùi Gian H·∫øt H·∫°n Gi·ªØ"],
  "HuyGhep": ["T√™n t∆∞ v·∫•n b√°n h√†ng", "T√™n kh√°ch h√†ng", "D√≤ng xe", "Phi√™n b·∫£n", "S·ªë ƒë∆°n h√†ng", "VIN", "K·∫øt qu·∫£", "Ng∆∞·ªùi h·ªßy", "Th·ªùi gian h·ªßy"],
  "Mail": ["T√™n t∆∞ v·∫•n b√°n h√†ng", "Email"],
  "ThongBaoWebApp": ["Timestamp", "Message", "Type", "TargetView", "TargetID", "CreatedBy", "IsRead", "Recipient"],
  "lichsu_donhang": ["Th·ªùi gian", "S·ªë ƒë∆°n h√†ng", "VIN", "H√†nh ƒë·ªông", "Chi ti·∫øt", "Ng∆∞·ªùi th·ª±c hi·ªán", "D·ªØ li·ªáu JSON"],
  "lichsu_xe": ["Th·ªùi gian", "VIN", "H√†nh ƒë·ªông", "Chi ti·∫øt", "Ng∆∞·ªùi th·ª±c hi·ªán", "D·ªØ li·ªáu JSON"],
  "log": ["Th·ªùi gian", "H√†nh ƒë·ªông", "Chi ti·∫øt"],
  "Xuathoadon": ["S·ªê TT", "T√äN KH√ÅCH H√ÄNG", "S·ªê ƒê∆†N H√ÄNG", "D√íNG XE", "PHI√äN B·∫¢N", "NGO·∫†I TH·∫§T", "N·ªòI TH·∫§T", "T∆Ø V·∫§N B√ÅN H√ÄNG", "S·ªê VIN", "S·ªê ƒê·ªòNG C∆†", "NG√ÄY Y√äU C·∫¶U XHƒê", "NG√ÄY XU·∫§T H√ìA ƒê∆†N", "Hoa h·ªìng ·ª©ng", "ƒêi·ªÉm Vpoint s·ª≠ d·ª•ng", "CH√çNH S√ÅCH", "NG√ÄY C·ªåC", "K·∫æT QU·∫¢ G·ª¨I MAIL", "URL H·ª£p ƒê·ªìng", "URL ƒê·ªÅ Ngh·ªã XHƒê", "URL H√≥a ƒê∆°n ƒê√£ Xu·∫•t"],
  "Thongtinxe": ["S·ªë VIN", "S·ªë t·ªìn kho", "S·ªë tham chi·∫øu", "M√£ s·∫£n ph·∫©m", "Phi√™n b·∫£n", "Khu v·ª±c", "M√†u ngo·∫°i th·∫•t xe", "M√†u n·ªôi th·∫•t xe", "S·ªë ƒë·ªông c∆°", "M√¥ t·∫£ s·∫£n ph·∫©m", "S·ªë ƒë∆°n h√†ng cu·ªëi c√πng", "NƒÉm s·∫£n xu·∫•t"],
  "removed_cars_log": ["Th·ªùi gian x√≥a", "Ng∆∞·ªùi x√≥a", "D√≤ng xe", "Phi√™n b·∫£n", "Ngo·∫°i th·∫•t", "N·ªôi th·∫•t", "VIN", "M√£ DMS (c≈©)", "Tr·∫°ng th√°i (c≈©)", "Ng√†y nh·∫≠p (c≈©)", "ƒê√£ th√¥ng b√°o (c≈©)", "L√Ω do x√≥a"],
  "Chinhsach": ["T√™n Ch√≠nh S√°ch", "Tr·∫°ng th√°i"]
};


const VALID_EXTERIOR_COLORS = [
  "Brahminy White (CE18)",
  "Sunset ORB (CE1A)",
  "Crimson Red (CE1M)",
  "Vinfast Blue (CE1N)",
  "Neptune Grey (CE14)",
  "Jet Black (CE11)",
  "Electric Blue (CE1J)",
  "Zenith Grey (CE1V)",
  "Jet Black Roof- Summer Yellow Body (111U)",
  "Brahminy White Roof- Aquatic Azure Body (181Y)",
  "Brahminy White Roof- Rose Pink Body (1821)",
  "Brahminy White Roof - Iris Berry Body (181X)",
  "Urbant Mint (CE1W)",
  "Vinbus Green (CE2B)",
  "Deep Ocean (CE1H)",
  "Brahminy White Roof- Summer Yellow Body (181U)", // Tr√πng l·∫∑p trong danh s√°ch cung c·∫•p, gi·ªØ l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh ch√≠nh x√°c
  "Iris Berry (CE1X)",
  "Zenith Grey-Desat Silver Roof (171V)",
  "Urbant Mint Green - Desat Silv (171W)",
  "Ivy Green-Desat Silver Roof (1722)",
  "Atlantic Blue-Aquatic Azure Ro (1Y26)",
  "Jet Black-Champagne Creme Roof (2311)",
  "Infinity Blanc _ Silky White R (2418)",
  "Champagne Creme - Matte Champa (2523)",
  "Jet Black - Graphite Roof (2811)",
  "Crimson Velvet - Mystery Bronz (2927)",
  "Ivy_Green_GNE (CE22)",
  "Champagne_Creme_YLG (CE23)",
  "Crimson Red - Jet Black Roof (111M)",
  "Infinity Blanc_Zenith Grey Roof (1V18)",
  "Deep Ocean_Jet Black Roof (111H)",
  "Alantic Blue_Denim Blue Roof (2A26)",
  "Jet Black_Mystery Bronze Roof (2911)",
  "Champagne Creme_Infinity Blanc Roof (1823)",
  "De Sat Silver IND12007 (CE17)"
];
/**
 * T·ªîNG H·ª¢P: Thi·∫øt l·∫≠p t·∫•t-c·∫£-trong-m·ªôt cho to√†n b·ªô c√°c trang t√≠nh.
 * H√†m n√†y s·∫Ω t·∫°o c√°c sheet ng∆∞·ªùi d√πng, l√°i th·ª≠ v√† t·∫•t c·∫£ c√°c sheet nghi·ªáp v·ª•.
 */
function setupAllSheets() {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    // const ui = SpreadsheetApp.getUi(); // REMOVE: Cannot call getUi in some contexts
    let createdCount = 0;
    let existingCount = 0;

    // Danh s√°ch t·∫•t c·∫£ c√°c sheet c·∫ßn thi·∫øt t·ª´ c√°c h√†m kh√°c nhau
    const requiredSheets = [
        // T·ª´ setupSheets()
        {
            name: USER_SHEET_NAME,
            headers: ['Username', 'PasswordHash', 'FullName', 'Role', 'Email', 'OTP', 'OTPExpiry']
        },
        {
            name: TEAM_SHEET_NAME,
            headers: ['Leader', 'Members']
        },
        // T·ª´ setupTestDriveSheet()
        {
            name: TEST_DRIVE_SHEET_NAME,
            headers: [
                'soPhieu', 'ngayThuXe', 'loaiXe', 'thoiGianKhoiHanh', 'thoiGianTroVe', 'loTrinh',
                'tenKhachHang', 'dienThoai', 'email', 'diaChi', 'tuLai', 'dacDiem',
                'gplxSo', 'hieuLucGPLX', 'ngayCamKet', 'tenTuVan',
                'odoBefore', 'imagesBefore', 'odoAfter', 'imagesAfter'
            ]
        },
        { // <-- TH√äM KH·ªêI M·ªöI N√ÄY
            name: CHINH_SACH_SHEET_NAME,
            headers: SHEET_HEADERS["Chinhsach"]
        }
    ];

    // Th√™m t·∫•t c·∫£ c√°c sheet t·ª´ SHEET_HEADERS (logic c·ªßa setupInitialSheet)
    for (const sheetName in SHEET_HEADERS) {
        if (Object.hasOwnProperty.call(SHEET_HEADERS, sheetName)) {
            // Ki·ªÉm tra ƒë·ªÉ kh√¥ng th√™m tr√πng l·∫∑p n·∫øu ƒë√£ c√≥ trong requiredSheets
            if (!requiredSheets.some(s => s.name === sheetName)) {
                requiredSheets.push({
                    name: sheetName,
                    headers: SHEET_HEADERS[sheetName]
                });
            }
        }
    }


    // V√≤ng l·∫∑p ƒë·ªÉ t·∫°o ho·∫∑c x√°c nh·∫≠n t·∫•t c·∫£ c√°c sheet
    requiredSheets.forEach(sheetInfo => {
        if (!sheetInfo.name || !Array.isArray(sheetInfo.headers)) return; // B·ªè qua n·∫øu c·∫•u h√¨nh kh√¥ng h·ª£p l·ªá

        const existingSheet = ss.getSheetByName(sheetInfo.name);
        if (!existingSheet) {
            // S·ª≠ d·ª•ng l·∫°i h√†m getOrCreateSheet ƒë·ªÉ t·∫°o v√† ƒë·ªãnh d·∫°ng sheet m·ªõi
            getOrCreateSheet(ss, sheetInfo.name, sheetInfo.headers);
            Logger.log(`ƒê√£ t·∫°o trang t√≠nh: ${sheetInfo.name}`);
            createdCount++;
        } else {
            // SHEET ƒê√É T·ªíN T·∫†I -> KI·ªÇM TRA V√Ä C·∫¨P NH·∫¨T HEADER N·∫æU THI·∫æU
            updateSheetHeaders(existingSheet, sheetInfo.headers);
            Logger.log(`Trang t√≠nh "${sheetInfo.name}" ƒë√£ t·ªìn t·∫°i v√† ƒë∆∞·ª£c ki·ªÉm tra c·∫≠p nh·∫≠t.`);
            existingCount++;
        }
    });

    // Hi·ªÉn th·ªã th√¥ng b√°o t·ªïng k·∫øt b·∫±ng Logger thay v√¨ UI Alert ƒë·ªÉ tr√°nh l·ªói context
    Logger.log('Ho√†n T·∫•t Thi·∫øt L·∫≠p To√†n B·ªô!');
    Logger.log(`ƒê√£ t·∫°o ${createdCount} trang t√≠nh m·ªõi.`);
    Logger.log(`${existingCount} trang t√≠nh ƒë√£ t·ªìn t·∫°i t·ª´ tr∆∞·ªõc.`);
    Logger.log("B√¢y gi·ªù b·∫°n c√≥ th·ªÉ ch·∫°y h√†m 'setupInitialAdminUser' ƒë·ªÉ t·∫°o t√†i kho·∫£n qu·∫£n tr·ªã ban ƒë·∫ßu.");
}

/**
 * H√†m h·ªó tr·ª£: C·∫≠p nh·∫≠t header cho sheet ƒë√£ t·ªìn t·∫°i.
 * Ch·ªâ th√™m c√°c c·ªôt m·ªõi ch∆∞a c√≥, KH√îNG x√≥a c·ªôt c≈© ƒë·ªÉ b·∫£o to√†n d·ªØ li·ªáu.
 */
function updateSheetHeaders(sheet, expectedHeaders) {
    if (!sheet || !expectedHeaders || expectedHeaders.length === 0) return;

    const lastCol = sheet.getLastColumn();
    if (lastCol === 0) {
        // Sheet tr·ªëng, set lu√¥n header
         sheet.getRange(1, 1, 1, expectedHeaders.length).setValues([expectedHeaders]);
         return;
    }

    const currentHeaders = sheet.getRange(1, 1, 1, lastCol).getValues()[0].map(h => String(h).trim());
    
    // T√¨m c√°c header c√≤n thi·∫øu
    const missingHeaders = expectedHeaders.filter(h => !currentHeaders.includes(h));

    if (missingHeaders.length > 0) {
        // Th√™m c√°c c·ªôt thi·∫øu v√†o sau c·ªôt cu·ªëi c√πng
        const startCol = lastCol + 1;
        sheet.getRange(1, startCol, 1, missingHeaders.length).setValues([missingHeaders]);
        
        // Copy ƒë·ªãnh d·∫°ng header t·ª´ c·ªôt ƒë·∫ßu ti√™n (n·∫øu c√≥) cho ƒë·∫πp
        try {
            const headerStyleRange = sheet.getRange(1, 1);
            const newHeaderRange = sheet.getRange(1, startCol, 1, missingHeaders.length);
            headerStyleRange.copyTo(newHeaderRange, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);
            Logger.log(`ƒê√£ th√™m ${missingHeaders.length} c·ªôt m·ªõi v√†o sheet "${sheet.getName()}": ${missingHeaders.join(', ')}`);
        } catch (e) {
            Logger.log("L·ªói copy ƒë·ªãnh d·∫°ng header: " + e.message);
        }
    }
}
function isValidExteriorColor(color) {
  if (!color || typeof color !== 'string') {
    return false;
  }
  const trimmedColor = color.trim().toLowerCase();
  return VALID_EXTERIOR_COLORS.some(validColor => validColor.trim().toLowerCase() === trimmedColor);
}
function doReadWriteLock(callback, timeout = 30000) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(timeout);
    const result = callback();
    return result;
  } catch (e) {
    Logger.log('Could not obtain lock after %s seconds: %s', timeout / 1000, e.message);
    throw new Error('H·ªá th·ªëng ƒëang b·∫≠n, vui l√≤ng th·ª≠ l·∫°i sau gi√¢y l√°t. (L·ªói kh√≥a d·ªØ li·ªáu)');
  } finally {
    lock.releaseLock();
  }
}

function doPost(e) {
  const lock = LockService.getScriptLock();
  // C·ªë g·∫Øng kh√≥a trong 30 gi√¢y
  if (!lock.tryLock(30000)) {
    return createJsonResponse({ status: "ERROR", message: "H·ªá th·ªëng ƒëang x·ª≠ l√Ω y√™u c·∫ßu kh√°c. Vui l√≤ng th·ª≠ l·∫°i sau gi√¢y l√°t." });
  }

  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheets = getSheets(ss);
    
    // L·∫•y userSheet m·ªôt l·∫ßn ·ªü ƒë√¢y
    const userSheet = ss.getSheetByName(USER_SHEET_NAME); 
    
    const action = e.parameter.action;
    
    // X√°c ƒë·ªãnh ng∆∞·ªùi d√πng th·ª±c hi·ªán h√†nh ƒë·ªông
    const user = e.parameter.updatedBy || 
                 e.parameter.cancelledBy || 
                 e.parameter.requestedBy || 
                 e.parameter.uploadedBy || 
                 e.parameter.ten_ban_hang || 
                 e.parameter.username || // Th√™m t·ª´ h√†m th·ª© 2
                 'Admin';

    let response;
    let message = "";
    Logger.log(`doPost action received: ${action} by ${user} with params: ${JSON.stringify(e.parameter)}`);

    switch (action) {
      // =================================================================
      // === C√ÅC CASE T·ª™ H√ÄM S·ªê 1 (LOGIC NGHI·ªÜP V·ª§ CH√çNH) ===
      // =================================================================
      case 'performOcr':
        response = handlePerformOcr(e);
        return response; // handlePerformOcr tr·∫£ v·ªÅ response ho√†n ch·ªânh
      case 'findAndAddCarByVin':
        message = findAndAddCarByVin(e.parameter.vin);
        response = createJsonResponse({ status: message.startsWith("L·ªói:") ? "ERROR" : "SUCCESS", message: message });
        break;
      case 'recordUserPresence':
        recordUserPresence(e.parameter.userEmail);
        response = createJsonResponse({ status: "SUCCESS" });
        break;
      case 'markNotificationAsRead':
        response = doReadWriteLock(() => handleMarkNotificationAsRead(e));
        break;
      case 'addDepositInfo':
        response = doReadWriteLock(() => handleAddDepositInfo(e));
        break;
      case 'requestVinClub':
        // THAY ƒê·ªîI: Th√™m sheets.mailSheet v√†o l·ªùi g·ªçi h√†m
        response = doReadWriteLock(() => handleRequestVinClub(e, sheets.mailSheet));
        break;
      case 'approveVcRequest':
        response = doReadWriteLock(() => handleVcRequestApproval(e.parameter.orderNumber, true, e.parameter.adminUser));
        break;
      case 'rejectVcRequest':
        response = doReadWriteLock(() => handleVcRequestApproval(e.parameter.orderNumber, false, e.parameter.adminUser, e.parameter.reason));
        break;
      case 'confirmVcUnc': // Frontend g·ªçi l√† 'confirmVc' nh∆∞ng th·ª±c thi 'confirmVcUnc'
        response = doReadWriteLock(() => handleConfirmVcUnc(e));
        break;
      case 'deleteWaitingRequest':
        response = doReadWriteLock(() => handleDeleteWaitingRequest(e));
        break;
      case 'confirmVinClubVerification':
        response = doReadWriteLock(() => handleConfirmVinClubVerification(e));
        break;
      case 'addBatchDeposits':
        response = doReadWriteLock(() => handleAddBatchDeposits(e));
        break;
      case 'addWaitingRequest':
        response = doReadWriteLock(() => handleAddWaitingRequest(e));
        break;
      case 'updateWaitingRequestNote':
        response = doReadWriteLock(() => handleUpdateWaitingRequestNote(e));
        break;
      case 'addCarFromOcr':
        message = addCarToStockFromOcr(e.parameter);
        response = createJsonResponse({ status: message.startsWith("L·ªói:") ? "ERROR" : "SUCCESS", message: message });
        break;
      case 'resendEmail':
        const resendResult = resendNotificationEmail(e.parameter.orderNumber, e.parameter.emailType, user);
        response = createJsonResponse({
          status: resendResult.success ? "SUCCESS" : "ERROR",
          message: resendResult.message
        });
        break;
      case 'revertOrderStatus':
        try {
          const result = revertOrderStatusByOrderNumber(e.parameter.orderNumber, user);
          response = createJsonResponse({ status: "SUCCESS", message: result.message });
        } catch (err) {
          response = createJsonResponse({ status: "ERROR", message: err.message });
        }
        break;
      case 'holdCar':
        try {
          const result = doReadWriteLock(() => holdCar(e.parameter.vin, user));
          response = createJsonResponse(result);
        } catch (err) {
          response = createJsonResponse({ status: "ERROR", message: err.message });
        }
        break;
      case 'releaseCar':
        try {
          const result = doReadWriteLock(() => releaseCar(e.parameter.vin, user));
          response = createJsonResponse(result);
        } catch (err) {
          response = createJsonResponse({ status: "ERROR", message: err.message });
        }
        break;

      // --- KHU V·ª∞C C·∫¨P NH·∫¨T (t·ª´ h√†m 1) ---
      case 'markAsPendingSignature':
        try {
            const actionId = e.parameter.actionId;
            if (e.parameter.orderNumbers) {
                const orderNumbers = JSON.parse(e.parameter.orderNumbers);
                let successCount = 0;
                let errorCount = 0;
                let errorMessages = [];
                orderNumbers.forEach(orderNumber => {
                    try {
                        const result = handleMarkAsPendingSignature(orderNumber, user, `${actionId}-${orderNumber}`);
                        if(result.success && result.tvbhName) {
                            addNotification(`Admin ƒë√£ chuy·ªÉn ƒêH ${orderNumber} sang "Ch·ªù k√Ω h√≥a ƒë∆°n".`, 'info', 'xuatHoaDon', orderNumber, user, result.tvbhName);
                        }
                        successCount++;
                      } catch (err) {
                        errorCount++;
                        errorMessages.push(`ƒêH ${orderNumber}: ${err.message}`);
                      }
                });
                let summaryMessage = `Ho√†n t·∫•t. Chuy·ªÉn tr·∫°ng th√°i th√†nh c√¥ng: ${successCount}. Th·∫•t b·∫°i: ${errorCount}.`;
                if(errorCount > 0) {
                    summaryMessage += `\nChi ti·∫øt l·ªói:\n` + errorMessages.join('\n');
                }
                response = createJsonResponse({ status: "SUCCESS", message: summaryMessage });
            } else {
                const result = handleMarkAsPendingSignature(e.parameter.orderNumber, user, actionId);
                if(result.success && result.tvbhName) {
                    addNotification(`Admin ƒë√£ chuy·ªÉn ƒêH ${e.parameter.orderNumber} sang "Ch·ªù k√Ω h√≥a ƒë∆°n".`, 'info', 'xuatHoaDon', e.parameter.orderNumber, user, result.tvbhName);
                }
                response = createJsonResponse({ status: "SUCCESS", message: result.message });
            }
        } catch (err) {
            response = createJsonResponse({ status: "ERROR", message: err.message });
        }
        break;
      case 'approveSelectedInvoiceRequest':
        if (e.parameter.orderNumbers) {
            const orderNumbers = JSON.parse(e.parameter.orderNumbers);
            let successCount = 0;
            let errorCount = 0;
            
            orderNumbers.forEach(orderNumber => {
                const resultJson = handleApproveRequestFromWebApp(orderNumber, `${e.parameter.actionId}-${orderNumber}`);
                const result = JSON.parse(resultJson.getContent());
                if (result.status === "SUCCESS") {
                    successCount++;
                  } else {
                    errorCount++;
                }
            });
            const message = `Ph√™ duy·ªát h√†ng lo·∫°t ho√†n t·∫•t. Th√†nh c√¥ng: ${successCount}, Th·∫•t b·∫°i: ${errorCount}.`;
            response = createJsonResponse({ status: "SUCCESS", message: message });
        } else {
            response = handleApproveRequestFromWebApp(e.parameter.orderNumber, e.parameter.actionId);
        }
        break;
      case 'requestSupplementForInvoice':
        if (e.parameter.orderNumbers) {
            const orderNumbers = JSON.parse(e.parameter.orderNumbers);
            const reason = e.parameter.reason;
            const imagesBase64Json = e.parameter.pastedImagesBase64 || null;

            let successCount = 0;
            let errorCount = 0;
            orderNumbers.forEach(orderNumber => {
                const resultJson = handleRequestSupplementFromWebApp(orderNumber, reason, sheets, imagesBase64Json, `${e.parameter.actionId}-${orderNumber}`);
                const result = JSON.parse(resultJson.getContent());
                if (result.status === "SUCCESS") {
                    successCount++;
                  } else {
                    errorCount++;
                }
            });
            const message = `Y/C b·ªï sung h√†ng lo·∫°t ho√†n t·∫•t. Th√†nh c√¥ng: ${successCount}, Th·∫•t b·∫°i: ${errorCount}.`;
            response = createJsonResponse({ status: "SUCCESS", message: message });
        } else {
            const imagesBase64Json = e.parameter.pastedImagesBase64 || null;
            response = handleRequestSupplementFromWebApp(e.parameter.orderNumber, e.parameter.reason, sheets, imagesBase64Json, e.parameter.actionId);
        }
        break;
      // --- K·∫æT TH√öC KHU V·ª∞C C·∫¨P NH·∫¨T ---
      
      case 'cancelRequest':
        if (e.parameter.orderNumbers) {
            const orderNumbers = JSON.parse(e.parameter.orderNumbers);
            const reason = e.parameter.reason;
            let successCount = 0;
            let errorCount = 0;
            orderNumbers.forEach(orderNumber => {
                const e_simulated = {
                    parameter: {
                        orderNumber: orderNumber,
                        reason: reason,
                        cancelledBy: user
                    }
                };
                const cancelResult = handleCancelRequest(e_simulated, sheets);
                if (cancelResult.success) 
                {
                    successCount++;
                    sendCancelEmail(sheets.mailSheet, cancelResult.emailData, cancelResult.vin, new Date(), user, cancelResult.reason);
                    const tvbhName = cancelResult.emailData.ten_ban_hang;
                    addNotification(`ƒê∆°n h√†ng ${cancelResult.orderNumber} ƒë√£ b·ªã h·ªßy b·ªüi ${user}.`, 'danger', 'huyGhep', cancelResult.orderNumber, user, tvbhName);
                  } else {
                    errorCount++;
                }
            });
            const message = `H·ªßy h√†ng lo·∫°t ho√†n t·∫•t. Th√†nh c√¥ng: ${successCount}, Th·∫•t b·∫°i: ${errorCount}.`;
            response = createJsonResponse({ status: "SUCCESS", message: message });
        } else {
            const cancelResult = handleCancelRequest(e, sheets);
            if (cancelResult.success) {
              sendCancelEmail(sheets.mailSheet, cancelResult.emailData, cancelResult.vin, new Date(), user, cancelResult.reason);
              const tvbhName = cancelResult.emailData.ten_ban_hang;
              addNotification(`ƒê∆°n h√†ng ${cancelResult.orderNumber} ƒë√£ b·ªã h·ªßy b·ªüi ${user}.`, 'danger', 'huyGhep', cancelResult.orderNumber, user, tvbhName);
              response = createJsonResponse({ status: "SUCCESS", message: cancelResult.message });
            } else {
              response = createJsonResponse({ status: "ERROR", message: cancelResult.message });
            }
        }
        break;
      case 'manualMatchCar':
        message = manualMatchCar(e.parameter.orderNumber, e.parameter.vin);
        if (typeof message === 'object' && message.status === 'ERROR') {
          response = createJsonResponse(message);
        } else {
          const orderDetails = findRowByKeyValue(sheets.daGhepSheet, "S·ªë ƒë∆°n h√†ng", e.parameter.orderNumber);
          const tvbhName = orderDetails ? orderDetails["T√™n t∆∞ v·∫•n b√°n h√†ng"] : null;
          addNotification(`ƒê∆°n h√†ng ${e.parameter.orderNumber} ƒë√£ ƒë∆∞·ª£c gh√©p th·ªß c√¥ng v·ªõi xe ${e.parameter.vin} b·ªüi ${user}.`, 'success', 'daGhep', e.parameter.orderNumber, user, tvbhName);
          response = createJsonResponse({ status: "SUCCESS", message: message });
        }
        break;
      case 'importCarsFromExcel':
        const importResult = doReadWriteLock(() => {
          return importCarsFromExcelLogic(e.parameter.carData, e.parameter.importedBy);
        });
        response = createJsonResponse(importResult);
        break;
      case 'unmatchOrder':
        const unmatchResult = unmatchOrder(e.parameter.orderNumber, e.parameter.reason, user);
        if (unmatchResult.success) {
          sendUnmatchNotificationEmail(sheets.mailSheet, unmatchResult.emailData, unmatchResult.vin, unmatchResult.reason, user);
          const tvbhName = unmatchResult.emailData.ten_ban_hang;
          addNotification(`ƒê∆°n h√†ng ${e.parameter.orderNumber} ƒë√£ ƒë∆∞·ª£c h·ªßy gh√©p v√† chuy·ªÉn v·ªÅ h√†ng ch·ªù b·ªüi ${user}.`, 'warning', 'chuaGhep', e.parameter.orderNumber, user, tvbhName);
          response = createJsonResponse({ status: "SUCCESS", message: unmatchResult.message });
        } else {
          response = createJsonResponse({ status: "ERROR", message: unmatchResult.message });
        }
        break;
      case 'deleteOrderLogic':
        message = deleteOrderLogic(e.parameter.orderNumber, user);
        if (!message.startsWith("Kh√¥ng t√¨m th·∫•y")) addNotification(`ƒê∆°n h√†ng ${e.parameter.orderNumber} ƒë√£ b·ªã x√≥a vƒ©nh vi·ªÖn b·ªüi ${user}.`, 'danger', 'huyGhep', e.parameter.orderNumber, user);
        response = createJsonResponse({ status: message.startsWith("Kh√¥ng t√¨m th·∫•y") ? "ERROR" : "SUCCESS", message: message });
        break;
      case 'deleteCarFromStockLogic':
        message = deleteCarFromStockLogic(e.parameter.vinToDelete, e.parameter.reason); 
        response = createJsonResponse({ status: message.startsWith("L·ªói:") ? "ERROR" : "SUCCESS", message: message });
        if (!message.startsWith("L·ªói:")) {
          addNotification(`Xe VIN ${e.parameter.vinToDelete} ƒë√£ b·ªã x√≥a kh·ªèi kho b·ªüi ${user}.`, 'danger', 'khoXe', e.parameter.vinToDelete, user);
        }
        break;
      case 'restoreCarToStockLogic':
        message = restoreCarToStockLogic(e.parameter.vinToRestore);
        response = createJsonResponse({ status: message.startsWith("L·ªói:") ? "ERROR" : "SUCCESS", message: message });
        if (!message.startsWith("L·ªói:")) {
          addNotification(`Xe VIN ${e.parameter.vinToRestore} ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi v√†o kho b·ªüi ${user}.`, 'success', 'khoXe', e.parameter.vinToRestore, user);
        }
        break;
      case 'updateRowData':
        try {
          const updateResult = handleUpdateRowData(e.parameter, user);
          response = createJsonResponse({ status: "SUCCESS", message: updateResult.message });
        } catch (err) {
          response = createJsonResponse({ status: "ERROR", message: err.message });
        }
        break;
      case 'updateOrderDetails':
        try {
          // Ch√∫ng ta s·∫Ω t·∫°o h√†m handleUpdateOrderDetails ·ªü b∆∞·ªõc 2
          const result = doReadWriteLock(() => handleUpdateOrderDetails(e, sheets, user));
          response = createJsonResponse(result);
        } catch (err) {
          response = createJsonResponse({ status: "ERROR", message: err.message });
        }
        break;
      case 'requestInvoice':
        response = handleRequestInvoice(e, sheets.daGhepSheet, sheets.mailSheet, sheets.xuathoadonSheet, sheets.thongtinxeSheet, sheets.stockSheet);
        break;
      case 'updateInvoiceFiles':
        response = handleUpdateInvoiceFiles(e);
        if (response && JSON.parse(response.getContent()).status === "SUCCESS") {
          const orderNumber = e.parameter.orderNumber;
          const tvbhName = user;
          const adminMessage = `B·∫°n v·ª´a b·ªï sung h·ªì s∆° cho ƒêH ${orderNumber}.`;
          addNotification(adminMessage, 'info', 'xuatHoaDon', orderNumber, tvbhName, tvbhName);
        }
        break;
      case 'addRequest':
        response = handleAddRequest(e, sheets.chuaGhepSheet, sheets.daGhepSheet, sheets.stockSheet, sheets.mailSheet);
        if (response && JSON.parse(response.getContent()).status === "SUCCESS") {
          const result = JSON.parse(response.getContent());
          const newRecord = result.newRecord || {};
          const orderNum = newRecord["S·ªë ƒë∆°n h√†ng"] || "kh√¥ng r√µ";
          const targetView = newRecord["K·∫øt qu·∫£"] === "ƒê√£ gh√©p" ? "daGhep" : "chuaGhep";
          const messageText = newRecord["K·∫øt qu·∫£"] === "ƒê√£ gh√©p"
            ?
            `B·∫°n ƒë√£ t·∫°o YC v√† ƒë√£ gh√©p th√†nh c√¥ng cho ƒêH ${orderNum}.`
            : `B·∫°n ƒë√£ t·∫°o YC v√† ƒëang ch·ªù gh√©p cho ƒêH ${orderNum}.`;
          const messageType = newRecord["K·∫øt qu·∫£"] === "ƒê√£ gh√©p" ? "success" : "info";
          addNotification(messageText, messageType, targetView, orderNum, user, user);
        }
        break;
      case 'addBulkRequests':
        response = handleAddBulkRequests(e, sheets.chuaGhepSheet, sheets.daGhepSheet, sheets.stockSheet, sheets.mailSheet);
        if (response && JSON.parse(response.getContent()).status === "SUCCESS") {
          const result = JSON.parse(response.getContent());
          addNotification(result.message, 'info', 'chuaGhep', null, user, user);
        }
        break;
      case 'handleBulkUploadIssuedInvoices':
        response = doReadWriteLock(() => handleBulkUploadIssuedInvoices(e));
        break;
      case 'uploadIssuedInvoice':
        response = handleUploadIssuedInvoice(e);
        break;
      case 'markAllNotificationsAsRead':
        response = markAllNotificationsAsRead(e);
        break;
      case 'getAiSuggestion':
        try {
          const { orderData, customPrompt } = e.parameter;
          if (!orderData || !customPrompt) {
            throw new Error("D·ªØ li·ªáu ƒë∆°n h√†ng ho·∫∑c y√™u c·∫ßu t·ª± do kh√¥ng ƒë∆∞·ª£c cung c·∫•p.");
          }
          const order = JSON.parse(orderData);
          const finalPrompt = `
            B·ªëi c·∫£nh: B·∫°n l√† m·ªôt tr·ª£ l√Ω ·∫£o cho m·ªôt showroom √¥ t√¥ VinFast.
            Nhi·ªám v·ª•: D·ª±a v√†o d·ªØ li·ªáu ƒë∆°n h√†ng d∆∞·ªõi ƒë√¢y v√† y√™u c·∫ßu t·ª´ ng∆∞·ªùi d√πng, h√£y ƒë∆∞a ra m·ªôt c√¢u tr·∫£ l·ªùi chuy√™n nghi·ªáp, chi ti·∫øt v√† ph√π h·ª£p.
            D·ªØ li·ªáu ƒë∆°n h√†ng (ƒë·ªãnh d·∫°ng JSON):
            ${JSON.stringify(order, null, 2)}
            Y√™u c·∫ßu t·ª´ ng∆∞·ªùi d√πng:
            "${customPrompt}"
            C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:
          `;
          const suggestion = callGeminiAPI(finalPrompt);
          response = createJsonResponse({ status: "SUCCESS", suggestion: suggestion });
        } catch (err) {
          response = createJsonResponse({ status: "ERROR", message: err.message });
        }
        break;
      case 'getGlobalAiResponse':
        try {
          const userPrompt = e.parameter.userPrompt;
          const pageContext = e.parameter.pageContext; 
          if (!userPrompt) {
            throw new Error("Kh√¥ng c√≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c cung c·∫•p.");
          }
          const finalPrompt = `
            B·ªêI C·∫¢NH: B·∫°n l√† m·ªôt tr·ª£ l√Ω ·∫£o th√¥ng minh v√† h·ªØu √≠ch cho nh√¢n vi√™n c·ªßa showroom VinFast Thu·∫≠n An.
            NHI·ªÜM V·ª§: D·ª±a v√†o N·ªòI DUNG C·ª¶A TRANG WEB ƒë∆∞·ª£c cung c·∫•p d∆∞·ªõi ƒë√¢y, h√£y tr·∫£ l·ªùi c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng m·ªôt c√°ch ch√≠nh x√°c, ng·∫Øn g·ªçn v√† th√¢n thi·ªán.
            Kh√¥ng t·ª± b·ªãa ra th√¥ng tin kh√¥ng c√≥ trong vƒÉn b·∫£n.
            --- N·ªòI DUNG C·ª¶A TRANG WEB ---
            ${pageContext || "Kh√¥ng c√≥ ng·ªØ c·∫£nh trang web."}
            --- H·∫æT N·ªòI DUNG ---

            C√ÇU H·ªéI C·ª¶A NG∆Ø·ªúI D√ôNG:
            "${userPrompt}"

            C√ÇU TR·∫¢ L·ªúI C·ª¶A B·∫†N:
          `;
          const suggestion = callGeminiAPI(finalPrompt);
          // H√†m n√†y tr·∫£ v·ªÅ text thu·∫ßn, kh√¥ng ph·∫£i JSON
          response = ContentService.createTextOutput(suggestion);
        } catch (err) {
          // H√†m n√†y tr·∫£ v·ªÅ text thu·∫ßn, kh√¥ng ph·∫£i JSON
          response = ContentService.createTextOutput(`Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra: ${err.message}`);
        }
        break;
      case 'revertLastAction':
        try {
          const result = revertLastActionById(e.parameter.actionId, user);
          response = createJsonResponse({ status: "SUCCESS", message: result.message });
        } catch (err) {
          response = createJsonResponse({ status: "ERROR", message: err.message });
        }
        break;

      // =================================================================
      // === C√ÅC CASE ƒê∆Ø·ª¢C GH√âP T·ª™ H√ÄM S·ªê 2 (AUTH, L√ÅI TH·ª¨) ===
      // =================================================================
      // L∆∞u √Ω: Ch√∫ng ta d√πng createJsonResponse ƒë·ªÉ g√≥i k·∫øt qu·∫£ tr·∫£ v·ªÅ
      // t·ª´ c√°c h√†m handler n√†y, ƒë·ªÉ ph√π h·ª£p v·ªõi logic c·ªßa h√†m 1.
      case 'login':
        response = createJsonResponse(handleLogin(e.parameter, userSheet));
        break;
      case 'addUser':
        response = createJsonResponse(handleAddNewUserAndSendMail(e.parameter, userSheet)); 
        break;
      case 'changePassword':
        response = createJsonResponse(handleChangePassword(e.parameter, userSheet));
        break;
      case 'forgotPassword':
        response = createJsonResponse(handleForgotPassword(e.parameter, userSheet));
        break;
      case 'resetPassword':
        response = createJsonResponse(handleResetPassword(e.parameter, userSheet));
        break;
      case 'updateTeams':
        response = createJsonResponse(handleUpdateTeams(e.parameter));
        break;
      case 'saveTestDriveBooking':
        response = createJsonResponse(handleSaveTestDriveBooking(e.parameter));
        break;
      case 'submitTestDriveCheckin':
        response = createJsonResponse(handleUpdateTestDriveCheckin(e.parameter));
        break;
      case 'deleteTestDriveBooking': 
        response = createJsonResponse(handleDeleteTestDriveRequest(e.parameter));
        break;
      case 'addTestDriveImages':
        response = createJsonResponse(handleAddTestDriveImages(e.parameter));
        break;

      // =================================================================
      // === CASE M·∫∂C ƒê·ªäNH ===
      // =================================================================
      default:
        response = createJsonResponse({ status: "ERROR", message: `H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá: ${action}` });
        break;
    }
    
    // Logic tƒÉng phi√™n b·∫£n d·ªØ li·ªáu t·ª´ h√†m 1
    // √Åp d·ª•ng cho t·∫•t c·∫£ c√°c case (k·ªÉ c·∫£ c√°c case m·ªõi gh√©p)
    // Ngo·∫°i tr·ª´ c√°c h√†m 'get' ƒë·∫∑c bi·ªát kh√¥ng l√†m thay ƒë·ªïi d·ªØ li·ªáu
    if (response && action !== 'getAiSuggestion' && action !== 'getGlobalAiResponse') {
      try {
        const responseObject = JSON.parse(response.getContent());
        if (responseObject.status === "SUCCESS") {
          incrementDataVersion();
        }
      } catch (parseError) {
         // L·ªói n·∫øu response kh√¥ng ph·∫£i l√† JSON (v√≠ d·ª•: getGlobalAiResponse tr·∫£ v·ªÅ text)
         // Kh√¥ng c·∫ßn l√†m g√¨ ·ªü ƒë√¢y, v√¨ ch√∫ng ta ƒë√£ lo·∫°i tr·ª´ n√≥ ·ªü tr√™n
         Logger.log(`Kh√¥ng th·ªÉ parse JSON ho·∫∑c kh√¥ng c·∫ßn tƒÉng version cho action: ${action}`);
      }
    }
    
    return response;

  } catch (error) {
    Logger.log(`L·ªói nghi√™m tr·ªçng trong doPost: ${error.message}, Stack: ${error.stack}`);
    sendErrorAlert('doPost', error);
    return createJsonResponse({ status: "ERROR", message: `L·ªói m√°y ch·ªß: ${error.message}` });
  } finally {
    lock.releaseLock();
  }
}



/**
 * B∆Ø·ªöC 3: Ch·∫°y h√†m n√†y ƒë·ªÉ t·∫°o t√†i kho·∫£n Admin ban ƒë·∫ßu.
 */
function setupInitialAdminUser() {
  const ADMIN_FULLNAME = 'PHAÃ£M THAÃÄNH NH√ÇN';
  const ADMIN_EMAIL = 'showroomthuanan@gmail.com';
  const ADMIN_INITIAL_PASSWORD = '123456';
  const ADMIN_ROLE = 'Admin';

  const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(USER_SHEET_NAME);
  if (!userSheet) {
    SpreadsheetApp.getUi().alert('L·ªói', `Kh√¥ng t√¨m th·∫•y trang t√≠nh "${USER_SHEET_NAME}". Vui l√≤ng ch·∫°y h√†m "setupSheets" tr∆∞·ªõc.`, SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }
  
  const ui = SpreadsheetApp.getUi();
  const username = generateUsernameFromName(ADMIN_FULLNAME);

  if (findUserByUsername(userSheet, username)) {
    ui.alert('Th√¥ng b√°o', `T√†i kho·∫£n admin v·ªõi username "${username}" ƒë√£ t·ªìn t·∫°i.`, ui.ButtonSet.OK);
    return;
  }

  const passwordHash = hashPassword(ADMIN_INITIAL_PASSWORD);
  userSheet.appendRow([username, passwordHash, ADMIN_FULLNAME, ADMIN_ROLE, ADMIN_EMAIL, '', '']);
  
  const message = `ƒê√£ t·∫°o t√†i kho·∫£n Admin th√†nh c√¥ng!\n\nT√™n ƒëƒÉng nh·∫≠p: ${username}\nM·∫≠t kh·∫©u: ${ADMIN_INITIAL_PASSWORD}\n\nVUI L√íNG ƒêƒÇNG NH·∫¨P V√Ä ƒê·ªîI M·∫¨T KH·∫®U NGAY!`;
  ui.alert('Th√†nh c√¥ng!', message, ui.ButtonSet.OK);
}

function handleRequestVinClub(e, mailSheet) {
  const STATUS = {
    PENDING_VC_APPROVAL: "Ch·ªù duy·ªát ycvc",
    VC_REQUESTED: "Y√™u c·∫ßu VinClub",
  };
  const CUSTOMER_TYPE = {
    PERSONAL: "C√° Nh√¢n",
    COMPANY: "C√¥ng Ty",
  };
  const ARCHIVE_PREFIX = "LuuTru";

  try {
    const { orderNumber, filesData: filesDataJson, customerType, dmsCode = "" } = e.parameter;
    if (!orderNumber || !filesDataJson) {
      throw new Error("Thi·∫øu th√¥ng tin quan tr·ªçng (s·ªë ƒë∆°n h√†ng ho·∫∑c file).");
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let foundOrder = null;

    const daGhepSheet = ss.getSheetByName(DA_GHEP_SHEET_NAME);
    if (daGhepSheet) {
      const daGhepIndices = {
        order: 6,
        customerName: 1,
        tvbh: 0,
        vin: 9
      };
      foundOrder = findOrderInSheet(daGhepSheet, orderNumber, daGhepIndices);
    }

    if (!foundOrder) {
      const archiveSheets = ss.getSheets().filter(sheet => sheet.getName().startsWith(ARCHIVE_PREFIX));
      for (const sheet of archiveSheets) {
        const luuTruIndices = {
          order: 2,
          customerName: 1,
          tvbh: 7,
          vin: 8
        };
        foundOrder = findOrderInSheet(sheet, orderNumber, luuTruIndices);
        if (foundOrder) break;
      }
    }

    if (!foundOrder) {
      const chuaGhepSheet = ss.getSheetByName(CHUA_GHEP_SHEET_NAME);
      if (chuaGhepSheet) {
        const headers = chuaGhepSheet.getRange(1, 1, 1, chuaGhepSheet.getLastColumn()).getValues()[0];
        const orderCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
        const customerCol = headers.indexOf("T√™n kh√°ch h√†ng");
        if (orderCol !== -1 && customerCol !== -1 && findOrderInSheet(chuaGhepSheet, orderNumber, {order: orderCol, customerName: customerCol, tvbh: -1, vin: -1})) {
          throw new Error(`ƒê∆°n h√†ng ${orderNumber} ƒëang ·ªü tr·∫°ng th√°i "Ch·ªù Gh√©p". Vui l√≤ng gh√©p xe tr∆∞·ªõc.`);
        }
      }
      const huyGhepSheet = ss.getSheetByName(CANCELLED_SHEET_NAME);
      if (huyGhepSheet) {
        const headers = huyGhepSheet.getRange(1, 1, 1, huyGhepSheet.getLastColumn()).getValues()[0];
        const orderCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
        const customerCol = headers.indexOf("T√™n kh√°ch h√†ng");
        if (orderCol !== -1 && customerCol !== -1 && findOrderInSheet(huyGhepSheet, orderNumber, {order: orderCol, customerName: customerCol, tvbh: -1, vin: -1})) {
          throw new Error(`ƒê∆°n h√†ng ${orderNumber} ƒë√£ b·ªã h·ªßy v√† kh√¥ng th·ªÉ th·ª±c hi·ªán thao t√°c n√†y.`);
        }
      }
      throw new Error(`Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} ho·∫∑c ƒë∆°n h√†ng thi·∫øu th√¥ng tin TVBH/VIN.`);
    }

    const { customerName, orderRowIndex, sheet: sourceSheet, tvbh, vin } = foundOrder;
    if (!vin) {
      throw new Error(`ƒê∆°n h√†ng ${orderNumber} ch∆∞a c√≥ s·ªë VIN. Vui l√≤ng c·∫≠p nh·∫≠t v√† th·ª≠ l·∫°i.`);
    }

    const filesData = JSON.parse(filesDataJson);
    const uploadedFileUrls = {};
    const requestDate = new Date();
    filesData.forEach(fileInfo => {
      const blob = Utilities.newBlob(Utilities.base64Decode(fileInfo.data), fileInfo.type, fileInfo.name);
      const fileResult = saveFileToDrive(blob, orderNumber, `VC_${fileInfo.key}`, customerName, requestDate);
      if (fileResult && fileResult.formula) {
        const urlMatch = fileResult.formula.match(/=HYPERLINK\("([^"]+)"/i);
        if (urlMatch && urlMatch[1]) {
          uploadedFileUrls[fileInfo.key] = urlMatch[1];
        }
      }
    });

    const yeuCauVcSheet = ss.getSheetByName(YEU_CAU_VC_SHEET_NAME);
    
    const newVcRequestData = {
      "S·ªë ƒë∆°n h√†ng": orderNumber,
      "T√™n kh√°ch h√†ng": customerName,
      "Th·ªùi gian YC": requestDate,
      "Ng∆∞·ªùi YC": tvbh,
      "Lo·∫°i YC": customerType === 'personal' ? CUSTOMER_TYPE.PERSONAL : CUSTOMER_TYPE.COMPANY,
      "Tr·∫°ng th√°i x·ª≠ l√Ω": STATUS.PENDING_VC_APPROVAL,
      "Ghi ch√∫": "",
      "FileUrls": JSON.stringify(uploadedFileUrls),
      "M√£ KH DMS": dmsCode,
      "VIN": vin
    };
    const newRowValues = SHEET_HEADERS["YeuCauVC"].map(header => newVcRequestData[header] || "");
    yeuCauVcSheet.appendRow(newRowValues);

    const trangThaiVcCol = sourceSheet.getDataRange().getValues()[0].indexOf("Tr·∫°ng th√°i VC");
    if (trangThaiVcCol !== -1) {
      sourceSheet.getRange(orderRowIndex, trangThaiVcCol + 1).setValue(STATUS.VC_REQUESTED);
    }

    recordOrderHistory(orderNumber, vin, "Y√™u c·∫ßu VinClub", `TVBH ${tvbh} ƒë√£ g·ª≠i y√™u c·∫ßu c·∫•p t√†i kho·∫£n VinClub.`);
    addNotification(`${tvbh} ƒë√£ g·ª≠i Y/C c·∫•p VinClub cho ƒêH ${orderNumber}.`, 'info', 'vc', orderNumber, tvbh, ADMIN_EMAIL);
    const telegramMessage = `üí≥ <b>Y√™u C·∫ßu C·∫•p VinClub M·ªõi</b>\n\n` +
                            `üë§ <b>TVBH:</b> ${tvbh}\n` +
                            `üë® <b>Kh√°ch h√†ng:</b> ${customerName}\n` +
                            `üìÑ <b>SƒêH:</b> <code>${orderNumber}</code>\n` +
                            `üî¢ <b>VIN:</b> <code>${vin}</code>\n\n` +
                            `<b>Tr·∫°ng th√°i:</b> Ch·ªù Admin duy·ªát`;
    sendTelegramNotification(telegramMessage);

    // --- B·∫ÆT ƒê·∫¶U TH√äM M·ªöI: G·ª≠i email x√°c nh·∫≠n cho TVBH ---
    const emailData = {
      ten_ban_hang: tvbh,
      so_don_hang: orderNumber,
      ten_khach_hang: customerName,
      vin: vin,
      customerType: customerType, // [cite: 187]
      dmsCode: dmsCode // [cite: 187]
    };
    sendVcRequestConfirmationEmailToTVBH(mailSheet, emailData);
    // --- K·∫æT TH√öC TH√äM M·ªöI ---

    return createJsonResponse({ status: "SUCCESS", message: "ƒê√£ g·ª≠i y√™u c·∫ßu c·∫•p VinClub th√†nh c√¥ng." });
  } catch (error) {
    Logger.log(`L·ªói khi x·ª≠ l√Ω y√™u c·∫ßu VinClub: ${error.message}\nStack: ${error.stack}`);
    return createJsonResponse({ status: "ERROR", message: error.message }, 500);
  }
}

function findOrderInSheet(sheet, orderNumber, columnIndices) {
  const data = sheet.getDataRange().getValues();
  const normalizedOrderNumber = orderNumber.trim().toLowerCase();

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const orderColIndex = columnIndices.order;

    if (row[orderColIndex]) {
      const sheetOrderNumber = String(row[orderColIndex]).trim().toLowerCase();
      if (sheetOrderNumber === normalizedOrderNumber) {
        return {
          sheet: sheet,
          orderRowIndex: i + 1,
          customerName: (columnIndices.customerName !== -1) ? row[columnIndices.customerName] : "",
          tvbh: (columnIndices.tvbh !== -1) ? row[columnIndices.tvbh] : "Kh√¥ng x√°c ƒë·ªãnh",
          vin: (columnIndices.vin !== -1) ? row[columnIndices.vin] : ""
        };
      }
    }
  }
  return null;
}
function createJsonResponse(payload, statusCode = 200) {
  return ContentService.createTextOutput(JSON.stringify(payload))
    .setMimeType(ContentService.MimeType.JSON);
}
function findRelevantData(prompt, sheets) {
    const lowerPrompt = prompt.toLowerCase();
    const { daGhepSheet, chuaGhepSheet, stockSheet, xuathoadonSheet, huyGhepSheet } = sheets;

    const allData = {
        DaGhep: daGhepSheet.getLastRow() > 1 ? daGhepSheet.getDataRange().getValues() : [],
        ChuaGhep: chuaGhepSheet.getLastRow() > 1 ? chuaGhepSheet.getDataRange().getValues() : [],
        KhoXe: stockSheet.getLastRow() > 1 ? stockSheet.getDataRange().getValues() : [],
        Xuathoadon: xuathoadonSheet.getLastRow() > 1 ? xuathoadonSheet.getDataRange().getValues() : [],
        HuyGhep: huyGhepSheet ? (huyGhepSheet.getLastRow() > 1 ? huyGhepSheet.getDataRange().getValues() : []) : []
    };

    const results = {};
    let foundSpecificData = false;

    // ∆Øu ti√™n 1: T√¨m theo S·ªë ƒê∆°n H√†ng (v√≠ d·ª•: SO-123456)
    const orderMatch = prompt.match(/\b(SO-\w+)\b/i);
    if (orderMatch) {
        const orderNumber = orderMatch[1].toUpperCase();
        for (const sheetName in allData) {
            const data = allData[sheetName];
            if (data.length > 1) {
                const headers = data[0];
                const orderCol = headers.findIndex(h => h.toUpperCase().includes('S·ªê ƒê∆†N H√ÄNG'));
                if (orderCol !== -1) {
                    const foundRows = data.slice(1).filter(row => String(row[orderCol]).toUpperCase() === orderNumber);
                    if (foundRows.length > 0) {
                        results[sheetName] = foundRows.map(row => Object.fromEntries(headers.map((key, i) => [key, row[i]])));
                        foundSpecificData = true;
                    }
                }
            }
        }
    }

    // ∆Øu ti√™n 2: T√¨m theo S·ªë VIN (17 k√Ω t·ª±)
    const vinMatch = prompt.match(/\b([A-Z0-9]{17})\b/i);
    if (vinMatch && !foundSpecificData) {
        const vin = vinMatch[1].toUpperCase();
        for (const sheetName in allData) {
            const data = allData[sheetName];
            if (data.length > 1) {
                const headers = data[0];
                const vinCol = headers.findIndex(h => h.toUpperCase().includes('VIN'));
                if (vinCol !== -1) {
                    const foundRows = data.slice(1).filter(row => String(row[vinCol]).toUpperCase() === vin);
                     if (foundRows.length > 0) {
                        results[sheetName] = foundRows.map(row => Object.fromEntries(headers.map((key, i) => [key, row[i]])));
                        foundSpecificData = true;
                    }
                }
            }
        }
    }

    // ∆Øu ti√™n 3: T√¨m theo t·ª´ kh√≥a chung (t√™n xe, m√†u s·∫Øc, tr·∫°ng th√°i...)
    if (!foundSpecificData) {
        const keywords = lowerPrompt.split(/\s+/).filter(word => word.length > 2);
        for (const sheetName in allData) {
            const data = allData[sheetName];
            if (data.length > 1) {
                const headers = data[0];
                const foundRows = data.slice(1).filter(row => {
                    const rowText = row.join(' ').toLowerCase();
                    return keywords.every(kw => rowText.includes(kw));
                });
                if (foundRows.length > 0 && foundRows.length <= 10) {
                    results[sheetName] = foundRows.map(row => Object.fromEntries(headers.map((key, i) => [key, row[i]])));
                    foundSpecificData = true;
                }
            }
        }
    }
    
    if (!foundSpecificData) {
        return {
            summary: "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c·ª• th·ªÉ. ƒê√¢y l√† t√≥m t·∫Øt to√†n b·ªô h·ªá th·ªëng:",
            KhoXe: `${allData.KhoXe.length - 1} xe`,
            ChuaGhep: `${allData.ChuaGhep.length - 1} ƒë∆°n ch·ªù gh√©p`,
            DaGhep: `${allData.DaGhep.length - 1} ƒë∆°n ƒë√£ gh√©p`,
            HuyGhep: `${allData.HuyGhep.length - 1} ƒë∆°n ƒë√£ h·ªßy`
        };
    }

    return results;
}
function doGet(e) {
  try {
    const action = e.parameter.action;
    const currentUser = e.parameter.currentUser;
    const isAdmin = e.parameter.isAdmin === 'true';

    // ================= B·∫ÆT ƒê·∫¶U S·ª¨A L·ªñI =================
    // Th√™m kh·ªëi IF n√†y ƒë·ªÉ x·ª≠ l√Ω ri√™ng y√™u c·∫ßu l·∫•y th√¥ng b√°o
    if (action === 'getNotifications') {
      return getNotifications(currentUser, isAdmin);
    }
    // ================= K·∫æT TH√öC S·ª¨A L·ªñI =================
    
    if (action === 'getArchivedDataPage') {
        return getArchivedDataPage(e.parameter);
    }
    if (action === 'getAllArchivedDataForUser') {
        return getAllArchivedDataForUser(e.parameter);
    }
    if (action === 'getPaginatedData') {
        return getPaginatedData(e.parameter);
    }
    if (action === 'getOrderHistory') {
        const orderNumber = e.parameter.orderNumber;
        const historyData = getOrderHistory(orderNumber);
        return createJsonResponse({ status: "SUCCESS", history: historyData });
    }
    if (action === 'getVersion') {
      const version = getDataVersion();
      return createJsonResponse({ status: "SUCCESS", version: version });
    }
    if (action === 'getAnalytics') {
      const analyticsData = getVehicleAnalytics();
      return createJsonResponse({ status: "SUCCESS", analytics: analyticsData });
    }

    // B·ªô ƒëi·ªÅu h∆∞·ªõng (router) cho c√°c y√™u c·∫ßu l·∫•y d·ªØ li·ªáu ri√™ng l·∫ª
    switch(action) {
      // --- Cases t·ª´ logic Auth/L√°i th·ª≠ (H√†m 1) ---
      // (Gi·∫£ ƒë·ªãnh c√°c h√†m handler n√†y tr·∫£ v·ªÅ object, ta b·ªçc ch√∫ng trong createJsonResponse)
      case 'getUsers':
        return createJsonResponse(handleGetUsers());
      case 'getTeamData':
        return createJsonResponse(handleGetTeamData());
      case 'getTestDriveSchedule':
        return createJsonResponse(handleGetTestDriveSchedule());

      case 'getActiveUsers':
        return createJsonResponse(getActiveUsers());
      case 'getDaGhepData':
        return getDaGhepData();
      
      case 'getChuaGhepData':
        return getChuaGhepData();
      case 'getKhoXeData':
        return getKhoXeData();
      case 'getXuathoadonData':
        return getXuathoadonData();
      case 'getHuyGhepData':
        return getHuyGhepData();
      case 'getDangKyChoData':
        return getDangKyChoData();
      case 'getYeuCauVcData':
        return getYeuCauVcData();
      case 'getChinhSachData': // <-- TH√äM CASE M·ªöI N√ÄY
        return getChinhSachData();
      case 'getLogData':
        return handleGetLogData();
  }

    // Logic m·∫∑c ƒë·ªãnh khi kh√¥ng c√≥ action n√†o ·ªü tr√™n ƒë∆∞·ª£c g·ªçi (t·∫£i l·∫ßn ƒë·∫ßu)
    Logger.log(`ƒêang l·∫•y d·ªØ li·ªáu c∆° b·∫£n t·ª´ Google Sheet cho ng∆∞·ªùi d√πng: ${currentUser}.`);
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheets = getSheets(ss);
    
    const notificationsResponse = getNotifications(currentUser, isAdmin);
    const notificationsResult = JSON.parse(notificationsResponse.getContent());

    const result = {
      status: "SUCCESS",
      version: getDataVersion(),
      currentUser: currentUser,
      isAdmin: isAdmin,
      notifications: notificationsResult.notifications || [],
      unreadCount: notificationsResult.unreadCount || 0
    };
    
    return createJsonResponse(result);

  } catch (error) {
    Logger.log(`L·ªói nghi√™m tr·ªçng trong doGet: ${error.message}, Stack: ${error.stack}`);
    sendErrorAlert('doGet', error);
    return createJsonResponse({ status: "ERROR", message: `L·ªói m√°y ch·ªß: ${error.message}` });
  }
}
function handleLogin(params) {
  const { username, password } = params;
  const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(USER_SHEET_NAME);
  const user = findUserByUsername(userSheet, username);

  if (!user) {
    return { success: false, message: "T√™n ƒëƒÉng nh·∫≠p kh√¥ng t·ªìn t·∫°i." };
  }

  const passwordHash = hashPassword(password);
  if (user.passwordHash !== passwordHash) {
    return { success: false, message: "M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c." };
  }

  return {
    success: true,
    username: user.username,
    consultantName: user.fullName,
    role: user.role,
    email: user.email // <-- TH√äM D√íNG N√ÄY
  };
}
/**
 * X·ª≠ l√Ω th√™m ng∆∞·ªùi d√πng m·ªõi v√† g·ª≠i email th√¥ng b√°o.
 * @param {object} params - C√°c tham s·ªë t·ª´ request (fullName, email).
 * @param {Sheet} userSheet - ƒê·ªëi t∆∞·ª£ng trang t√≠nh 'Users'.
 * @returns {object} - K·∫øt qu·∫£ th√†nh c√¥ng ho·∫∑c l·ªói.
 */
function handleAddNewUserAndSendMail(params, userSheet) {
  const { fullName, email } = params;
  if (!fullName || !email) {
    throw new Error("Vui l√≤ng cung c·∫•p ƒë·∫ßy ƒë·ªß H·ªç v√† T√™n v√† Email.");
  }

  if (findUserByEmail(userSheet, email)) {
    throw new Error(`Email "${email}" ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω cho m·ªôt t√†i kho·∫£n kh√°c.`);
  }

  let username = generateUsernameFromName(fullName);
  let originalUsername = username;
  while (findUserByUsername(userSheet, username)) {
    username = originalUsername + Math.floor(Math.random() * 100);
  }

  const password = generateRandomPassword(10);
  const passwordHash = hashPassword(password);
  
  userSheet.appendRow([username, passwordHash, fullName, DEFAULT_ROLE, email, '', '']);
  
  const subject = `Th√¥ng tin t√†i kho·∫£n h·ªá th·ªëng`;
  const bodyContent = `
      <div class="email-wrapper">
          <table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td>
              <table align="center" width="600" border="0" cellspacing="0" cellpadding="0" class="email-container">
                  <tr><td class="header-cell"><h1 class="header-title">${subject}</h1></td></tr>
                  <tr><td class="content-cell">
                 
           <p class="paragraph">Ch√†o ${fullName},</p>
                      <p class="paragraph">M·ªôt t√†i kho·∫£n m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o cho b·∫°n tr√™n h·ªá th·ªëng c·ªßa ch√∫ng t√¥i. Vui l√≤ng s·ª≠ d·ª•ng th√¥ng tin d∆∞·ªõi ƒë√¢y ƒë·ªÉ ƒëƒÉng nh·∫≠p:</p>
                      <table class="details-table">
                          <tr class="details-row"><td class="key-cell">T√™n ƒëƒÉng nh·∫≠p:</td><td class="value-cell"><b>${username}</b></td></tr>
                          <tr class="details-row"><td class="key-cell">M·∫≠t kh·∫©u t·∫°m th·ªùi:</td><td class="value-cell"><b>${password}</b></td></tr>
    
                     </table>
                      <p class="paragraph"><b>L∆∞u √Ω quan tr·ªçng:</b> V√¨ l√Ω do b·∫£o m·∫≠t, b·∫°n vui l√≤ng ƒëƒÉng nh·∫≠p v√† ƒë·ªïi m·∫≠t kh·∫©u ngay l·∫≠p t·ª©c.</p>
                  </td></tr>
                  <tr><td class="footer-cell"><p>ƒê√¢y l√† email t·ª± ƒë·ªông, vui l√≤ng kh√¥ng tr·∫£ l·ªùi.</p></td></tr>
              </table>
          </td></tr></table>
      </div>`;
  const fullEmailHtml = createFullHtmlEmail(subject, bodyContent);

  MailApp.sendEmail({ to: email, subject: subject, htmlBody: fullEmailHtml });
  return { success: true, message: `ƒê√£ t·∫°o t√†i kho·∫£n cho "${fullName}" v√† g·ª≠i email th√¥ng b√°o.` };
}
/**
 * X·ª≠ l√Ω ƒë·ªïi m·∫≠t kh·∫©u cho ng∆∞·ªùi d√πng.
 * @param {object} params - C√°c tham s·ªë t·ª´ request (username, oldPassword, newPassword).
 * @param {Sheet} userSheet - ƒê·ªëi t∆∞·ª£ng trang t√≠nh 'Users'.
 * @returns {object} - K·∫øt qu·∫£ th√†nh c√¥ng ho·∫∑c l·ªói.
 */
function handleChangePassword(params, userSheet) {
  const { username, oldPassword, newPassword } = params;
  const user = findUserByUsername(userSheet, username);

  if (!user) { 
    throw new Error("T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i."); 
  }
  
  const oldPasswordHash = hashPassword(oldPassword);
  if (user.passwordHash !== oldPasswordHash) { 
    throw new Error("M·∫≠t kh·∫©u c≈© kh√¥ng ch√≠nh x√°c."); 
  }

  if (!newPassword || newPassword.length < 8) { 
    throw new Error("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±."); 
  }
  
  const newPasswordHash = hashPassword(newPassword);
  userSheet.getRange(user.row, 2).setValue(newPasswordHash);

  return { success: true, message: "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng." };
}
/**
 * X·ª≠ l√Ω y√™u c·∫ßu qu√™n m·∫≠t kh·∫©u v√† g·ª≠i OTP qua email.
 * @param {object} params - C√°c tham s·ªë t·ª´ request (email).
 * @param {Sheet} userSheet - ƒê·ªëi t∆∞·ª£ng trang t√≠nh 'Users'.
 * @returns {object} - K·∫øt qu·∫£ th√†nh c√¥ng ho·∫∑c l·ªói.
 */
function handleForgotPassword(params, userSheet) {
    const { email } = params;
    const user = findUserByEmail(userSheet, email);

    if (!user) {
        throw new Error("Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n n√†o ƒë∆∞·ª£c li√™n k·∫øt v·ªõi email n√†y.");
    }

    const otp = Math.floor(100000 + Math.random() * 900000).toString();
    const expiry = new Date();
    expiry.setMinutes(expiry.getMinutes() + OTP_EXPIRY_MINUTES);
    userSheet.getRange(user.row, 6).setValue(otp);
    userSheet.getRange(user.row, 7).setValue(expiry);

    const subject = `Y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u`;
    const bodyContent = `
        <div class="email-wrapper">
            <table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td>
                <table align="center" width="600" border="0" cellspacing="0" cellpadding="0" class="email-container">
                    <tr><td class="header-cell"><h1 class="header-title">${subject}</h1></td></tr>
                    <tr><td class="content-cell">
       
                   <p class="paragraph">Ch√†o ${user.fullName},</p>
                        <p class="paragraph">Ch√∫ng t√¥i ƒë√£ nh·∫≠n ƒë∆∞·ª£c y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u cho t√†i kho·∫£n c·ªßa b·∫°n. Vui l√≤ng s·ª≠ d·ª•ng m√£ OTP d∆∞·ªõi ƒë√¢y ƒë·ªÉ ho√†n t·∫•t qu√° tr√¨nh:</p>
                        <p style="text-align:center; font-size: 24px; font-weight: bold; letter-spacing: 5px; color: #00509E; margin: 20px 0;">${otp}</p>
                        <p class="paragraph">M√£ OTP n√†y s·∫Ω h·∫øt h·∫°n trong v√≤ng <b>${OTP_EXPIRY_MINUTES} ph√∫t</b>. N·∫øu b·∫°n kh√¥ng y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u, vui l√≤ng b·ªè qua email n√†y.</p>
                    </td></tr>
                    <tr><td class="footer-cell"><p>ƒê√¢y l√† email t·ª± ƒë·ªông, vui l√≤ng kh√¥ng tr·∫£ l·ªùi.</p></td></tr>
                </table>
            </td></tr></table>
        
         </div>`;
    const fullEmailHtml = createFullHtmlEmail(subject, bodyContent);

    MailApp.sendEmail({ to: email, subject: subject, htmlBody: fullEmailHtml });
    return { success: true, message: `M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email ${email}.` };
}

/**
 * X·ª≠ l√Ω ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u b·∫±ng OTP.
 * @param {object} params - C√°c tham s·ªë t·ª´ request (email, otp, newPassword).
 * @param {Sheet} userSheet - ƒê·ªëi t∆∞·ª£ng trang t√≠nh 'Users'.
 * @returns {object} - K·∫øt qu·∫£ th√†nh c√¥ng ho·∫∑c l·ªói.
 */
function handleResetPassword(params, userSheet) {
    const { email, otp, newPassword } = params;
    const user = findUserByEmail(userSheet, email);

    if (!user) {
        throw new Error("Email kh√¥ng h·ª£p l·ªá.");
    }

    const data = userSheet.getRange(user.row, 1, 1, 7).getValues()[0];
    const storedOtp = data[5];
    const expiryDate = new Date(data[6]);
    
    if (storedOtp.toString() !== otp.toString()) {
        throw new Error("M√£ OTP kh√¥ng ch√≠nh x√°c.");
    }

    if (new Date() > expiryDate) {
        // X√≥a OTP ƒë√£ h·∫øt h·∫°n
        userSheet.getRange(user.row, 6, 1, 2).clearContent();
        throw new Error("M√£ OTP ƒë√£ h·∫øt h·∫°n. Vui l√≤ng th·ª≠ l·∫°i.");
    }
    
    if (!newPassword || newPassword.length < 8) { 
        throw new Error("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±.");
    }

    const newPasswordHash = hashPassword(newPassword);
    userSheet.getRange(user.row, 2).setValue(newPasswordHash);
    // X√≥a OTP v√† th·ªùi gian h·∫øt h·∫°n sau khi s·ª≠ d·ª•ng th√†nh c√¥ng
    userSheet.getRange(user.row, 6, 1, 2).clearContent();

    return { success: true, message: "M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i th√†nh c√¥ng." };
}

// =================================================================
//   QU·∫¢N L√ù PH√íNG BAN & C√ÅC CH·ª®C NƒÇNG KH√ÅC
// =================================================================

function handleGetUsers() {
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(USER_SHEET_NAME);
    const data = userSheet.getDataRange().getValues();
    const users = data.slice(1).map(row => ({
        username: row[0],
        name: row[2],
        role: row[3]
    }));
    return { status: 'SUCCESS', users: users };
}

function handleGetTeamData() {
    const teamSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(TEAM_SHEET_NAME);
    if (!teamSheet) return { status: 'SUCCESS', teamData: {} };
    const data = teamSheet.getDataRange().getValues();
    const teamData = {};
    for (let i = 1; i < data.length; i++) {
        const leader = data[i][0];
        const membersString = data[i][1] || '';
        if (leader) {
            teamData[leader] = membersString ? membersString.split(',').map(m => m.trim()) : [];
        }
    }
    return { status: 'SUCCESS', teamData: teamData };
}

function handleUpdateTeams(params) {
    const { teams } = params;
    if (!teams) { throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu ph√≤ng ban ƒë·ªÉ c·∫≠p nh·∫≠t."); }
    const teamData = JSON.parse(teams);
    const teamSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(TEAM_SHEET_NAME);
    teamSheet.getDataRange().offset(1, 0).clearContent();
    const rows = Object.keys(teamData).map(leader => [leader, (teamData[leader] || []).join(', ')]);
    if (rows.length > 0) {
        teamSheet.getRange(2, 1, rows.length, 2).setValues(rows);
    }
    return { success: true, message: "C·∫•u tr√∫c ph√≤ng kinh doanh ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t." };
}
function getDaGhepData() {
  return fetchAndCacheData('DaGhep_data', 21600, () => {
    // ---- LOGIC ƒê√É ƒê∆Ø·ª¢C T·ªêI ∆ØU ----
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const daGhepSheet = ss.getSheetByName(DA_GHEP_SHEET_NAME);
    
    // Ch·ªâ l·∫•y d·ªØ li·ªáu t·ª´ sheet "DaGhep" ƒëang ho·∫°t ƒë·ªông, kh√¥ng ƒë·ªçc c√°c sheet l∆∞u tr·ªØ n·ªØa.
    let activeDaGhepData = getAllSheetData(daGhepSheet);
    
    return createJsonResponse({ status: "SUCCESS", data: activeDaGhepData });
  });
}
function fetchAndCacheData(cacheKey, expirationInSeconds, dataFetchingFunction) {
  const cache = CacheService.getScriptCache();
  const version = getDataVersion(); // S·ª≠ d·ª•ng h·ªá th·ªëng phi√™n b·∫£n c√≥ s·∫µn c·ªßa b·∫°n
  const versionedCacheKey = `${cacheKey}_${version}`; // T·∫°o key ƒë·ªôc nh·∫•t cho phi√™n b·∫£n d·ªØ li·ªáu hi·ªán t·∫°i

  const cached = cache.get(versionedCacheKey);
  if (cached != null) {
    Logger.log(`CACHE HIT for key: ${versionedCacheKey}`);
    // Tr·∫£ v·ªÅ d·ªØ li·ªáu t·ª´ cache ngay l·∫≠p t·ª©c
    return ContentService.createTextOutput(cached).setMimeType(ContentService.MimeType.JSON);
  }

  Logger.log(`CACHE MISS for key: ${versionedCacheKey}. Fetching new data from Sheet.`);
  // N·∫øu kh√¥ng c√≥ trong cache, ch·∫°y h√†m g·ªëc ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi
  const freshDataResponse = dataFetchingFunction();
  const freshDataJsonString = freshDataResponse.getContent();

  // L∆∞u d·ªØ li·ªáu m·ªõi v√†o cache
  cache.put(versionedCacheKey, freshDataJsonString, expirationInSeconds);

  return freshDataResponse;
}
function getYeuCauVcData() {
  // Cache d·ªØ li·ªáu trong 5 ph√∫t ƒë·ªÉ gi·∫£m t·∫£i
  return fetchAndCacheData('YeuCauVC_data', 300, () => { 
      const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
      const yeuCauVcSheet = ss.getSheetByName(YEU_CAU_VC_SHEET_NAME);
      // D√πng h√†m n√†y ƒë·ªÉ l·∫•y ƒë∆∞·ª£c URL c·ªßa file t·ª´ c√¥ng th·ª©c HYPERLINK
      const data = getAllSheetDataWithHyperlink(yeuCauVcSheet);
      return createJsonResponse({ status: "SUCCESS", data: data });
  });
}
function getChinhSachData() {
  // Cache d·ªØ li·ªáu trong 1 gi·ªù (3600 gi√¢y) ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô
  return fetchAndCacheData('ChinhSach_data', 3600, () => { 
      const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
      const chinhSachSheet = ss.getSheetByName(CHINH_SACH_SHEET_NAME);
      if (!chinhSachSheet || chinhSachSheet.getLastRow() < 2) {
        return createJsonResponse({ status: "SUCCESS", data: [] });
      }

      const data = chinhSachSheet.getDataRange().getValues();
      const headers = data[0];
      const tenCol = headers.indexOf("T√™n Ch√≠nh S√°ch");
      const trangThaiCol = headers.indexOf("Tr·∫°ng th√°i");

      if (tenCol === -1 || trangThaiCol === -1) {
         return createJsonResponse({ status: "ERROR", message: "Sheet Chinhsach c·∫•u h√¨nh sai." });
      }

      const activePolicies = data.slice(1)
        .filter(row => String(row[trangThaiCol]).trim().toLowerCase() === "hoatdong")
        .map(row => row[tenCol]);

      return createJsonResponse({ status: "SUCCESS", data: activePolicies });
  });
}
function getChuaGhepData() {
    return fetchAndCacheData('ChuaGhep_data', 21600, () => {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const chuaGhepSheet = ss.getSheetByName(CHUA_GHEP_SHEET_NAME);
        const data = getAllSheetData(chuaGhepSheet);
        return createJsonResponse({ status: "SUCCESS", data: data });
    });
}

function getKhoXeData() {
    return fetchAndCacheData('KhoXe_data', 21600, () => {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const stockSheet = ss.getSheetByName(STOCK_SHEET_NAME);
        const khoXeData = getAllSheetData(stockSheet);
        // B·ªè ph·∫ßn x·ª≠ l√Ω vinToDmsMap v√¨ n√≥ kh√¥ng c·∫ßn thi·∫øt khi g·ª≠i v·ªÅ client
        return createJsonResponse({ status: "SUCCESS", khoxe: khoXeData });
    });
}

function getXuathoadonData() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const xuathoadonSheet = ss.getSheetByName(XUAT_HOA_DON_SHEET_NAME);
    const data = getAllSheetData(xuathoadonSheet);
    return createJsonResponse({ status: "SUCCESS", data: data });
  } catch (e) {
    Logger.log(`L·ªói khi ƒë·ªçc tr·ª±c ti·∫øp sheet Xuathoadon: ${e.message}`);
    sendErrorAlert('getXuathoadonData_noCache', e);
    return createJsonResponse({ status: "ERROR", message: `L·ªói m√°y ch·ªß khi l·∫•y d·ªØ li·ªáu h√≥a ƒë∆°n: ${e.message}` });
  }
}

function getHuyGhepData() {
    return fetchAndCacheData('HuyGhep_data', 21600, () => {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const cancelledSheet = ss.getSheetByName(CANCELLED_SHEET_NAME);
        const data = getAllSheetData(cancelledSheet);
        return createJsonResponse({ status: "SUCCESS", data: data });
    });
}

function getDangKyChoData() {
    return fetchAndCacheData('DangKyCho_data', 21600, () => {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const dangKyChoSheet = ss.getSheetByName(DANG_KY_CHO_SHEET_NAME);
        const data = getAllSheetData(dangKyChoSheet);
        return createJsonResponse({ status: "SUCCESS", data: data });
    });
}
// ƒê·∫∂T H√ÄM N√ÄY G·∫¶N C√ÅC H√ÄM "get...Data" KH√ÅC (v√≠ d·ª•: sau h√†m getDangKyChoData)

function handleGetLogData() {
  // Cache d·ªØ li·ªáu trong 1 ph√∫t (60 gi√¢y)
  return fetchAndCacheData('LogData_data', 60, () => { 
      const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
      const logSheet = ss.getSheetByName("log");
      if (!logSheet || logSheet.getLastRow() < 2) {
        return createJsonResponse({ status: "SUCCESS", data: [] });
      }

      // Ch·ªâ l·∫•y 200 d√≤ng log g·∫ßn nh·∫•t ƒë·ªÉ tr√°nh qu√° t·∫£i
      const lastRow = logSheet.getLastRow();
      const startRow = Math.max(2, lastRow - 199); // L·∫•y 200 d√≤ng ho·∫∑c t·ª´ d√≤ng 2
      const numRows = lastRow - startRow + 1;

      const dataRange = logSheet.getRange(startRow, 1, numRows, SHEET_HEADERS["log"].length);
      const values = dataRange.getValues();
      const headers = SHEET_HEADERS["log"];

      const data = values.map(row => {
        const rowObject = {};
        headers.forEach((header, index) => {
          rowObject[header] = row[index];
        });
        return rowObject;
      }).sort((a, b) => new Date(b["Th·ªùi gian"]) - new Date(a["Th·ªùi gian"])); // S·∫Øp x·∫øp m·ªõi nh·∫•t l√™n ƒë·∫ßu

      return createJsonResponse({ status: "SUCCESS", data: data });
  });
}

function getAllSheetDataWithHyperlink(sheet) {
  if (!sheet || sheet.getLastRow() < 2) {
    return [];
  }
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  const formulas = dataRange.getFormulas();
  const headers = values[0].map(header => header.trim());
  const data = [];

  for (let i = 1; i < values.length; i++) {
    const rowObject = {};
    for (let j = 0; j < headers.length; j++) {
      const headerName = headers[j];
      const formula = formulas[i][j];
      // ∆Øu ti√™n tr√≠ch xu·∫•t URL t·ª´ c√¥ng th·ª©c HYPERLINK
      if (formula && formula.toUpperCase().startsWith("=HYPERLINK")) {
        const urlMatch = formula.match(/=HYPERLINK\("([^"]+)"/i);
        rowObject[headerName] = urlMatch ? urlMatch[1] : values[i][j];
      } else {
        rowObject[headerName] = values[i][j];
      }
    }
    data.push(rowObject);
  }
  return data;
}
function getNotifications(currentUser, isAdmin) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const NOTIFICATION_HEADERS = SHEET_HEADERS["ThongBaoWebApp"];
  const sheet = getOrCreateSheet(ss, NOTIFICATION_SHEET_NAME, NOTIFICATION_HEADERS);
  if (sheet.getLastRow() < 2) {
    return createJsonResponse({ status: 'SUCCESS', notifications: [], unreadCount: 0 });
  }

  // L·∫•y t·ªëi ƒëa 50 th√¥ng b√°o g·∫ßn nh·∫•t ƒë·ªÉ x·ª≠ l√Ω
  const data = sheet.getRange(2, 1, Math.min(50, sheet.getLastRow() - 1), NOTIFICATION_HEADERS.length).getValues();
  // √Ånh x·∫° d·ªØ li·ªáu g·ªëc sang ƒë·ªëi t∆∞·ª£ng ƒë·ªÉ d·ªÖ x·ª≠ l√Ω
  const allNotifications = data.map(row => ({
    timestamp: row[0],
    message: row[1],
    type: row[2],
    targetView: row[3],
    targetId: row[4],
    createdBy: String(row[5] || "").trim(),
    isRead: row[6] === 'ƒê√£ ƒë·ªçc',
    recipient: String(row[7] || "").trim()
  }));
  
  let filteredNotifications;
  
  // --- LOGIC L·ªåC TH√îNG B√ÅO ƒê√É THAY ƒê·ªîI ---
  if (isAdmin) {
    // N·∫øu l√† Admin, v·∫´n th·∫•y t·∫•t c·∫£ th√¥ng b√°o nh∆∞ c≈©
    filteredNotifications = allNotifications;
  } else {
    // N·∫øu l√† TVBH, CH·ªà th·∫•y c√°c th√¥ng b√°o ƒë∆∞·ª£c g·ª≠i ƒë√≠ch danh cho h·ªç
    filteredNotifications = allNotifications.filter(n => 
      n.recipient === currentUser
    );
  }
  // --- K·∫æT TH√öC THAY ƒê·ªîI ---

  // ƒê·∫øm s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc D·ª∞A TR√äN DANH S√ÅCH ƒê√É L·ªåC
  const unreadCount = filteredNotifications.filter(n => !n.isRead).length;
  return createJsonResponse({ status: 'SUCCESS', notifications: filteredNotifications, unreadCount });
}
function getThongtinxeData() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const thongtinxeSheet = ss.getSheetByName(THONG_TIN_XE_SHEET_NAME);
    
    if (!thongtinxeSheet) {
      Logger.log("L·ªói: Kh√¥ng t√¨m th·∫•y sheet Thongtinxe.");
      return null;
    }
    
    const data = thongtinxeSheet.getDataRange().getValues();
    return data;
  } catch (e) {
    Logger.log(`L·ªói nghi√™m tr·ªçng khi ƒë·ªçc sheet Thongtinxe: ${e.message}`);
    sendErrorAlert('getThongtinxeData', e);
    return null; // Tr·∫£ v·ªÅ null khi c√≥ l·ªói
  }
}

function sendErrorAlert(functionName, error) {
  try {
    const subject = `[L·ªói H·ªá Th·ªëng] ƒê√£ x·∫£y ra l·ªói nghi√™m tr·ªçng trong h√†m: ${functionName}`;
    const body = `
      <p>M·ªôt l·ªói nghi√™m tr·ªçng ƒë√£ x·∫£y ra trong h·ªá th·ªëng qu·∫£n l√Ω xe.</p>
      <p><b>Th·ªùi gian:</b> ${new Date().toLocaleString('vi-VN')}</p>
      <p><b>H√†m b·ªã l·ªói:</b> ${functionName}</p>
      <p><b>Th√¥ng b√°o l·ªói:</b></p>
      <pre style="background-color: #fcecec; border: 1px solid #f0b6b6; padding: 10px; border-radius: 5px;">${error.message}</pre>
      <p><b>D·∫•u v·∫øt l·ªói (Stack Trace):</b></p>
      <pre style="background-color: #f1f1f1; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">${error.stack}</pre>
    `;
    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: subject,
      htmlBody: body
    });
  } catch (e) {
    Logger.log(`L·ªói khi ƒëang g·ª≠i email c·∫£nh b√°o l·ªói: ${e.message}`);
  }
}
// Thay th·∫ø to√†n b·ªô h√†m c≈© b·∫±ng h√†m n√†y trong Code.txt
function handleAddRequest(e, chuaGhepSheet, daGhepSheet, stockSheet, mailSheet) {
  try { // <--- B·∫ÆT ƒê·∫¶U KH·ªêI try...catch ƒê·ªÇ B·∫ÆT L·ªñI
    const newRow = {};
    const paramNameMap = {
      "T√™n t∆∞ v·∫•n b√°n h√†ng": "ten_ban_hang", "T√™n kh√°ch h√†ng": "ten_khach_hang",
      "D√≤ng xe": "dong_xe", "Phi√™n b·∫£n": "phien_ban", "Ngo·∫°i th·∫•t": "ngoai_that",
      "N·ªôi th·∫•t": "noi_that", "S·ªë ƒë∆°n h√†ng": "so_don_hang", "Ng√†y c·ªçc": "ngay_coc"
    };
    SHEET_HEADERS["DaGhep"].forEach(header => {
      const paramName = paramNameMap[header] || header.toLowerCase().replace(/ /g, '_').replace(/[\u0300-\u036f]/g, "");
      newRow[header] = e.parameter[paramName] ? e.parameter[paramName].trim() : "";
    });
    if (newRow["Ng√†y c·ªçc"]) {
      newRow["Ng√†y c·ªçc"] = formatDateTimeForSheet(new Date(newRow["Ng√†y c·ªçc"]));
    }
    const currentTime = new Date();
    newRow["Th·ªùi gian nh·∫≠p"] = formatDateTimeForSheet(currentTime);
    
    const requestedVin = e.parameter.vin_giu_yeu_cau;
    let matchedCarInfo = null;
    const currentUser = String(newRow["T√™n t∆∞ v·∫•n b√°n h√†ng"] || "").trim();
    if (requestedVin) {
        Logger.log(`Y√™u c·∫ßu gh√©p xe ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh VIN: ${requestedVin} b·ªüi ${currentUser}`);
        const stockData = stockSheet.getDataRange().getValues();
        const headers = stockData[0];
        const vinCol = headers.indexOf("VIN");
        const statusCol = headers.indexOf("Tr·∫°ng th√°i");
        const holderCol = headers.indexOf("Ng∆∞·ªùi Gi·ªØ Xe");
        const expiryCol = headers.indexOf("Th·ªùi Gian H·∫øt H·∫°n Gi·ªØ");
        const maDMSCol = headers.indexOf("M√£ DMS");
        for (let i = 1; i < stockData.length; i++) {
            const row = stockData[i];
            if (String(row[vinCol]).trim() === requestedVin) {
                const currentStatus = String(row[statusCol]).trim();
                const currentHolder = String(row[holderCol] || "").trim();
                const currentExpiry = row[expiryCol];
                if ((currentStatus === "Ch∆∞a gh√©p" || currentStatus === "ƒêang gi·ªØ") && 
                    currentHolder === currentUser && 
                    currentExpiry && 
                    new Date(currentExpiry) > new Date()) {
                    matchedCarInfo = {
      
                        vin: requestedVin,
                        maDMS: row[maDMSCol] || "",
                        rowIndex: i + 1,
                        statusColIndex: statusCol + 1
                    };
                    stockSheet.getRange(matchedCarInfo.rowIndex, matchedCarInfo.statusColIndex).setValue("ƒê√£ gh√©p");
                    logAction(`Gh√©p th√†nh c√¥ng xe ƒë√£ gi·ªØ ${requestedVin}`, `VIN ${requestedVin} ƒë∆∞·ª£c gh√©p cho ${currentUser} theo y√™u c·∫ßu.`);
                } else {
                    let errorMessage = `Kh√¥ng th·ªÉ gh√©p xe ${requestedVin}: `;
                    if (currentHolder !== currentUser) errorMessage += "Xe kh√¥ng ph·∫£i do b·∫°n gi·ªØ.";
                    else if (!currentExpiry || new Date(currentExpiry) <= new Date()) errorMessage += "L∆∞·ª£t gi·ªØ xe ƒë√£ h·∫øt h·∫°n.";
                    else if (currentStatus !== "Ch∆∞a gh√©p") errorMessage += `Xe ƒëang ·ªü tr·∫°ng th√°i '${currentStatus}'.`;
                    else errorMessage += "L·ªói kh√¥ng x√°c ƒë·ªãnh.";
                    Logger.log(`L·ªói khi gh√©p xe ƒë√£ gi·ªØ: ${errorMessage}`);
                    return createJsonResponse({ status: "ERROR", message: errorMessage });
                }
                break;
            }
        }
         if (!matchedCarInfo) {
             return createJsonResponse({ status: "ERROR", message: `Kh√¥ng t√¨m th·∫•y xe v·ªõi VIN ${requestedVin} trong kho.` });
         }
    } else {
        matchedCarInfo = matchCarAutomatically(newRow["D√≤ng xe"], newRow["Phi√™n b·∫£n"], newRow["Ngo·∫°i th·∫•t"], newRow["N·ªôi th·∫•t"], stockSheet);
    }
  
    let targetSheet, headersToUse, emailSentSuccessfully = false;
    const orderDataForEmail = {
      ten_ban_hang: String(newRow["T√™n t∆∞ v·∫•n b√°n h√†ng"] || "").trim(),
      ten_khach_hang: String(newRow["T√™n kh√°ch h√†ng"] || "").trim(),
      dong_xe: String(newRow["D√≤ng xe"] || "").trim(), phien_ban: String(newRow["Phi√™n b·∫£n"] || "").trim(),
      ngoai_that: String(newRow["Ngo·∫°i th·∫•t"] || "").trim(), noi_that: String(newRow["N·ªôi th·∫•t"] || "").trim(),
      so_don_hang: String(newRow["S·ªë ƒë∆°n h√†ng"] || "").trim(), ngay_coc: newRow["Ng√†y c·ªçc"],
      thoi_gian_nhap: newRow["Th·ªùi gian nh·∫≠p"]
    };
    if (matchedCarInfo) {
      newRow["VIN"] = matchedCarInfo.vin;
      newRow["K·∫øt qu·∫£"] = "ƒê√£ gh√©p";
      newRow["Th·ªùi gian gh√©p"] = formatDateTimeForSheet(currentTime);
      const targetRow = daGhepSheet.getLastRow() + 1;
      newRow["S·ªë ng√†y gh√©p"] = `=IFERROR(DATEDIF(K${targetRow};TODAY();"D"))`;
      targetSheet = daGhepSheet;
      headersToUse = SHEET_HEADERS["DaGhep"];
      emailSentSuccessfully = sendEmailNotification(mailSheet, orderDataForEmail, matchedCarInfo.vin, matchedCarInfo.maDMS, currentTime);
      recordOrderHistory(orderDataForEmail.so_don_hang, matchedCarInfo.vin, "Gh√©p t·ª± ƒë·ªông", "ƒê√£ gh√©p VIN th√†nh c√¥ng", newRow);
      recordVehicleHistory(matchedCarInfo.vin, "Gh√©p t·ª± ƒë·ªông", `Gh√©p v·ªõi ƒë∆°n h√†ng ${orderDataForEmail.so_don_hang}`, newRow);
    } else {
      newRow["VIN"] = "";
      newRow["K·∫øt qu·∫£"] = "Ch∆∞a gh√©p";
      newRow["Th·ªùi gian gh√©p"] = "";
      newRow["S·ªë ng√†y gh√©p"] = "";
      targetSheet = chuaGhepSheet;
      headersToUse = SHEET_HEADERS["ChuaGhep"];
      emailSentSuccessfully = sendPendingEmail(mailSheet, orderDataForEmail, currentTime);
      recordOrderHistory(orderDataForEmail.so_don_hang, "", "Ch·ªù gh√©p", "Ch∆∞a t√¨m th·∫•y VIN ph√π h·ª£p", newRow);
      const suggestionsResult = getSuggestionsForExistingData();
      if (suggestionsResult.status === "SUCCESS") {
          showToastOnSheet(`ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c th√™m v√†o danh s√°ch ch·ªù. ${suggestionsResult.message}`, "‚úÖ G·ª£i √Ω Gh√©p xe", 10);
      }
    }
    newRow["Tr·∫°ng th√°i g·ª≠i mail"] = emailSentSuccessfully ? "ƒê√£ g·ª≠i" : "L·ªói g·ª≠i";
    const rowData = headersToUse.map(header => newRow[header] || "");
    targetSheet.appendRow(rowData);
    
    const waitingRequestId = e.parameter.waitingRequestId;
    if (waitingRequestId) {
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const dangKyChoSheet = getOrCreateSheet(ss, DANG_KY_CHO_SHEET_NAME, SHEET_HEADERS["DangKyCho"]);
      const waitingData = dangKyChoSheet.getDataRange().getValues();
      const idCol = SHEET_HEADERS["DangKyCho"].indexOf("ID Y√™u C·∫ßu");
      for (let i = waitingData.length - 1; i >= 1; i--) {
          if (String(waitingData[i][idCol]).trim() === waitingRequestId) {
              dangKyChoSheet.deleteRow(i + 1);
              logAction("D·ªçn d·∫πp Y√™u C·∫ßu Ch·ªù", `ƒê√£ x√≥a YC ID: ${waitingRequestId} sau khi ho√†n t·∫•t gh√©p.`);
              break;
          }
      }
    }
    
    const ketQuaGhep = newRow["K·∫øt qu·∫£"];
    const tvbhGhep = newRow["T√™n t∆∞ v·∫•n b√°n h√†ng"];
    const khachHangGhep = newRow["T√™n kh√°ch h√†ng"];
    const xeGhep = `${newRow["D√≤ng xe"]} ${newRow["Phi√™n b·∫£n"]}`;
    const soDonHangGhep = newRow["S·ªë ƒë∆°n h√†ng"];
    const vinGhep = newRow["VIN"];
    const mauSacGhep = `${newRow["Ngo·∫°i th·∫•t"]} / ${newRow["N·ªôi th·∫•t"]}`;
  
    let telegramMessageGhep = `üìù <b>Y√™u C·∫ßu Gh√©p Xe M·ªõi</b>\n\n` +
                              `üë§ <b>TVBH:</b> ${tvbhGhep}\n` +
                              `üë® <b>Kh√°ch h√†ng:</b> ${khachHangGhep}\n` +
                              `üöó <b>Lo·∫°i xe:</b> ${xeGhep}\n` +
                              `üé® <b>M√†u s·∫Øc:</b> ${mauSacGhep}\n` +
                              `üìÑ <b>S·ªë ƒë∆°n h√†ng:</b> <code>${soDonHangGhep}</code>\n`;
    if (ketQuaGhep === "ƒê√£ gh√©p") {
        telegramMessageGhep += `‚úÖ <b>Tr·∫°ng th√°i:</b> ƒê√£ gh√©p th√†nh c√¥ng\n` +
                               `üî¢ <b>VIN:</b> <code>${vinGhep}</code>`;
    } else {
        telegramMessageGhep += `‚è≥ <b>Tr·∫°ng th√°i:</b> ƒêang ch·ªù gh√©p`;
    }
    sendTelegramNotification(telegramMessageGhep);
    return createJsonResponse({ 
      status: "SUCCESS", 
      message: `Y√™u c·∫ßu cho ƒêH ${newRow["S·ªë ƒë∆°n h√†ng"]} ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.`, 
      orderNumber: newRow["S·ªë ƒë∆°n h√†ng"],
      newRecord: newRow
    });
  // <--- B·∫ÆT L·ªñI V√Ä TR·∫¢ V·ªÄ PH·∫¢N H·ªíI JSON
  } catch (err) {
      Logger.log(`L·ªói nghi√™m tr·ªçng trong handleAddRequest: ${err.message}. Stack: ${err.stack}`);
      sendErrorAlert('handleAddRequest', err);
      return createJsonResponse({ status: "ERROR", message: `L·ªói ph√≠a m√°y ch·ªß: ${err.message}` });
  }
}
function handleAddBulkRequests(e, chuaGhepSheet, daGhepSheet, stockSheet, mailSheet) {
  const requests = JSON.parse(e.parameter.requests);
  const consultantName = e.parameter.consultantName || "Unknown";
  const paramNameMap = {
    "T√™n t∆∞ v·∫•n b√°n h√†ng": "ten_ban_hang",
    "T√™n kh√°ch h√†ng": "ten_khach_hang",
    "D√≤ng xe": "dong_xe",
    "Phi√™n b·∫£n": "phien_ban",
    "Ngo·∫°i th·∫•t": "ngoai_that",
    "N·ªôi th·∫•t": "noi_that",
    "S·ªë ƒë∆°n h√†ng": "so_don_hang",
    "Ng√†y c·ªçc": "ngay_coc"
  };
  const rowsForDaGhep = []; 
  const rowsForChuaGhep = [];
  let pairedCount = 0; 
  let unPairedCount = 0;
  const startRowForDaGhep = daGhepSheet.getLastRow() + 1;

  for (let i = 0; i < requests.length; i++) {
    const request = requests[i];
    const newRow = {};

    SHEET_HEADERS["DaGhep"].forEach(header => {
      const paramName = paramNameMap[header] || header.toLowerCase().replace(/ /g, '_').replace(/[\u0300-\u036f]/g, "");
      newRow[header] = request[paramName] || ""; 
    });
    newRow["T√™n t∆∞ v·∫•n b√°n h√†ng"] = consultantName;
    if (newRow["Ng√†y c·ªçc"]) {
      newRow["Ng√†y c·ªçc"] = formatDateTimeForSheet(new Date(newRow["Ng√†y c·ªçc"]));
    }
    const currentTime = new Date();
    newRow["Th·ªùi gian nh·∫≠p"] = formatDateTimeForSheet(currentTime);
    newRow["·∫¢nh UNC URL"] = "";
    const matchedCarInfo = matchCarAutomatically(newRow["D√≤ng xe"], newRow["Phi√™n b·∫£n"], newRow["Ngo·∫°i th·∫•t"], newRow["N·ªôi th·∫•t"], stockSheet);
    let headersToUse;
    let emailSentSuccessfully = false;
    const orderDataForEmail = {
      ten_ban_hang: String(newRow["T√™n t∆∞ v·∫•n b√°n h√†ng"] || "").trim(),
      ten_khach_hang: String(newRow["T√™n kh√°ch h√†ng"] || "").trim(),
      dong_xe: String(newRow["D√≤ng xe"] || "").trim(),
      phien_ban: String(newRow["Phi√™n b·∫£n"] || "").trim(),
      ngoai_that: String(newRow["Ngo·∫°i th·∫•t"] || "").trim(),
      noi_that: String(newRow["N·ªôi th·∫•t"] || "").trim(),
      so_don_hang: String(newRow["S·ªë ƒë∆°n h√†ng"] || "").trim(),
      ngay_coc: newRow["Ng√†y c·ªçc"],
      thoi_gian_nhap: newRow["Th·ªùi gian nh·∫≠p"]
    };

    if (matchedCarInfo) {
      newRow["VIN"] = matchedCarInfo.vin;
      newRow["K·∫øt qu·∫£"] = "ƒê√£ gh√©p";
      newRow["Th·ªùi gian gh√©p"] = formatDateTimeForSheet(currentTime); 

      const targetRow = startRowForDaGhep + pairedCount;
      const thoiGianGhepColLetter = "K";
      newRow["S·ªë ng√†y gh√©p"] = `=IFERROR(DATEDIF(${thoiGianGhepColLetter}${targetRow};TODAY();"D"))`;
      headersToUse = SHEET_HEADERS["DaGhep"];
      
      emailSentSuccessfully = sendEmailNotification(mailSheet, orderDataForEmail, matchedCarInfo.vin, matchedCarInfo.maDMS, currentTime);
      recordOrderHistory(orderDataForEmail.so_don_hang, matchedCarInfo.vin, "Gh√©p t·ª± ƒë·ªông (Bulk)", "ƒê√£ gh√©p VIN th√†nh c√¥ng t·ª´ nh·∫≠p h√†ng lo·∫°t");
      recordVehicleHistory(matchedCarInfo.vin, "Gh√©p t·ª± ƒë·ªông (Bulk)", `Gh√©p v·ªõi ƒë∆°n h√†ng ${orderDataForEmail.so_don_hang} t·ª´ nh·∫≠p h√†ng lo·∫°t`);
    } else {
      newRow["VIN"] = ""; 
      newRow["K·∫øt qu·∫£"] = "Ch∆∞a gh√©p";
      newRow["Th·ªùi gian gh√©p"] = ""; 
      newRow["S·ªë ng√†y gh√©p"] = ""; 

      headersToUse = SHEET_HEADERS["ChuaGhep"];
      emailSentSuccessfully = sendPendingEmail(mailSheet, orderDataForEmail, currentTime);
      recordOrderHistory(orderDataForEmail.so_don_hang, "", "Ch·ªù gh√©p (Bulk)", "Ch∆∞a t√¨m th·∫•y VIN ph√π h·ª£p t·ª´ nh·∫≠p h√†ng lo·∫°t");
    }

    newRow["Tr·∫°ng th√°i g·ª≠i mail"] = emailSentSuccessfully ? "ƒê√£ g·ª≠i" : "L·ªói g·ª≠i";
    if (matchedCarInfo) {
      rowsForDaGhep.push(headersToUse.map(header => newRow[header] || "")); 
      pairedCount++;
    } else {
      rowsForChuaGhep.push(headersToUse.map(header => newRow[header] || "")); 
      unPairedCount++;
    }
  }

  if (rowsForDaGhep.length > 0) {
    daGhepSheet.getRange(daGhepSheet.getLastRow() + 1, 1, rowsForDaGhep.length, SHEET_HEADERS["DaGhep"].length).setValues(rowsForDaGhep);
  }
  if (rowsForChuaGhep.length > 0) {
    chuaGhepSheet.getRange(chuaGhepSheet.getLastRow() + 1, 1, rowsForChuaGhep.length, SHEET_HEADERS["ChuaGhep"].length).setValues(rowsForChuaGhep);
  }
  showToastOnSheet(`ƒê√£ th√™m ${pairedCount + unPairedCount} y√™u c·∫ßu gh√©p xe h√†ng lo·∫°t th√†nh c√¥ng! (${pairedCount} ƒë√£ gh√©p, ${unPairedCount} ch∆∞a gh√©p)`, "Th√†nh c√¥ng");
  return createJsonResponse({ status: "SUCCESS", message: `ƒê√£ th√™m ${pairedCount + unPairedCount} y√™u c·∫ßu gh√©p xe h√†ng lo·∫°t th√†nh c√¥ng! (${pairedCount} ƒë√£ gh√©p, ${unPairedCount} ch∆∞a gh√©p)` });
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG H√ÄM N√ÄY]
function handleCancelRequest(e, sheets) {
    const { daGhepSheet, chuaGhepSheet, stockSheet, cancelledSheet, xuathoadonSheet } = sheets;
    const orderNumberToCancel = e.parameter.orderNumber;
    const cancelledBy = e.parameter.cancelledBy || "Unknown";
    const reason = e.parameter.reason || "Kh√¥ng c√≥ l√Ω do ƒë∆∞·ª£c cung c·∫•p";

    if (!orderNumberToCancel) {
        return { success: false, message: "S·ªë ƒë∆°n h√†ng c·∫ßn h·ªßy kh√¥ng ƒë∆∞·ª£c cung c·∫•p." };
    }

    let vinAssociatedWithRequest = "";
    let daghepRowDataForRevert = null;
    if (xuathoadonSheet) {
        const xuathoadonData = xuathoadonSheet.getDataRange().getValues();
        const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];
        const orderNumberColXHD = xuathoadonHeaders.indexOf("S·ªê ƒê∆†N H√ÄNG");
        const vinColXHD = xuathoadonHeaders.indexOf("S·ªê VIN");
        if (orderNumberColXHD !== -1) {
            for (let i = xuathoadonData.length - 1; i >= 1; i--) {
                if (String(xuathoadonData[i][orderNumberColXHD]).trim() === String(orderNumberToCancel).trim()) {
                    vinAssociatedWithRequest = String(xuathoadonData[i][vinColXHD] || "").trim();
                    xuathoadonSheet.deleteRow(i + 1);
                    logAction('X√≥a kh·ªèi Xuathoadon (H·ªßy)', `ƒê√£ x√≥a ƒë∆°n h√†ng ${orderNumberToCancel} kh·ªèi sheet Xuathoadon.`);
                    updateSerialNumbers(xuathoadonSheet);
                    break;
                }
            }
        }
    }

    if (vinAssociatedWithRequest) {
        const daGhepData = daGhepSheet.getDataRange().getValues();
        const daGhepHeaders = daGhepData[0];
        const vinColDaghep = daGhepHeaders.indexOf("VIN");
        const ketQuaColDaghep = daGhepHeaders.indexOf("K·∫øt qu·∫£");
        for (let i = 1; i < daGhepData.length; i++) {
            if (String(daGhepData[i][vinColDaghep]).trim() === vinAssociatedWithRequest) {
                daGhepSheet.getRange(i + 1, ketQuaColDaghep + 1).setValue("ƒê√£ gh√©p");
                logAction('Ho√†n t√°c tr·∫°ng th√°i DaGhep', `ƒê∆°n h√†ng ${orderNumberToCancel} ƒë∆∞·ª£c tr·∫£ v·ªÅ tr·∫°ng th√°i 'ƒê√£ gh√©p'.`);
                daghepRowDataForRevert = daGhepData[i];
                break;
            }
        }
    }

    let sourceSheet = null;
    let rowIndexToDelete = -1;
    let rowDataToMove = null;
    let headers = null;
    const searchInSheet = (sheet, sheetHeaders) => {
        const data = sheet.getDataRange().getValues();
        const orderCol = sheetHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
        for (let i = 1; i < data.length; i++) {
            if (String(data[i][orderCol] || "").trim() === String(orderNumberToCancel).trim()) {
                sourceSheet = sheet;
                rowIndexToDelete = i + 1;
                rowDataToMove = data[i];
                headers = sheetHeaders;
                return true;
            }
        }
        return false;
    };
    searchInSheet(daGhepSheet, daGhepSheet.getRange(1, 1, 1, daGhepSheet.getLastColumn()).getValues()[0]);
    if (!sourceSheet) {
        searchInSheet(chuaGhepSheet, chuaGhepSheet.getRange(1, 1, 1, chuaGhepSheet.getLastColumn()).getValues()[0]);
    }

    if (sourceSheet && rowIndexToDelete > -1) {
        const vinCol = headers.indexOf("VIN");
        const vinToRevert = (vinCol !== -1) ? String(rowDataToMove[vinCol] || "").trim() : "";
        if (vinToRevert && vinToRevert.toLowerCase() !== "h·ªßy") {
            updateKhoxeStatusForVin(stockSheet, vinToRevert, "Ch∆∞a gh√©p");
            recordVehicleHistory(vinToRevert, `H·ªßy ƒë∆°n h√†ng`, `H·ªßy ƒë∆°n h√†ng ${orderNumberToCancel}, VIN v·ªÅ 'Ch∆∞a gh√©p'`);
        }
        const cancelledSheetHeaders = cancelledSheet.getRange(1, 1, 1, cancelledSheet.getLastColumn()).getValues()[0];
        const cancelledRowForHuyGhep = {};
        cancelledSheetHeaders.forEach(header => {
            const originalHeaderIndex = headers.indexOf(header);
            if (originalHeaderIndex !== -1) {
                cancelledRowForHuyGhep[header] = rowDataToMove[originalHeaderIndex];
            }
        });
        cancelledRowForHuyGhep["Ng∆∞·ªùi h·ªßy"] = cancelledBy;
        cancelledRowForHuyGhep["Th·ªùi gian h·ªßy"] = new Date();
        cancelledRowForHuyGhep["K·∫øt qu·∫£"] = `ƒê√£ h·ªßy (L√Ω do: ${reason})`;
        const cancelledRowDataForHuyGhep = cancelledSheetHeaders.map(header => cancelledRowForHuyGhep[header] || "");
        cancelledSheet.appendRow(cancelledRowDataForHuyGhep);
        sourceSheet.deleteRow(rowIndexToDelete);
    } else if (!daghepRowDataForRevert) {
         return { success: false, message: `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumberToCancel} trong c√°c sheet ho·∫°t ƒë·ªông.` };
    }

    const emailData = {
        ten_ban_hang: rowDataToMove ? String(rowDataToMove[headers.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng")] || "").trim() : "",
        ten_khach_hang: rowDataToMove ? String(rowDataToMove[headers.indexOf("T√™n kh√°ch h√†ng")] || "").trim() : "",
        dong_xe: rowDataToMove ? String(rowDataToMove[headers.indexOf("D√≤ng xe")] || "").trim() : "",
        so_don_hang: orderNumberToCancel,
    };

    // ===== B·∫ÆT ƒê·∫¶U THAY ƒê·ªîI =====
    // G·ª≠i th√¥ng b√°o Telegram khi h·ªßy ƒë∆°n h√†ng
    if (rowDataToMove) {
        const tenKhachHangHuy = rowDataToMove[headers.indexOf("T√™n kh√°ch h√†ng")];
        const dongXeHuy = `${rowDataToMove[headers.indexOf("D√≤ng xe")]} ${rowDataToMove[headers.indexOf("Phi√™n b·∫£n")]}`;
        const mauSacHuy = `${rowDataToMove[headers.indexOf("Ngo·∫°i th·∫•t")]} / ${rowDataToMove[headers.indexOf("N·ªôi th·∫•t")]}`;
        const vinHuy = rowDataToMove[headers.indexOf("VIN")] || "Ch∆∞a c√≥";

        const telegramMessageHuyDon = `‚ùå <b>ƒê∆°n H√†ng ƒê√£ B·ªã H·ªßy</b>\n\n` +
                                      `üë§ <b>Ng∆∞·ªùi h·ªßy:</b> ${cancelledBy}\n` +
                                      `üìù <b>L√Ω do:</b> <i>${reason}</i>\n\n` +
                                      `--- Th√¥ng Tin ƒê∆°n H√†ng ---\n`+
                                      `üë® <b>Kh√°ch h√†ng:</b> ${tenKhachHangHuy}\n` +
                                      `üìÑ <b>S·ªë ƒë∆°n h√†ng:</b> <code>${orderNumberToCancel}</code>\n` +
                                      `üöó <b>Lo·∫°i xe:</b> ${dongXeHuy}\n` +
                                      `üé® <b>M√†u s·∫Øc:</b> ${mauSacHuy}\n` +
                                      `üî¢ <b>VIN ƒë√£ gh√©p (n·∫øu c√≥):</b> <code>${vinHuy}</code>`;
        sendTelegramNotification(telegramMessageHuyDon);
    }
    // ===== K·∫æT TH√öC THAY ƒê·ªîI =====

    return {
        success: true,
        message: `ƒê∆°n h√†ng ${orderNumberToCancel} ƒë√£ ƒë∆∞·ª£c h·ªßy th√†nh c√¥ng.`,
        orderNumber: orderNumberToCancel,
        vin: vinAssociatedWithRequest || (rowDataToMove ? String(rowDataToMove[headers.indexOf("VIN")] || "").trim() : ""),
        reason: reason,
        emailData: emailData
    };
}

// Thay th·∫ø to√†n b·ªô h√†m getAllSheetData c≈© b·∫±ng h√†m n√†y
function getAllSheetData(sheet) {
  if (!sheet || sheet.getLastRow() < 2) {
    return [];
  }
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  const formulas = dataRange.getFormulas();
  const headers = values[0].map(header => header.trim());
  const data = [];

  // ‚ñº‚ñº‚ñº B·∫ÆT ƒê·∫¶U THAY ƒê·ªîI QUAN TR·ªåNG ‚ñº‚ñº‚ñº
  // X√°c ƒë·ªãnh c√°c c·ªôt ch·ª©a ng√†y th√°ng
  const dateColumns = ["Ng√†y c·ªçc", "Th·ªùi gian nh·∫≠p", "Th·ªùi gian gh√©p", "Ng√†y xu·∫•t h√≥a ƒë∆°n"];
  const dateColumnIndices = {};
  headers.forEach((header, index) => {
    if (dateColumns.includes(header)) {
      dateColumnIndices[index] = true;
    }
  });
  // ‚ñ≤‚ñ≤‚ñ≤ K·∫æT TH√öC THAY ƒê·ªîI QUAN TR·ªåNG ‚ñ≤‚ñ≤‚ñ≤

  for (let i = 1; i < values.length; i++) {
    const rowObject = {};
    for (let j = 0; j < headers.length; j++) {
      const headerName = headers[j];
      const formula = formulas[i][j];
      let cellValue = values[i][j];

      // ‚ñº‚ñº‚ñº B·∫ÆT ƒê·∫¶U THAY ƒê·ªîI QUAN TR·ªåNG ‚ñº‚ñº‚ñº
      // N·∫øu ƒë√¢y l√† c·ªôt ng√†y th√°ng v√† gi√° tr·ªã l√† m·ªôt ƒë·ªëi t∆∞·ª£ng Date h·ª£p l·ªá,
      // chuy·ªÉn n√≥ sang ƒë·ªãnh d·∫°ng ISO string m√† JavaScript c√≥ th·ªÉ ƒë·ªçc d·ªÖ d√†ng.
      if (dateColumnIndices[j] && cellValue instanceof Date && !isNaN(cellValue)) {
        cellValue = cellValue.toISOString();
      }
      // ‚ñ≤‚ñ≤‚ñ≤ K·∫æT TH√öC THAY ƒê·ªîI QUAN TR·ªåNG ‚ñ≤‚ñ≤‚ñ≤

      if (formula && formula.toUpperCase().startsWith("=HYPERLINK")) {
        const urlMatch = formula.match(/=HYPERLINK\("([^"]+)"/i);
        if (urlMatch && urlMatch[1]) {
          rowObject[headerName] = urlMatch[1];
        } else {
          rowObject[headerName] = "";
        }
      } else {
        rowObject[headerName] = cellValue;
      }
    }
    data.push(rowObject);
  }
  return data;
}

function matchCarAutomatically(dongXe, phienBan, ngoaiThat, noiThat, stockSheet) {
  try {
    const stockData = stockSheet.getDataRange().getValues();
    const headers = SHEET_HEADERS["KhoXe"];
    const vinCol = headers.indexOf("VIN");
    const statusCol = headers.indexOf("Tr·∫°ng th√°i");
    const dongXeCol = headers.indexOf("D√≤ng xe");
    const phienBanCol = headers.indexOf("Phi√™n b·∫£n");
    const ngoaiThatCol = headers.indexOf("Ngo·∫°i th·∫•t");
    const noiThatCol = headers.indexOf("N·ªôi th·∫•t");
    const maDMSCol = headers.indexOf("M√£ DMS");
    const ngayNhapCol = headers.indexOf("Ng√†y nh·∫≠p");

    if ([vinCol, statusCol, dongXeCol, phienBanCol, ngoaiThatCol, noiThatCol, maDMSCol, ngayNhapCol].some(col => col === -1)) {
      logAction("L·ªói Gh√©p T·ª± ƒê·ªông", "Sheet 'KhoXe' thi·∫øu m·ªôt ho·∫∑c nhi·ªÅu c·ªôt c·∫ßn thi·∫øt.");
      return null;
    }

    const matchingCars = [];
    const normalizedRequestDongXe = normalizeForComparison(dongXe);
    const normalizedRequestPhienBan = normalizeForComparison(phienBan);
    const normalizedRequestNgoaiThat = normalizeForComparison(ngoaiThat);
    const normalizedRequestNoiThat = normalizeForComparison(noiThat);

    for (let i = 1; i < stockData.length; i++) {
      const row = stockData[i];
      const carStatus = normalizeForComparison(row[statusCol]);
      
      if (carStatus === "ch∆∞a gh√©p") {
        const carDongXe = normalizeForComparison(row[dongXeCol]);
        const carPhienBan = normalizeForComparison(row[phienBanCol]);
        const carNgoaiThat = normalizeForComparison(row[ngoaiThatCol]);
        const carNoiThat = normalizeForComparison(row[noiThatCol]);

        if (carDongXe === normalizedRequestDongXe &&
            carPhienBan === normalizedRequestPhienBan &&
            carNgoaiThat === normalizedRequestNgoaiThat &&
            carNoiThat === normalizedRequestNoiThat) {
          
          matchingCars.push({
            vin: String(row[vinCol]).trim(),
            maDMS: row[maDMSCol] || "",
            rowIndex: i + 1,
            ngayNhap: new Date(row[ngayNhapCol] || 0)
          });
        }
      }
    }

    if (matchingCars.length > 0) {
      // S·∫Øp x·∫øp ƒë·ªÉ ∆∞u ti√™n xe nh·∫≠p kho s·ªõm nh·∫•t (FIFO)
      matchingCars.sort((a, b) => a.ngayNhap - b.ngayNhap);
      const oldestMatchedCar = matchingCars[0];

      // C·∫≠p nh·∫≠t tr·∫°ng th√°i xe trong kho th√†nh "ƒê√£ gh√©p"
      stockSheet.getRange(oldestMatchedCar.rowIndex, statusCol + 1).setValue("ƒê√£ gh√©p");
      logAction("Gh√©p T·ª± ƒê·ªông Th√†nh C√¥ng", `ƒê√£ gh√©p VIN ${oldestMatchedCar.vin} cho y√™u c·∫ßu: ${dongXe} - ${phienBan}.`);

      return {
        vin: oldestMatchedCar.vin,
        maDMS: oldestMatchedCar.maDMS,
        rowIndex: oldestMatchedCar.rowIndex,
        statusColIndex: statusCol + 1
      };
    }

    logAction("Kh√¥ng T√¨m Th·∫•y Xe (T·ª± ƒê·ªông)", `Kh√¥ng c√≥ xe n√†o ph√π h·ª£p trong kho cho y√™u c·∫ßu: ${dongXe} - ${phienBan} - ${ngoaiThat}.`);
    return null; // Tr·∫£ v·ªÅ null n·∫øu kh√¥ng t√¨m th·∫•y xe ph√π h·ª£p

  } catch (e) {
    logAction("L·ªói Nghi√™m Tr·ªçng (Gh√©p T·ª± ƒê·ªông)", e.message);
    sendErrorAlert('matchCarAutomatically', e);
    return null;
  }
}
function createFullHtmlEmail(emailTitle, bodyContent) {
  return `<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${emailTitle}</title>
    <style>
        /* --- BASE STYLES --- */
        body, table, td, th { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; font-family: 'Roboto', Arial, sans-serif; }
        table { border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; }
        body { margin: 0; padding: 0; width: 100%; height: 100% !important; background-color: #f0f8ff; }
        img { -ms-interpolation-mode: bicubic; border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; }

        /* --- WINTER THEME COLORS --- */
        :root {
            --deep-blue: #0A638D;
            --light-blue: #5AC3E2;
            --background-icy: #e0f2f7;
            --text-color-dark: #3a4750;
            --highlight-icy: #C8E6F0;
            --dark-icy: #0A638D;
        }
        
        .email-wrapper { 
            background-color: #e0f2f7;
            padding: 40px 10px;
        }
        
        .email-container { 
            max-width: 600px; 
            margin: 0 auto; 
            border-radius: 12px;
            overflow: hidden; 
            box-shadow: 0 10px 25px rgba(10, 99, 141, 0.2);
            border: 1px solid #B3E5FC;
            background: linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.9)), url('https://wallpapershome.com/images/pages/pic_v/26912.jpg');
            background-repeat: no-repeat;
            background-position: center top;
            background-size: cover; 
            background-color: #ffffff; /* Fallback */
        }
        
        .header-cell { 
            background-color: rgba(10, 99, 141, 0.95);
            color: #ffffff; 
            padding: 30px 25px; 
            text-align: center; 
            border-bottom: 5px solid #5AC3E2;
        }
        
        .header-title { 
            margin: 0; 
            font-size: 22px; 
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        
        .content-cell { 
            padding: 30px 25px; 
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .content-title { 
            color: #0A638D; 
            font-size: 20px; 
            margin-top: 0; 
            margin-bottom: 20px;
            border-left: 4px solid #5AC3E2;
            padding-left: 12px;
        }
        
        .paragraph { 
            color: #3a4750; 
            font-size: 16px; 
            line-height: 1.6; 
            margin: 0 0 20px 0; 
        }
        
        .details-table { 
            width: 100%; 
            border: 1px solid #B3E5FC; 
            border-radius: 8px; 
            margin-bottom: 25px; 
            overflow: hidden;
            border-collapse: separate;
            border-spacing: 0;
            background-color: #ffffff;
        }
        
        .details-row td { border-bottom: 1px solid #E1F5FE; }
        .details-row:last-child td { border-bottom: none; }
        
        .key-cell { 
            padding: 12px 15px; 
            color: #0A638D; 
            font-weight: 600; 
            width: 150px; 
            background-color: #f8fcff;
            vertical-align: top; 
            border-right: 1px solid #E1F5FE;
        }
        
        .value-cell { 
            padding: 12px 15px; 
            color: #333; 
            vertical-align: top; 
            background-color: #ffffff;
        }
        
        /* Highlight VIN */
        .vin-highlight td { background-color: #C8E6F0 !important; }
        .vin-highlight .key-cell { color: #0A638D; background-color: transparent; border-right: 1px solid #a9d4e6;}
        .vin-highlight .value-cell { color: #0A638D; font-weight: 800; background-color: transparent; }
        
        .footer-cell { 
            background-color: rgba(10, 99, 141, 0.95);
            padding: 25px; 
            text-align: center; 
            font-size: 13px; 
            color: #ffffff; 
            border-top: 1px solid #ECEFF1;
        }
        
        .snowflake-greeting { 
            margin-top: 15px; 
            font-size: 14px; 
            color: #ffffff; 
            font-weight: bold; 
        }
        .snowflake { font-size: 18px; margin: 0 5px; color: #5AC3E2; }
        
        /* Utility Classes mapped from original logic */
        .warning { color: #d32f2f; border-left-color: #d32f2f; }
        .info { color: #0A638D; border-left-color: #5AC3E2; }
        
    </style>
</head>
<body>
    ${bodyContent}
</body>
</html>`;
}
function createUnifiedEmailBody(title, recipientName, details, note, titleClass = '', hideFooter = false) {
  let detailsHtml = '';
  
  // T·∫°o c√°c d√≤ng trong b·∫£ng chi ti·∫øt
  for (const key in details) {
    if (details.hasOwnProperty(key)) {
      // Ki·ªÉm tra xem d√≤ng n√†y c√≥ ph·∫£i l√† VIN kh√¥ng ƒë·ªÉ highlight
      const isVin = key.toLowerCase() === 'vin' || 
                    key.toLowerCase() === 's·ªë vin' || 
                    key.toLowerCase() === 'vin ƒë√£ h·ªßy' ||
                    key.toLowerCase() === 'xe m·ªõi ƒë√£ v·ªÅ'; // Th√™m case cho email b√°o xe v·ªÅ
      
      const rowClass = isVin ? 'details-row vin-highlight' : 'details-row';
      
      detailsHtml += `
        <tr class="${rowClass}">
            <td class="key-cell">${key}:</td>
            <td class="value-cell">${details[key]}</td>
        </tr>`;
    }
  }

  // X√¢y d·ª±ng HTML footer (Tuy·∫øt r∆°i)
  let footerHtml = '';
  if (!hideFooter) {
    footerHtml = `
      <tr>
        <td class="footer-cell">
            <p style="margin-bottom: 5px; color: #ffffff;">Tr√¢n tr·ªçng.</p>
            <p style="margin: 0; font-size: 11px; color: #E1F5FE;">ƒê√¢y l√† email t·ª± ƒë·ªông, vui l√≤ng kh√¥ng tr·∫£ l·ªùi.</p>
            
            <div class="snowflake-greeting">
                <span class="snowflake">‚ùÑÔ∏è</span> Ch√∫c b·∫°n m·ªôt m√πa Gi√°ng sinh an l√†nh & ·∫•m √°p! <span class="snowflake">‚ùÑÔ∏è</span>
            </div>
        </td>
      </tr>
    `;
  } else {
      // N·∫øu hideFooter=true (v√≠ d·ª• email x√°c th·ª±c), v·∫´n gi·ªØ style n·ªÅn nh∆∞ng b·ªè text
      footerHtml = `<tr><td class="footer-cell"></td></tr>`; 
  }

  // Gh√©p to√†n b·ªô c·∫•u tr√∫c
  return `
    <div class="email-wrapper">
        <table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td>
            <table align="center" width="600" border="0" cellspacing="0" cellpadding="0" class="email-container">
                <tr>
                    <td class="header-cell">
                        <h1 class="header-title">‚òÉÔ∏è TH√îNG B√ÅO H·ªÜ TH·ªêNG ‚òÉÔ∏è</h1>
                    </td>
                </tr>
                
                <tr>
                    <td class="content-cell">
                        <h2 class="content-title ${titleClass}">${title}</h2>
                        
                        <p class="paragraph">Xin ch√†o <b>${recipientName}</b>,</p>
                        
                        <table class="details-table">
                            ${detailsHtml}
                        </table>
                        
                        <div class="paragraph">
                            ${note}
                        </div>
                    </td>
                </tr>
                
                ${footerHtml}
            </table>
        </td></tr></table>
    </div>
  `;
}
function createOverdueWarningEmailBody(title, recipientName, orders, note) {
  let ordersHtml = `
    <tr class="details-row">
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left; background-color: #f0f4f8;">STT</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left; background-color: #f0f4f8;">S·ªë ƒë∆°n h√†ng</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left; background-color: #f0f4f8;">Kh√°ch h√†ng</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left; background-color: #f0f4f8;">S·ªë VIN</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: center; background-color: #f0f4f8;">S·ªë ng√†y gh√©p</th>
    </tr>`;
  orders.forEach((order, index) => {
    ordersHtml += `
      <tr class="details-row">
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${index + 1}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${order.so_don_hang}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${order.ten_khach_hang}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${order.vin}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1; text-align: center; font-weight: bold; color: #dc3545;">${order.so_ngay_ghep}</td>
      </tr>`;
  });

  return `
    <div class="email-wrapper">
      <table class="email-container" width="100%" border="0" cellspacing="0" cellpadding="0">
        <thead><tr><th class="header-cell"><h1 class="header-title">Th√¥ng B√°o H·ªá Th·ªëng</h1></th></tr></thead>
        <tbody>
          <tr>
            <td class="content-cell">
              <h2 class="content-title warning">${title}</h2>
              <p class="paragraph">Xin ch√†o <b>${recipientName}</b>,</p>
              <p class="paragraph">H·ªá th·ªëng ghi nh·∫≠n c√°c ƒë∆°n h√†ng d∆∞·ªõi ƒë√¢y ƒë√£ gh√©p xe <b>4 ng√†y tr·ªü l√™n</b> nh∆∞ng ch∆∞a ƒë∆∞·ª£c xu·∫•t h√≥a ƒë∆°n. Anh/Ch·ªã vui l√≤ng ki·ªÉm tra v√† x·ª≠ l√Ω s·ªõm:</p>
              <table class="details-table" width="100%" border="0" cellspacing="0" cellpadding="0">${ordersHtml}</table>
              <p class="paragraph" style="margin-top: 25px;">${note}</p>
            </td>
          </tr>
          <tr><td class="footer-cell"><p>ƒê√¢y l√† email t·ª± ƒë·ªông, vui l√≤ng kh√¥ng tr·∫£ l·ªùi.</p><p style="margin-top: 5px;">Tr√¢n tr·ªçng.</p></td></tr>
        </tbody>
      </table>
    </div>`;
}

/**
 * T·∫†O N·ªòI DUNG EMAIL XE M·ªöI NH·∫¨P KHO (H√ÄM M·ªöI)
 * T√°ch logic t·∫°o HTML ra kh·ªèi h√†m sendNewCarNotifications.
 */
function createNewCarNotificationBody(newCars) {
  let carsHtml = `
    <tr class="details-row">
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left; background-color: #f0f4f8;">STT</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left; background-color: #f0f4f8;">D√≤ng xe</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left; background-color: #f0f4f8;">Phi√™n b·∫£n</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left; background-color: #f0f4f8;">Ngo·∫°i th·∫•t</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left; background-color: #f0f4f8;">N·ªôi th·∫•t</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left; background-color: #f0f4f8;">S·ªë VIN</th>
    </tr>`;
  newCars.forEach((car, index) => {
    carsHtml += `
      <tr class="details-row">
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${index + 1}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${car.dong_xe}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${car.phien_ban}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${car.ngoai_that}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${car.noi_that}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1; font-weight: 600;">${car.vin}</td>
      </tr>`;
  });

  return `
    <div class="email-wrapper">
      <table class="email-container" width="100%" border="0" cellspacing="0" cellpadding="0" style="max-width: 800px;">
        <thead><tr><th class="header-cell"><h1 class="header-title">Th√¥ng B√°o H·ªá Th·ªëng</h1></th></tr></thead>
        <tbody>
          <tr>
            <td class="content-cell">
              <h2 class="content-title info">Danh S√°ch Xe M·ªõi Nh·∫≠p Kho</h2>
              <p class="paragraph">Xin ch√†o Qu√Ω Anh/Ch·ªã T∆∞ v·∫•n b√°n h√†ng,</p>
              <p class="paragraph">H·ªá th·ªëng ghi nh·∫≠n c√≥ <b>${newCars.length} xe m·ªõi</b> v·ª´a ƒë∆∞·ª£c nh·∫≠p kho v√† s·∫µn s√†ng ƒë·ªÉ gh√©p. Th√¥ng tin chi ti·∫øt nh∆∞ sau:</p>
              <table class="details-table" width="100%" border="0" cellspacing="0" cellpadding="0">${carsHtml}</table>
            </td>
          </tr>
          <tr><td class="footer-cell"><p>ƒê√¢y l√† email t·ª± ƒë·ªông, vui l√≤ng kh√¥ng tr·∫£ l·ªùi.</p></td></tr>
        </tbody>
      </table>
    </div>`;
}
function formatDateTimeForSheet(date) {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) { // Added instanceof Date check
    return "";
  }
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}

function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function getCharCodes(str) {
  return Array.from(str).map(char => char.charCodeAt(0)).join(',');
}

function formatDate(date) {
  return date ? Utilities.formatDate(new Date(date), "GMT+7", "dd/MM/yyyy") : "";
}

function formatDateTime(date) {
  return date ? Utilities.formatDate(new Date(date), "GMT+7", "dd/MM/yyyy HH:mm:ss") : "";
}

function removeDiacritics(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ƒë/g, "d").replace(/ƒê/g, "D");
}

function normalizeString(str) {
  return String(str)
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

function getEmailForAdvisor(mailSheet, advisorName) {
  if (!advisorName) {
    logAction("L·ªói getEmailForAdvisor", "T√™n t∆∞ v·∫•n r·ªóng ho·∫∑c kh√¥ng x√°c ƒë·ªãnh");
    return null;
  }
  if (!mailSheet) {
    logAction("L·ªói getEmailForAdvisor", "mailSheet kh√¥ng t·ªìn t·∫°i");
    return null;
  }

  const data = mailSheet.getDataRange().getValues();
  if (data.length <= 1) {
    logAction("L·ªói getEmailForAdvisor", "mailSheet kh√¥ng c√≥ d·ªØ li·ªáu (ch·ªâ c√≥ header ho·∫∑c tr·ªëng)");
    return null;
  }

  const normalizedAdvisorName = normalizeString(advisorName);

  for (let i = 1; i < data.length; i++) {
    const sheetAdvisorName = normalizeString(String(data[i][0] || ""));
    const email = String(data[i][1] || "").trim();

    if (sheetAdvisorName === normalizedAdvisorName) {
      if (email) {
        return email;
      } else {
        logAction("L·ªói getEmailForAdvisor", `T∆∞ v·∫•n: '${advisorName}' c√≥ email r·ªóng t·∫°i d√≤ng ${i + 1}`);
        return null;
      }
    }
  }

  logAction("L·ªói getEmailForAdvisor", `Kh√¥ng t√¨m th·∫•y email cho t∆∞ v·∫•n '${advisorName}'`);
  return null;
}

/**
 * G·ª≠i email th√¥ng b√°o gh√©p xe th√†nh c√¥ng.
 * So s√°nh M√£ DMS v·ªõi 6 k√Ω t·ª± ƒë·∫ßu c·ªßa S·ªë ƒë∆°n h√†ng ƒë·ªÉ ƒë∆∞a ra c·∫£nh b√°o n·∫øu c·∫ßn.
 * @param {Sheet} mailSheet - Sheet ch·ª©a email c·ªßa t∆∞ v·∫•n vi√™n.
 * @param {Object} data - D·ªØ li·ªáu c·ªßa ƒë∆°n h√†ng (ch·ª©a so_don_hang).
 * @param {string} vin - S·ªë VIN c·ªßa xe ƒë√£ gh√©p.
 * @param {string} maDMS - M√£ DMS c·ªßa xe ƒë√£ gh√©p.
 * @param {Date} timestamp - Th·ªùi gian th·ª±c hi·ªán gh√©p.
 * @returns {boolean} - Tr·∫£ v·ªÅ true n·∫øu g·ª≠i th√†nh c√¥ng.
 */
function sendEmailNotification(mailSheet, data, vin, maDMS, timestamp) {
  const tenTVBH = data.ten_ban_hang;
  const ngayGhep = formatDateTimeForSheet(timestamp); 
  const subject = `[TH√îNG BAÃÅO] V/v Gh√©p xe th√†nh c√¥ng cho ƒê∆°n h√†ng ${data.so_don_hang}`; 
  const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);

  if (!recipientEmail) { 
    logAction("L·ªói g·ª≠i email gh√©p", `Kh√¥ng t√¨m th·∫•y email cho ${tenTVBH}, ƒë∆°n ${data.so_don_hang}`);
    return false; 
  }

  // Kh·ªüi t·∫°o c√°c chi ti·∫øt c∆° b·∫£n c·ªßa ƒë∆°n h√†ng
  const details = {
   "S·ªë ƒë∆°n h√†ng": `<b>${data.so_don_hang}</b>`, 
   "T√™n kh√°ch h√†ng": data.ten_khach_hang, 
   "D√≤ng xe": data.dong_xe,
   "Phi√™n b·∫£n": data.phien_ban, 
   "Ngo·∫°i th·∫•t": data.ngoai_that, 
   "N·ªôi th·∫•t": data.noi_that, 
   "Ng√†y c·ªçc": (data.ngay_coc instanceof Date) ? 
        formatDateTimeForSheet(data.ngay_coc) : String(data.ngay_coc || ""),
   "Th·ªùi gian gh√©p": ngayGhep, 
    "VIN": vin 
  };

  // Ghi ch√∫ m·∫∑c ƒë·ªãnh
  let note = "Vui l√≤ng ki·ªÉm tra v√† x√°c nh·∫≠n th√¥ng tin. Tr√¢n tr·ªçng."; 

  // --- LOGIC M·ªöI: So s√°nh S·ªë ƒë∆°n h√†ng v√† M√£ DMS ---
  const dmsCode = String(maDMS || "").trim();
  
  // Ch·ªâ th·ª±c hi·ªán logic n·∫øu c√≥ M√£ DMS
  if (dmsCode) {
    // Lu√¥n hi·ªÉn th·ªã M√£ DMS n·∫øu c√≥
    details["M√£ DMS"] = `<b>${dmsCode}</b>`;

    const orderPrefix = String(data.so_don_hang || "").trim().substring(0, 6);

    // N·∫øu 6 k√Ω t·ª± ƒë·∫ßu c·ªßa SƒêH kh√¥ng kh·ªõp v·ªõi M√£ DMS, thay ƒë·ªïi ghi ch√∫ th√†nh c·∫£nh b√°o
    if (orderPrefix.toUpperCase() !== dmsCode.toUpperCase()) {
      note = `<b style="color: red;">C·∫¢NH B√ÅO: M√£ ƒë∆°n h√†ng (${orderPrefix}) kh√¥ng kh·ªõp v·ªõi M√£ DMS (${dmsCode}).</b><br>Vui l√≤ng ki·ªÉm tra v√† l√™n ƒë∆°n h√†ng theo ƒë√∫ng M√£ DMS ƒë∆∞·ª£c cung c·∫•p.`;
    }
    // N·∫øu kh·ªõp, ghi ch√∫ m·∫∑c ƒë·ªãnh s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng ("kh√¥ng c·∫ßn note" ƒë·∫∑c bi·ªát).
  }
  // --- K·∫æT TH√öC LOGIC M·ªöI ---

  const bodyContent = createUnifiedEmailBody(`ƒê∆°n h√†ng c·ªßa Anh/Ch·ªã ƒë√£ ƒë∆∞·ª£c gh√©p VIN th√†nh c√¥ng:`, tenTVBH, details, note);
  const fullHtml = createFullHtmlEmail(subject, bodyContent); 

  try {
    MailApp.sendEmail({ to: recipientEmail, subject: subject, htmlBody: fullHtml }); 
    logAction("G·ª≠i email gh√©p th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho ƒë∆°n ${data.so_don_hang}, VIN ${vin}`);
    return true; 
  } catch (e) {
    logAction("L·ªói g·ª≠i email gh√©p", `Email: ${recipientEmail}, ƒê∆°n: ${data.so_don_hang}, L·ªói: ${e.message}`);
    return false; 
  }
}

function sendPendingEmail(mailSheet, data, timestamp) {
  const tenTVBH = data.ten_ban_hang;
  const thoiGianNhapFormatted = formatDateTimeForSheet(timestamp);
  const subject = `[H·ªÜ TH·ªêNG] ƒê√£ ti·∫øp nh·∫≠n y√™u c·∫ßu gh√©p xe cho ƒê∆°n h√†ng ${data.so_don_hang}`;
  const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);

  if (!recipientEmail) {
    logAction("L·ªói g·ª≠i email ch·ªù gh√©p", `Kh√¥ng t√¨m th·∫•y email cho ${tenTVBH}, ƒë∆°n ${data.so_don_hang}`);
    return false;
  }

  const details = {
    "S·ªë ƒë∆°n h√†ng": `<b>${data.so_don_hang}</b>`,
    "T√™n kh√°ch h√†ng": data.ten_khach_hang,
    "D√≤ng xe": data.dong_xe,
    "Phi√™n b·∫£n": data.phien_ban,
    "Ngo·∫°i th·∫•t": data.ngoai_that,
    "N·ªôi th·∫•t": data.noi_that,
    "Ng√†y c·ªçc": (data.ngay_coc instanceof Date) ? formatDateTimeForSheet(data.ngay_coc) : String(data.ngay_coc || ""),
    "Th·ªùi gian nh·∫≠p": thoiGianNhapFormatted
  };
  const note = "H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√¨m xe ph√π h·ª£p. Vui l√≤ng ch·ªù ho·∫∑c li√™n h·ªá Admin n·∫øu c·∫ßn h·ªó tr·ª£.";

  const bodyContent = createUnifiedEmailBody("ƒê∆°n h√†ng sau ƒëang trong tr·∫°ng th√°i ch·ªù gh√©p VIN:", tenTVBH, details, note);
  const fullHtml = createFullHtmlEmail(subject, bodyContent);

  try {
    MailApp.sendEmail({ to: recipientEmail, subject: subject, htmlBody: fullHtml });
    logAction("G·ª≠i email ch·ªù gh√©p th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho ƒë∆°n ${data.so_don_hang}`);
    return true;
  } catch (e) {
    logAction("L·ªói g·ª≠i email ch·ªù gh√©p", `Email: ${recipientEmail}, ƒê∆°n: ${data.so_don_hang}, L·ªói: ${e.message}`);
    return false;
  }
}
/**
 * G·ª≠i email th√¥ng b√°o h·ªßy gh√©p VIN.
 * T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh n·ªôi dung email d·ª±a tr√™n vi·ªác c√≥ th√¥ng tin ng∆∞·ªùi h·ªßy hay kh√¥ng.
 * @param {Sheet} mailSheet - Sheet 'Mail' ƒë·ªÉ tra c·ª©u email.
 * @param {Object} data - D·ªØ li·ªáu c∆° b·∫£n c·ªßa ƒë∆°n h√†ng.
 * @param {string} vin - S·ªë VIN ƒë√£ ƒë∆∞·ª£c h·ªßy gh√©p.
 * @param {Date} timestamp - Th·ªùi gian th·ª±c hi·ªán h·ªßy.
 * @param {string | null} cancelledBy - Email c·ªßa ng∆∞·ªùi h·ªßy. N·∫øu l√† null, tr∆∞·ªùng n√†y s·∫Ω b·ªã ·∫©n.
 * @param {string} reason - L√Ω do h·ªßy.
 * @returns {boolean} - Tr·∫£ v·ªÅ true n·∫øu g·ª≠i th√†nh c√¥ng.
 */
function sendCancelEmail(mailSheet, data, vin, timestamp, cancelledBy, reason) {
  const tenTVBH = data.ten_ban_hang || data.ten_tu_van_ban_hang;
  const thoiGianHuyFormatted = formatDateTimeForSheet(timestamp);
  const subject = `[TH√îNG B√ÅO] V/v h·ªßy gh√©p xe cho ƒë∆°n h√†ng c·ªßa KH ${data.ten_khach_hang}`;
  const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);

  if (!recipientEmail) {
    logAction("L·ªói g·ª≠i email h·ªßy gh√©p", `Kh√¥ng t√¨m th·∫•y email cho ${tenTVBH}, ƒë∆°n ${data.so_don_hang}`);
    return false;
  }

  // B·∫Øt ƒë·∫ßu v·ªõi c√°c chi ti·∫øt c∆° b·∫£n c·ªßa email
  const details = {
    "S·ªë ƒë∆°n h√†ng": `<b>${data.so_don_hang}</b>`,
    "T√™n kh√°ch h√†ng": data.ten_khach_hang,
    "D√≤ng xe": data.dong_xe,
    "VIN ƒë√£ h·ªßy": vin || "N/A",
    "Th·ªùi gian h·ªßy": thoiGianHuyFormatted,
  };

  // T√πy ch·ªânh hi·ªÉn th·ªã d·ª±a tr√™n vi·ªác c√≥ th√¥ng tin ng∆∞·ªùi h·ªßy hay kh√¥ng
  if (cancelledBy) {
    // N·∫øu c√≥ ng∆∞·ªùi h·ªßy (h·ªßy t·ª´ web-app), hi·ªÉn th·ªã c·∫£ 2 d√≤ng
    details["Ng∆∞·ªùi h·ªßy"] = cancelledBy;
    details["L√Ω do"] = reason;
  } else {
    // N·∫øu kh√¥ng c√≥ ng∆∞·ªùi h·ªßy (h·ªßy t·ª´ UI), ch·ªâ hi·ªÉn th·ªã l√Ω do
    details["L√Ω do h·ªßy"] = reason;
  }

  const note = "Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.";
  const bodyContent = createUnifiedEmailBody("ƒê∆°n h√†ng sau ƒë√£ ƒë∆∞·ª£c h·ªßy gh√©p VIN:", tenTVBH, details, 'Vui l√≤ng ki·ªÉm tra th√¥ng tin laÃ£i v∆°ÃÅi Admin!');
  const fullHtml = createFullHtmlEmail(subject, bodyContent);

  try {
    MailApp.sendEmail({ to: recipientEmail, subject: subject, htmlBody: fullHtml });
    logAction("G·ª≠i email h·ªßy gh√©p th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho ƒë∆°n ${data.so_don_hang}`);
    return true;
  } catch (e) {
    logAction("L·ªói g·ª≠i email h·ªßy gh√©p", `Email: ${recipientEmail}, ƒê∆°n: ${data.so_don_hang}, L·ªói: ${e.message}`);
    return false;
  }
}

function sendIssuedInvoiceWithAttachment(mailSheet, orderData, invoiceFileBlob, xuathoadonSheet, rowIndexInXuathoadon) {
  const tenTVBH = orderData.ten_tu_van_ban_hang;
  const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);
  const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];
  const ketQuaGuiMailColIndex = xuathoadonHeaders.indexOf("K·∫æT QU·∫¢ G·ª¨I MAIL");
  const ketQuaCell = xuathoadonSheet.getRange(rowIndexInXuathoadon, ketQuaGuiMailColIndex + 1);

  if (!recipientEmail) {
    const errorMsg = "L·ªói: Kh√¥ng t√¨m th·∫•y email TVBH";
    logAction("L·ªói g·ª≠i mail XHƒê (Admin Upload)", `Kh√¥ng t√¨m th·∫•y email cho TVBH '${tenTVBH}', ƒë∆°n ${orderData.so_don_hang}`);
    if (ketQuaGuiMailColIndex !== -1) {
      ketQuaCell.setValue(errorMsg);
    }
    return false;
  }

  const subject = `[H√ìA ƒê∆†N ƒê√É PH√ÅT H√ÄNH] - ƒê∆°n h√†ng ${orderData.so_don_hang} cho KH ${orderData.ten_khach_hang}`;
  const details = {
    "S·ªë ƒë∆°n h√†ng": `<b>${orderData.so_don_hang}</b>`,
    "T√™n kh√°ch h√†ng": `<b>${orderData.ten_khach_hang}</b>`,
    "S·ªë VIN": `<b>${orderData.vin}</b>`,
    "Ng√†y xu·∫•t h√≥a ƒë∆°n": `<b>${formatDateTimeForSheet(new Date())}</b>`,
    "D√≤ng xe": orderData.dong_xe,
    "Phi√™n b·∫£n": orderData.phien_ban,
    "Ngo·∫°i th·∫•t": orderData.ngoai_that,
    "N·ªôi th·∫•t": orderData.noi_that
  };
  const note = "H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ƒë√£ ƒë∆∞·ª£c ph√°t h√†nh v√† ƒë√≠nh k√®m trong email n√†y. Anh/Ch·ªã vui l√≤ng t·∫£i v·ªÅ v√† g·ª≠i cho kh√°ch h√†ng. Tr√¢n tr·ªçng!";
  const bodyContent = createUnifiedEmailBody("H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c ph√°t h√†nh th√†nh c√¥ng!", tenTVBH, details, note, 'info');
  const fullHtml = createFullHtmlEmail(subject, bodyContent);

  try {
    const customerName = orderData.ten_khach_hang || 'KHONG_XAC_DINH';
    const sanitizedCustomerName = customerName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ƒë/g, "d").replace(/ƒê/g, "D").replace(/[^\w\s-]/g, '').trim();
    const originalFileName = invoiceFileBlob.getName();
    const extension = originalFileName.includes('.') ? originalFileName.substring(originalFileName.lastIndexOf('.')) : '';
    const newFileName = `H√≥a ƒë∆°n ${sanitizedCustomerName}${extension}`;
    
    invoiceFileBlob.setName(newFileName);
    logAction("ƒê·ªïi t√™n file ƒë√≠nh k√®m", `ƒê√£ ƒë·ªïi t√™n file h√≥a ƒë∆°n cho ƒêH ${orderData.so_don_hang} th√†nh "${newFileName}"`);
  } catch (e) {
      logAction("L·ªói ƒë·ªïi t√™n file", `Kh√¥ng th·ªÉ ƒë·ªïi t√™n file cho ƒêH ${orderData.so_don_hang}: ${e.message}`);
  }

  try {
    MailApp.sendEmail({
      to: recipientEmail,
      subject: subject,
      htmlBody: fullHtml,
      attachments: [invoiceFileBlob]
    });
    logAction("G·ª≠i mail XHƒê (Admin Upload) th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho ƒë∆°n ${orderData.so_don_hang}`);
    if (ketQuaGuiMailColIndex !== -1) {
      ketQuaCell.setValue("ƒê√£ g·ª≠i (Admin)");
    }
    return true;
  } catch (e) {
    const errorMsg = `L·ªói g·ª≠i mail: ${e.message.substring(0, 100)}`;
    logAction("L·ªói g·ª≠i mail XHƒê (Admin Upload)", `Email: ${recipientEmail}, ƒê∆°n: ${orderData.so_don_hang}, L·ªói: ${e.message}`);
    if (ketQuaGuiMailColIndex !== -1) {
      ketQuaCell.setValue(errorMsg);
    }
    return false;
  }
}
function sendInvoiceNotification(sheet, row) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = getSheets(ss);
  const mailSheet = sheets.mailSheet;
  const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];
  const KET_QUA_GUI_MAIL_HEADER = "K·∫æT QU·∫¢ G·ª¨I MAIL";
  const ketQuaGuiMailColIndex = xuathoadonHeaders.indexOf(KET_QUA_GUI_MAIL_HEADER);
  try {
    const dataRowValues = sheet.getRange(row, 1, 1, xuathoadonHeaders.length).getValues()[0];
    const invoiceData = {};
    xuathoadonHeaders.forEach((header, index) => invoiceData[header] = dataRowValues[index]);
    const tenTuVan = invoiceData["T∆Ø V·∫§N B√ÅN H√ÄNG"];
    const recipientEmail = getEmailForAdvisor(mailSheet, tenTuVan);

    if (!recipientEmail) {
      logAction("L·ªói g·ª≠i mail XHƒê (sendInvoiceNotification)", `Kh√¥ng t√¨m th·∫•y email cho TVBH '${tenTuVan}', ƒë∆°n ${invoiceData["S·ªê ƒê∆†N H√ÄNG"]}`);
      if (ketQuaGuiMailColIndex !== -1) {
        sheet.getRange(row, ketQuaGuiMailColIndex + 1).setValue("L·ªói: Kh√¥ng t√¨m th·∫•y email TVBH");
      }
      return;
    }

    const subject = `[H√ìA ƒê∆†N PH√ÅT H√ÄNH] KH ${invoiceData["T√äN KH√ÅCH H√ÄNG"]} (VIN ${invoiceData["S·ªê VIN"]})`;
    const ngayXuatHDFormatted = (invoiceData["NG√ÄY XU·∫§T H√ìA ƒê∆†N"] instanceof Date)
      ? Utilities.formatDate(invoiceData["NG√ÄY XU·∫§T H√ìA ƒê∆†N"], Session.getScriptTimeZone(), "dd/MM/yyyy")
      : "N/A";

    const details = {
      "S·ªë ƒë∆°n h√†ng": `<b>${invoiceData["S·ªê ƒê∆†N H√ÄNG"]}</b>`,
      "T√™n kh√°ch h√†ng": `<b>${invoiceData["T√äN KH√ÅCH H√ÄNG"]}</b>`,
      "VIN": `<b>${invoiceData["S·ªê VIN"]}</b>`,
      "Ng√†y xu·∫•t h√≥a ƒë∆°n": `<b>${ngayXuatHDFormatted}</b>`,
      "D√≤ng xe": invoiceData["D√íNG XE"],
      "Phi√™n b·∫£n": invoiceData["PHI√äN B·∫¢N"],
      "Ngo·∫°i th·∫•t": invoiceData["NGO·∫†I TH·∫§T"],
      "N·ªôi th·∫•t": invoiceData["N·ªòI TH·∫§T"]
    };
    const note = "Vui l√≤ng li√™n h·ªá b·ªô ph·∫≠n K·∫ø to√°n ƒë·ªÉ nh·∫≠n h√≥a ƒë∆°n.";

    const bodyContent = createUnifiedEmailBody(`ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c xu·∫•t h√≥a ƒë∆°n th√†nh c√¥ng:`, tenTuVan, details, note);
    const fullHtml = createFullHtmlEmail(subject, bodyContent);

    MailApp.sendEmail({ to: recipientEmail, subject: subject, htmlBody: fullHtml });
    logAction("G·ª≠i mail XHƒê th√†nh c√¥ng (sendInvoiceNotification)", `T·ªõi ${recipientEmail} cho ƒë∆°n ${invoiceData["S·ªê ƒê∆†N H√ÄNG"]}`);
    if (ketQuaGuiMailColIndex !== -1) {
      sheet.getRange(row, ketQuaGuiMailColIndex + 1).setValue("ƒê√£ g·ª≠i");
    }
  } catch (e) {
    Logger.log(`sendInvoiceNotification: L·ªói nghi√™m tr·ªçng khi g·ª≠i email ho·∫∑c c·∫≠p nh·∫≠t sheet cho d√≤ng ${row}: ${e.message}. Stack: ${e.stack}`);
    logAction("L·ªói g·ª≠i mail XHƒê (sendInvoiceNotification)", `D√≤ng ${row}, L·ªói: ${e.message}`);
    if (ketQuaGuiMailColIndex !== -1) {
      sheet.getRange(row, ketQuaGuiMailColIndex + 1).setValue(`L·ªói g·ª≠i: ${e.message.substring(0, 50)}`);
    }
  }
}
// Thay th·∫ø h√†m recordOrderHistory c≈©
function recordOrderHistory(soDonHang, vin, action, details, rowDataObject = null) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = getOrCreateSheet(ss, "lichsu_donhang", SHEET_HEADERS["lichsu_donhang"]);
  const timestamp = new Date();
  const user = Session.getActiveUser() ? Session.getActiveUser().getEmail() : "H·ªá th·ªëng";
  const jsonData = rowDataObject ? JSON.stringify(rowDataObject) : "";
  sheet.appendRow([timestamp, soDonHang, vin, action, details, user, jsonData]);
}

// Thay th·∫ø h√†m recordVehicleHistory c≈©
function recordVehicleHistory(vin, action, details, rowDataObject = null) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = getOrCreateSheet(ss, "lichsu_xe", SHEET_HEADERS["lichsu_xe"]);
  const timestamp = new Date();
  const user = Session.getActiveUser() ? Session.getActiveUser().getEmail() : "H·ªá th·ªëng";
  const jsonData = rowDataObject ? JSON.stringify(rowDataObject) : "";
  sheet.appendRow([timestamp, vin, action, details, user, jsonData]);
}

function logAction(action, details) {
  const actionsToLog = [
    "Gh√©p xe th·ªß c√¥ng",
    "G·ª≠i email",
    "L·ªói",
    "Th√™m v√†o chuaghep",
    "H·ªßy gh√©p",
    "T·∫°o b√°o c√°o chi ti·∫øt",
    "X√≥a ƒë∆°n h√†ng",
    "T√¨m ki·∫øm",
    "G·ª≠i c·∫£nh b√°o qu√° h·∫°n",
    "G·ª≠i email xe m·ªõi nh·∫≠p kho",
    "X√≥a Xe Kh·ªèi Kho",
    "Ph·ª•c H·ªìi Xe V√†o Kho",
    "Xu·∫•t h√≥a ƒë∆°n",
    "H·ªßy xu·∫•t h√≥a ƒë∆°n",
    "C·∫≠p nh·∫≠t tr·∫°ng th√°i khoxe"
  ];

  if (!actionsToLog.some(keyword => action.includes(keyword))) {
    // return; // Commented out to log more actions if needed for debugging
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const logSheet = getOrCreateSheet(ss, "log", SHEET_HEADERS["log"]);
  if (!logSheet) return;

  const maxLogRows = 1000;
  const currentRows = logSheet.getLastRow();
  if (currentRows > maxLogRows) {
    logSheet.deleteRows(2, currentRows - maxLogRows);
  }

  const timestamp = new Date();
  logSheet.appendRow([
    Utilities.formatDate(timestamp, "GMT+7", "dd/MM/yyyy HH:mm:ss"),
    action,
    details
  ]);
}

function getOrCreateSheet(ss, sheetName, headers) {
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);

    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange
      .setValues([headers])
      .setBackground(UI_CONFIG.headerBgColor)
      .setFontColor(UI_CONFIG.headerFontColor)
      .setFontFamily(UI_CONFIG.headerFont)
      .setFontSize(UI_CONFIG.headerFontSize)
      .setFontWeight(UI_CONFIG.headerFontWeight)
      .setHorizontalAlignment("center")
      .setVerticalAlignment("middle")
      .setWrap(true);

    headerRange.setBorder(
      true, true, true, true, false, false,
      UI_CONFIG.borderColor,
      SpreadsheetApp.BorderStyle.SOLID_MEDIUM
    );

    sheet.setFrozenRows(1);

    const defaultColumnWidth = UI_CONFIG.columnWidth;
    for (let i = 0; i < headers.length; i++) {
        sheet.setColumnWidth(i + 1, defaultColumnWidth);
    }

    const protection = sheet.protect().setDescription(`B·∫£o v·ªá ti√™u ƒë·ªÅ sheet ${sheetName}`);
    protection.setUnprotectedRanges([sheet.getRange(2, 1, sheet.getMaxRows() - 1, sheet.getMaxColumns())]);

    if (sheetName === "DaGhep") {
      const ngayCocCol = headers.indexOf("Ng√†y c·ªçc");
      const thoiGianNhapCol = headers.indexOf("Th·ªùi gian nh·∫≠p");
      const thoiGianGhepCol = headers.indexOf("Th·ªùi gian gh√©p");
      const ngayXuatHoaDonCol = headers.indexOf("Ng√†y xu·∫•t h√≥a ƒë∆°n");

      if (ngayCocCol !== -1) sheet.getRange(2, ngayCocCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");
      if (thoiGianNhapCol !== -1) sheet.getRange(2, thoiGianNhapCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");
      if (thoiGianGhepCol !== -1) sheet.getRange(2, thoiGianGhepCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");
      if (ngayXuatHoaDonCol !== -1) sheet.getRange(2, ngayXuatHoaDonCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy");
    }
    if (sheetName === "KhoXe") {
      const ngayNhapCol = headers.indexOf("Ng√†y nh·∫≠p");
      if (ngayNhapCol !== -1) sheet.getRange(2, ngayNhapCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");
    }
    if (sheetName === "HuyGhep") {
      const ngayCocCol = headers.indexOf("Ng√†y c·ªçc");
      const thoiGianNhapCol = headers.indexOf("Th·ªùi gian nh·∫≠p");
      const thoiGianGhepCol = headers.indexOf("Th·ªùi gian gh√©p");
      const thoiGianHuyCol = headers.indexOf("Th·ªùi gian h·ªßy");

      if (ngayCocCol !== -1) sheet.getRange(2, ngayCocCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");
      if (thoiGianNhapCol !== -1) sheet.getRange(2, thoiGianNhapCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");
      if (thoiGianGhepCol !== -1) sheet.getRange(2, thoiGianGhepCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");
      if (thoiGianHuyCol !== -1) sheet.getRange(2, thoiGianHuyCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");
    }
    if (sheetName === "lichsu_donhang" || sheetName === "lichsu_xe" || sheetName === "log") {
      const thoiGianCol = headers.indexOf("Th·ªùi gian");
      if (thoiGianCol !== -1) sheet.getRange(2, thoiGianCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy HH:mm:ss");
    }
    if (sheetName === XUAT_HOA_DON_SHEET_NAME) {
      // headers here refers to SHEET_HEADERS["Xuathoadon"]
      const ngayXuatHoaDonCol = headers.indexOf("NG√ÄY XU·∫§T H√ìA ƒê∆†N"); // Updated
      // ƒê√£ x√≥a checkbox B√ÅO B√ÅN
      if (ngayXuatHoaDonCol !== -1) {
        sheet.getRange(2, ngayXuatHoaDonCol + 1, sheet.getMaxRows() - 1, 1).setNumberFormat("dd/MM/yyyy");
      }
      updateSerialNumbers(sheet);
    }
  }
  return sheet;
}

function formatSheet(sheet, numColumns) {
  const maxRows = sheet.getMaxRows();
  if (maxRows < 2) return;

  const dataRange = sheet.getRange(2, 1, maxRows - 1, numColumns);

  dataRange
    .setFontFamily(UI_CONFIG.fontFamily)
    .setFontSize(UI_CONFIG.fontSize)
    .setFontColor(UI_CONFIG.textColor)
    .setHorizontalAlignment("left")
    .setVerticalAlignment("middle");

  sheet.autoResizeRows(2, maxRows - 1);
}


function onOpen() {
  try {
    SpreadsheetApp.getUi()
      .createMenu('Qu·∫£n L√Ω Xe')
      .addItem('T√¨m Ki·∫øm N√¢ng Cao', 'showSearchAndFilterSidebar')
      .addItem('KHO XE', 'runSyncKhoxeStatus')
      .addItem('G·ª£i √Ω Gh√©p xe', 'showSuggestionSidebar')
      .addItem('Gh√©p Xe Th·ªß C√¥ng', 'showManualMatchSidebar') 
      .addItem('H·ªßy Gh√©p ƒê∆°n H√†ng', 'showCancelOrderSidebar')
      .addItem('H·ªßy Xu·∫•t H√≥a ƒê∆°n', 'showCancelInvoicePrompt')
      .addItem('Xu·∫•t H√≥a ƒê∆°n', 'issueInvoice')
      .addItem('Ph√™ duy·ªát Y√™u c·∫ßu', 'approveSelectedInvoiceRequest')
      .addItem('Y√™u c·∫ßu B·ªï sung H·ªì s∆°', 'requestSupplementForInvoice')
      .addItem('X√≥a Xe Kh·ªèi Kho', 'showDeleteCarFromStockPrompt')
      .addItem('Ph·ª•c H·ªìi Xe V√†o Kho', 'showRestoreCarToStockPrompt')
      .addItem('X√≥a ƒê∆°n H√†ng', 'showDeleteOrderPrompt')
      .addSeparator()
      .addItem('L∆∞u Tr·ªØ H√≥a ƒê∆°n (Theo Th√°ng)', 'showArchivePrompt')
      .addItem('L∆∞u Tr·ªØ File Drive (Th√°ng Tr∆∞·ªõc)', 'runFileArchiveManually')
      .addItem('L∆∞u Tr∆∞ÃÉ ƒê∆°n HaÃÄng XHƒê', 'archiveInvoicedOrdersMonthly')
      .addItem('XoÃÅa ƒê∆°n HaÃÄng ƒêaÃÉ GheÃÅp XHƒê ThaÃÅng Tr∆∞∆°ÃÅc', 'deleteMonthlyInvoicedOrdersFromDaGhepLogic')
      .addItem('X√≥a ƒê∆°n H√†ng Xu·∫•t H√≥a ƒê∆°n Th√°ng Tr∆∞·ªõc', 'removeXuathoadonRowsFromPreviousMonth')
      .addItem('Ki·ªÉm Tra S·ª©c Kh·ªèe D·ªØ Li·ªáu', 'runDataHealthCheck')
      .addToUi();
  } catch (e) {
    Logger.log('L·ªói onOpen: ' + e.message);
    SpreadsheetApp.getUi().alert('L·ªói kh·ªüi t·∫°o menu: ' + e.message);
  }
}
function getSheets(ss) {
  const sheets = {
    daGhepSheet: getOrCreateSheet(ss, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"]),
    chuaGhepSheet: getOrCreateSheet(ss, CHUA_GHEP_SHEET_NAME, SHEET_HEADERS["ChuaGhep"]),
    stockSheet: getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]),
    cancelledSheet: getOrCreateSheet(ss, CANCELLED_SHEET_NAME, SHEET_HEADERS["HuyGhep"]),
    mailSheet: getOrCreateSheet(ss, MAIL_SHEET_NAME, SHEET_HEADERS["Mail"]),
    xuathoadonSheet: getOrCreateSheet(ss, XUAT_HOA_DON_SHEET_NAME, SHEET_HEADERS["Xuathoadon"]),
    thongtinxeSheet: getOrCreateSheet(ss, THONG_TIN_XE_SHEET_NAME, SHEET_HEADERS["Thongtinxe"]),
    lichsuDonhangSheet: getOrCreateSheet(ss, "lichsu_donhang", SHEET_HEADERS["lichsu_donhang"]),
    lichsuXeSheet: getOrCreateSheet(ss, "lichsu_xe", SHEET_HEADERS["lichsu_xe"]),
    logSheet: getOrCreateSheet(ss, "log", SHEET_HEADERS["log"]),
    removedCarsLogSheet: getOrCreateSheet(ss, "removed_cars_log", SHEET_HEADERS["removed_cars_log"]),
    nhatKyChinhSuaSheet: getOrCreateSheet(ss, "NhatKyChinhSua", SHEET_HEADERS["NhatKyChinhSua"]),
    dangKyChoSheet: getOrCreateSheet(ss, DANG_KY_CHO_SHEET_NAME, SHEET_HEADERS["DangKyCho"]),
    yeuCauVcSheet: getOrCreateSheet(ss, YEU_CAU_VC_SHEET_NAME, SHEET_HEADERS["YeuCauVC"]),
    chinhSachSheet: getOrCreateSheet(ss, CHINH_SACH_SHEET_NAME, SHEET_HEADERS["Chinhsach"]) // <-- TH√äM D√íNG M·ªöI N√ÄY
  };
  if (!sheets.mailSheet || sheets.mailSheet.getLastRow() < 2) {
    logAction("L·ªói mailSheet", "Sheet 'mail' kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu");
  }
  return sheets;
}
function handleEditTrigger(e) {
  // L·∫•y c√°c th√¥ng tin c∆° b·∫£n t·ª´ s·ª± ki·ªán
  const ss = e.source;
  const range = e.range;
  const sheet = range.getSheet();
  const sheetName = sheet.getName();
  const userEmail = e.user ? e.user.getEmail() : 'N/A';

  // Ch·ªëng l·∫∑p (Debounce) ƒë·ªÉ ngƒÉn trigger ch·∫°y nhi·ªÅu l·∫ßn cho m·ªôt h√†nh ƒë·ªông
  const props = PropertiesService.getScriptProperties();
  const lastEditKey = `lastEdit_trigger`; // S·ª≠ d·ª•ng key chung ƒë·ªÉ ƒë∆°n gi·∫£n h√≥a
  const now = Date.now();
  const lastEditTime = props.getProperty(lastEditKey);
  if (lastEditTime && (now - parseInt(lastEditTime)) < 1500) {
    return;
  }
  props.setProperty(lastEditKey, now.toString());

  // B·ªô ƒë·ªám (Cache) cho c√°c ƒë·ªëi t∆∞·ª£ng Sheet ƒë·ªÉ tƒÉng hi·ªáu su·∫•t
  let sheetsCache = null;
  function getCachedSheets() {
    if (!sheetsCache) {
      sheetsCache = getSheets(ss);
    }
    return sheetsCache;
  }

  // --- B·ªò ƒêI·ªÄU PH·ªêI (DISPATCHER) ---
  const handlers = {
    /**
     * =======================================================
     * X·ª¨ L√ù CH·ªàNH S·ª¨A TR√äN SHEET "DaGhep" (GI·ªÆ NGUY√äN)
     * =======================================================
     */
    "DaGhep": () => {
      if (range.getRow() <= 1) return;
      const daGhepHeaders = SHEET_HEADERS["DaGhep"];
      const vinCol = daGhepHeaders.indexOf("VIN") + 1;
      // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng x√≥a m·ªôt VIN kh·ªèi ƒë∆°n h√†ng
      if (range.getColumn() === vinCol && !range.getValue() && e.oldValue) {
        const vinToRevert = String(e.oldValue).trim();
        const currentSheets = getCachedSheets();
        const rowData = sheet.getRange(range.getRow(), 1, 1, daGhepHeaders.length).getValues()[0];
        const orderNumber = rowData[daGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng")];
        // 1. C·∫≠p nh·∫≠t tr·∫°ng th√°i xe trong KhoXe v·ªÅ "Ch∆∞a gh√©p"
        updateKhoxeStatusForVin(currentSheets.stockSheet, vinToRevert, "Ch∆∞a gh√©p");
        recordVehicleHistory(vinToRevert, "H·ªßy gh√©p (S·ª≠a tay)", `H·ªßy gh√©p v·ªõi ƒêH ${orderNumber} b·ªüi ${userEmail}`);
        // 2. Chuy·ªÉn ƒë∆°n h√†ng v·ªÅ sheet ChuaGhep
        const chuaGhepHeaders = SHEET_HEADERS["ChuaGhep"];
        const newChuaGhepRow = chuaGhepHeaders.map(header => {
          const indexInDaGhep = daGhepHeaders.indexOf(header);
          return indexInDaGhep !== -1 ? rowData[indexInDaGhep] : "";
        });
        currentSheets.chuaGhepSheet.appendRow(newChuaGhepRow);

        // 3. X√≥a d√≤ng kh·ªèi DaGhep
        sheet.deleteRow(range.getRow());
        recordOrderHistory(orderNumber, vinToRevert, "H·ªßy gh√©p (S·ª≠a tay)", `ƒê∆°n h√†ng ƒë∆∞·ª£c chuy·ªÉn v·ªÅ 'ChuaGhep' b·ªüi ${userEmail}`);
        showToastOnSheet(`ƒê√£ h·ªßy gh√©p cho ƒêH ${orderNumber} v√† chuy·ªÉn v·ªÅ sheet 'ChuaGhep'.`, "Thao T√°c Th√†nh C√¥ng");
      }
    },

    /**
     * =======================================================
     * X·ª¨ L√ù CH·ªàNH S·ª¨A TR√äN SHEET "KhoXe" (LOGIC M·ªöI ƒê√É S·ª¨A)
     * =======================================================
     */
    "KhoXe": () => {
        const editedRange = e.range;
        const startRow = editedRange.getRow();
        const startCol = editedRange.getColumn();
        const numRows = editedRange.getNumRows();

        const currentSheets = getCachedSheets();
        const khoXeHeaders = SHEET_HEADERS["KhoXe"];
        const vinColIndex = khoXeHeaders.indexOf("VIN");
        const ngayNhapColIndex = khoXeHeaders.indexOf("Ng√†y nh·∫≠p");

        // Ch·ªâ x·ª≠ l√Ω n·∫øu c·ªôt ƒë∆∞·ª£c ch·ªânh s·ª≠a l√† c·ªôt VIN
        if (startCol !== vinColIndex + 1) return;

        // V√≤ng l·∫∑p ƒë·ªÉ x·ª≠ l√Ω cho t·ª´ng d√≤ng trong ph·∫°m vi ƒë∆∞·ª£c d√°n (paste)
        for (let i = 0; i < numRows; i++) {
            const currentRow = startRow + i;
            if (currentRow <= 1) continue; // B·ªè qua d√≤ng ti√™u ƒë·ªÅ

            const vinCell = sheet.getRange(currentRow, vinColIndex + 1);
            const vinValue = vinCell.getValue();

            if (vinValue) {
                const currentVinInCell = String(vinValue).trim().toUpperCase();
                vinCell.setValue(currentVinInCell); // Chu·∫©n h√≥a vi·∫øt hoa

                if (currentVinInCell.length !== 17) {
                    vinCell.setNote(`L·ªñI: S·ªë VIN ph·∫£i c√≥ ƒë√∫ng 17 k√Ω t·ª±.`);
                } else {
                    vinCell.clearNote();
                    // T·ª± ƒë·ªông ƒëi·ªÅn c√°c th√¥ng tin kh√°c cho d√≤ng hi·ªán t·∫°i
                    updateDmsFromThongtinxe(sheet, currentSheets.thongtinxeSheet, currentVinInCell, currentRow);
                    const ngayNhapCell = sheet.getRange(currentRow, ngayNhapColIndex + 1);
                    if (!ngayNhapCell.getValue()) {
                        ngayNhapCell.setValue(new Date()).setNumberFormat("dd/MM/yyyy hh:mm:ss");
                    }
                    recordVehicleHistory(currentVinInCell, "Nh·∫≠p kho (S·ª≠a tay)", `Xe ƒë∆∞·ª£c nh·∫≠p/s·ª≠a b·ªüi ${userEmail}`);
                }
            }
        }
        if (numRows > 1) {
             showToastOnSheet(`ƒê√£ x·ª≠ l√Ω ${numRows} xe.`, "Ho√†n t·∫•t");
        }
    },


    /**
     * =======================================================
     * X·ª¨ L√ù CH·ªàNH S·ª¨A TR√äN SHEET "Xuathoadon" (GI·ªÆ NGUY√äN)
     * =======================================================
     */
    "Xuathoadon": () => {
      if (range.getRow() <= 1) return;
      const headers = SHEET_HEADERS["Xuathoadon"];
      const vinCol = headers.indexOf("S·ªê VIN") + 1;
      if (range.getColumn() === vinCol && e.value) {
        const vin = String(e.value).trim().toUpperCase();
        fillXuathoadonFromDaghepAndThongtinxe(e, range.getRow(), vin);
        logAction("ƒêi·ªÅn t·ª± ƒë·ªông XHƒê", `ƒê√£ ƒëi·ªÅn th√¥ng tin cho VIN ${vin} t·∫°i d√≤ng ${range.getRow()}.`);
      }
    },

    /**
     * =======================================================
     * X·ª¨ L√ù CH·ªàNH S·ª¨A TR√äN SHEET "DangKyCho" (GI·ªÆ NGUY√äN)
     * =======================================================
     */
    "DangKyCho": () => {
      if (range.getRow() <= 1) return;
      const currentSheets = getCachedSheets();
      const dangKyChoHeaders = SHEET_HEADERS["DangKyCho"];
      const ghiChuColIndex = dangKyChoHeaders.indexOf("Ghi ch√∫");

      if (range.getColumn() === ghiChuColIndex + 1 && userEmail === ADMIN_EMAIL) {
        const editedRowValues = sheet.getRange(range.getRow(), 1, 1, dangKyChoHeaders.length).getValues()[0];
        const adminNote = editedRowValues[ghiChuColIndex];

        if (adminNote && adminNote.trim() !== "") {
          const tenTVBH = editedRowValues[dangKyChoHeaders.indexOf("T√™n TVBH")];
          const tenKH = editedRowValues[dangKyChoHeaders.indexOf("T√™n kh√°ch h√†ng")];
          
          const requestData = {
            id: editedRowValues[dangKyChoHeaders.indexOf("ID Y√™u C·∫ßu")],
            ten_tvbh: tenTVBH,
            ten_khach_hang: tenKH,
            dong_xe: editedRowValues[dangKyChoHeaders.indexOf("D√≤ng xe")],
            phien_ban: editedRowValues[dangKyChoHeaders.indexOf("Phi√™n b·∫£n")],
            admin_note: adminNote
          };
          
          sendAdminReplyNotification(currentSheets.mailSheet, requestData);
          const notificationMessage = `Admin ƒë√£ ph·∫£n h·ªìi YC ch·ªù c·ªßa KH ${tenKH}: "${adminNote}"`;
          addNotification(notificationMessage, 'info', 'cho-xe', requestData.id, tenTVBH);
        }
      }
    }
  };
  // --- TH·ª∞C THI HANDLER V√Ä ƒê·ªíNG B·ªò H√ìA (GI·ªÆ NGUY√äN) ---
  try {
    if (handlers[sheetName]) {
      handlers[sheetName]();
      const currentSheetsForSync = getCachedSheets();
      if ([XUAT_HOA_DON_SHEET_NAME, DA_GHEP_SHEET_NAME, STOCK_SHEET_NAME, CANCELLED_SHEET_NAME, CHUA_GHEP_SHEET_NAME].includes(sheetName)) {
        syncKhoxeStatus(currentSheetsForSync.daGhepSheet, currentSheetsForSync.stockSheet, currentSheetsForSync.xuathoadonSheet);
        syncInvoiceDate(currentSheetsForSync.daGhepSheet, currentSheetsForSync.xuathoadonSheet);
      }
    }
  } catch (error) {
    Logger.log(`L·ªói trong handleEditTrigger khi x·ª≠ l√Ω sheet ${sheetName}: ${error.message} \nStack: ${error.stack}`);
    showToastOnSheet(`ƒê√£ x·∫£y ra l·ªói: ${error.message}`, "L·ªói H·ªá Th·ªëng");
  }
}

function findMatchedValidColor(userInputColor) {
  if (!userInputColor || typeof userInputColor !== 'string') {
    return null;
  }
  const normalizedUserInput = userInputColor.trim().toLowerCase();
  if (normalizedUserInput === "") return null;

  // 1. Kh·ªõp ch√≠nh x√°c ho√†n to√†n (kh√¥ng ph√¢n bi·ªát hoa/th∆∞·ªùng)
  for (const validColor of VALID_EXTERIOR_COLORS) {
    if (validColor.trim().toLowerCase() === normalizedUserInput) {
      return validColor; // Tr·∫£ v·ªÅ chu·ªói g·ªëc t·ª´ VALID_EXTERIOR_COLORS
    }
  }

  // 2. Th·ª≠ kh·ªõp n·∫øu userInputColor CH·ªà L√Ä M√É M√ÄU (v√≠ d·ª•: CE18 ho·∫∑c (CE18))
  // Gi·∫£ ƒë·ªãnh m√£ m√†u n·∫±m trong d·∫•u ngo·∫∑c ƒë∆°n ho·∫∑c l√† m·ªôt chu·ªói ng·∫Øn kh√¥ng c√≥ d·∫•u c√°ch.
  const codeMatchRegex = /^\(?([A-Z0-9]+)\)?$/i; // Regex ƒë·ªÉ b·∫Øt m√£ nh∆∞ CE18 ho·∫∑c (CE18)
  const userInputCodeMatch = normalizedUserInput.match(codeMatchRegex);

  if (userInputCodeMatch) {
    const extractedInputCode = userInputCodeMatch[1]; // M√£ ƒë√£ ƒë∆∞·ª£c tr√≠ch xu·∫•t, v√≠ d·ª•: "ce18"
    for (const validColor of VALID_EXTERIOR_COLORS) {
      const validColorLower = validColor.toLowerCase();
      // T√¨m m√£ trong chu·ªói validColor, v√≠ d·ª•: "brahminy white (ce18)"
      if (validColorLower.includes(`(${extractedInputCode})`)) {
        return validColor;
      }
      // Tr∆∞·ªùng h·ª£p m√£ kh√¥ng c√≥ ngo·∫∑c trong VALID_EXTERIOR_COLORS (√≠t kh·∫£ nƒÉng d·ª±a tr√™n danh s√°ch c·ªßa b·∫°n)
      // V√≠ d·ª• n·∫øu VALID_EXTERIOR_COLORS c√≥ "CE18 Special" v√† ng∆∞·ªùi d√πng nh·∫≠p "CE18"
      const parts = validColorLower.split(' ');
      if (parts.some(part => part === extractedInputCode)) {
          // C·∫ßn th√™m logic ƒë·ªÉ ƒë·∫£m b·∫£o ƒë√¢y l√† m√£ ch·ª© kh√¥ng ph·∫£i m·ªôt ph·∫ßn c·ªßa t√™n
          // V√≠ d·ª• ki·ªÉm tra xem extractedInputCode c√≥ gi·ªëng ƒë·ªãnh d·∫°ng m√£ kh√¥ng
          if (/^[A-Z0-9]+$/i.test(extractedInputCode) && extractedInputCode.length > 1 && extractedInputCode.length < 6) { // Heuristic cho m√£
             // Ki·ªÉm tra xem c√≥ nhi·ªÅu k·∫øt qu·∫£ kh·ªõp kh√¥ng, n·∫øu c√≥ th√¨ kh√¥ng eindeutig
             const potentialMatches = VALID_EXTERIOR_COLORS.filter(vc => vc.toLowerCase().includes(`(${extractedInputCode})`) || vc.toLowerCase().split(' ').some(p => p === extractedInputCode && /^[A-Z0-9]+$/i.test(extractedInputCode) && extractedInputCode.length > 1 && extractedInputCode.length < 6));
             if (potentialMatches.length === 1) return potentialMatches[0];
          }
      }
    }
  }

  // 3. Th·ª≠ kh·ªõp n·∫øu userInputColor CH·ªà L√Ä T√äN M√ÄU (v√≠ d·ª•: "Brahminy White")
  // ƒêi·ªÅu n√†y ph·ª©c t·∫°p h∆°n v√¨ t√™n c√≥ th·ªÉ ch·ª©a nhi·ªÅu t·ª´.
  // Ch√∫ng ta s·∫Ω t√¨m xem userInputColor c√≥ ph·∫£i l√† ph·∫ßn ƒë·∫ßu c·ªßa m·ªôt m√†u h·ª£p l·ªá kh√¥ng (tr∆∞·ªõc d·∫•u '(').
  let potentialNameMatches = [];
  for (const validColor of VALID_EXTERIOR_COLORS) {
    const namePartMatch = validColor.match(/^(.*?)\s*\(/);
    if (namePartMatch && namePartMatch[1]) {
      const namePart = namePartMatch[1].trim().toLowerCase();
      if (namePart === normalizedUserInput) {
        potentialNameMatches.push(validColor);
      }
    } else {
      // N·∫øu kh√¥ng c√≥ d·∫•u '(', coi to√†n b·ªô l√† t√™n
       if (validColor.trim().toLowerCase() === normalizedUserInput) {
         potentialNameMatches.push(validColor); // ƒê√£ ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü b∆∞·ªõc 1, nh∆∞ng ƒë·ªÉ an to√†n
       }
    }
  }
  if (potentialNameMatches.length === 1) {
    return potentialNameMatches[0]; // Ch·ªâ tr·∫£ v·ªÅ n·∫øu t√¨m th·∫•y duy nh·∫•t 1 k·∫øt qu·∫£ kh·ªõp t√™n
  }


  return null; // Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ kh·ªõp n√†o
}
/**
 * [PHI√äN B·∫¢N CU·ªêI] T√¨m c√°c d√≤ng thi·∫øu th√¥ng tin v√† kh√¥i ph·ª•c t·ª´ l·ªãch s·ª≠.
 * ∆Øu ti√™n 1: Kh√¥i ph·ª•c t·ª´ snapshot JSON trong 'lichsu_donhang'.
 * ∆Øu ti√™n 2: Kh√¥i ph·ª•c t·ª´ng √¥ m·ªôt t·ª´ 'NhatKyChinhSua'.
 */
function findAndRestoreFromHistory(sheets) {
  const { daGhepSheet, chuaGhepSheet, lichsuDonhangSheet, nhatKyChinhSuaSheet } = sheets;
  const corrections = [];
  const errors = [];

  // 1. L·∫•y d·ªØ li·ªáu t·ª´ c√°c sheet l·ªãch s·ª≠
  const historyData = lichsuDonhangSheet ? lichsuDonhangSheet.getDataRange().getValues() : [];
  const historyHeaders = SHEET_HEADERS["lichsu_donhang"];
  const historyOrderCol = historyHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
  const historyJsonCol = historyHeaders.indexOf("D·ªØ li·ªáu JSON");

  const auditLogData = nhatKyChinhSuaSheet ? nhatKyChinhSuaSheet.getDataRange().getValues() : [];
  const auditLogHeaders = SHEET_HEADERS["NhatKyChinhSua"];
  const auditSheetNameCol = auditLogHeaders.indexOf("T√™n Sheet");
  const auditCellCol = auditLogHeaders.indexOf("√î");

  // ==========================================================================================
  // H√ÄM QUAN TR·ªåNG: T√åM GI√Å TR·ªä TRONG NH·∫¨T K√ù CH·ªàNH S·ª¨A
  // ==========================================================================================
  const findLastCellValueInAuditLog = (sheetName, cellA1Notation) => {
    if (auditLogData.length === 0) return null;

    // Duy·ªát ng∆∞·ª£c t·ª´ cu·ªëi nh·∫≠t k√Ω ƒë·ªÉ t√¨m l·∫ßn ch·ªânh s·ª≠a g·∫ßn nh·∫•t c·ªßa √¥ n√†y
    for (let i = auditLogData.length - 1; i >= 1; i--) {
      if (auditLogData[i][auditSheetNameCol] === sheetName && auditLogData[i][auditCellCol] === cellA1Notation) {
        
        // S·ª¨A L·ªñI LOGIC QUAN TR·ªåNG: 
        // Ph·∫£i l·∫•y "Gi√° tr·ªã c≈©" ƒë·ªÉ kh√¥i ph·ª•c l·∫°i d·ªØ li·ªáu ƒë√£ b·ªã x√≥a.
        const oldValueColIndex = auditLogHeaders.indexOf("Gi√° tr·ªã c≈©");
        return auditLogData[i][oldValueColIndex];
      }
    }
    return null;
  };
  // ==========================================================================================

  // H√†m t√¨m b·∫£n ghi JSON ƒë·∫ßy ƒë·ªß (gi·ªØ nguy√™n)
  const findLastGoodRecord = (orderNumber) => {
    for (let i = historyData.length - 1; i >= 1; i--) {
      if (historyData[i][historyOrderCol] === orderNumber && historyData[i][historyJsonCol]) {
        try { return JSON.parse(historyData[i][historyJsonCol]); } catch (e) {}
      }
    }
    return null;
  };

  // H√†m qu√©t v√† kh√¥i ph·ª•c cho t·ª´ng sheet
  const checkAndRestoreSheet = (sheet, sheetName, headers, essentialCols) => {
    const sheetData = sheet.getDataRange().getValues();
    const orderCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");

    for (let i = 1; i < sheetData.length; i++) {
      const rowData = sheetData[i];
      const orderNumber = String(rowData[orderCol] || "").trim();
      const missingFields = essentialCols.filter(colName => !rowData[headers.indexOf(colName)]);

      if (missingFields.length > 0) {
        let restoredFieldsList = [];
        
        // ∆ØU TI√äN 1: Th·ª≠ kh√¥i ph·ª•c t·ª´ snapshot JSON c·ªßa ƒë∆°n h√†ng
        const historicalRecord = orderNumber ? findLastGoodRecord(orderNumber) : null;
        if (historicalRecord) {
          missingFields.forEach(fieldName => {
            if (historicalRecord.hasOwnProperty(fieldName) && historicalRecord[fieldName]) {
              const colIndexToUpdate = headers.indexOf(fieldName);
              // Ki·ªÉm tra xem tr∆∞·ªùng ƒë√≥ c√≥ c√≤n thi·∫øu kh√¥ng tr∆∞·ªõc khi ghi ƒë√®
              if (!restoredFieldsList.includes(fieldName)) {
                  sheet.getRange(i + 1, colIndexToUpdate + 1).setValue(historicalRecord[fieldName]);
                  restoredFieldsList.push(fieldName);
              }
            }
          });
        }

        // ∆ØU TI√äN 2: Th·ª≠ kh√¥i ph·ª•c t·ª´ng √¥ m·ªôt t·ª´ Nh·∫≠t k√Ω ch·ªânh s·ª≠a `NhatKyChinhSua`
        const remainingMissingFields = missingFields.filter(f => !restoredFieldsList.includes(f));
        if (remainingMissingFields.length > 0) {
          remainingMissingFields.forEach(fieldName => {
            const colIndexToUpdate = headers.indexOf(fieldName);
            const cellA1Notation = sheet.getRange(i + 1, colIndexToUpdate + 1).getA1Notation();
            
            // T√¨m gi√° tr·ªã c≈© g·∫ßn nh·∫•t trong nh·∫≠t k√Ω
            const lastValue = findLastCellValueInAuditLog(sheetName, cellA1Notation);
            
            if (lastValue && lastValue !== "[√î tr·ªëng]") {
              sheet.getRange(i + 1, colIndexToUpdate + 1).setValue(lastValue);
              if (!restoredFieldsList.includes(fieldName)) {
                restoredFieldsList.push(fieldName);
              }
            }
          });
        }

        if (restoredFieldsList.length > 0) {
          corrections.push({
            type: `Kh√¥i ph·ª•c t·ª´ l·ªãch s·ª≠`,
            details: `D√≤ng ${i + 1} ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c c√°c tr∆∞·ªùng: ${restoredFieldsList.join(', ')}.`,
            sheetName: sheetName, row: i + 1, vin: rowData[headers.indexOf("VIN")] || '', orderNumber: orderNumber,
          });
        } else {
          errors.push({
            type: 'Thi·∫øu th√¥ng tin & L·ªãch s·ª≠',
            details: `D√≤ng ${i + 1} thi·∫øu c√°c tr∆∞·ªùng: ${missingFields.join(', ')} v√† kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ ƒë·ªÉ kh√¥i ph·ª•c.`,
            sheetName: sheetName, row: i + 1, vin: rowData[headers.indexOf("VIN")] || '', orderNumber: orderNumber,
          });
        }
      }
    }
  };

  const essentialColsToCheck = ["T√™n t∆∞ v·∫•n b√°n h√†ng", "T√™n kh√°ch h√†ng", "D√≤ng xe", "Phi√™n b·∫£n", "Ngo·∫°i th·∫•t", "N·ªôi th·∫•t", "S·ªë ƒë∆°n h√†ng"];
  checkAndRestoreSheet(daGhepSheet, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"], essentialColsToCheck);
  checkAndRestoreSheet(chuaGhepSheet, CHUA_GHEP_SHEET_NAME, SHEET_HEADERS["ChuaGhep"], essentialColsToCheck);
  
  return { corrections, errors };
}
function findAndFixMissingInformation(sheets) {
  // S·ª¨A L·ªñI T·∫†I ƒê√ÇY: Th√™m 'chuaGhepSheet' v√†o danh s√°ch kh·ªüi t·∫°o.
  const { daGhepSheet, stockSheet, xuathoadonSheet, thongtinxeSheet, chuaGhepSheet } = sheets;
  const errors = [];
  const corrections = [];

  // --- D·ªØ li·ªáu v√† Headers ---
  const thongtinxeData = thongtinxeSheet.getDataRange().getValues();
  const thongtinxeHeaders = SHEET_HEADERS["Thongtinxe"];
  const daghepData = daGhepSheet.getDataRange().getValues();
  const daghepHeaders = SHEET_HEADERS["DaGhep"];
  const khoxeData = stockSheet.getDataRange().getValues();
  const khoxeHeaders = SHEET_HEADERS["KhoXe"];
  const xuathoadonData = xuathoadonSheet.getDataRange().getValues();
  const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];

  // --- Ch·ªâ s·ªë c√°c c·ªôt c·∫ßn thi·∫øt ---
  const vinColThongtinxe = thongtinxeHeaders.indexOf("S·ªë VIN");
  const dongCoColThongtinxe = thongtinxeHeaders.indexOf("S·ªë ƒë·ªông c∆°");
  const mauNgoaiThatColThongtinxe = thongtinxeHeaders.indexOf("M√†u ngo·∫°i th·∫•t xe");
  const mauNoiThatColThongtinxe = thongtinxeHeaders.indexOf("M√†u n·ªôi th·∫•t xe");
  const phienBanColThongtinxe = thongtinxeHeaders.indexOf("Phi√™n b·∫£n");

  const vinColDaghep = daghepHeaders.indexOf("VIN");

  // --- T·∫°o Map ƒë·ªÉ tra c·ª©u nhanh ---
  const vinToThongtinxeMap = new Map(thongtinxeData.slice(1).map(row => [String(row[vinColThongtinxe] || "").trim(), row]));
  const vinToDaghepMap = new Map(daghepData.slice(1).map(row => [String(row[vinColDaghep] || "").trim(), row]));

  // --- KI·ªÇM TRA 1: Ho√†n thi·ªán d·ªØ li·ªáu trong KhoXe t·ª´ Thongtinxe ---
  const khoxeVinCol = khoxeHeaders.indexOf("VIN");
  const khoxePhienBanCol = khoxeHeaders.indexOf("Phi√™n b·∫£n");
  const khoxeNgoaiThatCol = khoxeHeaders.indexOf("Ngo·∫°i th·∫•t");
  const khoxeNoiThatCol = khoxeHeaders.indexOf("N·ªôi th·∫•t");

  for (let i = 1; i < khoxeData.length; i++) {
    const row = khoxeData[i];
    const vin = String(row[khoxeVinCol] || "").trim();
    if (!vin) continue;

    const masterInfo = vinToThongtinxeMap.get(vin);
    if (masterInfo) {
      let changed = false;
      const changes = [];

      // S·ª≠a Phi√™n b·∫£n
      if (!row[khoxePhienBanCol] && masterInfo[phienBanColThongtinxe]) {
        stockSheet.getRange(i + 1, khoxePhienBanCol + 1).setValue(masterInfo[phienBanColThongtinxe]);
        changes.push(`Phi√™n b·∫£n (th√†nh '${masterInfo[phienBanColThongtinxe]}')`);
        changed = true;
      }
      // S·ª≠a Ngo·∫°i th·∫•t
      if (!row[khoxeNgoaiThatCol] && masterInfo[mauNgoaiThatColThongtinxe]) {
        stockSheet.getRange(i + 1, khoxeNgoaiThatCol + 1).setValue(masterInfo[mauNgoaiThatColThongtinxe]);
        changes.push(`Ngo·∫°i th·∫•t (th√†nh '${masterInfo[mauNgoaiThatColThongtinxe]}')`);
        changed = true;
      }
      // S·ª≠a N·ªôi th·∫•t
      if (!row[khoxeNoiThatCol] && masterInfo[mauNoiThatColThongtinxe]) {
        stockSheet.getRange(i + 1, khoxeNoiThatCol + 1).setValue(masterInfo[mauNoiThatColThongtinxe]);
        changes.push(`N·ªôi th·∫•t (th√†nh '${masterInfo[mauNoiThatColThongtinxe]}')`);
        changed = true;
      }

      if (changed) {
        corrections.push({
          type: 'B·ªï sung th√¥ng tin KhoXe',
          details: `VIN "${vin}" ƒë∆∞·ª£c b·ªï sung th√¥ng tin t·ª´ sheet Thongtinxe: ${changes.join(', ')}.`,
          sheetName: STOCK_SHEET_NAME,
          row: i + 1,
          vin: vin,
          orderNumber: ''
        });
      }
    } else {
        // N·∫øu VIN trong KhoXe kh√¥ng t·ªìn t·∫°i trong Thongtinxe th√¨ ƒë√¢y l√† m·ªôt l·ªói
        errors.push({
            type: 'VIN kh√¥ng c√≥ trong d·ªØ li·ªáu g·ªëc',
            details: `VIN "${vin}" trong KhoXe kh√¥ng ƒë∆∞·ª£c t√¨m th·∫•y trong sheet Thongtinxe. D·ªØ li·ªáu c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c.`,
            sheetName: STOCK_SHEET_NAME,
            row: i + 1,
            vin: vin,
            orderNumber: ''
        });
    }
  }

  // --- KI·ªÇM TRA 2: Ho√†n thi·ªán d·ªØ li·ªáu trong Xuathoadon t·ª´ DaGhep v√† Thongtinxe ---
  const xhdVinCol = xuathoadonHeaders.indexOf("S·ªê VIN");
  const xhdKhachHangCol = xuathoadonHeaders.indexOf("T√äN KH√ÅCH H√ÄNG");
  const xhdDongXeCol = xuathoadonHeaders.indexOf("D√íNG XE");
  const xhdPhienBanCol = xuathoadonHeaders.indexOf("PHI√äN B·∫¢N");
  const xhdDongCoCol = xuathoadonHeaders.indexOf("S·ªê ƒê·ªòNG C∆†");

  for (let i = 1; i < xuathoadonData.length; i++) {
    const row = xuathoadonData[i];
    const vin = String(row[xhdVinCol] || "").trim();
    if (!vin) continue;

    const daghepInfo = vinToDaghepMap.get(vin);
    const masterInfo = vinToThongtinxeMap.get(vin);
    let changed = false;
    const changes = [];

    if (daghepInfo) {
      // B·ªï sung c√°c th√¥ng tin li√™n quan ƒë·∫øn ƒë∆°n h√†ng
      if (!row[xhdKhachHangCol] && daghepInfo[daghepHeaders.indexOf("T√™n kh√°ch h√†ng")]) {
        xuathoadonSheet.getRange(i + 1, xhdKhachHangCol + 1).setValue(daghepInfo[daghepHeaders.indexOf("T√™n kh√°ch h√†ng")]);
        changes.push(`T√™n kh√°ch h√†ng`);
        changed = true;
      }
      if (!row[xhdDongXeCol] && daghepInfo[daghepHeaders.indexOf("D√≤ng xe")]) {
        xuathoadonSheet.getRange(i + 1, xhdDongXeCol + 1).setValue(daghepInfo[daghepHeaders.indexOf("D√≤ng xe")]);
        changes.push(`D√≤ng xe`);
        changed = true;
      }
       if (!row[xhdPhienBanCol] && daghepInfo[daghepHeaders.indexOf("Phi√™n b·∫£n")]) {
        xuathoadonSheet.getRange(i + 1, xhdPhienBanCol + 1).setValue(daghepInfo[daghepHeaders.indexOf("Phi√™n b·∫£n")]);
        changes.push(`Phi√™n b·∫£n`);
        changed = true;
      }
    }
    if (masterInfo) {
       // B·ªï sung c√°c th√¥ng tin li√™n quan ƒë·∫øn xe
       if(!row[xhdDongCoCol] && masterInfo[dongCoColThongtinxe]){
         xuathoadonSheet.getRange(i+1, xhdDongCoCol + 1).setValue(masterInfo[dongCoColThongtinxe]);
         changes.push(`S·ªë ƒë·ªông c∆°`);
         changed = true;
       }
    }
    
    if (changed) {
        corrections.push({
          type: 'B·ªï sung th√¥ng tin Xuathoadon',
          details: `VIN "${vin}" ƒë∆∞·ª£c b·ªï sung th√¥ng tin: ${changes.join(', ')}.`,
          sheetName: XUAT_HOA_DON_SHEET_NAME,
          row: i + 1,
          vin: vin,
          orderNumber: row[xuathoadonHeaders.indexOf("S·ªê ƒê∆†N H√ÄNG")]
        });
    }
  }
  
  // --- KI·ªÇM TRA 3: C√°c d√≤ng trong DaGhep/ChuaGhep thi·∫øu th√¥ng tin c∆° b·∫£n ---
  // (Kh√¥ng th·ªÉ t·ª± s·ª≠a, ch·ªâ b√°o l·ªói)
  const checkMissingEssentialData = (sheet, sheetName, headers, essentialCols) => {
      const data = sheet.getDataRange().getValues();
      const orderCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
      const vinCol = headers.indexOf("VIN");

      for(let i=1; i < data.length; i++){
          const row = data[i];
          const missingFields = [];
          essentialCols.forEach(colName => {
              const colIndex = headers.indexOf(colName);
              if(colIndex !== -1 && !row[colIndex]){
                  missingFields.push(colName);
              }
          });
          
          if(missingFields.length > 0){
               errors.push({
                  type: 'Thi·∫øu th√¥ng tin thi·∫øt y·∫øu',
                  details: `D√≤ng n√†y thi·∫øu c√°c th√¥ng tin quan tr·ªçng: ${missingFields.join(', ')}. Vui l√≤ng b·ªï sung th·ªß c√¥ng.`,
                  sheetName: sheetName,
                  row: i + 1,
                  vin: vinCol !== -1 ? row[vinCol] : '',
                  orderNumber: orderCol !== -1 ? row[orderCol] : ''
              });
          }
      }
  };

  const daghepEssentialCols = ["T√™n t∆∞ v·∫•n b√°n h√†ng", "T√™n kh√°ch h√†ng", "D√≤ng xe", "S·ªë ƒë∆°n h√†ng", "VIN"];
  const chuaghepEssentialCols = ["T√™n t∆∞ v·∫•n b√°n h√†ng", "T√™n kh√°ch h√†ng", "D√≤ng xe", "S·ªë ƒë∆°n h√†ng"];

  checkMissingEssentialData(daGhepSheet, DA_GHEP_SHEET_NAME, daghepHeaders, daghepEssentialCols);
  checkMissingEssentialData(chuaGhepSheet, CHUA_GHEP_SHEET_NAME, SHEET_HEADERS["ChuaGhep"], chuaghepEssentialCols);


  return { errors, corrections };
}
function updateSerialNumbers(sheet) {
  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) return; // No data rows

  const sttColIndex = SHEET_HEADERS[sheet.getName()] ? SHEET_HEADERS[sheet.getName()].indexOf("S·ªê TT") : -1;
  if (sttColIndex === -1 && sheet.getName() === XUAT_HOA_DON_SHEET_NAME) { // Only apply if S·ªê TT exists
      Logger.log("C·ªôt S·ªê TT kh√¥ng t√¨m th·∫•y cho sheet " + sheet.getName());
      return;
  }


  let serialNumber = 1;
  const sttValues = [];
  const dataRange = sheet.getRange(2, 1, lastRow -1, sheet.getMaxColumns()).getValues();
  const soDonHangColIndex = SHEET_HEADERS[sheet.getName()] ? SHEET_HEADERS[sheet.getName()].indexOf("S·ªê ƒê∆†N H√ÄNG") : -1;


  for (let i = 0; i < dataRange.length; i++) {
      // Check if the row has data, e.g., by checking the "S·ªê ƒê∆†N H√ÄNG" column or any key column
      // For Xuathoadon, let's assume if "S·ªê ƒê∆†N H√ÄNG" (new index 2) has value, it's a valid row.
      let hasData = false;
      if (sheet.getName() === XUAT_HOA_DON_SHEET_NAME && soDonHangColIndex !== -1) {
          if (dataRange[i][soDonHangColIndex] && String(dataRange[i][soDonHangColIndex]).trim() !== "") {
              hasData = true;
          }
      } else { // For other sheets, or if S·ªê ƒê∆†N H√ÄNG is not the key, assume any data in first few cells
          for(let j=1; j < 5 && j < dataRange[i].length; j++){ // Check first few data columns
              if(dataRange[i][j] && String(dataRange[i][j]).trim() !== ""){
                  hasData = true;
                  break;
              }
          }
      }

      if(hasData){
          sttValues.push([serialNumber++]);
      } else {
          sttValues.push([""]); // Keep STT blank for empty data rows
      }
  }
  if (sttValues.length > 0 && sttColIndex !== -1) {
    sheet.getRange(2, sttColIndex + 1, sttValues.length, 1).setValues(sttValues);
  }
}


function updateInvoiceDateInDaghep(daghepSheet, vin, invoiceDate) {
  const daghepData = daghepSheet.getDataRange().getValues();
  const daghepHeaders = SHEET_HEADERS["DaGhep"];
  const vinCol = daghepHeaders.indexOf("VIN");
  const invoiceDateCol = daghepHeaders.indexOf("Ng√†y xu·∫•t h√≥a ƒë∆°n");

  if (vinCol === -1 || invoiceDateCol === -1) {
      logAction("L·ªói updateInvoiceDateInDaghep", "Kh√¥ng t√¨m th·∫•y c·ªôt VIN ho·∫∑c Ng√†y xu·∫•t h√≥a ƒë∆°n trong DaGhep");
      return;
  }

  for (let i = 1; i < daghepData.length; i++) {
    if (String(daghepData[i][vinCol] || "").trim() === String(vin).trim()) {
      daghepSheet.getRange(i + 1, invoiceDateCol + 1).setValue(invoiceDate);
      logAction("C·∫≠p nh·∫≠t ng√†y xu·∫•t h√≥a ƒë∆°n trong DaGhep", `VIN ${vin} c·∫≠p nh·∫≠t ng√†y xu·∫•t h√≥a ƒë∆°n: ${Utilities.formatDate(invoiceDate, "GMT+7", "dd/MM/yyyy")}`);
      break;
    }
  }
}

function fillXuathoadonFromDaghepAndThongtinxe(e, row, vin) {
  const ss = e.source;
  const sheets = getSheets(ss);
  const { daGhepSheet, thongtinxeSheet, xuathoadonSheet } = sheets;

  vin = String(vin).trim();
  const daghepData = daGhepSheet.getDataRange().getValues();
  const thongtinxeData = thongtinxeSheet.getDataRange().getValues();

  const daghepHeaders = SHEET_HEADERS["DaGhep"];
  const thongtinxeHeaders = SHEET_HEADERS["Thongtinxe"];
  const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];

  let daghepInfo = null;
  const vinColDaghep = daghepHeaders.indexOf("VIN");
  for (let i = 1; i < daghepData.length; i++) {
    if (String(daghepData[i][vinColDaghep] || "").trim() === vin) {
      daghepInfo = daghepData[i];
      logAction("T√¨m th·∫•y trong DaGhep", `VIN: ${vin}, D√≤ng: ${i + 1}`);
      break;
    }
  }

  let thongtinxeInfo = null;
  const vinColThongtinxe = thongtinxeHeaders.indexOf("S·ªë VIN");
  for (let i = 1; i < thongtinxeData.length; i++) {
    if (String(thongtinxeData[i][vinColThongtinxe] || "").trim() === vin) {
      thongtinxeInfo = thongtinxeData[i];
      logAction("T√¨m th·∫•y trong Thongtinxe", `VIN: ${vin}, D√≤ng: ${i + 1}`);
      break;
    }
  }

  if (daghepInfo || thongtinxeInfo) {
    const rowData = [];
    // Populate rowData based on xuathoadonHeaders order
    rowData[xuathoadonHeaders.indexOf("S·ªê TT")] = ""; // STT will be updated by updateSerialNumbers
    rowData[xuathoadonHeaders.indexOf("T√äN KH√ÅCH H√ÄNG")] = daghepInfo ? daghepInfo[daghepHeaders.indexOf("T√™n kh√°ch h√†ng")] : "";
    rowData[xuathoadonHeaders.indexOf("S·ªê ƒê∆†N H√ÄNG")] = daghepInfo ? daghepInfo[daghepHeaders.indexOf("S·ªë ƒë∆°n h√†ng")] : "";
    rowData[xuathoadonHeaders.indexOf("D√íNG XE")] = daghepInfo ? daghepInfo[daghepHeaders.indexOf("D√≤ng xe")] : "";
    rowData[xuathoadonHeaders.indexOf("PHI√äN B·∫¢N")] = daghepInfo ? daghepInfo[daghepHeaders.indexOf("Phi√™n b·∫£n")] : "";
    rowData[xuathoadonHeaders.indexOf("NGO·∫†I TH·∫§T")] = daghepInfo ? daghepInfo[daghepHeaders.indexOf("Ngo·∫°i th·∫•t")] : "";
    rowData[xuathoadonHeaders.indexOf("N·ªòI TH·∫§T")] = daghepInfo ? daghepInfo[daghepHeaders.indexOf("N·ªôi th·∫•t")] : "";
    rowData[xuathoadonHeaders.indexOf("T∆Ø V·∫§N B√ÅN H√ÄNG")] = daghepInfo ? daghepInfo[daghepHeaders.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng")] : "";
    rowData[xuathoadonHeaders.indexOf("S·ªê VIN")] = vin;
    rowData[xuathoadonHeaders.indexOf("S·ªê ƒê·ªòNG C∆†")] = thongtinxeInfo ? thongtinxeInfo[thongtinxeHeaders.indexOf("S·ªë ƒë·ªông c∆°")] : "";
    rowData[xuathoadonHeaders.indexOf("NG√ÄY XU·∫§T H√ìA ƒê∆†N")] = ""; // Will be filled when "B√ÅO B√ÅN" is checked
    rowData[xuathoadonHeaders.indexOf("PO PIN")] = "";
    rowData[xuathoadonHeaders.indexOf("CH√çNH S√ÅCH")] = "";
    rowData[xuathoadonHeaders.indexOf("NG√ÄY C·ªåC")] = daghepInfo ? daghepInfo[daghepHeaders.indexOf("Ng√†y c·ªçc")] : "";
    rowData[xuathoadonHeaders.indexOf("B√ÅO B√ÅN")] = false;
    rowData[xuathoadonHeaders.indexOf("K·∫æT QU·∫¢ G·ª¨I MAIL")] = "";


    xuathoadonSheet.getRange(row, 1, 1, xuathoadonHeaders.length).setValues([rowData]);
    updateSerialNumbers(xuathoadonSheet);
    logAction("ƒêi·ªÅn th√¥ng tin xu·∫•t h√≥a ƒë∆°n", `ƒê√£ ƒëi·ªÅn cho VIN ${vin} t·∫°i d√≤ng ${row}`);
    syncInvoiceDate(daGhepSheet, xuathoadonSheet);
  } else {
    logAction("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu", `VIN ${vin} kh√¥ng c√≥ trong DaGhep ho·∫∑c Thongtinxe`);
    SpreadsheetApp.getUi().alert("C·∫£nh b√°o", `VIN ${vin} kh√¥ng t√¨m th·∫•y trong DaGhep ho·∫∑c Thongtinxe!`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function recordKhoxeStateBeforeInvoice(vin, khoxeRowData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const lichsuXeSheet = getOrCreateSheet(ss, "lichsu_xe", SHEET_HEADERS["lichsu_xe"]);
  const timestamp = new Date();
  const khoxeHeaders = SHEET_HEADERS["KhoXe"];
  const chiTiet = `L∆∞u tr·∫°ng th√°i khoxe tr∆∞·ªõc xu·∫•t h√≥a ƒë∆°n: Tr·∫°ng th√°i=${khoxeRowData[khoxeHeaders.indexOf("Tr·∫°ng th√°i")]}, Ng√†y nh·∫≠p=${khoxeRowData[khoxeHeaders.indexOf("Ng√†y nh·∫≠p")]}, ƒê√£ th√¥ng b√°o=${khoxeRowData[khoxeHeaders.indexOf("ƒê√£ th√¥ng b√°o")]}`;
  
  lichsuXeSheet.appendRow([
    timestamp,
    vin,
    "L∆∞u tr·∫°ng th√°i khoxe",
    chiTiet,
    Session.getActiveUser().getEmail() || "Unknown"
  ]);
  logAction("L∆∞u tr·∫°ng th√°i khoxe", `L∆∞u tr·∫°ng th√°i cho VIN ${vin}: ${chiTiet}`);
}

function findPreviousKhoxeData(ss, vin) {
  const lichsuXeSheet = ss.getSheetByName('lichsu_xe');
  if (!lichsuXeSheet) {
    Logger.log('L·ªói: Kh√¥ng t√¨m th·∫•y sheet lichsu_xe');
    return { ngayNhap: null, daThongBao: '', trangThai: '' };
  }

  const lichsuXeData = lichsuXeSheet.getDataRange().getValues();
  let ngayNhap = null;
  let daThongBao = '';
  let trangThai = '';
  let latestMatchIndex = -1;

  const vinColLichSu = SHEET_HEADERS["lichsu_xe"].indexOf("VIN");
  const chiTietColLichSu = SHEET_HEADERS["lichsu_xe"].indexOf("Chi ti·∫øt");


  for (let i = 1; i < lichsuXeData.length; i++) { // Start from 1 to skip headers
    const vinInSheet = String(lichsuXeData[i][vinColLichSu] || '').trim().toUpperCase();
    const vinToCompare = String(vin || '').trim().toUpperCase();
    
    if (vinInSheet === vinToCompare) {
      latestMatchIndex = i;
      const chiTiet = String(lichsuXeData[i][chiTietColLichSu] || '').trim();
      
      const trangThaiMatch = chiTiet.match(/Tr·∫°ng th√°i=([^,]+)/);
      if (trangThaiMatch && trangThaiMatch[1]) {
        trangThai = trangThaiMatch[1].trim();
      }

      const ngayNhapMatch = chiTiet.match(/Ng√†y nh·∫≠p=([^,]+)/);
      if (ngayNhapMatch && ngayNhapMatch[1]) {
        try {
          // Attempt to parse date, assuming it might be string or number
          let parsedDate = new Date(ngayNhapMatch[1].trim());
          if (isNaN(parsedDate.getTime())) { // Check if parsing failed
             // Try parsing dd/MM/yyyy HH:mm:ss if it's in that format
             const parts = ngayNhapMatch[1].trim().split(' ')[0].split('/');
             if (parts.length === 3) {
                parsedDate = new Date(parts[2], parts[1] - 1, parts[0]); // year, month-1, day
             }
          }
          if (!isNaN(parsedDate.getTime())) {
            ngayNhap = parsedDate;
          } else {
            ngayNhap = null; // Invalid date
          }
        } catch (e) {
          Logger.log(`L·ªói chuy·ªÉn ƒë·ªïi Ng√†y nh·∫≠p cho VIN ${vin}: ${e}`);
          ngayNhap = null;
        }
      }

      const daThongBaoMatch = chiTiet.match(/ƒê√£ th√¥ng b√°o=(ƒê√£ th√¥ng b√°o ng√†y \d{2}\/\d{2}\/\d{4}|[^,]*)/); // Adjusted regex
      if (daThongBaoMatch && daThongBaoMatch[1]) {
        daThongBao = daThongBaoMatch[1].trim();
      }
    }
  }

  if (latestMatchIndex === -1) {
    Logger.log(`Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu trong lichsu_xe cho VIN ${vin}`);
  } else {
    Logger.log(`T√¨m th·∫•y d·ªØ li·ªáu cho VIN ${vin} t·∫°i d√≤ng ${latestMatchIndex + 1}: trangThai=${trangThai}, ngayNhap=${ngayNhap}, daThongBao=${daThongBao}`);
  }

  return { ngayNhap, daThongBao, trangThai };
}
function cancelInvoice(soDonHang) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = getSheets(ss);
  const { daGhepSheet, stockSheet, chuaGhepSheet, xuathoadonSheet, mailSheet } = sheets;

  const xuathoadonData = xuathoadonSheet.getDataRange().getValues();
  const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"]; // 
  const soDonHangColXHD = xuathoadonHeaders.indexOf("S·ªê ƒê∆†N H√ÄNG");
  const vinColXHD = xuathoadonHeaders.indexOf("S·ªê VIN");

  let vinToCancel = null;
  let matchedRowInSheet = -1;
  let invoiceDataRow = null;

  for (let i = 1; i < xuathoadonData.length; i++) {
    if (String(xuathoadonData[i][soDonHangColXHD] || '').trim() === String(soDonHang).trim()) {
      vinToCancel = String(xuathoadonData[i][vinColXHD] || '').trim();
      matchedRowInSheet = i + 1;
      invoiceDataRow = xuathoadonData[i];
      xuathoadonSheet.deleteRow(matchedRowInSheet); // 
      break;
    }
  }

  if (!vinToCancel || matchedRowInSheet === -1) {
    showToastOnSheet(`Kh√¥ng t√¨m th·∫•y s·ªë ƒë∆°n h√†ng ${soDonHang} trong danh s√°ch xu·∫•t h√≥a ƒë∆°n!`, "L·ªói"); // 
    logAction('L·ªói h·ªßy xu·∫•t h√≥a ƒë∆°n', `Kh√¥ng t√¨m th·∫•y s·ªë ƒë∆°n h√†ng ${soDonHang} trong Xuathoadon`); // 
    return;
  }

  const invoiceData = {
      ten_ban_hang: invoiceDataRow[xuathoadonHeaders.indexOf("T∆Ø V·∫§N B√ÅN H√ÄNG")],
      ten_khach_hang: invoiceDataRow[xuathoadonHeaders.indexOf("T√äN KH√ÅCH H√ÄNG")],
      dong_xe: invoiceDataRow[xuathoadonHeaders.indexOf("D√íNG XE")],
      phien_ban: invoiceDataRow[xuathoadonHeaders.indexOf("PHI√äN B·∫¢N")],
      ngoai_that: invoiceDataRow[xuathoadonHeaders.indexOf("NGO·∫†I TH·∫§T")],
      noi_that: invoiceDataRow[xuathoadonHeaders.indexOf("N·ªòI TH·∫§T")],
      so_don_hang: soDonHang,
      ngay_coc: invoiceDataRow[xuathoadonHeaders.indexOf("NG√ÄY C·ªåC")],
      ngay_xuat_hoa_don: invoiceDataRow[xuathoadonHeaders.indexOf("NG√ÄY XU·∫§T H√ìA ƒê∆†N")]
  };
  const { ngayNhap, daThongBao } = findPreviousKhoxeData(ss, vinToCancel);

  // --- THAY ƒê·ªîI QUAN TR·ªåNG T·∫†I ƒê√ÇY ---
  // Khi h·ªßy xu·∫•t h√≥a ƒë∆°n, tr·∫°ng th√°i c·ªßa ƒë∆°n h√†ng trong DaGhep ph·∫£i lu√¥n l√† "ƒê√£ gh√©p".
  // B·ªè logic suy lu·∫≠n ph·ª©c t·∫°p, g√°n c·ª©ng gi√° tr·ªã ƒë√∫ng.
  const newDaghepStatus = "ƒê√£ gh√©p"; 
  // --- K·∫æT TH√öC THAY ƒê·ªîI ---

  let isVinInDaghep = false;
  let daghepRowIndexInSheet = -1; // 1-based
  const daghepData = daGhepSheet.getDataRange().getValues();
  const daghepHeaders = SHEET_HEADERS["DaGhep"];
  const vinColDaghep = daghepHeaders.indexOf("VIN");
  const ketQuaColDaghep = daghepHeaders.indexOf("K·∫øt qu·∫£");
  const ngayXuatHDColDaghep = daghepHeaders.indexOf("Ng√†y xu·∫•t h√≥a ƒë∆°n");

  for (let i = 1; i < daghepData.length; i++) {
    if (String(daghepData[i][vinColDaghep] || '').trim() === vinToCancel) {
      isVinInDaghep = true;
      daghepRowIndexInSheet = i + 1;
      break;
    }
  }

  if (isVinInDaghep && daghepRowIndexInSheet !== -1) {
    daGhepSheet.getRange(daghepRowIndexInSheet, ketQuaColDaghep + 1).setValue(newDaghepStatus); // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë√∫ng
    daGhepSheet.getRange(daghepRowIndexInSheet, ngayXuatHDColDaghep + 1).setValue(''); // X√≥a ng√†y xu·∫•t h√≥a ƒë∆°n
    logAction('C·∫≠p nh·∫≠t DaGhep', `C·∫≠p nh·∫≠t VIN ${vinToCancel} trong DaGhep: K·∫øt qu·∫£=${newDaghepStatus}, x√≥a Ng√†y xu·∫•t h√≥a ƒë∆°n`);
  } else if (!isVinInDaghep && invoiceData) {
      // Logic n√†y ƒë·ªÉ kh√¥i ph·ª•c l·∫°i d√≤ng trong DaGhep n·∫øu n√≥ ƒë√£ b·ªã x√≥a v√¨ l√Ω do n√†o ƒë√≥
      const newDaghepRowValues = [];
      newDaghepRowValues[daghepHeaders.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng")] = invoiceData.ten_ban_hang;
      newDaghepRowValues[daghepHeaders.indexOf("T√™n kh√°ch h√†ng")] = invoiceData.ten_khach_hang;
      newDaghepRowValues[daghepHeaders.indexOf("D√≤ng xe")] = invoiceData.dong_xe;
      newDaghepRowValues[daghepHeaders.indexOf("Phi√™n b·∫£n")] = invoiceData.phien_ban;
      newDaghepRowValues[daghepHeaders.indexOf("Ngo·∫°i th·∫•t")] = invoiceData.ngoai_that;
      newDaghepRowValues[daghepHeaders.indexOf("N·ªôi th·∫•t")] = invoiceData.noi_that;
      newDaghepRowValues[daghepHeaders.indexOf("S·ªë ƒë∆°n h√†ng")] = invoiceData.so_don_hang;
      newDaghepRowValues[daghepHeaders.indexOf("Ng√†y c·ªçc")] = invoiceData.ngay_coc;
      newDaghepRowValues[daghepHeaders.indexOf("Th·ªùi gian nh·∫≠p")] = invoiceData.ngay_xuat_hoa_don || new Date();
      newDaghepRowValues[vinColDaghep] = vinToCancel;
      newDaghepRowValues[ketQuaColDaghep] = newDaghepStatus; // G√°n tr·∫°ng th√°i ƒë√∫ng
      
      daGhepSheet.appendRow(daghepHeaders.map((_, index) => newDaghepRowValues[index] || ""));
      logAction('Ph·ª•c h·ªìi DaGhep', `Ph·ª•c h·ªìi b·∫£n ghi trong DaGhep cho VIN ${vinToCancel} v·ªõi tr·∫°ng th√°i '${newDaghepStatus}'`);
      isVinInDaghep = true;
  }

  const khoxeRowIndexInSheet = findRowByVin(stockSheet, vinToCancel);
  const newKhoxeStatus = isVinInDaghep ? 'ƒê√£ gh√©p' : 'Ch∆∞a gh√©p';
  const khoxeHeaders = SHEET_HEADERS["KhoXe"];
  const statusColKhoXe = khoxeHeaders.indexOf("Tr·∫°ng th√°i");
  const ngayNhapColKhoXe = khoxeHeaders.indexOf("Ng√†y nh·∫≠p");
  const daThongBaoColKhoXe = khoxeHeaders.indexOf("ƒê√£ th√¥ng b√°o");
  
  if (khoxeRowIndexInSheet !== -1) {
    stockSheet.getRange(khoxeRowIndexInSheet, statusColKhoXe + 1).setValue(newKhoxeStatus);
    if (!stockSheet.getRange(khoxeRowIndexInSheet, ngayNhapColKhoXe + 1).getValue() && ngayNhap) {
      stockSheet.getRange(khoxeRowIndexInSheet, ngayNhapColKhoXe + 1).setValue(ngayNhap);
    }
    if (!stockSheet.getRange(khoxeRowIndexInSheet, daThongBaoColKhoXe + 1).getValue() && daThongBao) {
      stockSheet.getRange(khoxeRowIndexInSheet, daThongBaoColKhoXe + 1).setValue(daThongBao);
    }
    logAction('C·∫≠p nh·∫≠t KhoXe', `C·∫≠p nh·∫≠t tr·∫°ng th√°i xe ${vinToCancel} th√†nh "${newKhoxeStatus}" trong KhoXe`);
  } else if (invoiceData) {
      const newKhoxeRowValues = [];
      newKhoxeRowValues[khoxeHeaders.indexOf("D√≤ng xe")] = invoiceData.dong_xe;
      newKhoxeRowValues[khoxeHeaders.indexOf("Phi√™n b·∫£n")] = invoiceData.phien_ban;
      newKhoxeRowValues[khoxeHeaders.indexOf("Ngo·∫°i th·∫•t")] = invoiceData.ngoai_that;
      newKhoxeRowValues[khoxeHeaders.indexOf("N·ªôi th·∫•t")] = invoiceData.noi_that;
      newKhoxeRowValues[khoxeHeaders.indexOf("VIN")] = vinToCancel;
      newKhoxeRowValues[statusColKhoXe] = newKhoxeStatus;
      newKhoxeRowValues[ngayNhapColKhoXe] = ngayNhap || '';
      newKhoxeRowValues[daThongBaoColKhoXe] = daThongBao || '';
      stockSheet.appendRow(khoxeHeaders.map((_, index) => newKhoxeRowValues[index] || ""));
      logAction('Th√™m v√†o KhoXe', `Th√™m xe ${vinToCancel} v√†o KhoXe v·ªõi tr·∫°ng th√°i '${newKhoxeStatus}'`);
  }

  recordOrderHistory(soDonHang, vinToCancel, 'H·ªßy xu·∫•t h√≥a ƒë∆°n', `H·ªßy xu·∫•t h√≥a ƒë∆°n cho ƒë∆°n h√†ng ${soDonHang}`);
  recordVehicleHistory(vinToCancel, 'H·ªßy xu·∫•t h√≥a ƒë∆°n', `H·ªßy xu·∫•t h√≥a ƒë∆°n cho ƒë∆°n h√†ng ${soDonHang}`);
  updateSerialNumbers(xuathoadonSheet);
  showToastOnSheet(`ƒê√£ h·ªßy xu·∫•t h√≥a ƒë∆°n cho ƒë∆°n h√†ng ${soDonHang}!`, "Th√†nh c√¥ng");
  logAction('H·ªßy xu·∫•t h√≥a ƒë∆°n', `H·ªßy xu·∫•t h√≥a ƒë∆°n cho ƒë∆°n h√†ng ${soDonHang}, VIN ${vinToCancel}`);
}
function showCancelInvoicePrompt() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'H·ªßy Xu·∫•t H√≥a ƒê∆°n',
    'Vui l√≤ng nh·∫≠p s·ªë ƒë∆°n h√†ng c·∫ßn h·ªßy xu·∫•t h√≥a ƒë∆°n:',
    ui.ButtonSet.OK_CANCEL
  );
  if (response.getSelectedButton() === ui.Button.OK) {
    const soDonHang = response.getResponseText().trim();
    if (!soDonHang) {
      showToastOnSheet('S·ªë ƒë∆°n h√†ng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!', 'L·ªói'); // Changed from ui.alert
      logAction("L·ªói h·ªßy xu·∫•t h√≥a ƒë∆°n", "Ng∆∞·ªùi d√πng kh√¥ng nh·∫≠p s·ªë ƒë∆°n h√†ng");
      return;
    }
    cancelInvoice(soDonHang);
  } else {
    showToastOnSheet('Thao t√°c h·ªßy xu·∫•t h√≥a ƒë∆°n ƒë√£ b·ªã h·ªßy b·ªè.', 'ƒê√£ h·ªßy'); // Changed from ui.alert
    logAction("H·ªßy thao t√°c", "Ng∆∞·ªùi d√πng ƒë√£ h·ªßy prompt h·ªßy xu·∫•t h√≥a ƒë∆°n");
  }
}
function updateKhoxeStatusForVin(stockSheet, vin, newStatus) {
  const stockData = stockSheet.getDataRange().getValues();
  const headers = SHEET_HEADERS["KhoXe"]; // Use defined headers
  const vinCol = headers.indexOf("VIN");
  const statusCol = headers.indexOf("Tr·∫°ng th√°i");

  if (vinCol === -1 || statusCol === -1) {
    logAction("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i KhoXe", "Sheet 'KhoXe' thi·∫øu c·ªôt 'VIN' ho·∫∑c 'Tr·∫°ng th√°i'.");
    return;
  }

  for (let i = 1; i < stockData.length; i++) { // Start from 1 to skip header row
    if (String(stockData[i][vinCol]).trim() === String(vin).trim()) {
      stockSheet.getRange(i + 1, statusCol + 1).setValue(newStatus); // i+1 for 1-based sheet row, statusCol+1 for 1-based col
      logAction("C·∫≠p nh·∫≠t tr·∫°ng th√°i KhoXe", `VIN ${vin} c·∫≠p nh·∫≠t tr·∫°ng th√°i t·ª´ '${stockData[i][statusCol]}' th√†nh '${newStatus}'.`);
      return;
    }
  }
  logAction("C·∫≠p nh·∫≠t tr·∫°ng th√°i KhoXe", `Kh√¥ng t√¨m th·∫•y VIN ${vin} trong sheet 'KhoXe' ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i.`);
}
function removeVehiclesWithInvoicedStatus() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const removedCarsLogSheet = getOrCreateSheet(ss, "removed_cars_log", SHEET_HEADERS["removed_cars_log"]);
  if (!stockSheet || !removedCarsLogSheet) {
    logAction("L·ªói x√≥a xe ƒë√£ xu·∫•t h√≥a ƒë∆°n", "Kh√¥ng t√¨m th·∫•y sheet 'KhoXe' ho·∫∑c 'removed_cars_log'.");
    return;
  }

  const stockData = stockSheet.getDataRange().getValues();
  if (stockData.length <= 1) {
    logAction("X√≥a xe ƒë√£ xu·∫•t h√≥a ƒë∆°n", "Sheet 'KhoXe' kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ x·ª≠ l√Ω.");
    return;
  }

  const headers = SHEET_HEADERS["KhoXe"]; // Use defined headers
  const vinCol = headers.indexOf("VIN");
  const statusCol = headers.indexOf("Tr·∫°ng th√°i");
  const dongXeCol = headers.indexOf("D√≤ng xe");
  const phienBanCol = headers.indexOf("Phi√™n b·∫£n");
  const ngoaiThatCol = headers.indexOf("Ngo·∫°i th·∫•t");
  const noiThatCol = headers.indexOf("N·ªôi th·∫•t");
  const ngayNhapCol = headers.indexOf("Ng√†y nh·∫≠p");
  const daThongBaoCol = headers.indexOf("ƒê√£ th√¥ng b√°o");
  if (vinCol === -1 || statusCol === -1) {
    logAction("L·ªói x√≥a xe ƒë√£ xu·∫•t h√≥a ƒë∆°n", "Sheet 'KhoXe' thi·∫øu c·ªôt 'VIN' ho·∫∑c 'Tr·∫°ng th√°i'.");
    return;
  }

  const rowsToDelete = [];
  const removedCarLogs = [];
  const timestamp = new Date();
  const user = Session.getActiveUser() ? Session.getActiveUser().getEmail() : "H·ªá th·ªëng t·ª± ƒë·ªông";
  for (let i = 1; i < stockData.length; i++) {
    const row = stockData[i];
    const vin = String(row[vinCol]).trim();
    const status = String(row[statusCol]).trim();

    if (status === "ƒê√£ xu·∫•t h√≥a ƒë∆°n") {
      rowsToDelete.push(i + 1);
      const removedCarData = {};
      removedCarData["Th·ªùi gian x√≥a"] = Utilities.formatDate(timestamp, "GMT+7", "dd/MM/yyyy HH:mm:ss");
      removedCarData["Ng∆∞·ªùi x√≥a"] = user;
      removedCarData["D√≤ng xe"] = row[dongXeCol] || "";
      removedCarData["Phi√™n b·∫£n"] = row[phienBanCol] || "";
      removedCarData["Ngo·∫°i th·∫•t"] = row[ngoaiThatCol] || "";
      removedCarData["N·ªôi th·∫•t"] = row[noiThatCol] || "";
      removedCarData["VIN"] = vin;
      removedCarData["Tr·∫°ng th√°i (c≈©)"] = status;
      removedCarData["Ng√†y nh·∫≠p (c≈©)"] = row[ngayNhapCol] ?
        Utilities.formatDate(new Date(row[ngayNhapCol]), "GMT+7", "dd/MM/yyyy HH:mm:ss") : "";
      removedCarData["ƒê√£ th√¥ng b√°o (c≈©)"] = row[daThongBaoCol] || "";

      removedCarLogs.push(SHEET_HEADERS["removed_cars_log"].map(header => removedCarData[header]));
    }
  }

  for (let i = rowsToDelete.length - 1; i >= 0; i--) {
    stockSheet.deleteRow(rowsToDelete[i]);
    // Make sure to get VIN from original stockData before it's altered by deletions if logging VIN
    const originalRowIndex = rowsToDelete[i] - 1;
    // 0-based index in stockData
    logAction("X√≥a xe ƒë√£ xu·∫•t h√≥a ƒë∆°n", `ƒê√£ x√≥a VIN ${stockData[originalRowIndex][vinCol]} kh·ªèi KhoXe.`);
  }

  if (removedCarLogs.length > 0) {
    removedCarLogs.forEach(logRow => {
      removedCarsLogSheet.appendRow(logRow);
    });
    logAction("Ghi log xe ƒë√£ x√≥a", `ƒê√£ ghi ${removedCarLogs.length} xe ƒë√£ x√≥a v√†o sheet 'removed_cars_log'.`);
  }

  if (rowsToDelete.length > 0) {
    showToastOnSheet(`ƒê√£ x√≥a ${rowsToDelete.length} xe c√≥ tr·∫°ng th√°i "ƒê√£ xu·∫•t h√≥a ƒë∆°n" kh·ªèi kho xe.`, "Th√¥ng b√°o"); // Changed from alert
  } else {
    logAction("X√≥a xe ƒë√£ xu·∫•t h√≥a ƒë∆°n", "Kh√¥ng t√¨m th·∫•y xe n√†o c√≥ tr·∫°ng th√°i 'ƒê√£ xu·∫•t h√≥a ƒë∆°n' ƒë·ªÉ x√≥a.");
  }
}
function showCancelMatchPrompt() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'H·ªßy Gh√©p ƒê∆°n H√†ng',
    'Vui l√≤ng nh·∫≠p s·ªë ƒë∆°n h√†ng c·∫ßn h·ªßy gh√©p:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    const orderNumber = response.getResponseText().trim();
    if (!orderNumber) {
      showToastOnSheet('S·ªë ƒë∆°n h√†ng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!', 'L·ªói');
      logAction("L·ªói h·ªßy gh√©p", "Ng∆∞·ªùi d√πng kh√¥ng nh·∫≠p s·ªë ƒë∆°n h√†ng.");
      return;
    }
    // G·ªçi h√†m logic m·ªõi
    const resultMessage = doReadWriteLock(() => unmatchOrder(orderNumber, "H·ªßy th·ªß c√¥ng t·ª´ Menu"));
    showToastOnSheet(resultMessage, resultMessage.startsWith("L·ªói:") ? "L·ªói" : "Th√†nh C√¥ng");
  } else {
    logAction("H·ªßy thao t√°c", "Ng∆∞·ªùi d√πng ƒë√£ h·ªßy prompt h·ªßy gh√©p ƒë∆°n h√†ng.");
  }
}

function findRowByVin(sheet, vin) {
  const data = sheet.getDataRange().getValues();
  const headers = SHEET_HEADERS[sheet.getName()] || data[0]; // Get headers for the specific sheet
  const vinColIndex = headers.indexOf("VIN"); 

  if (vinColIndex === -1) {
    logAction("L·ªói findRowByVin", `Sheet ${sheet.getName()} kh√¥ng c√≥ c·ªôt 'VIN' trong SHEET_HEADERS ho·∫∑c sheet tr·ªëng.`);
    return -1;
  }

  for (let i = 1; i < data.length; i++) { 
    if (String(data[i][vinColIndex] || "").trim() === String(vin).trim()) {
      return i + 1; 
    }
  }
  return -1; 
}
function issueInvoice() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = getSheets(ss);
  const { daGhepSheet, stockSheet, xuathoadonSheet, thongtinxeSheet } = sheets;
  // --- DEBUG: B·∫Øt ƒë·∫ßu h√†m ---
  Logger.log("B·∫Øt ƒë·∫ßu h√†m issueInvoice.");
  const response = ui.prompt(
    'Xu·∫•t H√≥a ƒê∆°n',
    'Nh·∫≠p s·ªë ƒë∆°n h√†ng c·∫ßn xu·∫•t h√≥a ƒë∆°n:',
    ui.ButtonSet.OK_CANCEL
  );
  if (response.getSelectedButton() !== ui.Button.OK || !response.getResponseText().trim()) {
    Logger.log("H·ªßy b·ªüi ng∆∞·ªùi d√πng ho·∫∑c kh√¥ng nh·∫≠p d·ªØ li·ªáu.");
    return;
  }

  const soDonHang = response.getResponseText().trim();
  // --- DEBUG: L·∫•y ƒë∆∞·ª£c s·ªë ƒë∆°n h√†ng ---
  Logger.log(`ƒêang x·ª≠ l√Ω s·ªë ƒë∆°n h√†ng: ${soDonHang}`);
  const daghepData = daGhepSheet.getDataRange().getValues();
  const daghepHeaders = SHEET_HEADERS["DaGhep"];
  const soDonHangColDaghep = daghepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
  const vinColDaghep = daghepHeaders.indexOf("VIN");
  let invoiceDataFromDaghep = null;
  let vin = null;
  let daghepRowIndex = -1;
  for (let i = 1; i < daghepData.length; i++) {
    if (String(daghepData[i][soDonHangColDaghep] || "").trim() === soDonHang) {
      invoiceDataFromDaghep = {};
      daghepHeaders.forEach((header, index) => {
        invoiceDataFromDaghep[header] = daghepData[i][index];
      });
      vin = String(daghepData[i][vinColDaghep] || "").trim();
      daghepRowIndex = i + 1;
      break;
    }
  }

  if (!invoiceDataFromDaghep || !vin) {
    showToastOnSheet(`Kh√¥ng t√¨m th·∫•y s·ªë ƒë∆°n h√†ng '${soDonHang}' ho·∫∑c ƒë∆°n h√†ng ch∆∞a ƒë∆∞·ª£c gh√©p VIN trong sheet 'DaGhep'!`, "L·ªói"); // Changed from ui.alert
    // --- DEBUG: L·ªói kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ho·∫∑c VIN ---
    Logger.log(`L·ªói: Kh√¥ng t√¨m th·∫•y s·ªë ƒë∆°n h√†ng '${soDonHang}' ho·∫∑c VIN tr·ªëng trong DaGhep.`);
    return;
  }
  // --- DEBUG: ƒê√£ t√¨m th·∫•y ƒë∆°n h√†ng trong DaGhep ---
  Logger.log(`T√¨m th·∫•y ƒë∆°n h√†ng '${soDonHang}' v·ªõi VIN: ${vin}`);
  const khoxeRowIndex = findRowByVin(stockSheet, vin);
  if (khoxeRowIndex !== -1) {
    const khoxeRowData = stockSheet.getRange(khoxeRowIndex, 1, 1, SHEET_HEADERS["KhoXe"].length).getValues()[0];
    recordKhoxeStateBeforeInvoice(vin, khoxeRowData);
    stockSheet.getRange(khoxeRowIndex, SHEET_HEADERS["KhoXe"].indexOf("Tr·∫°ng th√°i") + 1).setValue("ƒê√£ xu·∫•t h√≥a ƒë∆°n");
    // --- DEBUG: ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i trong KhoXe ---
    Logger.log(`ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i cho VIN ${vin} trong KhoXe th√†nh 'ƒê√£ xu·∫•t h√≥a ƒë∆°n'.`);
  } else {
    showToastOnSheet(`Kh√¥ng t√¨m th·∫•y VIN '${vin}' trong sheet 'KhoXe'!`,"L·ªói"); // Changed from ui.alert
    // --- DEBUG: L·ªói kh√¥ng t√¨m th·∫•y VIN trong KhoXe ---
    Logger.log(`L·ªói: Kh√¥ng t√¨m th·∫•y VIN '${vin}' trong KhoXe.`);
    return;
  }

  let soDongCo = "";
  const thongtinxeData = thongtinxeSheet.getDataRange().getValues();
  const thongtinxeHeaders = SHEET_HEADERS["Thongtinxe"];
  const vinColThongtinxe = thongtinxeHeaders.indexOf("S·ªë VIN");
  const soDongCoColThongtinxe = thongtinxeHeaders.indexOf("S·ªë ƒë·ªông c∆°");
  for (let i = 1; i < thongtinxeData.length; i++) {
    if (String(thongtinxeData[i][vinColThongtinxe] || "").trim() === vin) {
      soDongCo = String(thongtinxeData[i][soDongCoColThongtinxe] || "").trim();
      break;
    }
  }

  if (!soDongCo) {
    showToastOnSheet(`Kh√¥ng t√¨m th·∫•y S·ªë ƒê·ªông C∆° cho VIN '${vin}' trong sheet 'Thongtinxe'!`,"L·ªói"); // Changed from ui.alert
    // --- DEBUG: L·ªói kh√¥ng t√¨m th·∫•y S·ªë ƒê·ªông C∆° ---
    Logger.log(`L·ªói: Kh√¥ng t√¨m th·∫•y S·ªë ƒê·ªông C∆° cho VIN '${vin}' trong Thongtinxe.`);
    return;
  }
  // --- DEBUG: ƒê√£ t√¨m th·∫•y S·ªë ƒê·ªông C∆° ---
  Logger.log(`T√¨m th·∫•y S·ªë ƒê·ªông C∆° '${soDongCo}' cho VIN ${vin}.`);
  const xuathoadonDataValues = xuathoadonSheet.getDataRange().getValues();
  const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];
  const soDonHangColXHD = xuathoadonHeaders.indexOf("S·ªê ƒê∆†N H√ÄNG");
  let lastRowWithData = 1;
  for (let i = 1; i < xuathoadonDataValues.length; i++) {
    if (xuathoadonDataValues[i][soDonHangColXHD] && String(xuathoadonDataValues[i][soDonHangColXHD]).trim() !== "") {
      lastRowWithData = i + 1;
    }
  }
  const rowToInsert = lastRowWithData + 1;
  // --- DEBUG: X√°c ƒë·ªãnh h√†ng ƒë·ªÉ ch√®n d·ªØ li·ªáu ---
  Logger.log(`S·∫Ω ch√®n d·ªØ li·ªáu h√≥a ƒë∆°n v√†o h√†ng: ${rowToInsert}`);
  if (rowToInsert > xuathoadonSheet.getMaxRows()) {
    xuathoadonSheet.insertRowsAfter(xuathoadonSheet.getMaxRows(), 1);
  }

  const newXuathoadonRow = xuathoadonHeaders.map(header => {
    switch(header) {
      case "S·ªê TT": return "";
      case "T√äN KH√ÅCH H√ÄNG": return invoiceDataFromDaghep["T√™n kh√°ch h√†ng"];
      case "S·ªê ƒê∆†N H√ÄNG": return soDonHang;
      case "D√íNG XE": return invoiceDataFromDaghep["D√≤ng xe"];
      case "PHI√äN B·∫¢N": return invoiceDataFromDaghep["Phi√™n b·∫£n"];
      case "NGO·∫†I TH·∫§T": return invoiceDataFromDaghep["Ngo·∫°i th·∫•t"];
      case "N·ªòI TH·∫§T": return invoiceDataFromDaghep["N·ªôi th·∫•t"];
      case "T∆Ø V·∫§N B√ÅN H√ÄNG": return invoiceDataFromDaghep["T√™n t∆∞ v·∫•n b√°n h√†ng"];
      case "S·ªê VIN": return vin;
      case "S·ªê ƒê·ªòNG C∆†": return soDongCo;
      case "NG√ÄY XU·∫§T H√ìA ƒê∆†N": return "";
      case "PO PIN": return "";
      case "CH√çNH S√ÅCH": return "";
      case "NG√ÄY C·ªåC": return invoiceDataFromDaghep["Ng√†y c·ªçc"];
      case "B√ÅO B√ÅN": return false;
      case "K·∫æT QU·∫¢ G·ª¨I MAIL": return "";
      default: return "";
    }
  });

  // --- DEBUG: D·ªØ li·ªáu chu·∫©n b·ªã ƒë∆∞·ª£c ghi ---
  Logger.log(`D·ªØ li·ªáu h√†ng m·ªõi chu·∫©n b·ªã ghi: ${JSON.stringify(newXuathoadonRow)}`);
  try {
    xuathoadonSheet.getRange(rowToInsert, 1, 1, xuathoadonHeaders.length).setValues([newXuathoadonRow]);
    // --- DEBUG: Ghi d·ªØ li·ªáu th√†nh c√¥ng ---
    Logger.log("ƒê√£ ghi d·ªØ li·ªáu th√†nh c√¥ng v√†o sheet Xuathoadon.");
  } catch (err) {
    // --- DEBUG: L·ªói khi ghi d·ªØ li·ªáu ---
    Logger.log(`L·ªói nghi√™m tr·ªçng khi g·ªçi setValues(): ${err.message}. Stack: ${err.stack}`);
    showToastOnSheet(`ƒê√£ x·∫£y ra l·ªói khi c·ªë g·∫Øng ghi d·ªØ li·ªáu v√†o sheet Xuathoadon. Vui l√≤ng ki·ªÉm tra nh·∫≠t k√Ω th·ª±c thi (Executions).`, "L·ªói"); // Changed from ui.alert
    return;
  }

  if (daghepRowIndex !== -1) {
    daGhepSheet.getRange(daghepRowIndex, daghepHeaders.indexOf("K·∫øt qu·∫£") + 1).setValue("ƒê√£ xu·∫•t h√≥a ƒë∆°n");
  }

  recordOrderHistory(soDonHang, vin, "Xu·∫•t h√≥a ƒë∆°n", `Xu·∫•t h√≥a ƒë∆°n cho ƒë∆°n h√†ng ${soDonHang}`);
  recordVehicleHistory(vin, "Xu·∫•t h√≥a ƒë∆°n", `Xu·∫•t h√≥a ƒë∆°n cho ƒë∆°n h√†ng ${soDonHang}`);

  updateSerialNumbers(xuathoadonSheet);
  syncKhoxeStatus(daGhepSheet, stockSheet, xuathoadonSheet);
  showToastOnSheet(`ƒê√£ xu·∫•t h√≥a ƒë∆°n cho ƒë∆°n h√†ng ${soDonHang}!`, "Th√†nh c√¥ng"); // Changed from ui.alert
  logAction("Xu·∫•t h√≥a ƒë∆°n", `ƒê√£ xu·∫•t h√≥a ƒë∆°n cho ƒë∆°n h√†ng ${soDonHang}, VIN ${vin}`);
}

function findRowInDaGhep(sheet, soDonHang) {
  const data = sheet.getDataRange().getValues();
  const headers = SHEET_HEADERS["DaGhep"];
  const soDonHangCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
  if (soDonHangCol === -1) return -1;

  for (let i = 1; i < data.length; i++) { // Start from 1 to skip header
    if (String(data[i][soDonHangCol] || "").trim() === soDonHang) return i + 1; // 1-based row index
  }
  return -1;
}

function syncInvoiceDate(daghepSheet, xuathoadonSheet) {
  const daghepData = daghepSheet.getDataRange().getValues();
  const xuathoadonData = xuathoadonSheet.getDataRange().getValues();
  
  const daghepHeaders = SHEET_HEADERS["DaGhep"];
  const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];

  const vinColDaghep = daghepHeaders.indexOf("VIN");
  const invoiceDateColDaghep = daghepHeaders.indexOf("Ng√†y xu·∫•t h√≥a ƒë∆°n");

  const vinColXHD = xuathoadonHeaders.indexOf("S·ªê VIN");
  const invoiceDateColXHD = xuathoadonHeaders.indexOf("NG√ÄY XU·∫§T H√ìA ƒê∆†N");

  const vinToInvoiceDate = new Map();

  for (let i = 1; i < xuathoadonData.length; i++) {
    const vin = String(xuathoadonData[i][vinColXHD] || "").trim();
    const invoiceDate = xuathoadonData[i][invoiceDateColXHD];
    if (vin && invoiceDate) vinToInvoiceDate.set(vin, invoiceDate);
  }

  for (let i = 1; i < daghepData.length; i++) {
    const vin = String(daghepData[i][vinColDaghep] || "").trim();
    const currentInvoiceDate = daghepData[i][invoiceDateColDaghep];
    const expectedInvoiceDate = vinToInvoiceDate.get(vin) || "";
    // Compare dates carefully, as they might be Date objects or strings
    const currentInvoiceDateStr = currentInvoiceDate instanceof Date ? Utilities.formatDate(currentInvoiceDate, Session.getScriptTimeZone(), "yyyy-MM-dd") : String(currentInvoiceDate);
    const expectedInvoiceDateStr = expectedInvoiceDate instanceof Date ? Utilities.formatDate(expectedInvoiceDate, Session.getScriptTimeZone(), "yyyy-MM-dd") : String(expectedInvoiceDate);

    if (currentInvoiceDateStr !== expectedInvoiceDateStr) {
      daghepSheet.getRange(i + 1, invoiceDateColDaghep + 1).setValue(expectedInvoiceDate || null); // Set to null if empty to clear
    }
  }
}


/**
 * ƒê·ªíNG B·ªò TR·∫†NG TH√ÅI KHO XE (N√ÇNG C·∫§P)
 * Logic: Xuathoadon > DaGhep > ƒêang Gi·ªØ > Ch∆∞a Gh√©p
 */
function syncKhoxeStatus(daghepSheet, khoxeSheet, xuathoadonSheet) {
  const daghepData = daghepSheet.getDataRange().getValues();
  const xuathoadonData = xuathoadonSheet.getDataRange().getValues();
  const khoxeData = khoxeSheet.getDataRange().getValues();

  const daghepHeaders = SHEET_HEADERS["DaGhep"];
  const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];
  const khoxeHeaders = SHEET_HEADERS["KhoXe"];

  // L·∫•y ch·ªâ s·ªë c·ªôt
  const vinColDaghep = daghepHeaders.indexOf("VIN");
  const vinColXHD = xuathoadonHeaders.indexOf("S·ªê VIN");
  
  const vinColKhoXe = khoxeHeaders.indexOf("VIN");
  const statusColKhoXe = khoxeHeaders.indexOf("Tr·∫°ng th√°i");
  const expiryColKhoXe = khoxeHeaders.indexOf("Th·ªùi Gian H·∫øt H·∫°n Gi·ªØ"); // C·∫ßn ƒë·ªÉ ki·ªÉm tra gi·ªØ xe

  if (vinColKhoXe === -1 || statusColKhoXe === -1) {
    logAction("L·ªói Sync", "Kh√¥ng t√¨m th·∫•y c·ªôt VIN ho·∫∑c Tr·∫°ng th√°i trong KhoXe");
    return;
  }

  // 1. T·∫°o Map cho Xe ƒë√£ xu·∫•t h√≥a ƒë∆°n
  const vinInvoicedSet = new Set();
  for (let i = 1; i < xuathoadonData.length; i++) {
    const vin = String(xuathoadonData[i][vinColXHD] || "").trim().toUpperCase();
    if (vin) vinInvoicedSet.add(vin);
  }

  // 2. T·∫°o Map cho Xe ƒë√£ gh√©p
  const vinMatchedSet = new Set();
  for (let i = 1; i < daghepData.length; i++) {
    const vin = String(daghepData[i][vinColDaghep] || "").trim().toUpperCase();
    if (vin) vinMatchedSet.add(vin);
  }

  // 3. Qu√©t v√† c·∫≠p nh·∫≠t Kho Xe
  const updates = [];
  const timestamp = new Date();

  for (let i = 1; i < khoxeData.length; i++) {
    const vin = String(khoxeData[i][vinColKhoXe] || "").trim().toUpperCase();
    const currentStatus = String(khoxeData[i][statusColKhoXe] || "").trim();
    
    // L·∫•y th√¥ng tin gi·ªØ xe
    const expiryValue = expiryColKhoXe !== -1 ? khoxeData[i][expiryColKhoXe] : null;
    const isHolding = currentStatus.toLowerCase() === "ƒëang gi·ªØ" && expiryValue && new Date(expiryValue) > timestamp;

    let expectedStatus = "Ch∆∞a gh√©p"; // M·∫∑c ƒë·ªãnh

    // --- LOGIC ƒêA T·∫¶NG ---
    if (vinInvoicedSet.has(vin)) {
      expectedStatus = "ƒê√£ xu·∫•t h√≥a ƒë∆°n";
    } else if (vinMatchedSet.has(vin)) {
      expectedStatus = "ƒê√£ gh√©p";
    } else if (isHolding) {
      expectedStatus = "ƒêang gi·ªØ"; // Gi·ªØ nguy√™n n·∫øu ƒëang gi·ªØ h·ª£p l·ªá v√† ch∆∞a gh√©p/xu·∫•t Hƒê
    }
    // ---------------------

    // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu tr·∫°ng th√°i thay ƒë·ªïi
    if (vin && currentStatus !== expectedStatus) {
      // L∆∞u v√†o m·∫£ng updates ƒë·ªÉ ghi 1 l·∫ßn (batch write) ho·∫∑c ghi t·ª´ng d√≤ng n·∫øu c·∫ßn an to√†n
      khoxeSheet.getRange(i + 1, statusColKhoXe + 1).setValue(expectedStatus);
      // N·∫øu xe chuy·ªÉn t·ª´ ƒêang gi·ªØ sang ƒê√£ gh√©p/Ch∆∞a gh√©p -> X√≥a th√¥ng tin gi·ªØ xe ƒë·ªÉ s·∫°ch d·ªØ li·ªáu
      if (currentStatus.toLowerCase() === "ƒëang gi·ªØ" && expectedStatus !== "ƒêang gi·ªØ") {
         const holderCol = khoxeHeaders.indexOf("Ng∆∞·ªùi Gi·ªØ Xe");
         if (holderCol !== -1) khoxeSheet.getRange(i + 1, holderCol + 1).setValue("");
         if (expiryColKhoXe !== -1) khoxeSheet.getRange(i + 1, expiryColKhoXe + 1).setValue("");
      }
    }
  }

  // 4. G·ªçi h√†m d·ªçn d·∫πp xe ƒë√£ xu·∫•t h√≥a ƒë∆°n (n·∫øu c√≥ logic x√≥a)
  removeVehiclesWithInvoicedStatus();
}
function removeXuathoadonRowsFromPreviousMonth() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = getSheets(ss);
  const { xuathoadonSheet } = sheets;
  if (!xuathoadonSheet) {
    logAction("L·ªói x√≥a Xuathoadon", "Kh√¥ng t√¨m th·∫•y sheet 'Xuathoadon'.");
    showToastOnSheet("Kh√¥ng t√¨m th·∫•y sheet 'Xuathoadon'.", "L·ªói"); // Changed from ui.alert
    return;
  }

  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth(); // 0-indexed (January is 0)

  // Determine previous month and year
  let previousMonthDate = new Date(currentYear, currentMonth, 1);
  previousMonthDate.setDate(0); // Go to the last day of the previous month
  const previousYear = previousMonthDate.getFullYear();
  const previousMonth = previousMonthDate.getMonth(); // 0-indexed

  logAction("Th√¥ng tin th√°ng x√≥a (Xuathoadon)", `S·∫Ω x√≥a c√°c d√≤ng trong 'Xuathoadon' c√≥ ng√†y xu·∫•t h√≥a ƒë∆°n (c·ªôt NG√ÄY XU·∫§T H√ìA ƒê∆†N) thu·ªôc th√°ng ${previousMonth + 1}/${previousYear}`);
  const xuathoadonDataRange = xuathoadonSheet.getDataRange();
  const xuathoadonData = xuathoadonDataRange.getValues();
  const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];
  const invoiceDateColXHD = xuathoadonHeaders.indexOf("NG√ÄY XU·∫§T H√ìA ƒê∆†N");
  const soDonHangColXHD = xuathoadonHeaders.indexOf("S·ªê ƒê∆†N H√ÄNG");
  const vinColXHD = xuathoadonHeaders.indexOf("S·ªê VIN");
  if (xuathoadonData.length <= 1) {
    logAction("X√≥a Xuathoadon th√°ng tr∆∞·ªõc", "Sheet 'Xuathoadon' kh√¥ng c√≥ d·ªØ li·ªáu (ch·ªâ c√≥ header ho·∫∑c tr·ªëng).");
    return;
  }

  const rowsToDelete = []; // Store 1-based sheet row numbers

  for (let i = 1; i < xuathoadonData.length; i++) { // Start from 1 to skip header
    const rowData = xuathoadonData[i];
    const invoiceDateValue = rowData[invoiceDateColXHD];

    let invoiceDate = null;
    if (invoiceDateValue instanceof Date && !isNaN(invoiceDateValue)) {
      invoiceDate = invoiceDateValue;
    } else if (typeof invoiceDateValue === 'string' || typeof invoiceDateValue === 'number') {
      const parsedDate = new Date(invoiceDateValue);
      if (!isNaN(parsedDate)) {
        invoiceDate = parsedDate;
      }
    }

    if (invoiceDate) {
      const invoiceYear = invoiceDate.getFullYear();
      const invoiceMonth = invoiceDate.getMonth(); // 0-indexed

      if (invoiceYear === previousYear && invoiceMonth === previousMonth) {
        rowsToDelete.push(i + 1);
      }
    }
  }

  if (rowsToDelete.length === 0) {
    logAction("X√≥a Xuathoadon th√°ng tr∆∞·ªõc", `Kh√¥ng t√¨m th·∫•y d√≤ng n√†o trong 'Xuathoadon' c√≥ ng√†y xu·∫•t h√≥a ƒë∆°n thu·ªôc th√°ng ${previousMonth + 1}/${previousYear} ƒë·ªÉ x√≥a.`);
    return;
  }

  // Sort rows in descending order to delete from bottom up, avoiding index shifts
  rowsToDelete.sort((a, b) => b - a);
  logAction("Chu·∫©n b·ªã x√≥a Xuathoadon", `C√°c d√≤ng (1-based) trong 'Xuathoadon' ƒë∆∞·ª£c x√°c ƒë·ªãnh ƒë·ªÉ x√≥a: ${rowsToDelete.join(', ')}`);

  let deletedCount = 0;
  rowsToDelete.forEach(rowNumToDelete => {
    const originalRowIndexInData = rowNumToDelete - 1; // 0-based index in xuathoadonData

    if (originalRowIndexInData >= 1 && originalRowIndexInData < xuathoadonData.length) { // Ensure it's a valid data row index
      const soDonHangCuaDongBiXoa = String(xuathoadonData[originalRowIndexInData][soDonHangColXHD] || "").trim();
      const vinCuaDongBiXoa = String(xuathoadonData[originalRowIndexInData][vinColXHD] || "").trim();
      const ngayXuatHoaDonBiXoa = xuathoadonData[originalRowIndexInData][invoiceDateColXHD];

      recordOrderHistory(soDonHangCuaDongBiXoa, vinCuaDongBiXoa, "X√≥a h√≥a ƒë∆°n (Xuathoadon)", `H√≥a ƒë∆°n b·ªã x√≥a kh·ªèi Xuathoadon do ng√†y xu·∫•t (c·ªôt NG√ÄY XU·∫§T H√ìA ƒê∆†N: ${Utilities.formatDate(new Date(ngayXuatHoaDonBiXoa), Session.getScriptTimeZone(), "dd/MM/yyyy")}) thu·ªôc th√°ng ${previousMonth + 1}/${previousYear}.`);

      xuathoadonSheet.deleteRow(rowNumToDelete);
      deletedCount++;
      logAction("X√≥a d√≤ng Xuathoadon", `ƒê√£ x√≥a d√≤ng ${rowNumToDelete} trong 'Xuathoadon'.`);
    } else {
      logAction("L·ªói ghi l·ªãch s·ª≠ ho·∫∑c x√≥a Xuathoadon", `Kh√¥ng th·ªÉ truy c·∫≠p xuathoadonData[${originalRowIndexInData}] ho·∫∑c d√≤ng sheet ${rowNumToDelete} kh√¥ng h·ª£p l·ªá.`);
    }
  });


  if (deletedCount > 0) {
    updateSerialNumbers(xuathoadonSheet);
    logAction("Ho√†n t·∫•t x√≥a Xuathoadon", `ƒê√£ x√≥a t·ªïng c·ªông ${deletedCount} d√≤ng kh·ªèi sheet 'Xuathoadon'. C·ªôt S·ªë TT ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.`);
    showToastOnSheet(`ƒê√£ x√≥a ${deletedCount} d√≤ng kh·ªèi sheet 'Xuathoadon' do c√≥ ng√†y xu·∫•t h√≥a ƒë∆°n thu·ªôc th√°ng ${previousMonth + 1}/${previousYear}. S·ªë th·ª© t·ª± ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.`, "Ho√†n t·∫•t"); // Changed from ui.alert
  }
}

function setupRemoveXuathoadonTrigger() {
  const ui = SpreadsheetApp.getUi();
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === "removeXuathoadonRowsFromPreviousMonth") {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  try {
    ScriptApp.newTrigger("removeXuathoadonRowsFromPreviousMonth")
      .timeBased()
      .onMonthDay(1)
      .atHour(9) // Runs at 9 AM on the 1st of every month
      .create();
    showToastOnSheet("ƒê√£ thi·∫øt l·∫≠p trigger x√≥a h√≥a ƒë∆°n trong Xuathoadon ƒë√£ xu·∫•t h√≥a ƒë∆°n th√°ng tr∆∞·ªõc v√†o ng√†y 1 m·ªói th√°ng l√∫c 9:00.", "Th√†nh c√¥ng"); // Changed from ui.alert
    logAction("Thi·∫øt l·∫≠p trigger", "Trigger x√≥a h√≥a ƒë∆°n Xuathoadon th√°ng tr∆∞·ªõc ƒë∆∞·ª£c thi·∫øt l·∫≠p");
  } catch (e) {
    showToastOnSheet(`L·ªói khi thi·∫øt l·∫≠p trigger: ${e.message}`, "L·ªói"); // Changed from ui.alert
    logAction("L·ªói thi·∫øt l·∫≠p trigger", `Trigger x√≥a h√≥a ƒë∆°n Xuathoadon th√°ng tr∆∞·ªõc: ${e.message}`);
  }

}

function showManualMatchSidebar() {
  const html = HtmlService.createHtmlOutputFromFile('Sidebar')
      .setTitle('Gh√©p Xe Th·ªß C√¥ng')
      .setWidth(300);
  SpreadsheetApp.getUi().showSidebar(html);
}
function getUnpairedOrdersAndAvailableCars() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const chuaGhepSheet = getOrCreateSheet(ss, CHUA_GHEP_SHEET_NAME, SHEET_HEADERS["ChuaGhep"]);
    const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);

    const unpairedOrders = [];
    if (chuaGhepSheet && chuaGhepSheet.getLastRow() > 1) {
      const data = chuaGhepSheet.getDataRange().getValues();
      const headers = SHEET_HEADERS["ChuaGhep"]; // Use defined headers
      
      const tvbhCol = headers.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng");
      const tenKhCol = headers.indexOf("T√™n kh√°ch h√†ng");
      const dongXeCol = headers.indexOf("D√≤ng xe");
      const phienBanCol = headers.indexOf("Phi√™n b·∫£n");
      const ngoaiThatCol = headers.indexOf("Ngo·∫°i th·∫•t");
      const noiThatCol = headers.indexOf("N·ªôi th·∫•t");
      const soDonHangCol = headers.indexOf("S·ªë ƒë∆°n h√†ng"); 
      const ngayCocCol = headers.indexOf("Ng√†y c·ªçc");
      const ketQuaCol = headers.indexOf("K·∫øt qu·∫£");

      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const orderNumber = String(row[soDonHangCol] || "").trim();
        const ketQua = String(row[ketQuaCol] || "").toLowerCase().trim();

        if ((ketQua === "ch∆∞a gh√©p" || ketQua === "ch∆∞a t√¨m th·∫•y vin" || ketQua === "ch∆∞a c√≥") && orderNumber.length > 0) {
          
          let ngayCocValue = row[ngayCocCol];
          if (ngayCocValue instanceof Date) {
            ngayCocValue = Utilities.formatDate(ngayCocValue, Session.getScriptTimeZone(), "dd/MM/yyyy");
          } else if (ngayCocValue) { // If it's a string or number, try to format
            try {
                ngayCocValue = Utilities.formatDate(new Date(ngayCocValue), Session.getScriptTimeZone(), "dd/MM/yyyy");
            } catch(err){/*ignore format error, keep original*/}
          }


          const orderObject = {
            ten_tu_van_ban_hang: row[tvbhCol],
            ten_khach_hang: row[tenKhCol],
            dong_xe: row[dongXeCol],
            phien_ban: row[phienBanCol],
            ngoai_that: row[ngoaiThatCol],
            noi_that: row[noiThatCol],
            so_don_hang: orderNumber, 
            ngay_coc: ngayCocValue
          };
          unpairedOrders.push(orderObject);
        }
      }
    }

    const availableCars = [];
    if (stockSheet && stockSheet.getLastRow() > 1) {
      const stockData = stockSheet.getDataRange().getValues();
      const stockHeaders = SHEET_HEADERS["KhoXe"]; // Use defined headers
      const vinCol = stockHeaders.indexOf("VIN");
      const statusCol = stockHeaders.indexOf("Tr·∫°ng th√°i");
      const dongXeCol = stockHeaders.indexOf("D√≤ng xe");
      const phienBanCol = stockHeaders.indexOf("Phi√™n b·∫£n");
      const ngoaiThatCol = stockHeaders.indexOf("Ngo·∫°i th·∫•t");
      const noiThatCol = stockHeaders.indexOf("N·ªôi th·∫•t");
      const ngayNhapCol = stockHeaders.indexOf("Ng√†y nh·∫≠p");

      for (let i = 1; i < stockData.length; i++) {
        const rowData = stockData[i];
        if (String(rowData[statusCol]).toLowerCase().trim() === "ch∆∞a gh√©p" && String(rowData[vinCol]).trim() !== "") {
          let formattedDate = "";
          const ngayNhapValue = rowData[ngayNhapCol];
          if (ngayNhapValue) {
            const date = new Date(ngayNhapValue);
            if (date instanceof Date && !isNaN(date.getTime())) { 
              formattedDate = Utilities.formatDate(date, "GMT+7", "dd/MM/yyyy HH:mm:ss");
            } else {
              formattedDate = String(ngayNhapValue); // Keep as string if not a valid date
            }
          }
          availableCars.push({
            vin: String(rowData[vinCol]).trim(),
            dong_xe: String(rowData[dongXeCol]).trim(),
            phien_ban: String(rowData[phienBanCol]).trim(),
            ngoai_that: String(rowData[ngoaiThatCol]).trim(),
            noi_that: String(rowData[noiThatCol]).trim(),
            trang_thai: String(rowData[statusCol]).trim(),
            ngay_nhap: formattedDate
          });
        }
      }
    }
    
    return { status: "SUCCESS", unpairedOrders: unpairedOrders, availableCars: availableCars };

  } catch (e) {
    Logger.log("L·ªói nghi√™m tr·ªçng trong getUnpairedOrdersAndAvailableCars: " + e.stack);
    return { status: "ERROR", message: `L·ªói m√°y ch·ªß: ${e.message}` };
  }
}
function getCarDetailsByVin(vin) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
    const stockData = stockSheet.getDataRange().getValues();

    if (stockData.length <= 1) {
      return { status: "ERROR", message: "Sheet KhoXe kh√¥ng c√≥ d·ªØ li·ªáu." };
    }

    const headers = SHEET_HEADERS["KhoXe"]; // Use defined headers
    const vinCol = headers.indexOf("VIN"); 
    const dongXeCol = headers.indexOf("D√≤ng xe");
    const phienBanCol = headers.indexOf("Phi√™n b·∫£n");
    const ngoaiThatCol = headers.indexOf("Ngo·∫°i th·∫•t");
    const noiThatCol = headers.indexOf("N·ªôi th·∫•t");
    const statusCol = headers.indexOf("Tr·∫°ng th√°i"); 
    const ngayNhapCol = headers.indexOf("Ng√†y nh·∫≠p");

    if ([vinCol, dongXeCol, phienBanCol, ngoaiThatCol, noiThatCol, statusCol, ngayNhapCol].some(col => col === -1)) {
        logAction("L·ªói", "Sheet KhoXe thi·∫øu m·ªôt s·ªë c·ªôt c·∫ßn thi·∫øt ƒë·ªÉ l·∫•y chi ti·∫øt xe.");
        return { status: "ERROR", message: "Missing required columns in KhoXe sheet for car details." };
    }

    for (let i = 1; i < stockData.length; i++) {
      const row = stockData[i];
      if (String(row[vinCol]).trim() === String(vin).trim()) {
        let formattedNgayNhap = "";
        if (row[ngayNhapCol]){
            const date = new Date(row[ngayNhapCol]);
            if(date instanceof Date && !isNaN(date.getTime())){
                formattedNgayNhap = Utilities.formatDate(date, "GMT+7", "dd/MM/yyyy HH:mm:ss");
            } else {
                formattedNgayNhap = String(row[ngayNhapCol]);
            }
        }
        return {
          status: "SUCCESS",
          car: {
            vin: String(row[vinCol]).trim(),
            dong_xe: String(row[dongXeCol]).trim(),
            phien_ban: String(row[phienBanCol]).trim(),
            ngoai_that: String(row[ngoaiThatCol]).trim(),
            noi_that: String(row[noiThatCol]).trim(),
            trang_thai: String(row[statusCol]).trim(),
            ngay_nhap: formattedNgayNhap
          }
        };
      }
    }
    return { status: "ERROR", message: "Kh√¥ng t√¨m th·∫•y xe v·ªõi VIN n√†y." };
  } catch (e) {
    logAction("L·ªói l·∫•y chi ti·∫øt xe theo VIN", `L·ªói: ${e.message} Stack: ${e.stack}`);
    return { status: "ERROR", message: `L·ªói khi l·∫•y chi ti·∫øt xe: ${e.message}` };
  }
}
function manualMatchCar(orderNumber, vin) {
  // S·ª≠ d·ª•ng doReadWriteLock ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n d·ªØ li·ªáu khi c√≥ nhi·ªÅu ng∆∞·ªùi d√πng.
  const result = doReadWriteLock(() => {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const daGhepSheet = getOrCreateSheet(ss, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"]);
    const chuaGhepSheet = getOrCreateSheet(ss, CHUA_GHEP_SHEET_NAME, SHEET_HEADERS["ChuaGhep"]);
    const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
    const mailSheet = getOrCreateSheet(ss, MAIL_SHEET_NAME, SHEET_HEADERS["Mail"]);

    if (!daGhepSheet || !chuaGhepSheet || !stockSheet || !mailSheet) {
      throw new Error("Kh√¥ng t√¨m th·∫•y m·ªôt ho·∫∑c nhi·ªÅu sheet c·∫ßn thi·∫øt.");
    }

    const chuaGhepData = chuaGhepSheet.getDataRange().getValues();
    const chuaGhepHeaders = SHEET_HEADERS["ChuaGhep"];
    const orderNumberColChuaGhep = chuaGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
    let orderRowIndex = -1;
    let orderDataFromChuaGhep = null;

    for (let i = 1; i < chuaGhepData.length; i++) {
      if (String(chuaGhepData[i][orderNumberColChuaGhep]).trim() === String(orderNumber).trim()) {
        orderRowIndex = i + 1; // 1-based index
        orderDataFromChuaGhep = chuaGhepData[i];
        break;
      }
    }

    if (orderRowIndex === -1) {
      logAction("L·ªói gh√©p th·ªß c√¥ng", `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} trong sheet 'ChuaGhep'.`);
      return { status: "ERROR", message: `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} trong danh s√°ch ch·ªù gh√©p.` };
    }

    const stockData = stockSheet.getDataRange().getValues();
    const stockHeaders = SHEET_HEADERS["KhoXe"];
    const vinColStock = stockHeaders.indexOf("VIN");
    const statusColStock = stockHeaders.indexOf("Tr·∫°ng th√°i");
    const maDMSColStock = stockHeaders.indexOf("M√£ DMS");
    let carRowIndex = -1;
    let carDataFromStock = null;

    for (let i = 1; i < stockData.length; i++) {
      if (String(stockData[i][vinColStock]).trim() === String(vin).trim()) {
        carRowIndex = i + 1;
        carDataFromStock = stockData[i];
        break;
      }
    }

    if (carRowIndex === -1) {
      logAction("L·ªói gh√©p th·ªß c√¥ng", `Kh√¥ng t√¨m th·∫•y VIN ${vin} trong sheet 'KhoXe'.`);
      return { status: "ERROR", message: `Kh√¥ng t√¨m th·∫•y VIN ${vin} trong kho xe.` };
    }

    if (String(carDataFromStock[statusColStock]).toLowerCase().trim() !== "ch∆∞a gh√©p") {
      logAction("L·ªói gh√©p th·ªß c√¥ng", `VIN ${vin} ƒë√£ c√≥ tr·∫°ng th√°i '${carDataFromStock[statusColStock]}', kh√¥ng th·ªÉ gh√©p.`);
      return { status: "ERROR", message: `VIN ${vin} ƒë√£ c√≥ tr·∫°ng th√°i '${carDataFromStock[statusColStock]}', kh√¥ng th·ªÉ gh√©p.` };
    }

    const maDMS = carDataFromStock[maDMSColStock];
    stockSheet.getRange(carRowIndex, statusColStock + 1).setValue("ƒê√£ gh√©p");
    recordVehicleHistory(vin, "Gh√©p th·ªß c√¥ng", `ƒê√£ gh√©p v·ªõi ƒë∆°n h√†ng ${orderNumber}`);

    const newRowForDaGhep = {};
    const currentTime = new Date();
    const daGhepHeaders = SHEET_HEADERS["DaGhep"];

    daGhepHeaders.forEach(header => {
      const chuaGhepHeaderIndex = chuaGhepHeaders.indexOf(header);
      newRowForDaGhep[header] = (chuaGhepHeaderIndex !== -1) ? orderDataFromChuaGhep[chuaGhepHeaderIndex] : "";
    });

    newRowForDaGhep["VIN"] = vin;
    newRowForDaGhep["K·∫øt qu·∫£"] = "ƒê√£ gh√©p";
    newRowForDaGhep["Th·ªùi gian gh√©p"] = formatDateTimeForSheet(currentTime);
    
    const targetRow = daGhepSheet.getLastRow() + 1;
    const thoiGianGhepColLetter = "K";
    newRowForDaGhep["S·ªë ng√†y gh√©p"] = `=IFERROR(DATEDIF(${thoiGianGhepColLetter}${targetRow};TODAY();"D"))`;

    const rowDataToAppend = daGhepHeaders.map(header => newRowForDaGhep[header] || "");
    daGhepSheet.appendRow(rowDataToAppend);
    
    chuaGhepSheet.deleteRow(orderRowIndex);

    const orderDataForEmail = {
      ten_ban_hang: newRowForDaGhep["T√™n t∆∞ v·∫•n b√°n h√†ng"],
      ten_khach_hang: newRowForDaGhep["T√™n kh√°ch h√†ng"],
      dong_xe: newRowForDaGhep["D√≤ng xe"],
      phien_ban: newRowForDaGhep["Phi√™n b·∫£n"],
      ngoai_that: newRowForDaGhep["Ngo·∫°i th·∫•t"],
      noi_that: newRowForDaGhep["N·ªôi th·∫•t"],
      so_don_hang: newRowForDaGhep["S·ªë ƒë∆°n h√†ng"],
      ngay_coc: newRowForDaGhep["Ng√†y c·ªçc"],
      thoi_gian_nhap: newRowForDaGhep["Th·ªùi gian nh·∫≠p"]
    };
    
    const emailSentSuccessfully = sendEmailNotification(mailSheet, orderDataForEmail, vin, maDMS, currentTime);
    
    const lastDaGhepRow = daGhepSheet.getLastRow();
    const trangThaiGuiMailColDaGhep = daGhepHeaders.indexOf("Tr·∫°ng th√°i g·ª≠i mail");
    if (trangThaiGuiMailColDaGhep !== -1) {
        daGhepSheet.getRange(lastDaGhepRow, trangThaiGuiMailColDaGhep + 1).setValue(emailSentSuccessfully ? "ƒê√£ g·ª≠i" : "L·ªói g·ª≠i");
    }

    recordOrderHistory(orderNumber, vin, "Gh√©p th·ªß c√¥ng", `ƒê√£ gh√©p th·ªß c√¥ng VIN ${vin} cho ƒë∆°n h√†ng ${orderNumber}`);
    runSyncKhoxeStatus();
    return `ƒê√£ gh√©p th√†nh c√¥ng ƒë∆°n h√†ng ${orderNumber} v·ªõi VIN ${vin}.`;
  });

  // T√≠ch h·ª£p th√¥ng b√°o
  if (result && typeof result === 'string' && result.startsWith("ƒê√£ gh√©p th√†nh c√¥ng")) {
    addNotification(`ƒê∆°n h√†ng ${orderNumber} ƒë√£ ƒë∆∞·ª£c gh√©p th·ªß c√¥ng v·ªõi xe ${vin}.`, 'success');
  } else if (result && result.status === "ERROR") {
    addNotification(`Gh√©p th·ªß c√¥ng th·∫•t b·∫°i cho ƒêH ${orderNumber}: ${result.message}`, 'danger');
  }
  return result;
}


function unmatchOrder(orderNumber, reason, userEmail) {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheets = getSheets(ss);
    const { daGhepSheet, stockSheet, chuaGhepSheet } = sheets;

    if (!orderNumber) {
        return { success: false, message: "L·ªói: Kh√¥ng c√≥ s·ªë ƒë∆°n h√†ng." };
    }
    if (!reason || reason.trim() === "") {
        return { success: false, message: "L·ªói: L√Ω do h·ªßy gh√©p l√† b·∫Øt bu·ªôc." };
    }

    const daGhepData = daGhepSheet.getDataRange().getValues();
    const daGhepHeaders = daGhepSheet.getRange(1, 1, 1, daGhepSheet.getLastColumn()).getValues()[0];
    const orderColIndex = daGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
    const vinColIndex = daGhepHeaders.indexOf("VIN");

    let orderRowIndex = -1;
    let rowDataToMove = null;
    for (let i = 1; i < daGhepData.length; i++) {
        if (String(daGhepData[i][orderColIndex]).trim() === String(orderNumber).trim()) {
            orderRowIndex = i + 1;
            rowDataToMove = daGhepData[i];
            break;
        }
    }

    if (orderRowIndex === -1) {
        logAction("L·ªói H·ªßy Gh√©p", `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} trong sheet 'DaGhep'.`);
        return { success: false, message: `L·ªói: Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} trong danh s√°ch ƒë√£ gh√©p.` };
    }

    const vinToRevert = String(rowDataToMove[vinColIndex] || "").trim();
    if (vinToRevert) {
        updateKhoxeStatusForVin(stockSheet, vinToRevert, "Ch∆∞a gh√©p");
        recordVehicleHistory(vinToRevert, "H·ªßy gh√©p xe", `H·ªßy gh√©p v·ªõi ƒêH ${orderNumber}. L√Ω do: ${reason}. VIN ƒë∆∞·ª£c tr·∫£ v·ªÅ kho.`);
    }

    const chuaGhepHeaders = SHEET_HEADERS["ChuaGhep"];
    const newChuaGhepRow = {};
    
    chuaGhepHeaders.forEach(header => {
        const indexInDaGhep = daGhepHeaders.indexOf(header);
        if (indexInDaGhep !== -1) {
            newChuaGhepRow[header] = rowDataToMove[indexInDaGhep];
        }
    });
    newChuaGhepRow["K·∫øt qu·∫£"] = "Ch∆∞a gh√©p";
    newChuaGhepRow["Tr·∫°ng th√°i g·ª≠i mail"] = ""; // X√≥a tr·∫°ng th√°i mail c≈©

    const rowDataForChuaGhep = chuaGhepHeaders.map(header => newChuaGhepRow[header] || "");
    chuaGhepSheet.appendRow(rowDataForChuaGhep);

    daGhepSheet.deleteRow(orderRowIndex);
    
    const historyDetails = `ƒê√£ h·ªßy gh√©p xe. L√Ω do: "${reason}". ƒê∆°n h√†ng ƒë∆∞·ª£c chuy·ªÉn v·ªÅ l·∫°i 'Ch·ªù Gh√©p' b·ªüi ${userEmail}.`;
    recordOrderHistory(orderNumber, vinToRevert, "H·ªßy gh√©p xe", historyDetails);

    const emailData = {
      ten_ban_hang: newChuaGhepRow["T√™n t∆∞ v·∫•n b√°n h√†ng"],
      ten_khach_hang: newChuaGhepRow["T√™n kh√°ch h√†ng"],
      so_don_hang: orderNumber
    };
    runSyncKhoxeStatus();
    return {
        success: true,
        message: `ƒê√£ h·ªßy gh√©p th√†nh c√¥ng cho ƒë∆°n h√†ng ${orderNumber}.`,
        emailData: emailData,
        vin: vinToRevert,
        reason: reason
    };
}
function showToastOnSheet(message, title = "Th√¥ng B√°o", timeoutSeconds = 5) {
  try {
    SpreadsheetApp.getActiveSpreadsheet().toast(message, title, timeoutSeconds);
    Logger.log(`Toast displayed: ${message}`);
  } catch (e) {
    Logger.log(`L·ªói khi hi·ªÉn th·ªã toast: ${e.message}`);
    // Fallback: n·∫øu toast kh√¥ng ho·∫°t ƒë·ªông (v√≠ d·ª•, do kh√¥ng c√≥ UI), log l·ªói ho·∫∑c d√πng alert.
    SpreadsheetApp.getUi().alert("Th√¥ng b√°o", message);
  }
}
function addToChuaghepIfNotDuplicate(chuaGhepSheet, orderData) {
  const chuaGhepData = chuaGhepSheet.getDataRange().getValues();
  const headers = SHEET_HEADERS["ChuaGhep"]; // Use defined headers
  const soDonHangCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
  // const vinCol = headers.indexOf("VIN"); // VIN is not expected to be in orderData for ChuaGhep

  const existingOrder = chuaGhepData.slice(1).find(row => // slice(1) to skip header
    String(row[soDonHangCol] || "").trim() === String(orderData.so_don_hang || "").trim()
  );

  if (existingOrder) {
    logAction("B·ªè qua th√™m v√†o ChuaGhep", `ƒê∆°n h√†ng ${orderData.so_don_hang} ƒë√£ t·ªìn t·∫°i trong ChuaGhep.`);
    return;
  }

  const newRowValues = [];
  headers.forEach(header => {
      // Map orderData (which uses underscore keys) to header names
      let value = "";
      if (header === "T√™n t∆∞ v·∫•n b√°n h√†ng") value = orderData.ten_ban_hang;
      else if (header === "T√™n kh√°ch h√†ng") value = orderData.ten_khach_hang;
      else if (header === "D√≤ng xe") value = orderData.dong_xe;
      else if (header === "Phi√™n b·∫£n") value = orderData.phien_ban;
      else if (header === "Ngo·∫°i th·∫•t") value = orderData.ngoai_that;
      else if (header === "N·ªôi th·∫•t") value = orderData.noi_that;
      else if (header === "S·ªë ƒë∆°n h√†ng") value = orderData.so_don_hang;
      else if (header === "Ng√†y c·ªçc") value = orderData.ngay_coc;
      else if (header === "Th·ªùi gian nh·∫≠p") value = formatDateTimeForSheet(new Date(orderData.thoi_gian_nhap)); // Ensure format
      else if (header === "K·∫øt qu·∫£") value = "Ch∆∞a gh√©p";
      // VIN, Th·ªùi gian gh√©p, S·ªë ng√†y gh√©p, Tr·∫°ng th√°i g·ª≠i mail will be empty or default
      newRowValues.push(value);
  });


  chuaGhepSheet.appendRow(newRowValues);
  logAction("Th√™m v√†o ChuaGhep", `ƒê√£ th√™m ƒë∆°n h√†ng ${orderData.so_don_hang} v√†o ChuaGhep.`);
}


function restoreVinToDaghep(ss, vin, xuathoadonRowArray) { // xuathoadonRowArray is the array of values from the deleted row
  const daGhepSheet = getOrCreateSheet(ss, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"]);
  const chuaGhepSheet = getOrCreateSheet(ss, CHUA_GHEP_SHEET_NAME, SHEET_HEADERS["ChuaGhep"]);
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);

  const daghepData = daGhepSheet.getDataRange().getValues();
  const daghepHeaders = SHEET_HEADERS["DaGhep"];
  const vinColDaghep = daghepHeaders.indexOf("VIN");
  const resultColDaghep = daghepHeaders.indexOf("K·∫øt qu·∫£");
  const invoiceDateColDaghep = daghepHeaders.indexOf("Ng√†y xu·∫•t h√≥a ƒë∆°n");

  let foundInDaghep = false;
  for (let i = 1; i < daghepData.length; i++) { // Start from 1 to skip header
    if (String(daghepData[i][vinColDaghep] || "").trim() === String(vin).trim()) {
      daGhepSheet.getRange(i + 1, resultColDaghep + 1).setValue("ƒê√£ gh√©p");
      daGhepSheet.getRange(i + 1, invoiceDateColDaghep + 1).setValue(""); // Clear invoice date
      logAction("Kh√¥i ph·ª•c DaGhep", `VIN ${vin} ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c tr·∫°ng th√°i 'ƒê√£ gh√©p' v√† x√≥a ng√†y xu·∫•t h√≥a ƒë∆°n trong DaGhep.`);
      foundInDaghep = true;
      break;
    }
  }

  if (!foundInDaghep) {
    const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];
    const soDonHang = String(xuathoadonRowArray[xuathoadonHeaders.indexOf("S·ªê ƒê∆†N H√ÄNG")] || "").trim();
    
    const orderDataForChuaGhep = {
      ten_ban_hang: xuathoadonRowArray[xuathoadonHeaders.indexOf("T∆Ø V·∫§N B√ÅN H√ÄNG")],
      ten_khach_hang: xuathoadonRowArray[xuathoadonHeaders.indexOf("T√äN KH√ÅCH H√ÄNG")],
      dong_xe: xuathoadonRowArray[xuathoadonHeaders.indexOf("D√íNG XE")],
      phien_ban: xuathoadonRowArray[xuathoadonHeaders.indexOf("PHI√äN B·∫¢N")],
      ngoai_that: xuathoadonRowArray[xuathoadonHeaders.indexOf("NGO·∫†I TH·∫§T")],
      noi_that: xuathoadonRowArray[xuathoadonHeaders.indexOf("N·ªòI TH·∫§T")],
      so_don_hang: soDonHang,
      ngay_coc: xuathoadonRowArray[xuathoadonHeaders.indexOf("NG√ÄY C·ªåC")],
      thoi_gian_nhap: new Date() // Use current time for re-entry into ChuaGhep
    };
    addToChuaghepIfNotDuplicate(chuaGhepSheet, orderDataForChuaGhep);
    logAction("Th√™m v√†o ChuaGhep (restore)", `VIN ${vin} kh√¥ng c√≥ trong DaGhep, ƒë√£ th√™m/ki·ªÉm tra ƒë∆°n h√†ng ${soDonHang} trong ChuaGhep.`);
  }

  updateKhoxeStatusForVin(stockSheet, vin, foundInDaghep ? "ƒê√£ gh√©p" : "Ch∆∞a gh√©p");
}
/**
 * T·∫°o n·ªôi dung HTML cho email c·∫£nh b√°o ƒë∆°n h√†ng qu√° h·∫°n.
 * @param {string} title - Ti√™u ƒë·ªÅ ch√≠nh c·ªßa email.
 * @param {string} recipientName - T√™n ng∆∞·ªùi nh·∫≠n.
 * @param {Array<Object>} orders - M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng ƒë∆°n h√†ng qu√° h·∫°n.
 * @param {string} note - Ghi ch√∫ cu·ªëi email.
 * @returns {string} - N·ªôi dung HTML c·ªßa email.
 */
function createOverdueWarningEmailBody(title, recipientName, orders, note) {
  let ordersHtml = `
    <tr style="background-color: #f0f4f8;">
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left;">STT</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left;">S·ªë ƒë∆°n h√†ng</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left;">T√™n kh√°ch h√†ng</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left;">S·ªë VIN</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: center;">S·ªë ng√†y gh√©p</th>
    </tr>
  `;

  orders.forEach((order, index) => {
    ordersHtml += `
      <tr>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${index + 1}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${order.so_don_hang}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${order.ten_khach_hang}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${order.vin}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1; text-align: center; font-weight: bold; color: #dc3545;">${order.so_ngay_ghep}</td>
      </tr>
    `;
  });

  const vinfastBlue = '#00509E';
  const body = `
    <div style="font-family: 'Roboto', Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px;">
      <table width="100%" border="0" cellspacing="0" cellpadding="0" style="max-width: 700px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
        <thead>
          <tr>
            <th style="background-color: ${vinfastBlue}; color: #ffffff; padding: 15px 25px; text-align: left;">
              <h1 style="margin: 0; font-size: 16px; font-weight: 400; text-transform: uppercase; letter-spacing: 0.5px;">Th√¥ng B√°o H·ªá Th·ªëng</h1>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="padding: 25px;">
              <h2 style="color: #dc3545; font-size: 20px; margin-top: 0; margin-bottom: 15px;">${title}</h2>
              <p style="color: #555; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                Xin ch√†o <b>${recipientName}</b>,
              </p>
              <p style="color: #555; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                H·ªá th·ªëng ghi nh·∫≠n c√°c ƒë∆°n h√†ng d∆∞·ªõi ƒë√¢y ƒë√£ gh√©p xe ƒë∆∞·ª£c 4 ng√†y tr·ªü l√™n nh∆∞ng ch∆∞a ƒë∆∞·ª£c xu·∫•t h√≥a ƒë∆°n. Anh/Ch·ªã vui l√≤ng ki·ªÉm tra v√† x·ª≠ l√Ω s·ªõm:
              </p>
              <table width="100%" border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse; border: 1px solid #dfe6f1; border-radius: 5px;">
                ${ordersHtml}
              </table>
              <p style="color: #555; font-size: 16px; line-height: 1.6; margin-top: 25px;">
                ${note}
              </p>
            </td>
          </tr>
          <tr>
            <td style="background-color: #f1f3f5; padding: 20px; text-align: center; font-size: 12px; color: #888;">
              <p style="margin: 0;">ƒê√¢y l√† email t·ª± ƒë·ªông, vui l√≤ng kh√¥ng tr·∫£ l·ªùi.</p>
              <p style="margin: 5px 0 0;">Tr√¢n tr·ªçng.</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>`;
  return body;
}
function sendOverdueWarningEmail(mailSheet, consultantName, orders) {
  const recipientEmail = getEmailForAdvisor(mailSheet, consultantName); // 
  if (!recipientEmail) {
    logAction("L·ªói g·ª≠i c·∫£nh b√°o qu√° h·∫°n", `Kh√¥ng t√¨m th·∫•y email cho ${consultantName}`);
    return false;
  }

  // TI√äU ƒê·ªÄ EMAIL ƒê∆Ø·ª¢C L√ÄM N·ªîI B·∫¨T H∆†N
  const subject = `[C·∫¢NH B√ÅO] ${orders.length} ƒë∆°n h√†ng qu√° h·∫°n xu·∫•t h√≥a ƒë∆°n c·∫ßn x·ª≠ l√Ω ngay`;
  const title = "C·∫£nh B√°o ƒê∆°n H√†ng Qu√° H·∫°n Gh√©p Xe"; // 
  const note = "Vui l√≤ng li√™n h·ªá Admin n·∫øu c√≥ b·∫•t k·ª≥ th·∫Øc m·∫Øc n√†o."; // 

  const bodyContent = createOverdueWarningEmailBody(title, consultantName, orders, note); // 
  const fullHtml = createFullHtmlEmail(subject, bodyContent); // 

  try {
    MailApp.sendEmail({ to: recipientEmail, subject: subject, htmlBody: fullHtml }); // 
    logAction("G·ª≠i c·∫£nh b√°o qu√° h·∫°n", `G·ª≠i th√†nh c√¥ng t·ªõi ${recipientEmail} v·ªõi ${orders.length} ƒë∆°n h√†ng.`); // 
    return true; // 
  } catch (e) {
    logAction("L·ªói g·ª≠i c·∫£nh b√°o qu√° h·∫°n", `L·ªói khi g·ª≠i mail t·ªõi ${recipientEmail}: ${e.message}`); // 
    return false; // 
  }
}
function checkForOverdueOrders() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const daGhepSheet = ss.getSheetByName(DA_GHEP_SHEET_NAME);
  const mailSheet = ss.getSheetByName(MAIL_SHEET_NAME);

  if (!daGhepSheet || !mailSheet) {
    logAction("L·ªói c·∫£nh b√°o qu√° h·∫°n", "Kh√¥ng t√¨m th·∫•y sheet DaGhep ho·∫∑c Mail.");
    return;
  }

  const dataRange = daGhepSheet.getDataRange();
  const values = dataRange.getValues();
  const sheetHeaders = values[0];
  const soNgayGhepCol = sheetHeaders.indexOf("S·ªë ng√†y gh√©p");
  const ngayXuatHDCol = sheetHeaders.indexOf("Ng√†y xu·∫•t h√≥a ƒë∆°n");
  const tvbhCol = sheetHeaders.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng");
  const soDonHangCol = sheetHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
  const tenKhachHangCol = sheetHeaders.indexOf("T√™n kh√°ch h√†ng");
  const vinCol = sheetHeaders.indexOf("VIN");
  const canhBaoCol = sheetHeaders.indexOf("C·∫£nh b√°o qu√° h·∫°n");
  const ketQuaCol = sheetHeaders.indexOf("K·∫øt qu·∫£");

  if ([soNgayGhepCol, ngayXuatHDCol, tvbhCol, soDonHangCol, tenKhachHangCol, vinCol, canhBaoCol, ketQuaCol].some(c => c === -1)) {
      logAction("L·ªói c·∫£nh b√°o qu√° h·∫°n", "Thi·∫øu c√°c c·ªôt c·∫ßn thi·∫øt trong sheet DaGhep.");
      return;
  }
  
  const overdueOrdersByConsultant = {};
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const consultantName = row[tvbhCol];
    if (!consultantName) continue;

    const soNgayGhep = row[soNgayGhepCol];
    const ngayXuatHD = row[ngayXuatHDCol];
    const ketQua = String(row[ketQuaCol]).trim();
    const soNgayGhepValue = parseInt(soNgayGhep, 10);
    
    if (!isNaN(soNgayGhepValue) && soNgayGhepValue >= 4 && !ngayXuatHD && ketQua === "ƒê√£ gh√©p") { 
      if (!overdueOrdersByConsultant[consultantName]) {
        overdueOrdersByConsultant[consultantName] = [];
      }
      
      overdueOrdersByConsultant[consultantName].push({
        so_don_hang: row[soDonHangCol],
        ten_khach_hang: row[tenKhachHangCol],
        vin: row[vinCol],
        so_ngay_ghep: soNgayGhepValue,
        rowIndex: i + 1 
      });
    }
  }

  for (const consultantName in overdueOrdersByConsultant) {
    const orders = overdueOrdersByConsultant[consultantName];
    if (orders.length > 0) {
      const emailSent = sendOverdueWarningEmail(mailSheet, consultantName, orders);
      if (emailSent) {
        // --- THAY ƒê·ªîI T·∫†I ƒê√ÇY ---
        // T·∫°o chu·ªói tr·∫°ng th√°i m·ªõi bao g·ªìm c·∫£ ng√†y g·ª≠i
        const notificationStatus = "ƒê√£ g·ª≠i " + Utilities.formatDate(new Date(), "GMT+7", "dd/MM/yyyy");
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªõi cho t·ª´ng ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i c·∫£nh b√°o
        orders.forEach(order => {
          daGhepSheet.getRange(order.rowIndex, canhBaoCol + 1).setValue(notificationStatus);
        });
        logAction("C·∫≠p nh·∫≠t tr·∫°ng th√°i c·∫£nh b√°o", `ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i cho ${orders.length} ƒë∆°n h√†ng c·ªßa ${consultantName}.`);
      }
    }
  }
}
function setupOverdueCheckTrigger() {
  const ui = SpreadsheetApp.getUi();
  const triggers = ScriptApp.getProjectTriggers();

  // X√≥a c√°c trigger c≈© cho h√†m n√†y ƒë·ªÉ tr√°nh tr√πng l·∫∑p
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === "checkForOverdueOrders") {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  try {
    // T·∫°o trigger m·ªõi
    ScriptApp.newTrigger("checkForOverdueOrders")
      .timeBased()
      .everyDays(2)
      .atHour(8)
      .create();
    const message = "ƒê√£ thi·∫øt l·∫≠p th√†nh c√¥ng trigger t·ª± ƒë·ªông ki·ªÉm tra v√† g·ª≠i c·∫£nh b√°o ƒë∆°n h√†ng qu√° h·∫°n v√†o 9:00 s√°ng m·ªói ng√†y.";
    showToastOnSheet(message, "Th√†nh C√¥ng"); // Changed from ui.alert
    logAction("Thi·∫øt l·∫≠p Trigger C·∫£nh B√°o", message);
  } catch (e) {
    const errorMessage = `L·ªói khi thi·∫øt l·∫≠p trigger: ${e.message}`;
    showToastOnSheet(errorMessage, "L·ªói"); // Changed from ui.alert
    logAction("L·ªói Trigger C·∫£nh B√°o", errorMessage);
  }
}
function sendNewCarNotifications() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const stockSheet = ss.getSheetByName(STOCK_SHEET_NAME);
  
  try {
    // --- B·∫ÆT ƒê·∫¶U THAY ƒê·ªîI: Khai b√°o ƒë·ªãa ch·ªâ email nh√≥m ·ªü ƒë√¢y ---
    const GROUP_EMAIL = "new-stock@googlegroups.com"; // <-- THAY ƒê·ªäA CH·ªà EMAIL NH√ìM C·ª¶A B·∫†N V√ÄO ƒê√ÇY
    
    if (!GROUP_EMAIL) {
      throw new Error("Ch∆∞a c·∫•u h√¨nh ƒë·ªãa ch·ªâ email nh√≥m ƒë·ªÉ nh·∫≠n th√¥ng b√°o xe m·ªõi.");
    }
    // --- K·∫æT TH√öC THAY ƒê·ªîI ---

    if (!stockSheet) {
      throw new Error("Kh√¥ng t√¨m th·∫•y sheet KhoXe.");
    }

    const stockHeaders = SHEET_HEADERS["KhoXe"];
    const statusCol = stockHeaders.indexOf("Tr·∫°ng th√°i");
    const notifiedCol = stockHeaders.indexOf("ƒê√£ th√¥ng b√°o");
    const stockData = stockSheet.getDataRange().getValues();
    const newCars = [];

    // T√¨m t·∫•t c·∫£ xe m·ªõi c·∫ßn th√¥ng b√°o
    for (let i = 1; i < stockData.length; i++) {
      if (String(stockData[i][statusCol]).toLowerCase().trim() === "ch∆∞a gh√©p" && !stockData[i][notifiedCol]) {
        newCars.push({
          dong_xe: stockData[i][stockHeaders.indexOf("D√≤ng xe")],
          phien_ban: stockData[i][stockHeaders.indexOf("Phi√™n b·∫£n")],
          ngoai_that: stockData[i][stockHeaders.indexOf("Ngo·∫°i th·∫•t")],
          noi_that: stockData[i][stockHeaders.indexOf("N·ªôi th·∫•t")],
          vin: stockData[i][stockHeaders.indexOf("VIN")],
          rowIndex: i + 1
        });
      }
    }

    if (newCars.length === 0) {
      logAction("Th√¥ng B√°o Xe M·ªõi", "Kh√¥ng c√≥ xe m·ªõi n√†o c·∫ßn th√¥ng b√°o.");
      return; // Kh√¥ng c√≥ g√¨ ƒë·ªÉ l√†m, tho√°t ra
    }

    // Chu·∫©n b·ªã n·ªôi dung email
    const bodyContent = createNewCarNotificationBody(newCars);
    const subject = `[TH√îNG B√ÅO] C√≥ ${newCars.length} Xe M·ªõi V·ª´a Nh·∫≠p Kho`;
    const fullHtml = createFullHtmlEmail(subject, bodyContent);

    // G·ª≠i email v√† c·∫≠p nh·∫≠t sheet
    let emailSentSuccessfully = false;
    try {
      // Ch·ªâ g·ª≠i 1 email duy nh·∫•t ƒë·∫øn ƒë·ªãa ch·ªâ nh√≥m
      MailApp.sendEmail({
        to: GROUP_EMAIL,
        subject: subject,
        htmlBody: fullHtml
      });
      emailSentSuccessfully = true;
      logAction("G·ª≠i email xe m·ªõi nh·∫≠p kho", `ƒê√£ g·ª≠i th√¥ng b√°o cho ${newCars.length} xe m·ªõi ƒë·∫øn nh√≥m ${GROUP_EMAIL}.`);
    } catch (emailError) {
      throw new Error(`G·ª≠i email th·∫•t b·∫°i: ${emailError.message}`);
    }
    
    if (emailSentSuccessfully) {
      const notificationDate = "ƒê√£ th√¥ng b√°o ng√†y " + Utilities.formatDate(new Date(), "GMT+7", "dd/MM/yyyy");
      for (const car of newCars) {
        stockSheet.getRange(car.rowIndex, notifiedCol + 1).setValue(notificationDate);
        Utilities.sleep(300); // V·∫´n gi·ªØ ƒë·ªô tr·ªÖ ƒë·ªÉ ƒë·∫£m b·∫£o c·∫≠p nh·∫≠t ·ªïn ƒë·ªãnh
      }
    }

  } catch (e) {
    logAction("L·ªói Th√¥ng B√°o Xe M·ªõi (Nghi√™m tr·ªçng)", `L·ªói: ${e.message}`);
    showToastOnSheet(`ƒê√£ c√≥ l·ªói x·∫£y ra: ${e.message}`, "L·ªói H·ªá Th·ªëng");
    sendErrorAlert('sendNewCarNotifications', e);
  }
}
function showDeleteCarFromStockPrompt() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'X√≥a Xe Kh·ªèi Kho',
    'Vui l√≤ng nh·∫≠p S·ªë VIN c·ªßa xe c·∫ßn x√≥a:',
    ui.ButtonSet.OK_CANCEL
  );
  if (response.getSelectedButton() === ui.Button.OK) {
    const vinToDelete = response.getResponseText().trim();
    if (!vinToDelete) {
      showToastOnSheet('S·ªë VIN kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!', 'L·ªói'); // Changed from ui.alert
      logAction("L·ªói X√≥a Xe Kho", "Ng∆∞·ªùi d√πng kh√¥ng nh·∫≠p VIN.");
      return;
    }
    // G·ªçi h√†m logic ch√≠nh v·ªõi LockService
    const resultMessage = doReadWriteLock(() => deleteCarFromStockLogic(vinToDelete));
    showToastOnSheet(resultMessage); // Changed from ui.alert
    logAction("X√≥a Xe Kho (Prompt)", `K·∫øt qu·∫£ cho VIN ${vinToDelete}: ${resultMessage}`);
  } else {
    logAction("H·ªßy X√≥a Xe Kho", "Ng∆∞·ªùi d√πng ƒë√£ h·ªßy thao t√°c x√≥a xe.");
  }
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈®]
function deleteCarFromStockLogic(vinToDelete, reason) {
  Logger.log(`DEBUG: B·∫Øt ƒë·∫ßu x√≥a xe ${vinToDelete} v·ªõi l√Ω do: "${reason}"`);

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const removedCarsLogSheet = getOrCreateSheet(ss, "removed_cars_log", SHEET_HEADERS["removed_cars_log"]);
  const userEmail = Session.getActiveUser().getEmail() || "Kh√¥ng x√°c ƒë·ªãnh";

  const stockData = stockSheet.getDataRange().getValues();
  const actualStockHeaders = stockData[0]; // [S·ª¨A L·ªñI] L·∫•y header th·ª±c t·∫ø t·ª´ sheet
  const vinColStock = actualStockHeaders.indexOf("VIN");

  if (vinColStock === -1) {
    return "L·ªói: Sheet KhoXe kh√¥ng c√≥ c·ªôt VIN.";
  }

  for (let i = 1; i < stockData.length; i++) {
    const currentRow = stockData[i];
    const currentVin = String(currentRow[vinColStock] || "").trim();

    if (currentVin === vinToDelete) {
      // [S·ª¨A L·ªñI] T·∫°o object chi ti·∫øt xe b·∫±ng c√°ch map header th·ª±c t·∫ø v·ªõi gi√° tr·ªã
      const carToRemoveDetails = {};
      actualStockHeaders.forEach((header, index) => {
        if(header) carToRemoveDetails[header] = currentRow[index];
      });

      const logEntry = [
        formatDateTimeForSheet(new Date()),
        userEmail,
        carToRemoveDetails["D√≤ng xe"],
        carToRemoveDetails["Phi√™n b·∫£n"],
        carToRemoveDetails["Ngo·∫°i th·∫•t"],
        carToRemoveDetails["N·ªôi th·∫•t"],
        vinToDelete,
        carToRemoveDetails["M√£ DMS"], // ƒê·ªçc ƒë√∫ng t·ª´ object chi ti·∫øt
        carToRemoveDetails["Tr·∫°ng th√°i"],
        carToRemoveDetails["Ng√†y nh·∫≠p"] ? formatDateTimeForSheet(new Date(carToRemoveDetails["Ng√†y nh·∫≠p"])) : "",
        carToRemoveDetails["ƒê√£ th√¥ng b√°o"],
        reason || "Kh√¥ng c√≥ l√Ω do"
      ];
      removedCarsLogSheet.appendRow(logEntry);

      stockSheet.deleteRow(i + 1);
      
      recordVehicleHistory(vinToDelete, "X√≥a Kh·ªèi Kho", `Xe ƒë√£ ƒë∆∞·ª£c x√≥a b·ªüi ${userEmail}. L√Ω do: ${reason}`);
      logAction("X√≥a Xe Th√†nh C√¥ng", `VIN ${vinToDelete} ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi KhoXe v√† ghi v√†o log.`);
      return `Xe v·ªõi VIN ${vinToDelete} ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng kh·ªèi kho!`;
    }
  }
  return `Kh√¥ng t√¨m th·∫•y xe v·ªõi VIN ${vinToDelete} trong KhoXe.`;
}
function showRestoreCarToStockPrompt() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'Ph·ª•c H·ªìi Xe V√†o Kho',
    'Vui l√≤ng nh·∫≠p S·ªë VIN c·ªßa xe c·∫ßn ph·ª•c h·ªìi:',
    ui.ButtonSet.OK_CANCEL
  );
  if (response.getSelectedButton() === ui.Button.OK) {
    const vinToRestore = response.getResponseText().trim();
    if (!vinToRestore) {
      showToastOnSheet('S·ªë VIN kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!', 'L·ªói'); // Changed from ui.alert
      logAction("L·ªói Ph·ª•c H·ªìi Xe", "Ng∆∞·ªùi d√πng kh√¥ng nh·∫≠p VIN.");
      return;
    }
    // G·ªçi h√†m logic ch√≠nh v·ªõi LockService
    const resultMessage = doReadWriteLock(() => restoreCarToStockLogic(vinToRestore));
    showToastOnSheet(resultMessage); // Changed from ui.alert
    logAction("Ph·ª•c H·ªìi Xe (Prompt)", `K·∫øt qu·∫£ cho VIN ${vinToRestore}: ${resultMessage}`);
  } else {
    logAction("H·ªßy Ph·ª•c H·ªìi Xe", "Ng∆∞·ªùi d√πng ƒë√£ h·ªßy thao t√°c ph·ª•c h·ªìi xe.");
  }
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈®]
function restoreCarToStockLogic(vinToRestore) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const removedCarsLogSheet = getOrCreateSheet(ss, "removed_cars_log", SHEET_HEADERS["removed_cars_log"]);
  const userEmail = Session.getActiveUser().getEmail() || "Kh√¥ng x√°c ƒë·ªãnh";

  // Ki·ªÉm tra xem VIN ƒë√£ t·ªìn t·∫°i trong kho ch∆∞a (gi·ªØ nguy√™n)
  const stockDataCheck = stockSheet.getDataRange().getValues();
  const stockVinColCheck = SHEET_HEADERS["KhoXe"].indexOf("VIN");
  for (let k = 1; k < stockDataCheck.length; k++) {
    if (String(stockDataCheck[k][stockVinColCheck] || "").trim() === vinToRestore) {
      return `L·ªói: Xe v·ªõi VIN ${vinToRestore} ƒë√£ t·ªìn t·∫°i trong KhoXe.`;
    }
  }

  // L·∫•y d·ªØ li·ªáu t·ª´ log (gi·ªØ nguy√™n)
  const logData = removedCarsLogSheet.getDataRange().getValues();
  const logHeaders = SHEET_HEADERS["removed_cars_log"];
  const vinColLog = logHeaders.indexOf("VIN");
  let carDataFromLog = null;
  for (let i = logData.length - 1; i >= 1; i--) {
    if (String(logData[i][vinColLog] || "").trim() === vinToRestore) {
      carDataFromLog = {};
      logHeaders.forEach((header, index) => {
        carDataFromLog[header] = logData[i][index];
      });
      break;
    }
  }

  if (!carDataFromLog) {
    return `Kh√¥ng t√¨m th·∫•y th√¥ng tin xe v·ªõi VIN ${vinToRestore} trong nh·∫≠t k√Ω xe ƒë√£ x√≥a.`;
  }

  // [S·ª¨A L·ªñI] X√¢y d·ª±ng m·∫£ng d·ªØ li·ªáu ƒë·ªÉ ghi d·ª±a tr√™n header th·ª±c t·∫ø c·ªßa sheet KhoXe
  const actualStockHeaders = stockSheet.getRange(1, 1, 1, stockSheet.getLastColumn()).getValues()[0];
  
  const newRowValues = actualStockHeaders.map(header => {
      switch (header) {
          case "D√≤ng xe": return carDataFromLog["D√≤ng xe"];
          case "Phi√™n b·∫£n": return carDataFromLog["Phi√™n b·∫£n"];
          case "Ngo·∫°i th·∫•t": return carDataFromLog["Ngo·∫°i th·∫•t"];
          case "N·ªôi th·∫•t": return carDataFromLog["N·ªôi th·∫•t"];
          case "VIN": return vinToRestore;
          case "M√£ DMS": return carDataFromLog["M√£ DMS (c≈©)"]; // L·∫•y ƒë√∫ng M√£ DMS t·ª´ log
          case "Tr·∫°ng th√°i": return "Ch∆∞a gh√©p";
          case "Ng√†y nh·∫≠p": return carDataFromLog["Ng√†y nh·∫≠p (c≈©)"] ? new Date(carDataFromLog["Ng√†y nh·∫≠p (c≈©)"]) : new Date();
          case "ƒê√£ th√¥ng b√°o": return carDataFromLog["ƒê√£ th√¥ng b√°o (c≈©)"] || "";
          default: return ""; // ƒê·ªÉ tr·ªëng cho c√°c c·ªôt kh√°c nh∆∞ checkbox, Ng∆∞·ªùi gi·ªØ xe...
      }
  });

  stockSheet.appendRow(newRowValues);
  
  // ƒê·ªãnh d·∫°ng l·∫°i c·ªôt ng√†y cho ƒë√∫ng
  const lastRow = stockSheet.getLastRow();
  const ngayNhapColIndex = actualStockHeaders.indexOf("Ng√†y nh·∫≠p");
  if(ngayNhapColIndex > -1) {
      stockSheet.getRange(lastRow, ngayNhapColIndex + 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");
  }

  recordVehicleHistory(vinToRestore, "Ph·ª•c H·ªìi V√†o Kho", `Xe ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi b·ªüi ${userEmail} t·ª´ Web App.`);
  logAction("Ph·ª•c H·ªìi Xe Th√†nh C√¥ng", `VIN ${vinToRestore} ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi v√†o KhoXe.`);
  return `Xe v·ªõi VIN ${vinToRestore} ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi th√†nh c√¥ng!`;
}
function getSuggestedColors(userInputColor) {
  if (!userInputColor || typeof userInputColor !== 'string') {
    return [];
  }
  const normalizedUserInput = userInputColor.trim().toLowerCase();
  if (normalizedUserInput === "") return [];

  const suggestions = VALID_EXTERIOR_COLORS.filter(validColor =>
    validColor.trim().toLowerCase().includes(normalizedUserInput)
  );

  return suggestions;
}
/**
 * [PHI√äN B·∫¢N HO√ÄN CH·ªàNH] - L∆∞u tr·ªØ c√°c ƒë∆°n h√†ng ƒë√£ xu·∫•t h√≥a ƒë∆°n t·ª´ sheet 'Xuathoadon'
 * sang m·ªôt sheet l∆∞u tr·ªØ ri√™ng theo th√°ng.
 * Ch·ª©c nƒÉng n√†y sao ch√©p ƒë·∫ßy ƒë·ªß m·ªçi th√¥ng tin bao g·ªìm: gi√° tr·ªã, c√¥ng th·ª©c (link),
 * ƒë·ªãnh d·∫°ng (m√†u s·∫Øc, font ch·ªØ), v√† data validation (checkbox).
 *
 * @param {number} year - T√πy ch·ªçn. NƒÉm 4 ch·ªØ s·ªë c·ªßa th√°ng c·∫ßn l∆∞u tr·ªØ (v√≠ d·ª•: 2024).
 * @param {number} month - T√πy ch·ªçn. Th√°ng c·∫ßn l∆∞u tr·ªØ (1-12).
 */
function archiveInvoicedOrdersMonthly(year = null, month = null) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const xuathoadonSheet = getOrCreateSheet(ss, XUAT_HOA_DON_SHEET_NAME, SHEET_HEADERS["Xuathoadon"]);

  if (!xuathoadonSheet || xuathoadonSheet.getLastRow() < 2) {
    const errorMsg = `L·ªói ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu trong sheet '${XUAT_HO_DON_SHEET_NAME}'.`;
    logAction("L·ªói L∆∞u Tr·ªØ XHƒê", errorMsg);
    SpreadsheetApp.getUi().alert(errorMsg);
    return;
  }

  let namLuuTru, thangLuuTru;

  if (year !== null && month !== null) {
    namLuuTru = year;
    thangLuuTru = month - 1; // Th√°ng trong JavaScript b·∫Øt ƒë·∫ßu t·ª´ 0
  } else {
    const today = new Date();
    const firstDayOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDayOfPreviousMonth = new Date(firstDayOfCurrentMonth.getTime() - 1);
    namLuuTru = lastDayOfPreviousMonth.getFullYear();
    thangLuuTru = lastDayOfPreviousMonth.getMonth();
  }

  const archiveSheetName = `LuuTru_${namLuuTru}_${String(thangLuuTru + 1).padStart(2, '0')}`;
  const archiveSheet = getOrCreateSheet(ss, archiveSheetName, SHEET_HEADERS["Xuathoadon"]);

  const allData = xuathoadonSheet.getDataRange().getValues();
  const headers = allData[0];
  const invoiceDateColIndex = headers.indexOf("NG√ÄY XU·∫§T H√ìA ƒê∆†N");

  if (invoiceDateColIndex === -1) {
    const errorMsg = "Sheet Xuathoadon thi·∫øu c·ªôt 'NG√ÄY XU·∫§T H√ìA ƒê∆†N'.";
    logAction("L·ªói L∆∞u Tr·ªØ XHƒê", errorMsg);
    SpreadsheetApp.getUi().alert(errorMsg);
    return;
  }

  let copiedCount = 0;
  // Duy·ªát ng∆∞·ª£c t·ª´ cu·ªëi l√™n ƒë·ªÉ vi·ªác x√≥a (n·∫øu c√≥ sau n√†y) kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn ch·ªâ s·ªë
  for (let i = allData.length - 1; i >= 1; i--) {
    const invoiceDateValue = allData[i][invoiceDateColIndex];
    if (invoiceDateValue instanceof Date && !isNaN(invoiceDateValue)) {
      const invoiceYear = invoiceDateValue.getFullYear();
      const invoiceMonth = invoiceDateValue.getMonth();

      if (invoiceYear === namLuuTru && invoiceMonth === thangLuuTru) {
        // L·∫•y to√†n b·ªô d√≤ng ngu·ªìn
        const sourceRowRange = xuathoadonSheet.getRange(i + 1, 1, 1, xuathoadonSheet.getLastColumn());
        // X√°c ƒë·ªãnh d√≤ng ti·∫øp theo trong sheet l∆∞u tr·ªØ
        const destinationRow = archiveSheet.getLastRow() + 1;
        
        // S·ª≠ d·ª•ng copyTo ƒë·ªÉ sao ch√©p t·∫•t c·∫£ m·ªçi th·ª©: gi√° tr·ªã, c√¥ng th·ª©c, ƒë·ªãnh d·∫°ng
        sourceRowRange.copyTo(archiveSheet.getRange(destinationRow, 1), {contentsOnly: false});
        
        copiedCount++;
      }
    }
  }

  if (copiedCount > 0) {
    const successMsg = `ƒê√£ sao ch√©p v√† l∆∞u tr·ªØ ƒë·∫ßy ƒë·ªß ${copiedCount} ƒë∆°n h√†ng c·ªßa th√°ng ${thangLuuTru + 1}/${namLuuTru} v√†o sheet ${archiveSheetName}.`;
    logAction("L∆∞u Tr·ªØ XHƒê (B·∫£n ƒë·∫ßy ƒë·ªß)", successMsg);
    SpreadsheetApp.getUi().alert(successMsg);
  } else {
    const noRowsMsg = `Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o c·ªßa th√°ng ${thangLuuTru + 1}/${namLuuTru} c·∫ßn l∆∞u tr·ªØ.`;
    logAction("L∆∞u Tr·ªØ XHƒê", noRowsMsg);
    SpreadsheetApp.getUi().alert(noRowsMsg);
  }
}
/**
 * Displays a prompt to the user to enter a month and year for archiving.
 * It then calls the archiveInvoicedOrdersMonthly function with the user's input.
 */
function showArchivePrompt() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'L∆∞u Tr·ªØ ƒê∆°n H√†ng Theo Th√°ng',
    'Vui l√≤ng nh·∫≠p th√°ng v√† nƒÉm c·∫ßn l∆∞u tr·ªØ (ƒë·ªãnh d·∫°ng: MM-YYYY, v√≠ d·ª•: 09-2024):',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() == ui.Button.OK) {
    const inputText = response.getResponseText();
    const parts = inputText.split('-');

    if (parts.length === 2) {
      const month = parseInt(parts[0], 10);
      const year = parseInt(parts[1], 10);

      if (!isNaN(month) && !isNaN(year) && month >= 1 && month <= 12 && year > 2000) {
        archiveInvoicedOrdersMonthly(year, month);
      } else {
        ui.alert('ƒê·ªãnh d·∫°ng th√°ng-nƒÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    } else {
      ui.alert('ƒê·ªãnh d·∫°ng nh·∫≠p kh√¥ng ƒë√∫ng. Vui l√≤ng s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng MM-YYYY.');
    }
  }
}

function setupArchiveInvoicedOrdersTrigger() {
  const ui = SpreadsheetApp.getUi();
  const triggers = ScriptApp.getProjectTriggers();
  // X√≥a c√°c trigger c≈© cho h√†m n√†y ƒë·ªÉ tr√°nh tr√πng l·∫∑p
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === "archiveInvoicedOrdersMonthly") {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  try {
    ScriptApp.newTrigger("archiveInvoicedOrdersMonthly")
      .timeBased()
      .onMonthDay(1) // Ch·∫°y v√†o ng√†y 1 h√†ng th√°ng
      .atHour(2)     // Ch·∫°y v√†o l√∫c 2 gi·ªù s√°ng
      .create();
    const message = "ƒê√£ thi·∫øt l·∫≠p th√†nh c√¥ng trigger t·ª± ƒë·ªông l∆∞u tr·ªØ h√≥a ƒë∆°n th√°ng tr∆∞·ªõc v√†o 02:00 s√°ng ng√†y 1 m·ªói th√°ng.";
    showToastOnSheet(message, "Th√†nh C√¥ng"); // Changed from ui.alert
    logAction("Thi·∫øt l·∫≠p Trigger L∆∞u Tr·ªØ XHƒê", message);
  } catch (e) {
    const errorMessage = `L·ªói khi thi·∫øt l·∫≠p trigger l∆∞u tr·ªØ XHƒê: ${e.message}`;
    showToastOnSheet(errorMessage, "L·ªói"); // Changed from ui.alert
    logAction("L·ªói Trigger L∆∞u Tr·ªØ XHƒê", errorMessage);
  }
}
function deleteMonthlyInvoicedOrdersFromDaGhepLogic() {
  Logger.log("--- B·∫ÆT ƒê·∫¶U: deleteMonthlyInvoicedOrdersFromDaGhepLogic ---");
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const daGhepSheet = getOrCreateSheet(ss, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"]);

  const daGhepDataRange = daGhepSheet.getDataRange();
  const daGhepValues = daGhepDataRange.getValues();

  if (daGhepValues.length <= 1) {
    const msg = "Sheet DaGhep kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ d·ªçn d·∫πp.";
    Logger.log(msg);
    logAction("X√≥a DaGhep (XHƒê Th√°ng Tr∆∞·ªõc)", msg);
    return msg;
  }

  const headers = daGhepValues[0];
  const ketQuaCol = headers.indexOf("K·∫øt qu·∫£");
  const ngayXuatHDCol = headers.indexOf("Ng√†y xu·∫•t h√≥a ƒë∆°n");
  const soDonHangCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
  const vinCol = headers.indexOf("VIN");

  if (ketQuaCol === -1 || ngayXuatHDCol === -1) {
    const msg = "L·ªói: Kh√¥ng t√¨m th·∫•y c·ªôt 'K·∫øt qu·∫£' ho·∫∑c 'Ng√†y xu·∫•t h√≥a ƒë∆°n' trong sheet DaGhep.";
    Logger.log(msg);
    logAction("L·ªói X√≥a DaGhep (XHƒê Th√°ng Tr∆∞·ªõc)", msg);
    return msg;
  }

  const today = new Date();
  let previousMonthDate = new Date(today.getFullYear(), today.getMonth(), 1);
  previousMonthDate.setDate(0);
  const targetYear = previousMonthDate.getFullYear();
  const targetMonth = previousMonthDate.getMonth();

  const rowIndicesToDeleteInDaGhep = [];
  let deletedCount = 0;
  const deletedOrderInfoForLog = [];

  for (let i = daGhepValues.length - 1; i >= 1; i--) {
    const rowContent = daGhepValues[i];
    const ketQua = String(rowContent[ketQuaCol] || "").trim();
    const ngayXuatHDValue = rowContent[ngayXuatHDCol];

    if (ketQua === "ƒê√£ xu·∫•t h√≥a ƒë∆°n") {
      let invoiceDate = null;
      if (ngayXuatHDValue instanceof Date && !isNaN(ngayXuatHDValue)) {
        invoiceDate = ngayXuatHDValue;
      } else if ((typeof ngayXuatHDValue === 'string' && ngayXuatHDValue.trim() !== "") || typeof ngayXuatHDValue === 'number') {
        let parsedDateAttempt;
        if (typeof ngayXuatHDValue === 'string' && ngayXuatHDValue.includes('/')) {
            const parts = ngayXuatHDValue.split('/');
            if (parts.length === 3) {
                parsedDateAttempt = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            }
        } else {
            parsedDateAttempt = new Date(ngayXuatHDValue);
        }
        
        if (parsedDateAttempt && !isNaN(parsedDateAttempt)) {
          invoiceDate = parsedDateAttempt;
        }
      }

      if (invoiceDate) {
        if (invoiceDate.getFullYear() === targetYear && invoiceDate.getMonth() === targetMonth) {
          rowIndicesToDeleteInDaGhep.push(i + 1);
          deletedCount++;
          const orderNumber = soDonHangCol !== -1 ? String(rowContent[soDonHangCol] || "N/A").trim() : "N/A";
          const vin = vinCol !== -1 ? String(rowContent[vinCol] || "N/A").trim() : "N/A";
          deletedOrderInfoForLog.push(`ƒêH: ${orderNumber}, VIN: ${vin} (d√≤ng sheet ${i+1})`);
        }
      }
    }
  }

  if (deletedCount > 0) {
    rowIndicesToDeleteInDaGhep.forEach(rowIndex => {
      daGhepSheet.deleteRow(rowIndex);
    });

    const successMsg = `ƒê√£ x√≥a vƒ©nh vi·ªÖn ${deletedCount} ƒë∆°n h√†ng (ƒë√£ XHƒê th√°ng ${targetMonth + 1}/${targetYear}) kh·ªèi sheet DaGhep.`;
    logAction("X√≥a DaGhep (XHƒê Th√°ng Tr∆∞·ªõc)", `${successMsg} Chi ti·∫øt: ${deletedOrderInfoForLog.join('; ')}`);
    return successMsg;
  } else {
    const noRowsMsg = `Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o trong DaGhep ƒë√£ xu·∫•t h√≥a ƒë∆°n c·ªßa th√°ng ${targetMonth + 1}/${targetYear} ƒë·ªÉ x√≥a.`;
    logAction("X√≥a DaGhep (XHƒê Th√°ng Tr∆∞·ªõc)", noRowsMsg);
    return noRowsMsg;
  }
}

function showDeleteMonthlyInvoicedOrdersFromDaGhepPrompt() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.confirm(
    'X√°c Nh·∫≠n X√≥a Vƒ©nh Vi·ªÖn ƒê∆°n H√†ng (Sheet DaGhep)',
    'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA Vƒ®NH VI·ªÑN c√°c ƒë∆°n h√†ng ƒë√£ xu·∫•t h√≥a ƒë∆°n c·ªßa TH√ÅNG TR∆Ø·ªöC kh·ªèi sheet DaGhep kh√¥ng?\n\nL∆ØU √ù: H√†nh ƒë·ªông n√†y s·∫Ω x√≥a d·ªØ li·ªáu v√† KH√îNG c√≥ b∆∞·ªõc l∆∞u tr·ªØ ri√™ng cho c√°c d√≤ng n√†y (tr·ª´ khi b·∫°n c√≥ c∆° ch·∫ø sao l∆∞u kh√°c).\n\nN√™n s·ª≠ d·ª•ng ch·ª©c nƒÉng "L∆∞u tr·ªØ h√≥a ƒë∆°n" cho sheet Xuathoadon n·∫øu b·∫°n mu·ªën gi·ªØ l·∫°i b·∫£n sao.',
    ui.ButtonSet.YES_NO
  );
  if (response === ui.Button.YES) {
    const resultMessage = doReadWriteLock(() => deleteMonthlyInvoicedOrdersFromDaGhepLogic());
    showToastOnSheet(resultMessage, 'K·∫øt Qu·∫£ X√≥a T·ª´ DaGhep'); // Changed from ui.alert
  } else {
    showToastOnSheet('ƒê√£ h·ªßy thao t√°c x√≥a ƒë∆°n h√†ng kh·ªèi sheet DaGhep.', 'Th√¥ng B√°o'); // Changed from ui.alert
  }
}
function showDeleteOrderPrompt() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'X√≥a ƒê∆°n H√†ng Vƒ©nh Vi·ªÖn',
    'C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn ƒë∆°n h√†ng kh·ªèi c√°c sheet ƒëang ho·∫°t ƒë·ªông (DaGhep, ChuaGhep) v√† chuy·ªÉn v√†o HuyGhep.\n\nVui l√≤ng nh·∫≠p s·ªë ƒë∆°n h√†ng c·∫ßn x√≥a:',
    ui.ButtonSet.OK_CANCEL
  );
  if (response.getSelectedButton() === ui.Button.OK) {
    const orderNumber = response.getResponseText().trim();
    if (!orderNumber) {
      showToastOnSheet('S·ªë ƒë∆°n h√†ng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!', 'L·ªói'); // Changed from ui.alert
      logAction("L·ªói X√≥a ƒê∆°n H√†ng", "Ng∆∞·ªùi d√πng kh√¥ng nh·∫≠p s·ªë ƒë∆°n h√†ng.");
      return;
    }
    // G·ªçi h√†m logic ch√≠nh v·ªõi LockService ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n d·ªØ li·ªáu
    const resultMessage = doReadWriteLock(() => deleteOrderLogic(orderNumber, Session.getActiveUser().getEmail() || "Manual User"));

    // S·ª¨A ƒê·ªîI T·∫†I ƒê√ÇY: Th√™m ui.ButtonSet.OK
    showToastOnSheet(String(resultMessage), 'K·∫øt Qu·∫£ X√≥a'); // Changed from ui.alert

  } else {
    showToastOnSheet('Thao t√°c x√≥a ƒë∆°n h√†ng ƒë√£ b·ªã h·ªßy b·ªè.', 'ƒê√£ h·ªßy'); // Changed from ui.alert
    logAction("H·ªßy thao t√°c", "Ng∆∞·ªùi d√πng ƒë√£ h·ªßy prompt x√≥a ƒë∆°n h√†ng.");
  }
}

function deleteOrderLogic(orderNumber, deletedBy) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const daGhepSheet = getOrCreateSheet(ss, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"]);
  const chuaGhepSheet = getOrCreateSheet(ss, CHUA_GHEP_SHEET_NAME, SHEET_HEADERS["ChuaGhep"]);
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const cancelledSheet = getOrCreateSheet(ss, CANCELLED_SHEET_NAME, SHEET_HEADERS["HuyGhep"]);

  if (!orderNumber) {
    return "S·ªë ƒë∆°n h√†ng kh√¥ng ƒë∆∞·ª£c cung c·∫•p.";
  }

  let sourceSheet = null;
  let rowIndexToDelete = -1; // Ch·ªâ s·ªë d√≤ng 1-based ƒë·ªÉ x√≥a
  let rowDataToMove = null;
  let headers = null;

  // T√¨m trong sheet DaGhep
  const daGhepData = daGhepSheet.getDataRange().getValues();
  // KI·ªÇM TRA M·ªöI: Ch·ªâ x·ª≠ l√Ω n·∫øu sheet c√≥ nhi·ªÅu h∆°n d√≤ng ti√™u ƒë·ªÅ
  if (daGhepData.length > 1) {
    const daGhepHeaders = daGhepData[0];
    const orderNumberColDaGhep = daGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
    if (orderNumberColDaGhep !== -1) {
      for (let i = 1; i < daGhepData.length; i++) {
        if (String(daGhepData[i][orderNumberColDaGhep]).trim() === String(orderNumber).trim()) {
          sourceSheet = daGhepSheet;
          rowIndexToDelete = i + 1;
          rowDataToMove = daGhepData[i];
          headers = daGhepHeaders;
          break;
        }
      }
    }
  }

  // N·∫øu kh√¥ng t√¨m th·∫•y, t√¨m trong sheet ChuaGhep
  if (sourceSheet === null) {
    const chuaGhepData = chuaGhepSheet.getDataRange().getValues();
    // KI·ªÇM TRA M·ªöI: Ch·ªâ x·ª≠ l√Ω n·∫øu sheet c√≥ nhi·ªÅu h∆°n d√≤ng ti√™u ƒë·ªÅ
    if (chuaGhepData.length > 1) {
      const chuaGhepHeaders = chuaGhepData[0];
      const orderNumberColChuaGhep = chuaGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
      if (orderNumberColChuaGhep !== -1) {
        for (let i = 1; i < chuaGhepData.length; i++) {
          if (String(chuaGhepData[i][orderNumberColChuaGhep]).trim() === String(orderNumber).trim()) {
            sourceSheet = chuaGhepSheet;
            rowIndexToDelete = i + 1;
            rowDataToMove = chuaGhepData[i];
            headers = chuaGhepHeaders;
            break;
          }
        }
      }
    }
  }

  // N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, tr·∫£ v·ªÅ l·ªói
  if (sourceSheet === null || rowIndexToDelete === -1) {
    logAction("L·ªói X√≥a ƒê∆°n H√†ng", `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber}.`);
    return `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} trong c√°c sheet ho·∫°t ƒë·ªông.`;
  }

  const vinCol = headers.indexOf("VIN");
  const vinToRevert = (vinCol !== -1) ? String(rowDataToMove[vinCol] || "").trim() : "";

  // Ho√†n tr·∫£ tr·∫°ng th√°i VIN trong KhoXe n·∫øu c√≥
  if (vinToRevert && vinToRevert !== "" && vinToRevert.toLowerCase() !== "h·ªßy") {
    updateKhoxeStatusForVin(stockSheet, vinToRevert, "Ch∆∞a gh√©p");
    recordVehicleHistory(vinToRevert, "X√≥a ƒë∆°n h√†ng (Th·ªß c√¥ng)", `ƒê√£ h·ªßy gh√©p cho ƒë∆°n h√†ng ${orderNumber}, VIN v·ªÅ 'Ch∆∞a gh√©p'`);
    logAction("C·∫≠p nh·∫≠t KhoXe (X√≥a ƒê∆°n H√†ng)", `VIN ${vinToRevert} ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªÅ 'Ch∆∞a gh√©p'.`);
  }

  // Di chuy·ªÉn d√≤ng v√†o sheet HuyGhep
  const cancelledSheetHeaders = SHEET_HEADERS["HuyGhep"];
  const cancelledRow = {};

  cancelledSheetHeaders.forEach(header => {
    const originalHeaderIndex = headers.indexOf(header);
    if (originalHeaderIndex !== -1) {
      cancelledRow[header] = rowDataToMove[originalHeaderIndex];
    } else if (header === "Ng∆∞·ªùi h·ªßy") {
      cancelledRow[header] = deletedBy;
    } else if (header === "Th·ªùi gian h·ªßy") {
      cancelledRow[header] = formatDateTimeForSheet(new Date());
    } else if (header === "K·∫øt qu·∫£") {
      cancelledRow[header] = "ƒê√£ x√≥a (Th·ªß c√¥ng)"; // Tr·∫°ng th√°i m·ªõi cho vi·ªác x√≥a th·ªß c√¥ng
    }
  });

  const cancelledRowData = cancelledSheetHeaders.map(header => cancelledRow[header] || "");
  cancelledSheet.appendRow(cancelledRowData);
  logAction("Di chuy·ªÉn ƒë∆°n h√†ng (X√≥a)", `ƒê∆°n h√†ng ${orderNumber} ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang ${CANCELLED_SHEET_NAME}.`);

  // X√≥a d√≤ng kh·ªèi sheet g·ªëc
  sourceSheet.deleteRow(rowIndexToDelete);
  logAction("X√≥a ƒê∆°n H√†ng Th√†nh C√¥ng", `ƒê∆°n h√†ng ${orderNumber} ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi ${sourceSheet.getName()}.`);

  // Ghi l·∫°i l·ªãch s·ª≠
  recordOrderHistory(orderNumber, vinToRevert, "X√≥a ƒë∆°n h√†ng (Th·ªß c√¥ng)", `ƒê∆°n h√†ng ƒë√£ b·ªã x√≥a b·ªüi ${deletedBy}`);

  return `ƒê∆°n h√†ng ${orderNumber} ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng v√† chuy·ªÉn v√†o sheet ${CANCELLED_SHEET_NAME}.`;
}
function runDataHealthCheck() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'B·∫Øt ƒë·∫ßu Ki·ªÉm tra & S·ª≠a l·ªói D·ªØ li·ªáu?',
    'Qu√° tr√¨nh n√†y s·∫Ω qu√©t v√† t·ª± ƒë·ªông KH√îI PH·ª§C d·ªØ li·ªáu l·ªói v·ªÅ tr·∫°ng th√°i t·ªët g·∫ßn nh·∫•t ƒë∆∞·ª£c ghi trong l·ªãch s·ª≠. M·ªôt sheet b√°o c√°o chi ti·∫øt s·∫Ω ƒë∆∞·ª£c t·∫°o. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?',
    ui.ButtonSet.YES_NO
  );
  if (response !== ui.Button.YES) {
    return;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('ƒêang b·∫Øt ƒë·∫ßu qu√° tr√¨nh ki·ªÉm tra v√† s·ª≠a l·ªói. Vui l√≤ng ch·ªù...', 'Th√¥ng B√°o', -1);
  logAction("B·∫Øt ƒë·∫ßu Ki·ªÉm tra & S·ª≠a l·ªói D·ªØ li·ªáu", "B·∫Øt ƒë·∫ßu qu√©t.");

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = getSheets(ss);
  const manualFixErrors = [];
  const autoCorrections = [];

  // Ch·∫°y c√°c b√†i ki·ªÉm tra
  // ---- THAY TH·∫æ LOGIC C≈® B·∫∞NG LOGIC KH√îI PH·ª§C T·ª™ L·ªäCH S·ª¨ M·ªöI ----
  const restoreResults = findAndRestoreFromHistory(sheets);
  autoCorrections.push(...restoreResults.corrections);
  manualFixErrors.push(...restoreResults.errors);
  // ---- H·∫æT THAY TH·∫æ ----

  autoCorrections.push(...findAndFixInconsistentVins(sheets));
  autoCorrections.push(...findAndFixOrphanedOrders(sheets));

  const colorCheckResults = findAndFixInvalidColors(sheets);
  manualFixErrors.push(...colorCheckResults.errors);
  autoCorrections.push(...colorCheckResults.corrections);

  manualFixErrors.push(...findLongPendingOrders(sheets));
  // T·∫°o b√°o c√°o
  generateHealthCheckReport(ss, manualFixErrors, autoCorrections);
  SpreadsheetApp.getActiveSpreadsheet().toast('ƒê√£ ho√†n t·∫•t ki·ªÉm tra. Vui l√≤ng xem sheet b√°o c√°o m·ªõi.', 'Ho√†n Th√†nh', 10);
  logAction("Ho√†n t·∫•t Ki·ªÉm tra & S·ª≠a l·ªói D·ªØ li·ªáu", `S·ª≠a t·ª± ƒë·ªông: ${autoCorrections.length}. C·∫ßn s·ª≠a th·ªß c√¥ng: ${manualFixErrors.length}.`);
}
function findAndFixInconsistentVins(sheets) {
  const { daGhepSheet, stockSheet } = sheets;
  const corrections = [];
  const daGhepData = daGhepSheet.getDataRange().getValues();
  const stockData = stockSheet.getDataRange().getValues();

  const daGhepHeaders = SHEET_HEADERS["DaGhep"];
  const stockHeaders = SHEET_HEADERS["KhoXe"];

  const daGhepVinCol = daGhepHeaders.indexOf("VIN");
  const stockVinCol = stockHeaders.indexOf("VIN");
  const stockStatusCol = stockHeaders.indexOf("Tr·∫°ng th√°i");

  const daGhepVins = new Set(daGhepData.slice(1).map(row => String(row[daGhepVinCol] || "").trim()).filter(Boolean));

  for (let i = 1; i < stockData.length; i++) {
    const row = stockData[i];
    const vin = String(row[stockVinCol] || "").trim();
    const status = String(row[stockStatusCol] || "").trim().toLowerCase();

    if (status === 'ƒë√£ gh√©p' && vin && !daGhepVins.has(vin)) {
      // T·ª± ƒë·ªông s·ª≠a: ƒê·ªïi tr·∫°ng th√°i v·ªÅ "Ch∆∞a gh√©p"
      stockSheet.getRange(i + 1, stockStatusCol + 1).setValue("Ch∆∞a gh√©p");
      const correctionDetails = `VIN "${vin}" trong KhoXe c√≥ tr·∫°ng th√°i "ƒê√£ gh√©p" nh∆∞ng kh√¥ng t√¨m th·∫•y trong DaGhep. ƒê√£ t·ª± ƒë·ªông ƒë·ªïi tr·∫°ng th√°i v·ªÅ "Ch∆∞a gh√©p".`;
      corrections.push({
        type: 'S·ª≠a VIN kh√¥ng nh·∫•t qu√°n',
        details: correctionDetails,
        sheetName: STOCK_SHEET_NAME,
        row: i + 1,
        vin: vin,
        orderNumber: ''
      });
      recordVehicleHistory(vin, "S·ª≠a l·ªói t·ª± ƒë·ªông", "Tr·∫°ng th√°i ƒë·ªïi v·ªÅ 'Ch∆∞a gh√©p' do kh√¥ng nh·∫•t qu√°n.");
    }
  }
  return corrections;
}

/**
 * [S·ª¨A L·ªñI 2] T√¨m v√† s·ª≠a c√°c ƒë∆°n h√†ng trong DaGhep c√≥ VIN nh∆∞ng VIN ƒë√≥ l·∫°i kh√¥ng c√≥ trong KhoXe.
 * Tr·∫£ v·ªÅ danh s√°ch c√°c h√†nh ƒë·ªông ƒë√£ s·ª≠a.
 */
function findAndFixOrphanedOrders(sheets) {
  const { daGhepSheet, stockSheet, chuaGhepSheet } = sheets;
  const corrections = [];
  const daGhepData = daGhepSheet.getDataRange().getValues();
  const stockData = stockSheet.getDataRange().getValues();

  const daGhepHeaders = SHEET_HEADERS["DaGhep"];
  const stockHeaders = SHEET_HEADERS["KhoXe"];
  const chuaGhepHeaders = SHEET_HEADERS["ChuaGhep"];

  const stockVins = new Set(stockData.slice(1).map(row => String(row[stockHeaders.indexOf("VIN")] || "").trim()).filter(Boolean));
  const rowsToDelete = [];

  for (let i = 1; i < daGhepData.length; i++) {
    const rowData = daGhepData[i];
    const vin = String(rowData[daGhepHeaders.indexOf("VIN")] || "").trim();
    const orderNumber = String(rowData[daGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng")] || "").trim();

    if (vin && !stockVins.has(vin)) {
      // T·ª± ƒë·ªông s·ª≠a: Chuy·ªÉn ƒë∆°n h√†ng v·ªÅ sheet ChuaGhep
      const newChuaGhepRow = {};
      chuaGhepHeaders.forEach(header => {
        const originalIndex = daGhepHeaders.indexOf(header);
        if (originalIndex !== -1) {
          newChuaGhepRow[header] = rowData[originalIndex];
        }
      });
      newChuaGhepRow["K·∫øt qu·∫£"] = "Ch·ªù gh√©p (VIN c≈© kh√¥ng h·ª£p l·ªá)";
      newChuaGhepRow["VIN"] = ""; // X√≥a VIN kh√¥ng h·ª£p l·ªá
      
      const rowDataForChuaGhep = chuaGhepHeaders.map(header => newChuaGhepRow[header] || "");
      chuaGhepSheet.appendRow(rowDataForChuaGhep);

      rowsToDelete.push(i + 1); // ƒê√°nh d·∫•u d√≤ng ƒë·ªÉ x√≥a kh·ªèi DaGhep

      const correctionDetails = `ƒê∆°n h√†ng "${orderNumber}" c√≥ VIN "${vin}" kh√¥ng t·ªìn t·∫°i trong KhoXe. ƒê√£ t·ª± ƒë·ªông chuy·ªÉn ƒë∆°n h√†ng v·ªÅ sheet ChuaGhep.`;
      corrections.push({
        type: 'S·ª≠a ƒë∆°n h√†ng m·ªì c√¥i',
        details: correctionDetails,
        sheetName: DA_GHEP_SHEET_NAME,
        row: i + 1,
        vin: vin,
        orderNumber: orderNumber
      });
      recordOrderHistory(orderNumber, vin, "S·ª≠a l·ªói t·ª± ƒë·ªông", "Chuy·ªÉn v·ªÅ ChuaGhep do VIN kh√¥ng t·ªìn t·∫°i trong KhoXe.");
    }
  }

  // X√≥a c√°c d√≤ng ƒë√£ chuy·ªÉn t·ª´ sheet DaGhep (x√≥a t·ª´ d∆∞·ªõi l√™n ƒë·ªÉ kh√¥ng b·ªã l·ªách ch·ªâ s·ªë)
  for (let i = rowsToDelete.length - 1; i >= 0; i--) {
    daGhepSheet.deleteRow(rowsToDelete[i]);
  }

  return corrections;
}

/**
 * [S·ª¨A L·ªñI 3] T√¨m v√† s·ª≠a c√°c m√†u ngo·∫°i th·∫•t kh√¥ng h·ª£p l·ªá.
 * Tr·∫£ v·ªÅ c·∫£ danh s√°ch l·ªói c·∫ßn s·ª≠a th·ªß c√¥ng v√† danh s√°ch ƒë√£ s·ª≠a t·ª± ƒë·ªông.
 */
function findAndFixInvalidColors(sheets) {
  const { daGhepSheet, stockSheet } = sheets;
  const errors = [];
  const corrections = [];

  const checkAndFixSheet = (sheet, sheetName, headers) => {
    const colorColIndex = headers.indexOf("Ngo·∫°i th·∫•t");
    const vinColIndex = headers.indexOf("VIN");
    const orderColIndex = headers.indexOf("S·ªë ƒë∆°n h√†ng");
    if (colorColIndex === -1) return;

    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const color = String(row[colorColIndex] || "").trim();
      if (color && !isValidExteriorColor(color)) {
        const matchedColor = findMatchedValidColor(color);
        const vin = vinColIndex !== -1 ? String(row[vinColIndex] || "").trim() : 'N/A';
        const orderNumber = orderColIndex !== -1 ? String(row[orderColIndex] || "").trim() : 'N/A';

        if (matchedColor) {
          // T·ª± ƒë·ªông s·ª≠a
          sheet.getRange(i + 1, colorColIndex + 1).setValue(matchedColor);
          const correctionDetails = `M√†u "${color}" ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông s·ª≠a th√†nh "${matchedColor}".`;
          corrections.push({
            type: 'S·ª≠a m√†u ngo·∫°i th·∫•t',
            details: correctionDetails,
            sheetName: sheetName,
            row: i + 1,
            vin: vin,
            orderNumber: orderNumber
          });
        } else {
          // B√°o l·ªói ƒë·ªÉ s·ª≠a th·ªß c√¥ng
          errors.push({
            type: 'M√†u ngo·∫°i th·∫•t kh√¥ng h·ª£p l·ªá',
            details: `Gi√° tr·ªã m√†u "${color}" kh√¥ng h·ª£p l·ªá v√† kh√¥ng th·ªÉ t·ª± ƒë·ªông s·ª≠a.`,
            sheetName: sheetName,
            row: i + 1,
            vin: vin,
            orderNumber: orderNumber
          });
        }
      }
    }
  };

  checkAndFixSheet(stockSheet, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  checkAndFixSheet(daGhepSheet, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"]);

  return { errors, corrections };
}

// Gi·ªØ nguy√™n h√†m findLongPendingOrders v√¨ n√≥ ch·ªâ b√°o c√°o
function findLongPendingOrders(sheets) {
  const { chuaGhepSheet } = sheets;
  const errors = [];
  const data = chuaGhepSheet.getDataRange().getValues();
  const headers = SHEET_HEADERS["ChuaGhep"];
  const ngayCocCol = headers.indexOf("Ng√†y c·ªçc");
  const orderCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
  const NINETY_DAYS_IN_MS = 90 * 24 * 60 * 60 * 1000;
  const now = new Date();

  if (ngayCocCol === -1) return errors;

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const ngayCocValue = row[ngayCocCol];
    const orderNumber = String(row[orderCol] || "").trim();

    if (ngayCocValue && orderNumber) {
      const ngayCocDate = new Date(ngayCocValue);
      if (!isNaN(ngayCocDate.getTime()) && (now - ngayCocDate > NINETY_DAYS_IN_MS)) {
        const daysPending = Math.round((now - ngayCocDate) / (1000 * 60 * 60 * 24));
        errors.push({
          type: 'ƒê∆°n h√†ng ch·ªù qu√° l√¢u',
          details: `ƒê∆°n h√†ng ƒë√£ ·ªü tr·∫°ng th√°i ch·ªù ${daysPending} ng√†y (k·ªÉ t·ª´ ng√†y c·ªçc). C·∫ßn ƒë∆∞·ª£c xem x√©t.`,
          sheetName: CHUA_GHEP_SHEET_NAME,
          row: i + 1,
          vin: '',
          orderNumber: orderNumber
        });
      }
    }
  }
  return errors;
}
/**
 * T·∫°o ho·∫∑c c·∫≠p nh·∫≠t sheet b√°o c√°o duy nh·∫•t t·ª´ danh s√°ch l·ªói v√† danh s√°ch ƒë√£ s·ª≠a.
 */
function generateHealthCheckReport(ss, errors, corrections) {
  const spreadsheetUrl = ss.getUrl();
  const REPORT_SHEET_NAME = "B√°o C√°o S·ª©c Kh·ªèe D·ªØ Li·ªáu"; // T√™n sheet b√°o c√°o c·ªë ƒë·ªãnh

  // L·∫•y sheet b√°o c√°o. N·∫øu ƒë√£ t·ªìn t·∫°i, x√≥a s·∫°ch n·ªôi dung. N·∫øu ch∆∞a, t·∫°o m·ªõi.
  let reportSheet = ss.getSheetByName(REPORT_SHEET_NAME);
  if (reportSheet) {
    reportSheet.clear(); // X√≥a s·∫°ch n·ªôi dung v√† ƒë·ªãnh d·∫°ng c≈©
  } else {
    reportSheet = ss.insertSheet(REPORT_SHEET_NAME, 0);
  }

  const reportHeaders = ["Lo·∫°i V·∫•n ƒê·ªÅ", "Chi Ti·∫øt", "Sheet", "D√≤ng", "S·ªë ƒê∆°n H√†ng", "VIN", "Link"];
  let currentRow = 1;

  // --- Ph·∫ßn ƒë√£ t·ª± ƒë·ªông s·ª≠a ---
  reportSheet.getRange(currentRow, 1, 1, 7).setValue("C√ÅC V·∫§N ƒê·ªÄ ƒê√É T·ª∞ ƒê·ªòNG S·ª¨A").merge().setBackground("#d9ead3").setFontWeight("bold").setHorizontalAlignment("center");
  currentRow++;
  reportSheet.getRange(currentRow, 1, 1, reportHeaders.length).setValues([reportHeaders]).setBackground("#4682b4").setFontColor("#ffffff").setFontWeight("bold");
  currentRow++;

  if (corrections.length > 0) {
    const correctionData = corrections.map(item => {
      // L·∫•y sheetId m·ªôt c√°ch an to√†n
      const sourceSheet = ss.getSheetByName(item.sheetName);
      const sheetId = sourceSheet ? sourceSheet.getSheetId() : '0';
      const link = `${spreadsheetUrl}#gid=${sheetId}&range=A${item.row}`;
      return [item.type, item.details, item.sheetName, item.row, item.orderNumber, item.vin, '=HYPERLINK("' + link + '"; "Xem L·∫°i")'];
    });
    reportSheet.getRange(currentRow, 1, correctionData.length, reportHeaders.length).setValues(correctionData);
    currentRow += correctionData.length;
  } else {
    reportSheet.getRange(currentRow, 1, 1, 7).setValue("Kh√¥ng c√≥ v·∫•n ƒë·ªÅ n√†o ƒë∆∞·ª£c s·ª≠a t·ª± ƒë·ªông.").merge().setHorizontalAlignment("center");
    currentRow++;
  }

  // --- Ph·∫ßn c·∫ßn s·ª≠a th·ªß c√¥ng ---
  currentRow++; // Th√™m m·ªôt d√≤ng tr·ªëng
  reportSheet.getRange(currentRow, 1, 1, 7).setValue("C√ÅC V·∫§N ƒê·ªÄ C·∫¶N S·ª¨A TH·ª¶ C√îNG").merge().setBackground("#f4cccc").setFontWeight("bold").setHorizontalAlignment("center");
  currentRow++;
  reportSheet.getRange(currentRow, 1, 1, reportHeaders.length).setValues([reportHeaders]).setBackground("#4682b4").setFontColor("#ffffff").setFontWeight("bold");
  currentRow++;

  if (errors.length > 0) {
    const errorData = errors.map(item => {
      // L·∫•y sheetId m·ªôt c√°ch an to√†n
      const sourceSheet = ss.getSheetByName(item.sheetName);
      const sheetId = sourceSheet ? sourceSheet.getSheetId() : '0';
      const link = `${spreadsheetUrl}#gid=${sheetId}&range=A${item.row}`;
      return [item.type, item.details, item.sheetName, item.row, item.orderNumber, item.vin, '=HYPERLINK("' + link + '"; "ƒê·∫øn D√≤ng ' + item.row + '")'];
    });
    reportSheet.getRange(currentRow, 1, errorData.length, reportHeaders.length).setValues(errorData);
  } else {
     reportSheet.getRange(currentRow, 1, 1, 7).setValue("Kh√¥ng t√¨m th·∫•y v·∫•n ƒë·ªÅ n√†o c·∫ßn s·ª≠a th·ªß c√¥ng. D·ªØ li·ªáu c·ªßa b·∫°n r·∫•t t·ªët!").merge().setHorizontalAlignment("center");
  }

  reportSheet.setFrozenRows(1);
  reportSheet.autoResizeColumns(1, reportHeaders.length);
  
  // K√≠ch ho·∫°t sheet b√°o c√°o ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y ngay k·∫øt qu·∫£
  reportSheet.activate();
}
// THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG H√ÄM N√ÄY
function myOnEditTrigger(e) {
  const range = e.range;
  const sheet = range.getSheet();
  const sheetName = sheet.getName();

  // Danh s√°ch c√°c sheet kh√¥ng c·∫ßn ch·∫°y trigger
  const sheetsToExclude = ["B√°o C√°o S·ª©c Kh·ªèe D·ªØ Li·ªáu", "log", "NhatKyChinhSua", "lichsu_donhang", "lichsu_xe"];
  if (sheetsToExclude.includes(sheetName) || !e.user || e.user.getEmail() === "") {
    return;
  }

  // Kh√≥a script ƒë·ªÉ tr√°nh xung ƒë·ªôt
  const lock = LockService.getScriptLock();
  if (!lock.tryLock(15000)) {
    e.source.toast(`H·ªá th·ªëng ƒëang b·∫≠n, thay ƒë·ªïi c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω sau √≠t ph√∫t.`, "Vui l√≤ng ch·ªù", 5);
    return;
  }

  try {
    let dataChanged = logUserEdit(e); // Ghi l·∫°i l·ªãch s·ª≠ ch·ªânh s·ª≠a
    if (dataChanged) {
      
      // --- B·∫ÆT ƒê·∫¶U PH·∫¶N S·ª¨A L·ªñI QUAN TR·ªåNG ---
      // X·ª≠ l√Ω logic nghi·ªáp v·ª• trong h√†m handleEditTrigger
      if (["DaGhep", "KhoXe", "Xuathoadon"].includes(sheetName)) { // B·ªè "DangKyCho" ra kh·ªèi ƒë√¢y
         Logger.log(`onEdit: B·∫Øt ƒë·∫ßu g·ªçi h√†m handleEditTrigger cho sheet ${sheetName}...`);
         handleEditTrigger(e); // G·ªçi h√†m x·ª≠ l√Ω logic ch√≠nh
         Logger.log(`onEdit: Ho√†n t·∫•t th·ª±c thi handleEditTrigger cho sheet ${sheetName}.`);
      }
      
      // X·ª¨ L√ù G·ª¨I TH√îNG B√ÅO KHI ADMIN PH·∫¢N H·ªíI Y√äU C·∫¶U CH·ªú
      // (Logic n√†y ƒë∆∞·ª£c ƒë·∫∑t tr·ª±c ti·∫øp ·ªü ƒë√¢y ƒë·ªÉ ƒë·∫£m b·∫£o n√≥ lu√¥n ch·∫°y ƒë√∫ng)
      if (sheetName === "DangKyCho" && range.getRow() > 1) {
        const currentSheets = getSheets(e.source);
        const dangKyChoHeaders = SHEET_HEADERS["DangKyCho"];
        const ghiChuColIndex = dangKyChoHeaders.indexOf("Ghi ch√∫");

        // Ch·ªâ g·ª≠i th√¥ng b√°o khi Admin (ho·∫∑c ng∆∞·ªùi c√≥ quy·ªÅn) ch·ªânh s·ª≠a c·ªôt "Ghi ch√∫"
        if (range.getColumn() === ghiChuColIndex + 1 && e.user.getEmail() === ADMIN_EMAIL) {
            const editedRowValues = sheet.getRange(range.getRow(), 1, 1, dangKyChoHeaders.length).getValues()[0];
            const adminNote = editedRowValues[ghiChuColIndex];

            if (adminNote && adminNote.trim() !== "") {
              const tenTVBH = editedRowValues[dangKyChoHeaders.indexOf("T√™n TVBH")];
              const tenKH = editedRowValues[dangKyChoHeaders.indexOf("T√™n kh√°ch h√†ng")];
              const requestId = editedRowValues[dangKyChoHeaders.indexOf("ID Y√™u C·∫ßu")];
              
              const notificationMessage = `Admin ƒë√£ ph·∫£n h·ªìi YC ch·ªù c·ªßa KH ${tenKH}: "${adminNote}"`;
              // G·ªåI H√ÄM addNotification V·ªöI ƒê√öNG THAM S·ªê
              addNotification(notificationMessage, 'info', 'cho-xe', requestId, e.user.getEmail(), tenTVBH);
            }
        }
      }
      // --- K·∫æT TH√öC PH·∫¶N S·ª¨A L·ªñI QUAN TR·ªåNG ---
      
      // TƒÉng phi√™n b·∫£n d·ªØ li·ªáu ƒë·ªÉ web app nh·∫≠n bi·∫øt v√† c·∫≠p nh·∫≠t
      incrementDataVersion();
    }
  } catch (error) {
    Logger.log(`L·ªói nghi√™m tr·ªçng trong myOnEditTrigger: ${error.message} Stack: ${error.stack}`);
    e.source.toast(`ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω ch·ªânh s·ª≠a: ${error.message}`, "L·ªói H·ªá Th·ªëng", 10);
  } finally {
    lock.releaseLock();
  }
}

function logUserEdit(e, actionId = null) {
  try {
    const range = e.range;
    if (range.getNumRows() === 1 && range.getNumColumns() === 1) {
      const oldValue = e.oldValue !== undefined ? String(e.oldValue) : "[√î tr·ªëng]";
      const newValue = e.value !== undefined ? String(e.value) : "[√î tr·ªëng]";
      if (oldValue !== newValue) {
        const logSheet = getOrCreateSheet(e.source, "NhatKyChinhSua", SHEET_HEADERS["NhatKyChinhSua"]);
        logSheet.appendRow([
          new Date(),
          e.user.getEmail(),
          range.getSheet().getName(),
          range.getA1Notation(),
          oldValue,
          newValue,
          actionId || `manual-${new Date().getTime()}`, // Ghi l·∫°i Action ID ho·∫∑c t·∫°o ID cho s·ª≠a tay
          "" // Tr·∫°ng th√°i Log ban ƒë·∫ßu ƒë·ªÉ tr·ªëng
        ]);
        return true;
      }
    } else {
        return true;
    }
  } catch (logError) {
    Logger.log(`L·ªói khi ghi nh·∫≠t k√Ω ch·ªânh s·ª≠a: ${logError.message}`);
  }
  return false;
}
function findAndSuggestMatches(newCarDetails, userEmail) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const chuaGhepSheet = ss.getSheetByName(CHUA_GHEP_SHEET_NAME);
  if (!chuaGhepSheet || chuaGhepSheet.getLastRow() < 2) {
    return;
  }

  const chuaGhepData = chuaGhepSheet.getDataRange().getValues();
  const chuaGhepHeaders = SHEET_HEADERS["ChuaGhep"];

  const tvbhCol = chuaGhepHeaders.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng");
  const khachHangCol = chuaGhepHeaders.indexOf("T√™n kh√°ch h√†ng");
  const donHangCol = chuaGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
  const dongXeCol = chuaGhepHeaders.indexOf("D√≤ng xe");
  const phienBanCol = chuaGhepHeaders.indexOf("Phi√™n b·∫£n");
  const ngoaiThatCol = chuaGhepHeaders.indexOf("Ngo·∫°i th·∫•t");
  const noiThatCol = chuaGhepHeaders.indexOf("N·ªôi th·∫•t");
  const ngayCocCol = chuaGhepHeaders.indexOf("Ng√†y c·ªçc");

  const matchedOrders = [];
  const carDongXe = String(newCarDetails.dong_xe).trim().toLowerCase().normalize('NFC');
  const carPhienBan = String(newCarDetails.phien_ban).trim().toLowerCase().normalize('NFC');
  const carNgoaiThat = String(newCarDetails.ngoai_that).trim().toLowerCase().normalize('NFC');
  const carNoiThat = String(newCarDetails.noi_that).trim().toLowerCase().normalize('NFC');
  for (let i = 1; i < chuaGhepData.length; i++) {
    const order = chuaGhepData[i];
    const orderDongXe = String(order[dongXeCol]).trim().toLowerCase().normalize('NFC');
    const orderPhienBan = String(order[phienBanCol]).trim().toLowerCase().normalize('NFC');
    const orderNgoaiThat = String(order[ngoaiThatCol]).trim().toLowerCase().normalize('NFC');
    const orderNoiThat = String(order[noiThatCol]).trim().toLowerCase().normalize('NFC');
    if (carDongXe === orderDongXe &&
      carPhienBan === orderPhienBan &&
      carNgoaiThat === orderNgoaiThat &&
      orderNoiThat.includes(carNoiThat)) {

      matchedOrders.push({
        so_don_hang: order[donHangCol],
        ten_khach_hang: order[khachHangCol],
        ten_tu_van: order[tvbhCol],
        ngay_coc: order[ngayCocCol]
      });
    }
  }

  if (matchedOrders.length > 0) {
    matchedOrders.sort((a, b) => {
      const dateA = new Date(a.ngay_coc);
      const dateB = new Date(b.ngay_coc);
      if (isNaN(dateA.getTime())) return 1;
      if (isNaN(dateB.getTime())) return -1;
      return dateA.getTime() - dateB.getTime();
    });
    // T·∫°o c·∫•u tr√∫c d·ªØ li·ªáu t∆∞∆°ng t·ª± nh∆∞ getSuggestionsForExistingData
    const singleCarSuggestion = [{
      car: newCarDetails,
      orders: matchedOrders
    }];
    const userProperties = PropertiesService.getUserProperties();
    const suggestionData = {
      timestamp: new Date().getTime(),
      allSuggestions: singleCarSuggestion // L∆∞u ch·ªâ g·ª£i √Ω cho xe m·ªõi nh·∫≠p
    };
    userProperties.setProperty('MATCH_SUGGESTION_ALL', JSON.stringify(suggestionData)); // C·∫≠p nh·∫≠t c√πng m·ªôt kh√≥a

    showToastOnSheet(
      `T√¨m th·∫•y ${matchedOrders.length} ƒë∆°n h√†ng ph√π h·ª£p! M·ªü sidebar "G·ª£i √Ω Gh√©p xe" ƒë·ªÉ xem.`,
      "‚úÖ G·ª£i √Ω Gh√©p xe",
      10
    );
  }
}
function showSuggestionSidebar() {
  // G·ªçi h√†m ƒë·ªÉ t·∫°o g·ª£i √Ω t·ª´ d·ªØ li·ªáu hi·ªán c√≥
  const result = doReadWriteLock(() => getSuggestionsForExistingData());

  if (result.status === "SUCCESS") {
    showToastOnSheet(result.message, "‚úÖ G·ª£i √Ω Gh√©p xe", 10);
  } else {
    showToastOnSheet(result.message, "Th√¥ng b√°o", 5);
  }

  const html = HtmlService.createHtmlOutputFromFile('SuggestionSidebar')
    .setTitle('G·ª£i √Ω Gh√©p xe')
    .setWidth(350);
  SpreadsheetApp.getUi().showSidebar(html);
}
function getMatchSuggestions() {
  const userProperties = PropertiesService.getUserProperties();
  const suggestionJson = userProperties.getProperty('MATCH_SUGGESTION_ALL'); // ƒê·ªçc t·ª´ kh√≥a m·ªõi

  if (suggestionJson) {
    userProperties.deleteProperty('MATCH_SUGGESTION_ALL'); // X√≥a sau khi l·∫•y
    const suggestionData = JSON.parse(suggestionJson);

    const fiveMinutes = 5 * 60 * 1000;
    if (new Date().getTime() - suggestionData.timestamp < fiveMinutes) {
      return suggestionData.allSuggestions; // Tr·∫£ v·ªÅ m·∫£ng c√°c g·ª£i √Ω
    }
  }
  return null;
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈®]
function getSuggestionsForExistingData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const chuaGhepSheet = ss.getSheetByName(CHUA_GHEP_SHEET_NAME);
  const stockSheet = ss.getSheetByName(STOCK_SHEET_NAME);
  if (!chuaGhepSheet || chuaGhepSheet.getLastRow() < 2 || !stockSheet || stockSheet.getLastRow() < 2) {
    return { status: "NO_DATA", message: "Kh√¥ng c√≥ ƒë·ªß d·ªØ li·ªáu trong sheet 'Ch∆∞a gh√©p' ho·∫∑c 'KhoXe' ƒë·ªÉ t·∫°o g·ª£i √Ω." };
  }

  const chuaGhepData = chuaGhepSheet.getDataRange().getValues();
  const chuaGhepHeaders = SHEET_HEADERS["ChuaGhep"];
  const stockData = stockSheet.getDataRange().getValues();
  const stockHeaders = SHEET_HEADERS["KhoXe"];
  const suggestions = [];

  // L·∫•y ch·ªâ s·ªë c√°c c·ªôt c·∫ßn thi·∫øt
  const tvbhColCHG = chuaGhepHeaders.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng");
  const tenKhColCHG = chuaGhepHeaders.indexOf("T√™n kh√°ch h√†ng");
  const donHangColCHG = chuaGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
  const dongXeColCHG = chuaGhepHeaders.indexOf("D√≤ng xe");
  const phienBanColCHG = chuaGhepHeaders.indexOf("Phi√™n b·∫£n");
  const ngoaiThatColCHG = chuaGhepHeaders.indexOf("Ngo·∫°i th·∫•t");
  const noiThatColCHG = chuaGhepHeaders.indexOf("N·ªôi th·∫•t");
  const ngayCocColCHG = chuaGhepHeaders.indexOf("Ng√†y c·ªçc");
  const vinColStock = stockHeaders.indexOf("VIN");
  const statusColStock = stockHeaders.indexOf("Tr·∫°ng th√°i");
  const dongXeColStock = stockHeaders.indexOf("D√≤ng xe");
  const phienBanColStock = stockHeaders.indexOf("Phi√™n b·∫£n");
  const ngoaiThatColStock = stockHeaders.indexOf("Ngo·∫°i th·∫•t");
  const noiThatColStock = stockHeaders.indexOf("N·ªôi th·∫•t");
  const ngayNhapColStock = stockHeaders.indexOf("Ng√†y nh·∫≠p");

  for (let i = 1; i < stockData.length; i++) {
    const car = stockData[i];
    const carVin = String(car[vinColStock] || "").trim();
    const carStatus = String(car[statusColStock] || "").toLowerCase().trim();

    if (carStatus === "ch∆∞a gh√©p" && carVin) {
      const carDongXe = normalizeForComparison(car[dongXeColStock]);
      const carPhienBan = normalizeForComparison(car[phienBanColStock]);
      const carNgoaiThat = normalizeForComparison(car[ngoaiThatColStock]);
      const carNoiThat = normalizeForComparison(car[noiThatColStock]); // Chu·∫©n h√≥a n·ªôi th·∫•t xe
      const carNgayNhap = car[ngayNhapColStock];
      
      const matchingOrdersForCar = [];
      for (let j = 1; j < chuaGhepData.length; j++) {
        const order = chuaGhepData[j];
        const orderKetQua = String(order[chuaGhepHeaders.indexOf("K·∫øt qu·∫£")] || "").toLowerCase().trim();
        
        if (orderKetQua.startsWith("ch∆∞a")) {
          const orderDongXe = normalizeForComparison(order[dongXeColCHG]);
          const orderPhienBan = normalizeForComparison(order[phienBanColCHG]);
          const orderNgoaiThat = normalizeForComparison(order[ngoaiThatColCHG]);
          const orderNoiThat = normalizeForComparison(order[noiThatColCHG]); // Chu·∫©n h√≥a n·ªôi th·∫•t ƒë∆°n h√†ng
          
          // [T·ªêI ∆ØU] So s√°nh n·ªôi th·∫•t ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a
          if (carDongXe === orderDongXe &&
              carPhienBan === orderPhienBan &&
              carNgoaiThat === orderNgoaiThat &&
              carNoiThat === orderNoiThat) { // So s√°nh b·∫±ng thay v√¨ includes
            
            let ngayCocValue = order[ngayCocColCHG];
            if (ngayCocValue instanceof Date) {
              ngayCocValue = Utilities.formatDate(ngayCocValue, Session.getScriptTimeZone(), "dd/MM/yyyy");
            } else if (ngayCocValue) {
              try {
                ngayCocValue = Utilities.formatDate(new Date(ngayCocValue), Session.getScriptTimeZone(), "dd/MM/yyyy");
              } catch (err) { /* B·ªè qua l·ªói ƒë·ªãnh d·∫°ng */ }
            }

            matchingOrdersForCar.push({
              so_don_hang: order[donHangColCHG],
              ten_khach_hang: order[tenKhColCHG],
              ten_tu_van: order[tvbhColCHG],
              ngay_coc: ngayCocValue
            });
          }
        }
      }

      if (matchingOrdersForCar.length > 0) {
        matchingOrdersForCar.sort((a, b) => {
          const dateA = new Date(a.ngay_coc);
          const dateB = new Date(b.ngay_coc);
          if (isNaN(dateA.getTime())) return 1;
          if (isNaN(dateB.getTime())) return -1;
          return dateA.getTime() - dateB.getTime();
        });
        suggestions.push({
          car: {
            vin: carVin,
            dong_xe: String(car[dongXeColStock]).trim(),
            phien_ban: String(car[phienBanColStock]).trim(),
            ngoai_that: String(car[ngoaiThatColStock]).trim(),
            noi_that: String(car[noiThatColStock]).trim(),
            ngay_nhap: carNgayNhap instanceof Date ? Utilities.formatDate(carNgayNhap, Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss") : String(carNgayNhap || "")
          },
          orders: matchingOrdersForCar
        });
      }
    }
  }

  if (suggestions.length > 0) {
    suggestions.sort((a, b) => {
      const dateA = new Date(a.car.ngay_nhap);
      const dateB = new Date(b.car.ngay_nhap);
      if (isNaN(dateA.getTime())) return 1;
      if (isNaN(dateB.getTime())) return -1;
      return dateA.getTime() - dateB.getTime();
    });
    const userProperties = PropertiesService.getUserProperties();
    const suggestionData = {
      timestamp: new Date().getTime(),
      allSuggestions: suggestions
    };
    userProperties.setProperty('MATCH_SUGGESTION_ALL', JSON.stringify(suggestionData));
    return { status: "SUCCESS", message: `T√¨m th·∫•y ${suggestions.length} nh√≥m g·ª£i √Ω gh√©p xe.`, data: suggestionData };
  } else {
    return { status: "NO_SUGGESTIONS", message: "Kh√¥ng t√¨m th·∫•y b·∫•t k·ª≥ g·ª£i √Ω gh√©p xe n√†o ph√π h·ª£p." };
  }
}
function showSearchAndFilterSidebar() {
  const html = HtmlService.createHtmlOutputFromFile('SearchSidebar')
      .setTitle('T√¨m Ki·∫øm & L·ªçc N√¢ng Cao')
      .setWidth(1550); // TƒÉng chi·ªÅu r·ªông
  SpreadsheetApp.getUi().showSidebar(html);
}
/**
 * L·∫•y c√°c gi√° tr·ªã duy nh·∫•t t·ª´ c√°c c·ªôt ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh tr√™n nhi·ªÅu sheet ƒë·ªÉ ƒëi·ªÅn v√†o c√°c dropdown c·ªßa b·ªô l·ªçc.
 * @returns {Object} M·ªôt ƒë·ªëi t∆∞·ª£ng ch·ª©a c√°c m·∫£ng gi√° tr·ªã duy nh·∫•t cho c√°c ti√™u ch√≠ l·ªçc kh√°c nhau.
 */
function getFilterOptions() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = getSheets(ss);
  const options = {
    dong_xe: new Set(),
    phien_ban: new Set(),
    ngoai_that: new Set(),
  };

  const sheetsToScan = {
    DaGhep: { sheet: sheets.daGhepSheet, headers: SHEET_HEADERS.DaGhep },
    ChuaGhep: { sheet: sheets.chuaGhepSheet, headers: SHEET_HEADERS.ChuaGhep },
    KhoXe: { sheet: sheets.stockSheet, headers: SHEET_HEADERS.KhoXe }
  };

  for (const key in sheetsToScan) {
    const { sheet, headers } = sheetsToScan[key];
    if (!sheet || sheet.getLastRow() < 2) continue;
    const data = sheet.getDataRange().getValues();

    const dongXeCol = headers.indexOf("D√≤ng xe");
    const phienBanCol = headers.indexOf("Phi√™n b·∫£n");
    const ngoaiThatCol = headers.indexOf("Ngo·∫°i th·∫•t");

    for (let i = 1; i < data.length; i++) {
      if (dongXeCol > -1 && data[i][dongXeCol]) options.dong_xe.add(data[i][dongXeCol]);
      if (phienBanCol > -1 && data[i][phienBanCol]) options.phien_ban.add(data[i][phienBanCol]);
      if (ngoaiThatCol > -1 && data[i][ngoaiThatCol]) options.ngoai_that.add(data[i][ngoaiThatCol]);
    }
  }

  VALID_EXTERIOR_COLORS.forEach(c => options.ngoai_that.add(c));

  // Danh s√°ch tr·∫°ng th√°i h·ª£p nh·∫•t, d·ªÖ hi·ªÉu
  const combinedStatus = new Set([
    'Ch∆∞a gh√©p / S·∫µn c√≥',
    'ƒê√£ gh√©p',
    'ƒê√£ xu·∫•t h√≥a ƒë∆°n',
    'ƒê√£ h·ªßy'
  ]);

  return {
    dong_xe: Array.from(options.dong_xe).sort(),
    phien_ban: Array.from(options.phien_ban).sort(),
    ngoai_that: Array.from(options.ngoai_that).sort(),
    status: Array.from(combinedStatus) // Tr·∫£ v·ªÅ danh s√°ch tr·∫°ng th√°i m·ªõi
  };
}
/**
 * Th·ª±c hi·ªán t√¨m ki·∫øm n√¢ng cao tr√™n nhi·ªÅu sheet d·ª±a tr√™n m·ªôt b·ªô l·ªçc ƒë√£ ƒë∆∞·ª£c ƒë∆°n gi·∫£n h√≥a.
 * @param {Object} filters - M·ªôt ƒë·ªëi t∆∞·ª£ng ch·ª©a c√°c ti√™u ch√≠ l·ªçc t·ª´ sidebar.
 * @returns {Object} M·ªôt ƒë·ªëi t∆∞·ª£ng ch·ª©a k·∫øt qu·∫£ t√¨m ki·∫øm, ƒë∆∞·ª£c nh√≥m theo t√™n sheet.
 */
function performAdvancedSearch(filters) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const spreadsheetUrl = ss.getUrl();
    const searchResults = {};

    const sheetConfigs = {
      'DaGhep': { sheet: ss.getSheetByName(DA_GHEP_SHEET_NAME), headers: SHEET_HEADERS.DaGhep },
      'ChuaGhep': { sheet: ss.getSheetByName(CHUA_GHEP_SHEET_NAME), headers: SHEET_HEADERS.ChuaGhep },
      'KhoXe': { sheet: ss.getSheetByName(STOCK_SHEET_NAME), headers: SHEET_HEADERS.KhoXe },
      'HuyGhep': { sheet: ss.getSheetByName(CANCELLED_SHEET_NAME), headers: SHEET_HEADERS.HuyGhep },
      'Xuathoadon': { sheet: ss.getSheetByName(XUAT_HOA_DON_SHEET_NAME), headers: SHEET_HEADERS.Xuathoadon }
    };

    const sheetsToSearch = filters.sheets || [];

    for (const sheetName of sheetsToSearch) {
      const config = sheetConfigs[sheetName];
      if (!config || !config.sheet || config.sheet.getLastRow() < 2) continue;

      const data = config.sheet.getDataRange().getValues();
      const headers = data[0];
      const sheetId = config.sheet.getSheetId();

      const filteredRows = data.slice(1).map((row, index) => ({
        data: row,
        rowIndex: index + 2
      })).filter(rowObject => {
        let isMatch = true;
        const row = rowObject.data;

        // 1. L·ªçc theo t·ª´ kh√≥a
        const keyword = filters.keyword ? normalizeString(String(filters.keyword)) : '';
        if (keyword) {
          const searchableHeaders = ["S·ªë ƒë∆°n h√†ng", "S·ªê ƒê∆†N H√ÄNG", "VIN", "S·ªê VIN", "T√™n kh√°ch h√†ng", "T√äN KH√ÅCH H√ÄNG", "T√™n t∆∞ v·∫•n b√°n h√†ng", "T∆Ø V·∫§N B√ÅN H√ÄNG"];
          let keywordMatch = false;
          for (const headerName of searchableHeaders) {
            const colIdx = headers.indexOf(headerName);
            if (colIdx > -1 && row[colIdx] && normalizeString(String(row[colIdx])).includes(keyword)) {
              keywordMatch = true;
              break;
            }
          }
          if (!keywordMatch) isMatch = false;
        }

        // 2. L·ªçc theo c√°c dropdown kh√°c n·∫øu h√†ng v·∫´n kh·ªõp
        if (isMatch && filters.dong_xe) {
            const colIdx = headers.findIndex(h => h.toUpperCase() === "D√íNG XE");
            if (colIdx === -1 || String(row[colIdx] || '').trim() !== filters.dong_xe) isMatch = false;
        }
        if (isMatch && filters.phien_ban) {
            const colIdx = headers.findIndex(h => h.toUpperCase() === "PHI√äN B·∫¢N");
            if (colIdx === -1 || String(row[colIdx] || '').trim() !== filters.phien_ban) isMatch = false;
        }
        if (isMatch && filters.ngoai_that) {
            const colIdx = headers.findIndex(h => h.toUpperCase() === "NGO·∫†I TH·∫§T");
            if (colIdx === -1 || String(row[colIdx] || '').trim() !== filters.ngoai_that) isMatch = false;
        }

        // 3. L·ªçc theo tr·∫°ng th√°i h·ª£p nh·∫•t
        if (isMatch && filters.status) {
          let statusMatch = false;
          const ketQuaCol = headers.indexOf("K·∫øt qu·∫£");
          const trangThaiCol = headers.indexOf("Tr·∫°ng th√°i");

          switch (filters.status) {
            case 'Ch∆∞a gh√©p / S·∫µn c√≥':
              if (sheetName === 'ChuaGhep' && ketQuaCol > -1 && ["ch∆∞a gh√©p", "ch∆∞a t√¨m th·∫•y vin", "ch∆∞a c√≥"].includes(String(row[ketQuaCol]||'').toLowerCase().trim())) statusMatch = true;
              if (sheetName === 'KhoXe' && trangThaiCol > -1 && String(row[trangThaiCol]||'').toLowerCase().trim() === 'ch∆∞a gh√©p') statusMatch = true;
              break;
            case 'ƒê√£ gh√©p':
              if (sheetName === 'DaGhep' && ketQuaCol > -1 && String(row[ketQuaCol]||'').toLowerCase().trim() === 'ƒë√£ gh√©p') statusMatch = true;
              if (sheetName === 'KhoXe' && trangThaiCol > -1 && String(row[trangThaiCol]||'').toLowerCase().trim() === 'ƒë√£ gh√©p') statusMatch = true;
              break;
            case 'ƒê√£ xu·∫•t h√≥a ƒë∆°n':
              if (sheetName === 'Xuathoadon') statusMatch = true;
              if (sheetName === 'DaGhep' && ketQuaCol > -1 && String(row[ketQuaCol]||'').toLowerCase().trim() === 'ƒë√£ xu·∫•t h√≥a ƒë∆°n') statusMatch = true;
              if (sheetName === 'KhoXe' && trangThaiCol > -1 && String(row[trangThaiCol]||'').toLowerCase().trim() === 'ƒë√£ xu·∫•t h√≥a ƒë∆°n') statusMatch = true;
              break;
            case 'ƒê√£ h·ªßy':
              if (sheetName === 'HuyGhep') statusMatch = true;
              break;
          }
          if (!statusMatch) isMatch = false;
        }
        
        return isMatch;
      });

      if (filteredRows.length > 0) {
        searchResults[sheetName] = {
          headers: headers,
          rows: filteredRows.map(rowObject => {
            const formattedRow = rowObject.data.map(cell => (cell instanceof Date) ? formatDateTimeForSheet(cell) : cell);
            return { data: formattedRow, link: `${spreadsheetUrl}#gid=${sheetId}&range=A${rowObject.rowIndex}` };
          })
        };
      }
    }
    return { status: "SUCCESS", results: searchResults };
  } catch (e) {
    logAction("L·ªói T√¨m Ki·∫øm N√¢ng Cao", `Error: ${e.message}, Stack: ${e.stack}`);
    return { status: "ERROR", message: `L·ªói m√°y ch·ªß khi t√¨m ki·∫øm: ${e.message}` };
  }
}

function anSoKhongChoSheetKPI() {
  const tenSheet = "KPI";
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = spreadsheet.getSheetByName(tenSheet);

  if (!sheet) {
    // N·∫øu kh√¥ng t√¨m th·∫•y sheet "KPI", hi·ªÉn th·ªã c·∫£nh b√°o cho ng∆∞·ªùi d√πng
    SpreadsheetApp.getUi().alert(`Kh√¥ng t√¨m th·∫•y sheet v·ªõi t√™n "${tenSheet}". Vui l√≤ng ki·ªÉm tra l·∫°i.`);
    return;
  }

  // L·∫•y to√†n b·ªô v√πng d·ªØ li·ªáu c·ªßa sheet
  const range = sheet.getDataRange();

  // ƒê·ªãnh d·∫°ng ƒë·ªÉ ·∫©n s·ªë 0
  const dinhDangAnSoKhong = "0;-0;;@";

  // √Åp d·ª•ng ƒë·ªãnh d·∫°ng cho to√†n b·ªô v√πng d·ªØ li·ªáu
  range.setNumberFormat(dinhDangAnSoKhong);

  // Th√¥ng b√°o cho ng∆∞·ªùi d√πng khi ho√†n t·∫•t
  SpreadsheetApp.getUi().alert(`ƒê√£ ·∫©n t·∫•t c·∫£ c√°c gi√° tr·ªã b·∫±ng 0 tr√™n sheet "${tenSheet}".`);
}
/**
 * [H√ÄM M·ªöI] Qu√©t v√† ƒë·ªìng b·ªô c√°c M√£ DMS c√≤n thi·∫øu t·ª´ Thongtinxe sang KhoXe.
 * H√†m n√†y ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ ch·∫°y t·ª± ƒë·ªông theo th·ªùi gian (v√≠ d·ª•: m·ªói 5 ph√∫t).
 */
function syncDmsCodes() {
  // S·ª≠ d·ª•ng LockService ƒë·ªÉ tr√°nh xung ƒë·ªôt khi c√≥ nhi·ªÅu ng∆∞·ªùi d√πng ho·∫∑c ti·∫øn tr√¨nh c√πng l√∫c
  doReadWriteLock(() => {
    Logger.log("B·∫Øt ƒë·∫ßu qu√©t M√£ DMS c√≤n thi·∫øu...");
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = getSheets(ss);
    const { stockSheet, thongtinxeSheet } = sheets;

    if (!stockSheet || !thongtinxeSheet) {
      logAction("L·ªói ƒë·ªìng b·ªô M√£ DMS", "Kh√¥ng t√¨m th·∫•y sheet KhoXe ho·∫∑c Thongtinxe.");
      return;
    }

    // 1. T·∫°o Map t·ª´ Thongtinxe ƒë·ªÉ tra c·ª©u nhanh VIN -> M√£ DMS (Khu v·ª±c)
    const thongtinxeData = thongtinxeSheet.getDataRange().getValues();
    const thongtinxeHeaders = SHEET_HEADERS["Thongtinxe"];
    const vinColThongtinxe = thongtinxeHeaders.indexOf("S·ªë VIN");
    const khuVucColThongtinxe = thongtinxeHeaders.indexOf("Khu v·ª±c");
    const vinToDmsMap = new Map();

    if (vinColThongtinxe > -1 && khuVucColThongtinxe > -1) {
      for (let i = 1; i < thongtinxeData.length; i++) {
        const vin = String(thongtinxeData[i][vinColThongtinxe] || "").trim();
        const dms = String(thongtinxeData[i][khuVucColThongtinxe] || "").trim();
        if (vin && dms) {
          vinToDmsMap.set(vin, dms);
        }
      }
    } else {
      logAction("L·ªói ƒë·ªìng b·ªô M√£ DMS", "Sheet Thongtinxe thi·∫øu c·ªôt 'S·ªë VIN' ho·∫∑c 'Khu v·ª±c'.");
      return;
    }

    // 2. Qu√©t KhoXe ƒë·ªÉ t√¨m v√† c·∫≠p nh·∫≠t c√°c M√£ DMS c√≤n thi·∫øu
    const stockData = stockSheet.getDataRange().getValues();
    const stockHeaders = SHEET_HEADERS["KhoXe"];
    const vinColStock = stockHeaders.indexOf("VIN");
    const maDmsColStock = stockHeaders.indexOf("M√£ DMS");
    
    if (vinColStock === -1 || maDmsColStock === -1) {
      logAction("L·ªói ƒë·ªìng b·ªô M√£ DMS", "Sheet KhoXe thi·∫øu c·ªôt 'VIN' ho·∫∑c 'M√£ DMS'.");
      return;
    }

    let updatesMade = 0;
    for (let i = 1; i < stockData.length; i++) {
      const vin = String(stockData[i][vinColStock] || "").trim();
      const currentDms = String(stockData[i][maDmsColStock] || "").trim();

      // N·∫øu c√≥ VIN nh∆∞ng ch∆∞a c√≥ M√£ DMS, th·ª±c hi·ªán c·∫≠p nh·∫≠t
      if (vin && !currentDms) {
        const expectedDms = vinToDmsMap.get(vin);
        if (expectedDms) {
          stockSheet.getRange(i + 1, maDmsColStock + 1).setValue(expectedDms);
          updatesMade++;
          logAction("ƒê·ªìng b·ªô M√£ DMS", `ƒê√£ c·∫≠p nh·∫≠t M√£ DMS '${expectedDms}' cho VIN ${vin} t·∫°i d√≤ng ${i + 1} sheet KhoXe.`);
        }
      }
    }

    if (updatesMade > 0) {
      Logger.log(`Ho√†n t·∫•t qu√©t. ƒê√£ c·∫≠p nh·∫≠t ${updatesMade} M√£ DMS.`);
    } else {
      Logger.log("Ho√†n t·∫•t qu√©t. Kh√¥ng c√≥ M√£ DMS n√†o c·∫ßn c·∫≠p nh·∫≠t.");
    }
  });
}

/**
 * [H√ÄM M·ªöI] Thi·∫øt l·∫≠p tr√¨nh k√≠ch ho·∫°t (trigger) t·ª± ƒë·ªông ch·∫°y h√†m syncDmsCodes m·ªói 5 ph√∫t.
 * Ch·∫°y h√†m n√†y m·ªôt l·∫ßn t·ª´ tr√¨nh so·∫°n th·∫£o script ƒë·ªÉ c√†i ƒë·∫∑t.
 */
function setupDmsSyncTrigger() {
  const ui = SpreadsheetApp.getUi();
  const triggers = ScriptApp.getProjectTriggers();

  // X√≥a c√°c trigger c≈© cho h√†m n√†y ƒë·ªÉ tr√°nh ch·∫°y nhi·ªÅu l·∫ßn
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === "syncDmsCodes") {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  try {
    // T·∫°o trigger m·ªõi, ch·∫°y m·ªói 5 ph√∫t
    ScriptApp.newTrigger("syncDmsCodes")
      .timeBased()
      .everyMinutes(5)
      .create();
    const message = "ƒê√£ thi·∫øt l·∫≠p th√†nh c√¥ng trigger t·ª± ƒë·ªông ƒë·ªìng b·ªô M√£ DMS 5 ph√∫t m·ªôt l·∫ßn.";
    showToastOnSheet(message, "Th√†nh C√¥ng");
    logAction("Thi·∫øt l·∫≠p Trigger", message);
  } catch (e) {
    const errorMessage = `L·ªói khi thi·∫øt l·∫≠p trigger: ${e.message}`;
    showToastOnSheet(errorMessage, "L·ªói");
    logAction("L·ªói Trigger", errorMessage);
  }
}

/**
 * [H√ÄM H·ªñ TR·ª¢ M·ªöI] C·∫≠p nh·∫≠t M√£ DMS cho m·ªôt d√≤ng c·ª• th·ªÉ khi ng∆∞·ªùi d√πng ch·ªânh s·ª≠a VIN.
 * @param {Sheet} khoXeSheet Sheet KhoXe ƒëang ƒë∆∞·ª£c ch·ªânh s·ª≠a.
 * @param {Sheet} thongtinxeSheet Sheet Thongtinxe ch·ª©a d·ªØ li·ªáu ngu·ªìn.
 * @param {string} vin S·ªë VIN c·∫ßn tra c·ª©u.
 * @param {number} rowIndex Ch·ªâ s·ªë c·ªßa d√≤ng ƒëang ƒë∆∞·ª£c ch·ªânh s·ª≠a.
 */
function updateDmsFromThongtinxe(khoXeSheet, thongtinxeSheet, vin, rowIndex) {
    if (!vin || !thongtinxeSheet || !khoXeSheet) return;
    // T·∫°o map ƒë·ªÉ tra c·ª©u nhanh, hi·ªáu qu·∫£ h∆°n v√≤ng l·∫∑p
    const thongtinxeData = thongtinxeSheet.getDataRange().getValues();
    const thongtinxeHeaders = SHEET_HEADERS["Thongtinxe"];
    const vinColThongtinxe = thongtinxeHeaders.indexOf("S·ªë VIN");
    const khuVucColThongtinxe = thongtinxeHeaders.indexOf("Khu v·ª±c");
    if (vinColThongtinxe === -1 || khuVucColThongtinxe === -1) {
        logAction("L·ªói c·∫≠p nh·∫≠t M√£ DMS (onEdit)", "Sheet Thongtinxe thi·∫øu c·ªôt 'S·ªë VIN' ho·∫∑c 'Khu v·ª±c'.");
        return;
    }

    const vinToDmsMap = new Map(
      thongtinxeData.slice(1).map(row => [
        String(row[vinColThongtinxe] || "").trim(),
        String(row[khuVucColThongtinxe] || "").trim()
      ])
    );
    const dmsCode = vinToDmsMap.get(vin);

    if (dmsCode) {
        const khoXeHeaders = SHEET_HEADERS["KhoXe"];
        const maDmsColKhoXe = khoXeHeaders.indexOf("M√£ DMS");
        if (maDmsColKhoXe > -1) {
            khoXeSheet.getRange(rowIndex, maDmsColKhoXe + 1).setValue(dmsCode);
            logAction("C·∫≠p nh·∫≠t M√£ DMS (onEdit)", `ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn M√£ DMS '${dmsCode}' cho VIN ${vin} t·∫°i d√≤ng ${rowIndex}.`);
        }
    } else {
       logAction("C·∫≠p nh·∫≠t M√£ DMS (onEdit)", `Kh√¥ng t√¨m th·∫•y M√£ DMS cho VIN ${vin} trong sheet Thongtinxe.`);
    }
}
function sendDmsMismatchWarningEmail() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = getSheets(ss);
  const { daGhepSheet, stockSheet, mailSheet } = sheets;
  if (!daGhepSheet || !stockSheet || !mailSheet) {
    logAction("L·ªói C·∫£nh b√°o M√£ DMS", "Kh√¥ng t√¨m th·∫•y m·ªôt trong c√°c sheet c·∫ßn thi·∫øt: DaGhep, KhoXe, Mail.");
    return;
  }

  // B∆∞·ªõc 1: T·∫°o m·ªôt Map tra c·ª©u nhanh t·ª´ VIN sang M√£ DMS t·ª´ sheet KhoXe
  const stockData = stockSheet.getDataRange().getValues();
  const stockHeaders = SHEET_HEADERS["KhoXe"];
  const vinColStock = stockHeaders.indexOf("VIN");
  const maDmsColStock = stockHeaders.indexOf("M√£ DMS");
  const vinToDmsMap = new Map();
  if (vinColStock > -1 && maDmsColStock > -1) {
    for (let i = 1; i < stockData.length; i++) {
      const vin = String(stockData[i][vinColStock] || "").trim().toUpperCase();
      const dms = String(stockData[i][maDmsColStock] || "").trim().toUpperCase();
      if (vin && dms) {
        vinToDmsMap.set(vin, dms);
      }
    }
  } else {
      logAction("L·ªói C·∫£nh b√°o M√£ DMS", "Sheet KhoXe thi·∫øu c·ªôt 'VIN' ho·∫∑c 'M√£ DMS'.");
      return;
  }

  // B∆∞·ªõc 2: Qu√©t sheet DaGhep ƒë·ªÉ t√¨m c√°c ƒë∆°n h√†ng kh√¥ng kh·ªõp V√Ä ch∆∞a ƒë∆∞·ª£c c·∫£nh b√°o
  const daGhepData = daGhepSheet.getDataRange().getValues();
  const daGhepHeaders = SHEET_HEADERS["DaGhep"];
  const vinColDaghep = daGhepHeaders.indexOf("VIN");
  const soDonHangCol = daGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
  const ketQuaCol = daGhepHeaders.indexOf("K·∫øt qu·∫£");
  const ngayXuatHDCol = daGhepHeaders.indexOf("Ng√†y xu·∫•t h√≥a ƒë∆°n");
  const tvbhCol = daGhepHeaders.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng");
  const tenKhachHangCol = daGhepHeaders.indexOf("T√™n kh√°ch h√†ng");
  const canhBaoSaiDmsCol = daGhepHeaders.indexOf("C·∫£nh b√°o sai DMS"); // L·∫•y ch·ªâ s·ªë c·ªôt m·ªõi

  if (canhBaoSaiDmsCol === -1) {
      logAction("L·ªói C·∫£nh b√°o M√£ DMS", "Sheet DaGhep thi·∫øu c·ªôt 'C·∫£nh b√°o sai DMS'. Vui l√≤ng ch·∫°y l·∫°i h√†m setup ƒë·ªÉ t·∫°o c·ªôt.");
      return;
  }

  const mismatchedOrdersByConsultant = {};
  for (let i = 1; i < daGhepData.length; i++) {
    const row = daGhepData[i];
    const ketQua = String(row[ketQuaCol] || "").trim();
    const ngayXuatHD = row[ngayXuatHDCol];
    const vin = String(row[vinColDaghep] || "").trim().toUpperCase();
    const soDonHang = String(row[soDonHangCol] || "").trim();
    const daGuiCanhBao = String(row[canhBaoSaiDmsCol] || "").trim();

    // ƒêi·ªÅu ki·ªán: ƒê√£ gh√©p, ch∆∞a xu·∫•t h√≥a ƒë∆°n, c√≥ VIN, v√† CH∆ØA t·ª´ng g·ª≠i c·∫£nh b√°o
    if (ketQua === "ƒê√£ gh√©p" && !ngayXuatHD && vin && daGuiCanhBao !== "ƒê√£ g·ª≠i") {
      const expectedDms = vinToDmsMap.get(vin);
      const orderPrefix = soDonHang.substring(0, 6).toUpperCase();

      // N·∫øu c√≥ M√£ DMS v√† n√≥ kh√¥ng kh·ªõp v·ªõi 6 k√Ω t·ª± ƒë·∫ßu c·ªßa SƒêH
      if (expectedDms && expectedDms !== orderPrefix) {
        const consultantName = String(row[tvbhCol] || "Ch∆∞a x√°c ƒë·ªãnh").trim();
        if (!mismatchedOrdersByConsultant[consultantName]) {
          mismatchedOrdersByConsultant[consultantName] = [];
        }

        mismatchedOrdersByConsultant[consultantName].push({
          so_don_hang: soDonHang,
          ten_khach_hang: String(row[tenKhachHangCol] || ""),
          vin: vin,
          ma_dms_xe: expectedDms,
          ma_don_hang_dms: orderPrefix,
          rowIndex: i + 1 // L∆∞u ch·ªâ s·ªë d√≤ng ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
        });
      }
    }
  }

  // B∆∞·ªõc 3: G·ª≠i email cho t·ª´ng nh√¢n vi√™n t∆∞ v·∫•n v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i
  if (Object.keys(mismatchedOrdersByConsultant).length === 0) {
    logAction("Ho√†n t·∫•t C·∫£nh b√°o M√£ DMS", "Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o m·ªõi b·ªã sai M√£ DMS c·∫ßn c·∫£nh b√°o.");
    return;
  }

  for (const consultantName in mismatchedOrdersByConsultant) {
    const orders = mismatchedOrdersByConsultant[consultantName];
    const recipientEmail = getEmailForAdvisor(mailSheet, consultantName);

    if (recipientEmail) {
      const subject = `[C·∫¢NH B√ÅO] Ph√°t hi·ªán sai m√£ DMS tr√™n ${orders.length} ƒë∆°n h√†ng ƒë√£ gh√©p xe`;
      const bodyContent = createDmsMismatchEmailBody(consultantName, orders);
      const fullHtml = createFullHtmlEmail(subject, bodyContent);
      try {
        MailApp.sendEmail({
          to: recipientEmail,
          subject: subject,
          htmlBody: fullHtml
        });
        logAction("G·ª≠i C·∫£nh b√°o M√£ DMS", `ƒê√£ g·ª≠i email th√†nh c√¥ng ƒë·∫øn ${consultantName} (${recipientEmail}) cho ${orders.length} ƒë∆°n h√†ng.`);

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i "ƒê√£ g·ª≠i" sau khi g·ª≠i email th√†nh c√¥ng
        orders.forEach(order => {
            daGhepSheet.getRange(order.rowIndex, canhBaoSaiDmsCol + 1).setValue("ƒê√£ g·ª≠i");
        });
        logAction("C·∫≠p nh·∫≠t tr·∫°ng th√°i C·∫£nh b√°o DMS", `ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i cho ${orders.length} ƒë∆°n h√†ng c·ªßa ${consultantName}.`);

      } catch (e) {
        logAction("L·ªói G·ª≠i C·∫£nh b√°o M√£ DMS", `L·ªói khi g·ª≠i email ƒë·∫øn ${consultantName}: ${e.message}`);
      }
    } else {
      logAction("L·ªói G·ª≠i C·∫£nh b√°o M√£ DMS", `Kh√¥ng t√¨m th·∫•y email cho nh√¢n vi√™n t∆∞ v·∫•n: ${consultantName}.`);
    }
  }
}
function createDmsMismatchEmailBody(recipientName, orders) {
  let ordersHtml = `
    <tr style="background-color: #f0f4f8;">
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left;">STT</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left;">S·ªë ƒê∆°n H√†ng</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left;">T√™n Kh√°ch H√†ng</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: left;">S·ªë VIN</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: center; color: #dc3545; font-weight: bold;">M√£ ƒê∆°n H√†ng (6 k√Ω t·ª±)</th>
      <th style="padding: 10px; border: 1px solid #dfe6f1; text-align: center; color: #28a745; font-weight: bold;">M√£ DMS ƒê√∫ng C·ªßa Xe</th>
    </tr>
  `;

  orders.forEach((order, index) => {
    ordersHtml += `
      <tr>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${index + 1}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${order.so_don_hang}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1;">${order.ten_khach_hang}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1; font-weight: 600;">${order.vin}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1; text-align: center; background-color: #ffe8e8;">${order.ma_don_hang_dms}</td>
        <td style="padding: 10px; border: 1px solid #dfe6f1; text-align: center; background-color: #e2f5e8;">${order.ma_dms_xe}</td>
      </tr>
    `;
  });

  const vinfastBlue = '#00509E';
  return `
    <div class="email-wrapper">
      <table class="email-container" width="100%" border="0" cellspacing="0" cellpadding="0" style="max-width: 800px;">
        <thead>
          <tr>
            <th class="header-cell" style="background-color: ${vinfastBlue}; color: #ffffff; padding: 15px 25px; text-align: left;">
              <h1 class="header-title" style="margin: 0; font-size: 16px; font-weight: 400; text-transform: uppercase; letter-spacing: 0.5px;">Y√™u C·∫ßu X∆∞Ãâ LyÃÅ Tr∆∞∆°ÃÅc Khi G∆∞Ãâi XU√¢ÃÅt HoÃÅa ƒê∆°n</h1>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="content-cell" style="padding: 25px;">
              <p class="paragraph" style="color: #555; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">Xin ch√†o <b>${recipientName}</b>,</p>
              <p class="paragraph" style="color: #555; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
                H·ªá th·ªëng ph√°t hi·ªán c√°c ƒë∆°n h√†ng d∆∞·ªõi ƒë√¢y ƒë√£ ƒë∆∞·ª£c gh√©p xe, nh∆∞ng <b>M√£ DMS cuÃâa xe kh√¥ng kh·ªõp v·ªõi maÃÉ DMS c·ªßa S·ªë ƒë∆°n h√†ng</b> hi·ªán t·∫°i.
                ƒêi·ªÅu n√†y s·∫Ω g√¢y ra l·ªói khi xu·∫•t h√≥a ƒë∆°n.
              </p>
              <p class="paragraph" style="color: #333; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0; font-weight: bold; border-left: 4px solid #ffc107; padding-left: 15px;">
                Y√äU C·∫¶U: Anh/Ch·ªã vui l√≤ng <b style="color: #dc3545;">H·ª¶Y ƒê∆†N H√ÄNG C≈® V√Ä TAÃ£O L·∫†I ƒê∆†N H√ÄNG M·ªöI</b> s·ª≠ d·ª•ng "M√£ DMS ƒê√∫ng C·ªßa Xe" ƒë∆∞·ª£c cung c·∫•p cho s·ªë ƒë∆°n h√†ng m·ªõi.
              </p>
              <table class="details-table" width="100%" border="0" cellspacing="0" cellpadding="0" style="border: 1px solid #dfe6f1; border-radius: 5px; margin-bottom: 20px;">
                ${ordersHtml}
              </table>
            </td>
          </tr>
          <tr>
            <td class="footer-cell" style="background-color: #f1f3f5; padding: 20px; text-align: center; font-size: 12px; color: #888;">
              <p style="margin: 0;">ƒê√¢y l√† email t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng qu·∫£n l√Ω xe. Vui l√≤ng kh√¥ng tr·∫£ l·ªùi.</p>
              <p style="margin-top: 5px;">Tr√¢n tr·ªçng.</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
}
/**
 * Thi·∫øt l·∫≠p trigger t·ª± ƒë·ªông ch·∫°y h√†m sendDmsMismatchWarningEmail m·ªói ng√†y m·ªôt l·∫ßn.
 */
function setupDmsMismatchTrigger() {
  const ui = SpreadsheetApp.getUi();
  const triggers = ScriptApp.getProjectTriggers();

  // X√≥a trigger c≈© ƒë·ªÉ tr√°nh tr√πng l·∫∑p
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === "sendDmsMismatchWarningEmail") {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  try {
    // T·∫°o trigger m·ªõi, ch·∫°y v√†o 8h s√°ng h√†ng ng√†y
    ScriptApp.newTrigger("sendDmsMismatchWarningEmail")
      .timeBased()
      .everyDays(1)
      .atHour(8)
      .create();

    const message = "ƒê√£ thi·∫øt l·∫≠p th√†nh c√¥ng trigger t·ª± ƒë·ªông g·ª≠i c·∫£nh b√°o sai M√£ DMS v√†o 8:00 s√°ng m·ªói ng√†y.";
    showToastOnSheet(message, "Th√†nh C√¥ng");
    logAction("Thi·∫øt l·∫≠p Trigger C·∫£nh b√°o DMS", message);
  } catch (e) {
    const errorMessage = `L·ªói khi thi·∫øt l·∫≠p trigger: ${e.message}`;
    showToastOnSheet(errorMessage, "L·ªói");
    logAction("L·ªói Trigger C·∫£nh b√°o DMS", errorMessage);
  }
}
/**
 * X·ª≠ l√Ω ph√™ duy·ªát ho·∫∑c t·ª´ ch·ªëi y√™u c·∫ßu VinClub.
 */
function handleVcRequestApproval(orderNumber, isApproved, adminUser, reason = "") {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheets = getSheets(ss);
  const { daGhepSheet, yeuCauVcSheet } = sheets;

  const vcData = yeuCauVcSheet.getDataRange().getValues();
  const vcHeaders = vcData[0];
  const vcOrderCol = vcHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
  const vcStatusCol = vcHeaders.indexOf("Tr·∫°ng th√°i x·ª≠ l√Ω");
  const vcGhiChuCol = vcHeaders.indexOf("Ghi ch√∫");
  const vcNguoiYcCol = vcHeaders.indexOf("Ng∆∞·ªùi YC");

  let vcRowIndex = -1;
  let nguoiYc = "";
  for (let i = 1; i < vcData.length; i++) {
      if (String(vcData[i][vcOrderCol]).trim() === orderNumber) {
          vcRowIndex = i + 1;
          nguoiYc = vcData[i][vcNguoiYcCol];
          break;
      }
  }

  if (vcRowIndex === -1) {
    throw new Error(`Kh√¥ng t√¨m th·∫•y Y√™u c·∫ßu VC cho ƒë∆°n h√†ng ${orderNumber}.`);
  }

  const newVcStatus = isApproved ? "ƒê√£ ph√™ duy·ªát" : "T·ª´ ch·ªëi ycvc";
  yeuCauVcSheet.getRange(vcRowIndex, vcStatusCol + 1).setValue(newVcStatus);
  if (!isApproved) {
    yeuCauVcSheet.getRange(vcRowIndex, vcGhiChuCol + 1).setValue(reason);
  }

  const daGhepData = daGhepSheet.getDataRange().getValues();
  const daGhepHeaders = daGhepData[0];
  const daGhepOrderCol = daGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
  const daGhepVcStatusCol = daGhepHeaders.indexOf("Tr·∫°ng th√°i VC");
  const vinCol = daGhepHeaders.indexOf("VIN");

  let daGhepRowIndex = -1;
  let vin = "";
  for (let i = 1; i < daGhepData.length; i++) {
    if (String(daGhepData[i][daGhepOrderCol]).trim() === orderNumber) {
        daGhepRowIndex = i + 1;
        vin = daGhepData[i][vinCol];
        break;
    }
  }
  
  if (daGhepRowIndex > -1) {
    const newDaGhepStatus = isApproved ? "Ch·ªù x√°c th·ª±c vc (tvbh)" : "T·ª´ ch·ªëi ycvc";
    daGhepSheet.getRange(daGhepRowIndex, daGhepVcStatusCol + 1).setValue(newDaGhepStatus);
  }

  const actionLog = isApproved ? "Ph√™ duy·ªát Y√™u c·∫ßu VinClub" : "T·ª´ ch·ªëi Y√™u c·∫ßu VinClub";
  const detailsLog = isApproved ? `Ph√™ duy·ªát b·ªüi ${adminUser}` : `T·ª´ ch·ªëi b·ªüi ${adminUser}. L√Ω do: ${reason}`;
  recordOrderHistory(orderNumber, vin, actionLog, detailsLog);
  
  const notifType = isApproved ? 'success' : 'danger';
  const notifMessage = isApproved 
    ? `Y√™u c·∫ßu VinClub cho ƒêH ${orderNumber} ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát. Vui l√≤ng v√†o web ƒë·ªÉ x√°c nh·∫≠n UNC.`
    : `Y√™u c·∫ßu VinClub cho ƒêH ${orderNumber} ƒë√£ b·ªã t·ª´ ch·ªëi. L√Ω do: ${reason}`;
  addNotification(notifMessage, notifType, 'vc', orderNumber, adminUser, nguoiYc);
  
  return createJsonResponse({ status: "SUCCESS", message: `ƒê√£ ${isApproved ? 'ph√™ duy·ªát' : 't·ª´ ch·ªëi'} y√™u c·∫ßu th√†nh c√¥ng.` });
}

/**
 * X·ª≠ l√Ω khi TVBH x√°c nh·∫≠n ƒë√£ nh·∫≠n UNC cho y√™u c·∫ßu VinClub
 */
function handleConfirmVcUnc(e) {
  const orderNumber = e.parameter.orderNumber;
  const user = e.parameter.updatedBy; // L·∫•y t·ª´ apiService.performAdminAction

  if (!user || !orderNumber) {
    throw new Error("Thi·∫øu th√¥ng tin ƒë·ªÉ x√°c nh·∫≠n UNC.");
  }
  
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const daGhepSheet = ss.getSheetByName(DA_GHEP_SHEET_NAME);
  const data = daGhepSheet.getDataRange().getValues();
  const headers = data[0];
  const soDonHangCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
  const trangThaiVcCol = headers.indexOf("Tr·∫°ng th√°i VC");
  const vinCol = headers.indexOf("VIN");

  for (let i = 1; i < data.length; i++) {
    if (String(data[i][soDonHangCol]).trim() === orderNumber) {
      const currentStatus = String(data[i][trangThaiVcCol] || "").trim();
      if (currentStatus !== "Ch·ªù x√°c th·ª±c vc (tvbh)") {
        throw new Error(`H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá. Tr·∫°ng th√°i hi·ªán t·∫°i l√† '${currentStatus}'.`);
      }
      
      daGhepSheet.getRange(i + 1, trangThaiVcCol + 1).setValue("ƒê√£ c√≥ VC");
      const vin = data[i][vinCol];

      recordOrderHistory(orderNumber, vin, "TVBH X√°c nh·∫≠n UNC VinClub", `X√°c nh·∫≠n b·ªüi: ${user}`);
      addNotification(`${user} ƒë√£ x√°c nh·∫≠n UNC VinClub cho ƒêH ${orderNumber}.`, 'success', 'vc', orderNumber, user, ADMIN_EMAIL);
      sendTelegramNotification(`‚úÖ <b>TVBH ƒê√£ X√°c Nh·∫≠n UNC VinClub</b>\n\nüë§ <b>TVBH:</b> ${user}\nüìÑ <b>SƒêH:</b> <code>${orderNumber}</code>`);
      
      return createJsonResponse({ status: "SUCCESS", message: "X√°c nh·∫≠n th√†nh c√¥ng." });
    }
  }

  throw new Error(`Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} trong sheet DaGhep.`);
}
function showCancelOrderSidebar() {
  const html = HtmlService.createHtmlOutputFromFile('CancelSidebar')
      .setTitle('H·ªßy Gh√©p ƒê∆°n H√†ng');
  SpreadsheetApp.getUi().showSidebar(html);
}
function processCancellationFromDialog(formObject) {
  // Ki·ªÉm tra ƒë·∫ßu v√†o
  if (!formObject || !formObject.orderNumber || !formObject.orderNumber.trim() || !formObject.reason || !formObject.reason.trim()) {
    throw new Error("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß S·ªë ƒë∆°n h√†ng v√† L√Ω do h·ªßy.");
  }
  
  const userEmail = Session.getActiveUser().getEmail() || "Manual User";
  
  // L·∫•y c√°c sheet c·∫ßn thi·∫øt
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const daGhepSheet = getOrCreateSheet(ss, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"]);
  const chuaGhepSheet = getOrCreateSheet(ss, CHUA_GHEP_SHEET_NAME, SHEET_HEADERS["ChuaGhep"]);
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const cancelledSheet = getOrCreateSheet(ss, CANCELLED_SHEET_NAME, SHEET_HEADERS["HuyGhep"]);
  const mailSheet = getOrCreateSheet(ss, MAIL_SHEET_NAME, SHEET_HEADERS["Mail"]);

  // T·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng s·ª± ki·ªán gi·∫£ l·∫≠p ƒë·ªÉ truy·ªÅn d·ªØ li·ªáu
  const e_simulated = {
    parameter: {
      action: 'cancelRequest',
      orderNumber: formObject.orderNumber.trim(),
      cancelledBy: userEmail,
      fromUI: 'true',
      reason: formObject.reason.trim() // ƒê·∫£m b·∫£o 'reason' ƒë∆∞·ª£c ƒë∆∞a v√†o ƒë√¢y
    }
  };
  
  // G·ªçi h√†m x·ª≠ l√Ω ch√≠nh v·ªõi LockService ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n d·ªØ li·ªáu
  const resultJson = doReadWriteLock(() => handleCancelRequest(e_simulated, daGhepSheet, chuaGhepSheet, stockSheet, cancelledSheet, mailSheet));
  
  // Ph√¢n t√≠ch k·∫øt qu·∫£ v√† hi·ªÉn th·ªã th√¥ng b√°o
  const result = JSON.parse(resultJson.getContent());
  SpreadsheetApp.getActiveSpreadsheet().toast(result.message, 'Th√¥ng B√°o', 7);

  return result.message; // Tr·∫£ v·ªÅ k·∫øt qu·∫£ cho client-side
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG H√ÄM N√ÄY]
function handleRequestInvoice(e, daGhepSheet, mailSheet, xuathoadonSheet, thongtinxeSheet, stockSheet) {
    Logger.log("--- B·∫ÆT ƒê·∫¶U handleRequestInvoice (PHI√äN B·∫¢N C√ì CH√çNH S√ÅCH & VPOINT - C·∫¨P NH·∫¨T M·ªöI) ---");
    try {
        const orderNumber = e.parameter.orderNumber;
        const requestedBy = e.parameter.requestedBy || "Kh√¥ng x√°c ƒë·ªãnh";
        const hopDongBase64String = e.parameter.hop_dong_file_base64;
        const hopDongName = e.parameter.hop_dong_file_name;
        const deNghiBase64String = e.parameter.denghi_xhd_file_base64;
        const deNghiName = e.parameter.denghi_xhd_file_name;
        const requestDate = new Date();

        // --- THAY ƒê·ªîI B·∫ÆT ƒê·∫¶U: L·∫•y d·ªØ li·ªáu ch√≠nh s√°ch, hoa h·ªìng v√† vpoint t·ª´ web app ---
        const policyContent = e.parameter.policy || ""; // N·ªôi dung ch√≠nh s√°ch tr·ª±c ti·∫øp
        const commissionAmount = e.parameter.commission || ""; // Hoa h·ªìng ·ª©ng
        const vpointAmount = e.parameter.vpoint || ""; // ƒêi·ªÉm Vpoint
        // --- THAY ƒê·ªîI K·∫æT TH√öC ---

        if (!hopDongBase64String || !deNghiBase64String) {
            return createJsonResponse({ status: "ERROR", message: "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung file H·ª£p ƒë·ªìng ho·∫∑c ƒê·ªÅ ngh·ªã XHƒê." });
        }
        if (!orderNumber) {
            return createJsonResponse({ status: "ERROR", message: "S·ªë ƒë∆°n h√†ng kh√¥ng ƒë∆∞·ª£c cung c·∫•p." });
        }
        const hopDongBlob = Utilities.newBlob(Utilities.base64Decode(hopDongBase64String.split(',')[1]), MimeType.PDF, hopDongName);
        const deNghiBlob = Utilities.newBlob(Utilities.base64Decode(deNghiBase64String.split(',')[1]), MimeType.PDF, deNghiName);
        
        const daghepData = daGhepSheet.getDataRange().getValues();
        const daghepHeaders = SHEET_HEADERS["DaGhep"];
        const soDonHangColDaghep = daghepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
        const vinColDaghep = daghepHeaders.indexOf("VIN");
        const ketQuaColDaghep = daghepHeaders.indexOf("K·∫øt qu·∫£");
        let invoiceDataFromDaghep = null;
        let vin = null;
        let daghepRowIndex = -1;
        
        for (let i = 1; i < daghepData.length; i++) {
            if (String(daghepData[i][soDonHangColDaghep] || "").trim() === orderNumber) {
                invoiceDataFromDaghep = {};
                daghepHeaders.forEach((header, index) => { invoiceDataFromDaghep[header] = daghepData[i][index]; });
                vin = String(daghepData[i][vinColDaghep] || "").trim();
                daghepRowIndex = i + 1;
                break;
            }
        }
        if (!invoiceDataFromDaghep || !vin) {
            return createJsonResponse({ status: "ERROR", message: `Kh√¥ng t√¨m th·∫•y s·ªë ƒë∆°n h√†ng '${orderNumber}' ho·∫∑c ƒë∆°n h√†ng ch∆∞a ƒë∆∞·ª£c gh√©p VIN.` });
        }
        const currentStatus = String(invoiceDataFromDaghep["K·∫øt qu·∫£"]).trim().normalize('NFC');
        if (currentStatus !== "ƒê√£ gh√©p") {
            return createJsonResponse({ status: "ERROR", message: `Ch·ªâ c√≥ th·ªÉ y√™u c·∫ßu xu·∫•t h√≥a ƒë∆°n cho ƒë∆°n h√†ng c√≥ tr·∫°ng th√°i 'ƒê√£ gh√©p'. Tr·∫°ng th√°i hi·ªán t·∫°i: '${invoiceDataFromDaghep["K·∫øt qu·∫£"]}'.` });
        }
        
        const xuathoadonData = xuathoadonSheet.getDataRange().getValues();
        const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];
        const soDonHangColXHD = xuathoadonHeaders.indexOf("S·ªê ƒê∆†N H√ÄNG");
        const vinColXHD = xuathoadonHeaders.indexOf("S·ªê VIN");
        
        for (let i = 1; i < xuathoadonData.length; i++) {
            const existingOrder = String(xuathoadonData[i][soDonHangColXHD] || "").trim();
            const existingVin = String(xuathoadonData[i][vinColXHD] || "").trim();
            if (existingOrder === orderNumber || (vin && existingVin === vin)) {
                return createJsonResponse({ status: "ERROR", message: `ƒê∆°n h√†ng '${orderNumber}' ho·∫∑c VIN '${vin}' ƒë√£ t·ªìn t·∫°i trong danh s√°ch ch·ªù xu·∫•t h√≥a ƒë∆°n.` });
            }
        }
        if (daghepRowIndex !== -1) {
            daGhepSheet.getRange(daghepRowIndex, ketQuaColDaghep + 1).setValue("Ch·ªù ph√™ duy·ªát");
        }
        const soDongCo = getEngineNumberForVin(thongtinxeSheet, vin);
        const customerName = invoiceDataFromDaghep["T√™n kh√°ch h√†ng"] || "KHONG_RO";
        
        const hopDongResult = saveFileToDrive(hopDongBlob, orderNumber, 'HDMB', customerName, requestDate);
        const deNghiResult = saveFileToDrive(deNghiBlob, orderNumber, 'DNXHD', customerName, requestDate);
        
        const newXuathoadonRow = xuathoadonHeaders.map(header => {
            switch (header) {
                case "S·ªê TT": return "";
                case "T√äN KH√ÅCH H√ÄNG": return invoiceDataFromDaghep["T√™n kh√°ch h√†ng"];
                case "S·ªê ƒê∆†N H√ÄNG": return orderNumber;
                case "D√íNG XE": return invoiceDataFromDaghep["D√≤ng xe"];
                case "PHI√äN B·∫¢N": return invoiceDataFromDaghep["Phi√™n b·∫£n"];
                case "NGO·∫†I TH·∫§T": return invoiceDataFromDaghep["Ngo·∫°i th·∫•t"];
                case "N·ªòI TH·∫§T": return invoiceDataFromDaghep["N·ªôi th·∫•t"];
                case "T∆Ø V·∫§N B√ÅN H√ÄNG": return invoiceDataFromDaghep["T√™n t∆∞ v·∫•n b√°n h√†ng"];
                case "S·ªê VIN": return vin;
                case "S·ªê ƒê·ªòNG C∆†": return soDongCo;
                case "NG√ÄY C·ªåC": return invoiceDataFromDaghep["Ng√†y c·ªçc"];
                case "NG√ÄY Y√äU C·∫¶U XHƒê": return requestDate;
                case "K·∫æT QU·∫¢ G·ª¨I MAIL": return "";
                
                // --- MAPPING 3 TR∆Ø·ªúNG M·ªöI/C·∫¨P NH·∫¨T ---
                case "Hoa h·ªìng ·ª©ng": return commissionAmount;
                case "ƒêi·ªÉm Vpoint s·ª≠ d·ª•ng": return vpointAmount;
                case "CH√çNH S√ÅCH": return policyContent;
                // -------------------------------------

                default: return "";
            }
        });

        let rowToInsert = -1;
        for (let i = 1; i < xuathoadonData.length; i++) { 
            if (!xuathoadonData[i][soDonHangColXHD] || String(xuathoadonData[i][soDonHangColXHD]).trim() === "") {
                rowToInsert = i + 1;
                break;
            }
        }
        if (rowToInsert === -1) {
            rowToInsert = xuathoadonSheet.getLastRow() + 1;
        }
        
        Logger.log(`S·∫Ω ch√®n d·ªØ li·ªáu y√™u c·∫ßu h√≥a ƒë∆°n v√†o h√†ng: ${rowToInsert}`);
        xuathoadonSheet.getRange(rowToInsert, 1, 1, newXuathoadonRow.length).setValues([newXuathoadonRow]);
        
        const urlHopDongCol = xuathoadonHeaders.indexOf("URL H·ª£p ƒê·ªìng") + 1;
        const urlDeNghiCol = xuathoadonHeaders.indexOf("URL ƒê·ªÅ Ngh·ªã XHƒê") + 1;
        
        if (urlHopDongCol > 0 && hopDongResult && hopDongResult.formula) {
            xuathoadonSheet.getRange(rowToInsert, urlHopDongCol).setFormula(hopDongResult.formula);
        }
        if (urlDeNghiCol > 0 && deNghiResult && deNghiResult.formula) {
            xuathoadonSheet.getRange(rowToInsert, urlDeNghiCol).setFormula(deNghiResult.formula);
        }
        
        updateSerialNumbers(xuathoadonSheet);
        
        const emailData = {
            ten_ban_hang: invoiceDataFromDaghep["T√™n t∆∞ v·∫•n b√°n h√†ng"],
            so_don_hang: orderNumber,
            ten_khach_hang: customerName,
            vin: vin,
        };
        sendInvoiceRequestConfirmationEmailToTVBH(mailSheet, emailData);
        recordOrderHistory(orderNumber, vin, "Y√™u c·∫ßu xu·∫•t h√≥a ƒë∆°n", `ƒê∆°n h√†ng ƒë∆∞·ª£c chuy·ªÉn sang danh s√°ch ch·ªù b·ªüi ${requestedBy}`);
        logAction("Y√™u c·∫ßu xu·∫•t h√≥a ƒë∆°n", `ƒê√£ chuy·ªÉn ƒë∆°n h√†ng ${orderNumber} (VIN: ${vin}) v√†o sheet Xuathoadon.`);
        
        const tvbhNotificationMessage = `Y√™u c·∫ßu XHƒê c·ªßa b·∫°n cho ƒêH ${orderNumber} ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng.`;
        addNotification(tvbhNotificationMessage, 'success', 'xuatHoaDon', orderNumber, requestedBy, requestedBy);

        const adminNotificationMessage = `${requestedBy} ƒë√£ g·ª≠i y√™u c·∫ßu XHƒê cho ƒêH ${orderNumber}.`;
        addNotification(adminNotificationMessage, 'info', 'xuatHoaDon', orderNumber, requestedBy, ADMIN_EMAIL);
        
        const telegramMessage = `üìÑ <b>Y√™u C·∫ßu Xu·∫•t H√≥a ƒê∆°n M·ªõi</b>\n\n` +
                                `üë§ <b>TVBH:</b> ${requestedBy}\n` +
                                `üë® <b>Kh√°ch h√†ng:</b> ${customerName}\n` +
                                `üöó <b>Xe:</b> ${invoiceDataFromDaghep["D√≤ng xe"]} ${invoiceDataFromDaghep["Phi√™n b·∫£n"]}\n` +
                                `üé® <b>M√†u s·∫Øc:</b> ${invoiceDataFromDaghep["Ngo·∫°i th·∫•t"]} / ${invoiceDataFromDaghep["N·ªôi th·∫•t"]}\n` +
                                `üìÑ <b>SƒêH:</b> <code>${orderNumber}</code>\n` +
                                `üî¢ <b>VIN:</b> <code>${vin}</code>\n\n` +
                                `<b>Tr·∫°ng th√°i:</b> Ch·ªù ph√™ duy·ªát`;
        const keyboard = [[
            { text: "‚úÖ Ph√™ Duy·ªát", callback_data: `approve:${orderNumber}` },
            { text: "‚ö†Ô∏è Y/C B·ªï Sung", callback_data: `req_supp:${orderNumber}` },
        ]];
        sendTelegramMessage(telegramMessage, keyboard);

        if (hopDongResult && hopDongResult.finalName) {
            hopDongBlob.setName(hopDongResult.finalName);
            sendTelegramDocument(hopDongBlob, `<i>File H·ª£p ƒë·ªìng cho SƒêH: ${orderNumber}</i>`);
        }
        if (deNghiResult && deNghiResult.finalName) {
            deNghiBlob.setName(deNghiResult.finalName);
            sendTelegramDocument(deNghiBlob, `<i>File ƒê·ªÅ ngh·ªã XHƒê cho SƒêH: ${orderNumber}</i>`);
        }
        
        return createJsonResponse({ status: "SUCCESS", message: `ƒê√£ chuy·ªÉn ƒë∆°n h√†ng ${orderNumber} v√†o danh s√°ch ch·ªù xu·∫•t h√≥a ƒë∆°n.` });
    } catch (err) {
        Logger.log("L·ªói nghi√™m tr·ªçng trong handleRequestInvoice (Base64): " + err.toString());
        return createJsonResponse({ status: "ERROR", message: "L·ªói m√°y ch·ªß khi x·ª≠ l√Ω: " + err.message });
    }
}
function sendInvoiceRequestConfirmationEmailToTVBH(mailSheet, data) {
  const tenTVBH = data.ten_ban_hang;
  const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);
  if (!recipientEmail) {
    logAction("L·ªói g·ª≠i mail x√°c nh·∫≠n Y/C XHƒê", `Kh√¥ng t√¨m th·∫•y email cho TVBH '${tenTVBH}', ƒë∆°n ${data.so_don_hang}`);
    return false;
  }
  const subject = `[X√ÅC NH·∫¨N] Y√™u c·∫ßu xu·∫•t h√≥a ƒë∆°n cho ƒêH ${data.so_don_hang} ƒë√£ ƒë∆∞·ª£c g·ª≠i`;
  const details = {
    "S·ªë ƒë∆°n h√†ng": `<b>${data.so_don_hang}</b>`,
    "T√™n kh√°ch h√†ng": data.ten_khach_hang,
    "S·ªë VIN": `<b>${data.vin}</b>`,
    "Tr·∫°ng th√°i m·ªõi": "<b>Ch·ªù xu·∫•t h√≥a ƒë∆°n</b>"
  };
  const note = "Y√™u c·∫ßu c·ªßa baÃ£n ƒë√£ ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn b·ªô ph·∫≠n li√™n quan ƒë·ªÉ x·ª≠ l√Ω. H·ªá th·ªëng s·∫Ω c√≥ th√¥ng b√°o ti·∫øp theo khi h√≥a ƒë∆°n ƒë∆∞·ª£c ch√≠nh th·ª©c ph√°t h√†nh. Xin c·∫£m ∆°n!";
  const bodyContent = createUnifiedEmailBody("Y√™u c·∫ßu xu·∫•t h√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!", tenTVBH, details, note, 'info');
  const fullHtml = createFullHtmlEmail(subject, bodyContent);
  try {
    MailApp.sendEmail({ to: recipientEmail, subject: subject, htmlBody: fullHtml });
    logAction("G·ª≠i mail x√°c nh·∫≠n Y/C XHƒê th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho ƒë∆°n ${data.so_don_hang}`);
    return true;
  } catch (e) {
    logAction("L·ªói g·ª≠i mail x√°c nh·∫≠n Y/C XHƒê", `Email: ${recipientEmail}, ƒê∆°n: ${data.so_don_hang}, L·ªói: ${e.message}`);
    return false;
  }
}
function onEditXuathoadon(e) {
  const range = e.range;
  const sheet = range.getSheet();

  // Ch·ªâ ch·∫°y n·∫øu ch·ªânh s·ª≠a di·ªÖn ra tr√™n sheet "Xuathoadon"
  if (sheet.getName() !== XUAT_HOA_DON_SHEET_NAME) {
    return;
  }

  const row = range.getRow();
  const col = range.getColumn();
  const headers = SHEET_HEADERS["Xuathoadon"];
  const vinColIndex = headers.indexOf("S·ªê VIN") + 1;

  // Ch·ªâ ch·∫°y khi ch·ªânh s·ª≠a ·ªü c·ªôt "S·ªê VIN", kh√¥ng ph·∫£i header, v√† c√≥ gi√° tr·ªã m·ªõi
  if (col === vinColIndex && row > 1 && e.value) {
    const vin = String(e.value).trim();
    // Kh√≥a ti·∫øn tr√¨nh ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n d·ªØ li·ªáu
    doReadWriteLock(() => {
      fillXuathoadonFromDaghepAndThongtinxe(e, row, vin);
    });
  }
}

function setupOnEditXuathoadonTrigger() {
  const ss = SpreadsheetApp.getActive();
  // X√≥a c√°c trigger c≈© cho h√†m n√†y ƒë·ªÉ tr√°nh tr√πng l·∫∑p
  ScriptApp.getProjectTriggers().forEach(trigger => {
    if (trigger.getHandlerFunction() === 'onEditXuathoadon') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // T·∫°o trigger m·ªõi
  ScriptApp.newTrigger('onEditXuathoadon')
    .forSpreadsheet(ss)
    .onEdit()
    .create();

  SpreadsheetApp.getUi().alert('ƒê√£ thi·∫øt l·∫≠p th√†nh c√¥ng trigger t·ª± ƒë·ªông ƒëi·ªÅn d·ªØ li·ªáu cho sheet Xuathoadon.');
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG H√ÄM N√ÄY]
function saveFileToDrive(fileObject, orderNumber, fileType, customerName, referenceDate = null) {
  if (!fileObject || !customerName || !fileType) {
    logAction("L·ªói L∆∞u File Drive", "Thi·∫øu th√¥ng tin file, t√™n kh√°ch h√†ng ho·∫∑c lo·∫°i file.");
    return null;
  }
  try {
    const dateToUse = (referenceDate && referenceDate instanceof Date && !isNaN(referenceDate)) ?
    referenceDate : new Date();
    const monthFolder_Name = Utilities.formatDate(dateToUse, "GMT+7", "yyyy-MM");
    const dayFolder_Name = Utilities.formatDate(dateToUse, "GMT+7", "yyyy-MM-dd");
    const rootFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const monthFolder = getOrCreateSubFolder(rootFolder, monthFolder_Name);
    const dayFolder = getOrCreateSubFolder(monthFolder, dayFolder_Name);
    
    const sanitizedCustomerNameForFolder = customerName.replace(/[\/\\?%*:|"<>"]/g, '').replace(/[\u0000-\u001F\u007F-\u009F]/g, '').trim().replace(/\s+/g, ' ');
    const customerFolder = getOrCreateSubFolder(dayFolder, sanitizedCustomerNameForFolder);
    
    const originalFileName = fileObject.getName();
    const extension = originalFileName.includes('.') ? originalFileName.substring(originalFileName.lastIndexOf('.')) : '';

    let fileName;
    if (fileType === 'HDMB') {
      fileName = `HƒêMB ${sanitizedCustomerNameForFolder}${extension}`;
    } else if (fileType === 'DNXHD') {
      fileName = `ƒêNXHƒê ${sanitizedCustomerNameForFolder}${extension}`;
    } else if (fileType === 'HOADON') {
      fileName = `H√≥a ƒë∆°n ${sanitizedCustomerNameForFolder}${extension}`;
    } else {
      const timestamp = Utilities.formatDate(new Date(), "GMT+7", "yyyyMMdd_HHmmss");
      fileName = `${orderNumber}_${fileType}_${timestamp}${extension}`;
    }

    const file = customerFolder.createFile(fileObject).setName(fileName);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    const fileId = file.getId();
    const viewUrl = 'https://drive.google.com/file/d/' + fileId + '/view?usp=sharing';
    logAction("L∆∞u File Drive th√†nh c√¥ng", `ƒê√£ l∆∞u file: ${fileName} v·ªõi URL: ${viewUrl}`);
    
    const formulaFileName = fileName.replace(/"/g, '""');
    return {
      formula: `=HYPERLINK("${viewUrl}"; "${formulaFileName}")`,
      finalName: fileName 
    };
  } catch (error) {
    logAction("L·ªói nghi√™m tr·ªçng khi l∆∞u File Drive", error.toString());
    Logger.log(error);
    return null;
  }
}
function getOrCreateSubFolder(parentFolder, childFolderName) {
  const folders = parentFolder.getFoldersByName(childFolderName);
  if (folders.hasNext()) {
    return folders.next();
  } else {
    return parentFolder.createFolder(childFolderName);
  }
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG H√ÄM N√ÄY]
function handleUpdateInvoiceFiles(e) {
    const orderNumber = e.parameter.orderNumber;
    Logger.log(`B·∫Øt ƒë·∫ßu handleUpdateInvoiceFiles cho ƒë∆°n h√†ng: ${orderNumber}`);
    try {
        const updatedBy = e.parameter.updatedBy || "Kh√¥ng x√°c ƒë·ªãnh";
        if (!orderNumber) {
            throw new Error("L·ªói nghi√™m tr·ªçng: S·ªë ƒë∆°n h√†ng kh√¥ng ƒë∆∞·ª£c cung c·∫•p.");
        }
        Logger.log(`Y√™u c·∫ßu b·ªüi: ${updatedBy}`);
        const hopDongBase64String = e.parameter.hop_dong_file_base64;
        const hopDongName = e.parameter.hop_dong_file_name;
        const deNghiBase64String = e.parameter.denghi_xhd_file_base64;
        const deNghiName = e.parameter.denghi_xhd_file_name;
        if (!hopDongBase64String && !deNghiBase64String) {
            throw new Error("Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c cung c·∫•p ƒë·ªÉ c·∫≠p nh·∫≠t.");
        }
        Logger.log(`File HƒêMB ƒë∆∞·ª£c cung c·∫•p: ${!!hopDongName}, File ƒêNXHƒê ƒë∆∞·ª£c cung c·∫•p: ${!!deNghiName}`);
        const ss = SpreadsheetApp.getActiveSpreadsheet();
        const xuathoadonSheet = getOrCreateSheet(ss, XUAT_HOA_DON_SHEET_NAME, SHEET_HEADERS["Xuathoadon"]);
        const data = xuathoadonSheet.getDataRange().getValues();
        const headers = data[0];
        const soDonHangCol = headers.indexOf("S·ªê ƒê∆†N H√ÄNG");
        const urlHdCol = headers.indexOf("URL H·ª£p ƒê·ªìng");
        const urlDnxhdCol = headers.indexOf("URL ƒê·ªÅ Ngh·ªã XHƒê");
        const customerNameCol = headers.indexOf("T√äN KH√ÅCH H√ÄNG");
        const vinCol = headers.indexOf("S·ªê VIN");
        const requestDateCol = headers.indexOf("NG√ÄY Y√äU C·∫¶U XHƒê");

        // ===== B·∫ÆT ƒê·∫¶U THAY ƒê·ªîI 1: L·∫•y th√™m th√¥ng tin m√†u s·∫Øc t·ª´ sheet Xuathoadon =====
        const ngoaiThatCol = headers.indexOf("NGO·∫†I TH·∫§T");
        const noiThatCol = headers.indexOf("N·ªòI TH·∫§T");
        // ===== K·∫æT TH√öC THAY ƒê·ªîI 1 =====

        if ([soDonHangCol, urlHdCol, urlDnxhdCol, customerNameCol, vinCol, requestDateCol].some(col => col === -1)) { 
            throw new Error("M·ªôt ho·∫∑c nhi·ªÅu c·ªôt c·∫ßn thi·∫øt ('S·ªê ƒê∆†N H√ÄNG', 'URL H·ª£p ƒê·ªìng', 'URL ƒê·ªÅ Ngh·ªã XHƒê', 'T√äN KH√ÅCH H√ÄNG', 'S·ªê VIN', 'NG√ÄY Y√äU C·∫¶U XHƒê') kh√¥ng t·ªìn t·∫°i trong sheet Xuathoadon.");
        }
        let rowIndex = -1;
        for (let i = 1; i < data.length; i++) {
            if (String(data[i][soDonHangCol]).trim() === orderNumber) {
                rowIndex = i + 1;
                break;
            }
        }
        if (rowIndex === -1) {
            throw new Error(`Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng '${orderNumber}' trong danh s√°ch xu·∫•t h√≥a ƒë∆°n.`);
        }
        Logger.log(`T√¨m th·∫•y ƒë∆°n h√†ng '${orderNumber}' t·∫°i d√≤ng ${rowIndex}`);
        const rowData = data[rowIndex - 1];
        const customerName = rowData[customerNameCol] || "KHONG_RO";
        const vin = rowData[vinCol] || "";
        const originalRequestDate = rowData[requestDateCol] ? new Date(rowData[requestDateCol]) : null;

        let filesUpdatedLog = [];
        
        // ===== B·∫ÆT ƒê·∫¶U THAY ƒê·ªîI 2: X√¢y d·ª±ng caption v·ªõi th√¥ng tin m√†u s·∫Øc =====
        const captionBaseTelegram = `üì§ <b>TVBH ƒê√£ B·ªï Sung H·ªì S∆°</b>\n\n` +
                                    `üë§ <b>Ng∆∞·ªùi TH:</b> ${updatedBy}\n` +
                                    `üë® <b>Kh√°ch h√†ng:</b> ${customerName}\n` +
                                    `üé® <b>M√†u s·∫Øc:</b> ${rowData[ngoaiThatCol]} / ${rowData[noiThatCol]}\n` +
                                    `üìÑ <b>SƒêH:</b> <code>${orderNumber}</code>\n` +
                                    `üî¢ <b>VIN:</b> <code>${vin}</code>\n\n`;
        // ===== K·∫æT TH√öC THAY ƒê·ªîI 2 =====

        if (hopDongBase64String && hopDongName) {
            Logger.log("ƒêang x·ª≠ l√Ω H·ª£p ƒë·ªìng mua b√°n...");
            const oldHdFormula = xuathoadonSheet.getRange(rowIndex, urlHdCol + 1).getFormula();
            deleteDriveFileFromFormula(oldHdFormula, orderNumber, "HƒêMB c≈©");
            const hopDongBlob = Utilities.newBlob(Utilities.base64Decode(hopDongBase64String.split(',')[1]), MimeType.PDF, hopDongName);
            const newHdResult = saveFileToDrive(hopDongBlob, orderNumber, 'HDMB', customerName, originalRequestDate);

            if (newHdResult && newHdResult.formula) {
                xuathoadonSheet.getRange(rowIndex, urlHdCol + 1).setFormula(newHdResult.formula);
                filesUpdatedLog.push("H·ª£p ƒë·ªìng mua b√°n");
                hopDongBlob.setName(newHdResult.finalName);
                sendTelegramDocument(hopDongBlob, captionBaseTelegram + `<i>File: H·ª£p ƒê·ªìng Mua B√°n (M·ªõi)</i>`);
                Logger.log("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng file H·ª£p ƒë·ªìng mua b√°n.");
            } else {
                throw new Error("L·ªói khi l∆∞u file H·ª£p ƒë·ªìng mua b√°n m·ªõi l√™n Drive.");
            }
        }
        if (deNghiBase64String && deNghiName) {
            Logger.log("ƒêang x·ª≠ l√Ω ƒê·ªÅ ngh·ªã XHƒê...");
            const oldDnxhdFormula = xuathoadonSheet.getRange(rowIndex, urlDnxhdCol + 1).getFormula();
            deleteDriveFileFromFormula(oldDnxhdFormula, orderNumber, "ƒêNXHƒê c≈©");
            const deNghiBlob = Utilities.newBlob(Utilities.base64Decode(deNghiBase64String.split(',')[1]), MimeType.PDF, deNghiName);
            const newDnxhdResult = saveFileToDrive(deNghiBlob, orderNumber, 'DNXHD', customerName, originalRequestDate);

            if (newDnxhdResult && newDnxhdResult.formula) {
                xuathoadonSheet.getRange(rowIndex, urlDnxhdCol + 1).setFormula(newDnxhdResult.formula);
                filesUpdatedLog.push("ƒê·ªÅ ngh·ªã XHƒê");
                deNghiBlob.setName(newDnxhdResult.finalName);
                sendTelegramDocument(deNghiBlob, captionBaseTelegram + `<i>File: ƒê·ªÅ Ngh·ªã Xu·∫•t H√≥a ƒê∆°n (M·ªõi)</i>`);
                Logger.log("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng file ƒê·ªÅ ngh·ªã XHƒê.");
            } else {
                 throw new Error("L·ªói khi l∆∞u file ƒê·ªÅ ngh·ªã XHƒê m·ªõi l√™n Drive.");
            }
        }
        
        const details = `Ng∆∞·ªùi d√πng ${updatedBy} ƒë√£ c·∫≠p nh·∫≠t c√°c file: ${filesUpdatedLog.join(', ')}.`;
        recordOrderHistory(orderNumber, vin, "C·∫≠p nh·∫≠t file XHƒê", details);
        logAction("C·∫≠p nh·∫≠t file XHƒê", `ƒê∆°n h√†ng ${orderNumber}: ${details}`);
        const daGhepSheet = getOrCreateSheet(ss, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"]);
        const daGhepData = daGhepSheet.getDataRange().getValues();
        const daGhepHeaders = daGhepData[0];
        const soDonHangColDaghep = daGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
        const ketQuaColDaghep = daGhepHeaders.indexOf("K·∫øt qu·∫£");
        for (let i = 1; i < daGhepData.length; i++) {
            if (String(daGhepData[i][soDonHangColDaghep]).trim() === orderNumber) {
                if(String(daGhepData[i][ketQuaColDaghep]).trim() === "Y√™u c·∫ßu b·ªï sung") {
                    daGhepSheet.getRange(i + 1, ketQuaColDaghep + 1).setValue("ƒê√£ b·ªï sung");
                    logAction("C·∫≠p nh·∫≠t tr·∫°ng th√°i (sau khi b·ªï sung)", `ƒê∆°n h√†ng ${orderNumber} ƒë√£ ƒë∆∞·ª£c chuy·ªÉn v·ªÅ 'ƒê√£ b·ªï sung'.`);
                }
                break;
            }
        }
        Logger.log(`Ho√†n t·∫•t handleUpdateInvoiceFiles cho ƒë∆°n h√†ng: ${orderNumber}.`);
        return createJsonResponse({ status: "SUCCESS", message: `ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng: ${filesUpdatedLog.join(' v√† ')}.` });
    } catch (err) {
        Logger.log(`L·ªói nghi√™m tr·ªçng trong handleUpdateInvoiceFiles cho ƒë∆°n ${orderNumber || 'N/A'}: ${err.message}. Stack: ${err.stack}`);
        logAction("L·ªói nghi√™m tr·ªçng khi c·∫≠p nh·∫≠t file", `ƒê∆°n h√†ng ${orderNumber || 'N/A'}: ${err.toString()}`);
        return createJsonResponse({ status: "ERROR", message: "L·ªói ph√≠a m√°y ch·ªß: " + err.message });
    }
}
function handleConfirmVinClubVerification(e) {
  const orderNumber = e.parameter.orderNumber;
  const user = e.parameter.updatedBy;

  if (!user) {
    return createJsonResponse({ status: "ERROR", message: "Kh√¥ng th·ªÉ x√°c ƒë·ªãnh ng∆∞·ªùi d√πng th·ª±c hi·ªán." });
  }

  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheets = getSheets(ss);
    const { daGhepSheet, nhatKyChinhSuaSheet } = sheets;
    const actionId = `confirm-vinclub-${new Date().getTime()}`;

    const daGhepData = daGhepSheet.getDataRange().getValues();
    const headers = daGhepData[0];
    const soDonHangCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
    const ketQuaCol = headers.indexOf("K·∫øt qu·∫£");
    const vinCol = headers.indexOf("VIN");
    const tvbhCol = headers.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng");
    const ngoaiThatCol = headers.indexOf("Ngo·∫°i th·∫•t");
    const noiThatCol = headers.indexOf("N·ªôi th·∫•t");

    for (let i = 1; i < daGhepData.length; i++) {
      if (String(daGhepData[i][soDonHangCol]).trim() === orderNumber) {
        const currentStatus = String(daGhepData[i][ketQuaCol]).trim();
        const assignedTvbh = String(daGhepData[i][tvbhCol]).trim();

        if (currentStatus === "Y√™u c·∫ßu VinClub" && user === assignedTvbh) {
          updateCellAndLog(daGhepSheet, i + 1, ketQuaCol + 1, "ƒê√£ b·ªï sung", user, actionId, nhatKyChinhSuaSheet);
          
          const vin = daGhepData[i][vinCol];
          const adminMessage = `${user} ƒë√£ x√°c nh·∫≠n ho√†n t·∫•t VinClub cho ƒêH ${orderNumber}.`;
          addNotification(adminMessage, 'success', 'xuatHoaDon', orderNumber, user, ADMIN_EMAIL);

          const mauSac = `${daGhepData[i][ngoaiThatCol]} / ${daGhepData[i][noiThatCol]}`;
          const telegramMessageVinClub = `‚úÖ <b>TVBH ƒê√£ X√°c Nh·∫≠n VinClub</b>\n\n` +
                                         `üë§ <b>Ng∆∞·ªùi x√°c nh·∫≠n:</b> ${user}\n` +
                                         `üìÑ <b>S·ªë ƒë∆°n h√†ng:</b> <code>${orderNumber}</code>\n` +
                                         `üé® <b>M√†u s·∫Øc:</b> ${mauSac}\n` +
                                         `üî¢ <b>VIN:</b> <code>${vin}</code>\n\n` +
                                         `<i>ƒê∆°n h√†ng ƒë√£ s·∫µn s√†ng cho c√°c b∆∞·ªõc ti·∫øp theo.</i>`;
          sendTelegramNotification(telegramMessageVinClub);

          recordOrderHistory(orderNumber, vin, "Ho√†n t·∫•t x√°c th·ª±c VinClub", `X√°c nh·∫≠n b·ªüi TVBH: ${user}`);
          return createJsonResponse({ status: "SUCCESS", message: "ƒê√£ x√°c nh·∫≠n ho√†n t·∫•t. C·∫£m ∆°n b·∫°n!" });
        } else if (user !== assignedTvbh) {
          return createJsonResponse({ status: "ERROR", message: "B·∫°n kh√¥ng ƒë∆∞·ª£c ph√¢n c√¥ng cho ƒë∆°n h√†ng n√†y." });
        } else {
          return createJsonResponse({ status: "ERROR", message: `H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá. Tr·∫°ng th√°i hi·ªán t·∫°i l√† '${currentStatus}'.` });
        }
      }
    }
    return createJsonResponse({ status: "ERROR", message: `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber}.` });
  } catch (err) {
      Logger.log(`L·ªói nghi√™m tr·ªçng trong handleConfirmVinClubVerification: ${err.message}. Stack: ${err.stack}`);
      sendErrorAlert('handleConfirmVinClubVerification', err);
      return createJsonResponse({ status: 'ERROR', message: `L·ªói m√°y ch·ªß khi x√°c nh·∫≠n VinClub: ${err.message}` });
  }
}
function deleteDriveFileFromFormula(formulaString, orderNumber, fileTypeForLog) {
    if (!formulaString || !formulaString.toUpperCase().startsWith("=HYPERLINK")) {
        return; // Kh√¥ng c√≥ c√¥ng th·ª©c ho·∫∑c kh√¥ng ph·∫£i HYPERLINK, kh√¥ng c·∫ßn l√†m g√¨
    }

    try {
        const urlMatch = formulaString.match(/=HYPERLINK\("([^"]+)"/i);
        if (urlMatch && urlMatch[1]) {
            const url = urlMatch[1];
            
            // ===== S·ª¨A L·ªñI QUAN TR·ªåNG T·∫†I ƒê√ÇY =====
            // Regex m·ªõi ƒë·ªÉ t√¨m ID file t·ª´ c·∫£ 2 lo·∫°i link: /d/FILE_ID/ ho·∫∑c id=FILE_ID
            const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9_-]{25,})|id=([a-zA-Z0-9_-]{25,})/);

            if (fileIdMatch) {
                // ID c·ªßa file s·∫Ω n·∫±m ·ªü nh√≥m b·∫Øt th·ª© 1 ho·∫∑c th·ª© 2
                const fileId = fileIdMatch[1] || fileIdMatch[2];
                if (fileId) {
                    DriveApp.getFileById(fileId).setTrashed(true); // Chuy·ªÉn v√†o th√πng r√°c
                    logAction("X√≥a file c≈© th√†nh c√¥ng", `ƒê√£ chuy·ªÉn v√†o th√πng r√°c file ${fileTypeForLog} (ID: ${fileId}) c·ªßa ƒë∆°n h√†ng ${orderNumber}`);
                }
            } else {
                 logAction("Kh√¥ng th·ªÉ tr√≠ch xu·∫•t File ID", `Kh√¥ng t√¨m th·∫•y File ID trong URL: ${url}`);
            }
        }
    } catch (err) {
        logAction("L·ªói x√≥a file c≈©", `Kh√¥ng th·ªÉ x√≥a file ${fileTypeForLog} c·ªßa ƒë∆°n h√†ng ${orderNumber}. L·ªói: ${err.message}`);
        // Kh√¥ng d·ª´ng th·ª±c thi n·∫øu kh√¥ng x√≥a ƒë∆∞·ª£c file c≈©, v·∫´n cho ph√©p t·∫£i file m·ªõi l√™n
    }
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM handleUploadIssuedInvoice C≈®]
function handleUploadIssuedInvoice(e) {
  try {
    const orderNumber = e.parameter.orderNumber;
    const uploadedBy = e.parameter.uploadedBy || "Admin";
    const originalFileName = e.parameter.invoiceFileName;
    const base64Data = e.parameter.invoiceFileBase64;
    const mimeType = e.parameter.invoiceMimeType;

    if (!orderNumber || !originalFileName || !base64Data || !mimeType) {
      throw new Error("D·ªØ li·ªáu kh√¥ng ƒë·∫ßy ƒë·ªß ƒë·ªÉ t·∫£i l√™n h√≥a ƒë∆°n.");
    }

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheets = getSheets(ss);
    const { daGhepSheet, mailSheet, xuathoadonSheet } = sheets;

    // --- B∆Ø·ªöC 1: ƒê·ªçc th√¥ng tin c·∫ßn thi·∫øt t·ª´ sheet TR∆Ø·ªöC KHI KH√ìA ---
    const daGhepRowData = findRowByKeyValue(daGhepSheet, "S·ªë ƒë∆°n h√†ng", orderNumber);
    if (!daGhepRowData) {
      throw new Error(`Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng '${orderNumber}' trong sheet DaGhep.`);
    }
    const xuathoadonRowIndex = findRowIndexByKeyValue(xuathoadonSheet, "S·ªê ƒê∆†N H√ÄNG", orderNumber);
    if (xuathoadonRowIndex === -1) {
      throw new Error(`Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng '${orderNumber}' trong sheet Xuathoadon.`);
    }

    const customerName = daGhepRowData["T√™n kh√°ch h√†ng"] || "KHONG_RO";
    const vin = daGhepRowData["VIN"] || "";
    const tvbhName = daGhepRowData["T√™n t∆∞ v·∫•n b√°n h√†ng"];

    // --- B∆Ø·ªöC 2: Th·ª±c hi·ªán c√°c t√°c v·ª• ch·∫≠m (I/O) TR∆Ø·ªöC KHI KH√ìA ---
    const decodedData = Utilities.base64Decode(base64Data);
    const blob = Utilities.newBlob(decodedData, mimeType, originalFileName);
    const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];
    const requestDateColXHD = xuathoadonHeaders.indexOf("NG√ÄY Y√äU C·∫¶U XHƒê");
    const requestDateValue = xuathoadonSheet.getRange(xuathoadonRowIndex, requestDateColXHD + 1).getValue();
    const requestDate = requestDateValue ? new Date(requestDateValue) : null;

    // T·∫£i file l√™n Drive
    const fileFormulaObject = saveFileToDrive(blob, orderNumber, 'HOADON', customerName, requestDate);

    // --- B∆Ø·ªöC 3: KH√ìA B·∫£ng t√≠nh v√† th·ª±c hi·ªán c√°c t√°c v·ª• ghi NHANH ---
    doReadWriteLock(() => {
        const daghepHeaders = daGhepSheet.getRange(1, 1, 1, daGhepSheet.getLastColumn()).getValues()[0];
        const daghepRowIndex = findRowIndexByKeyValue(daGhepSheet, "S·ªë ƒë∆°n h√†ng", orderNumber);

        if (daghepRowIndex > -1) {
            daGhepSheet.getRange(daghepRowIndex, daghepHeaders.indexOf("K·∫øt qu·∫£") + 1).setValue("ƒê√£ xu·∫•t h√≥a ƒë∆°n");
            if (fileFormulaObject && fileFormulaObject.formula) {
                const linkCol = daghepHeaders.indexOf("LinkHoaDonDaXuat");
                if (linkCol > -1) {
                    daGhepSheet.getRange(daghepRowIndex, linkCol + 1).setFormula(fileFormulaObject.formula);
                }
            }
        }
        
        xuathoadonSheet.getRange(xuathoadonRowIndex, xuathoadonHeaders.indexOf("B√ÅO B√ÅN") + 1).check();
        if (fileFormulaObject && fileFormulaObject.formula) {
            const urlFinalInvoiceCol = xuathoadonHeaders.indexOf("URL H√≥a ƒê∆°n ƒê√£ Xu·∫•t");
            if (urlFinalInvoiceCol !== -1) {
                xuathoadonSheet.getRange(xuathoadonRowIndex, urlFinalInvoiceCol + 1).setFormula(fileFormulaObject.formula);
            }
        }
        recordOrderHistory(orderNumber, vin, "T·∫£i l√™n H√≥a ƒë∆°n", `ƒê√£ t·∫£i l√™n v√† ph√°t h√†nh h√≥a ƒë∆°n b·ªüi ${uploadedBy}.`);
    });

    // --- B∆Ø·ªöC 4: G·ª≠i email v√† th√¥ng b√°o SAU KHI ƒë√£ nh·∫£ kh√≥a ---
    const orderDataForEmail = {
        so_don_hang: orderNumber,
        ten_khach_hang: customerName,
        ten_tu_van_ban_hang: tvbhName,
        vin: vin,
        dong_xe: daGhepRowData["D√≤ng xe"],
        phien_ban: daGhepRowData["Phi√™n b·∫£n"],
        ngoai_that: daGhepRowData["Ngo·∫°i th·∫•t"],
        noi_that: daGhepRowData["N·ªôi th·∫•t"]
    };

    sendIssuedInvoiceWithAttachment(mailSheet, orderDataForEmail, blob, xuathoadonSheet, xuathoadonRowIndex);
    addNotification(`H√≥a ƒë∆°n cho ƒêH ${orderNumber} ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n b·ªüi ${uploadedBy}.`, 'success', 'xuatHoaDon', orderNumber, uploadedBy, tvbhName);
    
    return createJsonResponse({ status: 'SUCCESS', message: 'T·∫£i l√™n h√≥a ƒë∆°n v√† g·ª≠i email th√†nh c√¥ng!' });

  } catch (err) {
    Logger.log(`L·ªói nghi√™m tr·ªçng trong handleUploadIssuedInvoice: ${err.message}. Stack: ${err.stack}`);
    sendErrorAlert('handleUploadIssuedInvoice', err);
    runSyncKhoxeStatus();
    return createJsonResponse({ status: 'ERROR', message: `L·ªói ph√≠a m√°y ch·ªß: ${err.message}` });
  }
}

function getEngineNumberForVin(thongtinxeSheet, vin) {
  const thongtinxeData = thongtinxeSheet.getDataRange().getValues();
  const thongtinxeHeaders = SHEET_HEADERS["Thongtinxe"];
  const vinCol = thongtinxeHeaders.indexOf("S·ªë VIN");
  const soDongCoCol = thongtinxeHeaders.indexOf("S·ªë ƒë·ªông c∆°");
  for (let i = 1; i < thongtinxeData.length; i++) {
    if (String(thongtinxeData[i][vinCol] || "").trim() === vin) {
      return String(thongtinxeData[i][soDongCoCol] || "").trim();
    }
  }
  return "";
}
function approveSelectedInvoiceRequest() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();
  if (activeSheet.getName() !== XUAT_HOA_DON_SHEET_NAME) {
    ui.alert("Vui l√≤ng ch·ªçn m·ªôt y√™u c·∫ßu trong sheet 'Xuathoadon' ƒë·ªÉ ph√™ duy·ªát.");
    return;
  }

  const selectedRow = activeSheet.getActiveRange().getRow();
  if (selectedRow < 2) {
    ui.alert("Vui l√≤ng ch·ªçn m·ªôt d√≤ng d·ªØ li·ªáu (kh√¥ng ph·∫£i d√≤ng ti√™u ƒë·ªÅ).");
    return;
  }

  const result = doReadWriteLock(() => {
    const sheets = getSheets(ss);
    const orderNumber = activeSheet.getRange(selectedRow, SHEET_HEADERS["Xuathoadon"].indexOf("S·ªê ƒê∆†N H√ÄNG") + 1).getValue();
    
    const daghepData = sheets.daGhepSheet.getDataRange().getValues();
    const headers = SHEET_HEADERS["DaGhep"];
    const soDonHangCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
    const ketQuaCol = headers.indexOf("K·∫øt qu·∫£");
    const vinCol = headers.indexOf("VIN");

    for (let i = 1; i < daghepData.length; i++) {
      if (String(daghepData[i][soDonHangCol]).trim() === String(orderNumber).trim()) {
        const currentStatus = String(daghepData[i][ketQuaCol]).trim();

        if (currentStatus === "Ch·ªù ph√™ duy·ªát" || currentStatus === "ƒê√£ b·ªï sung") {
          sheets.daGhepSheet.getRange(i + 1, ketQuaCol + 1).setValue("ƒê√£ ph√™ duy·ªát");
          
          const vin = daghepData[i][vinCol];
          
          recordOrderHistory(orderNumber, vin, "Ph√™ duy·ªát XHƒê", `Y√™u c·∫ßu ƒë∆∞·ª£c ph√™ duy·ªát b·ªüi ${Session.getActiveUser().getEmail()}`);
          return { success: true, message: `ƒê√£ ph√™ duy·ªát th√†nh c√¥ng y√™u c·∫ßu cho ƒë∆°n h√†ng ${orderNumber}.` };
        } else {
          return { success: false, message: `Kh√¥ng th·ªÉ ph√™ duy·ªát ƒë∆°n h√†ng n√†y. Tr·∫°ng th√°i hi·ªán t·∫°i l√† '${currentStatus}'.` };
        }
      }
    }
    return { success: false, message: `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} trong sheet DaGhep.` };
  });

  showToastOnSheet(result.message, result.success ? "Th√†nh c√¥ng" : "L·ªói");
}
function requestSupplementForInvoice() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  if (activeSheet.getName() !== XUAT_HOA_DON_SHEET_NAME) { // 
    ui.alert("Vui l√≤ng ch·ªçn m·ªôt y√™u c·∫ßu trong sheet 'Xuathoadon'.");
    return;
  }

  const selectedRow = activeSheet.getActiveRange().getRow();
  if (selectedRow < 2) {
    ui.alert("Vui l√≤ng ch·ªçn m·ªôt d√≤ng d·ªØ li·ªáu (kh√¥ng ph·∫£i d√≤ng ti√™u ƒë·ªÅ).");
    return;
  }

  const reasonPrompt = ui.prompt("Y√™u C·∫ßu B·ªï Sung", "Vui l√≤ng nh·∫≠p n·ªôi dung c·∫ßn b·ªï sung (v√≠ d·ª•: '·∫¢nh HƒêMB b·ªã m·ªù', 'Thi·∫øu ch·ªØ k√Ω tr√™n ƒêNXHƒê'):", ui.ButtonSet.OK_CANCEL);
  if (reasonPrompt.getSelectedButton() !== ui.Button.OK || !reasonPrompt.getResponseText()) {
    showToastOnSheet("ƒê√£ h·ªßy thao t√°c.", "Th√¥ng b√°o"); // 
    return;
  }
  const reason = reasonPrompt.getResponseText().trim();

  const result = doReadWriteLock(() => { // 
    const sheets = getSheets(ss); // 
    const orderNumber = activeSheet.getRange(selectedRow, SHEET_HEADERS["Xuathoadon"].indexOf("S·ªê ƒê∆†N H√ÄNG") + 1).getValue(); // 

    const daghepData = sheets.daGhepSheet.getDataRange().getValues(); // 
    const headers = SHEET_HEADERS["DaGhep"]; // 
    const soDonHangCol = headers.indexOf("S·ªë ƒë∆°n h√†ng"); // 
    const ketQuaCol = headers.indexOf("K·∫øt qu·∫£"); // 
    const vinCol = headers.indexOf("VIN"); // 
    const tenKhachHangCol = headers.indexOf("T√™n kh√°ch h√†ng"); // 
    const tvbhCol = headers.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng"); // 

    for (let i = 1; i < daghepData.length; i++) {
      if (String(daghepData[i][soDonHangCol]).trim() === String(orderNumber).trim()) {
        const currentStatus = String(daghepData[i][ketQuaCol]).trim();
        if (currentStatus === "Ch·ªù ph√™ duy·ªát") {
          sheets.daGhepSheet.getRange(i + 1, ketQuaCol + 1).setValue("Y√™u c·∫ßu b·ªï sung");
          
          const orderData = {
              ten_ban_hang: daghepData[i][tvbhCol],
              ten_khach_hang: daghepData[i][tenKhachHangCol],
              so_don_hang: orderNumber,
              vin: daghepData[i][vinCol]
          };
          // G·ª≠i email y√™u c·∫ßu b·ªï sung
          sendSupplementRequestEmail(sheets.mailSheet, orderData, reason);
          
          recordOrderHistory(orderNumber, orderData.vin, "Y√™u c·∫ßu b·ªï sung XHƒê", `L√Ω do: ${reason}. Y√™u c·∫ßu b·ªüi: ${Session.getActiveUser().getEmail()}`); // 
          return { success: true, message: `ƒê√£ g·ª≠i y√™u c·∫ßu b·ªï sung cho ƒë∆°n h√†ng ${orderNumber}.` };
        } else {
          return { success: false, message: `Kh√¥ng th·ªÉ th·ª±c hi·ªán. Tr·∫°ng th√°i hi·ªán t·∫°i l√† '${currentStatus}'.` };
        }
      }
    }
    return { success: false, message: `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} trong sheet DaGhep.` };
  });

  showToastOnSheet(result.message, result.success ? "Th√†nh c√¥ng" : "L·ªói"); // 
}

// [THAY TH·∫æ]
function sendSupplementRequestEmail(mailSheet, data, reason, imagesBase64Json = null) {
    const tenTVBH = data.ten_ban_hang;
    const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);
    if (!recipientEmail) {
        logAction("L·ªói g·ª≠i mail YCBS", `Kh√¥ng t√¨m th·∫•y email cho TVBH '${tenTVBH}', ƒë∆°n ${data.so_don_hang}`);
        return;
    }

    const subject = `[C·∫¶N X·ª¨ L√ù] Y√™u c·∫ßu b·ªï sung h·ªì s∆° cho ƒêH ${data.so_don_hang}`;
    const details = {
        "S·ªë ƒë∆°n h√†ng": `<b>${data.so_don_hang}</b>`,
        "T√™n kh√°ch h√†ng": data.ten_khach_hang,
        "S·ªë VIN": `<b>${data.vin}</b>`,
        "Tr·∫°ng th√°i": "<b style='color: orange;'>Y√™u c·∫ßu b·ªï sung</b>",
        "N·ªôi dung c·∫ßn b·ªï sung": `<b style="color: #dc3545;">${reason}</b>`
    };
    
    const mailOptions = {
        to: recipientEmail,
        subject: subject,
        inlineImages: {} // Kh·ªüi t·∫°o ƒë·ªëi t∆∞·ª£ng r·ªóng
    };
    
    let imageAttachmentHtml = '';

    // --- B·∫ÆT ƒê·∫¶U LOGIC X·ª¨ L√ù NHI·ªÄU ·∫¢NH ---
    let imagesArray = [];
    if (imagesBase64Json) {
        try {
            imagesArray = JSON.parse(imagesBase64Json);
        } catch(e) {
            logAction("L·ªói ph√¢n t√≠ch JSON ·∫£nh YCBS", `ƒê∆°n ${data.so_don_hang}, L·ªói: ${e.message}`);
        }
    }
    
    if (Array.isArray(imagesArray) && imagesArray.length > 0) {
        imageAttachmentHtml = `<p style="color: #555; font-size: 16px; line-height: 1.6; margin: 15px 0 5px 0;"><strong>H√¨nh ·∫£nh:</strong></p><div>`;

        imagesArray.forEach((base64string, index) => {
            if (base64string && base64string.startsWith('data:image')) {
                try {
                    const parts = base64string.split(',');
                    const mimeType = parts[0].match(/:(.*?);/)[1];
                    const decodedData = Utilities.base64Decode(parts[1]);
                    const blob = Utilities.newBlob(decodedData, mimeType, `hinh_${index + 1}.png`);
                    
                    const cid = `pastedImage_${index}`; // T·∫°o Content ID duy nh·∫•t cho m·ªói ·∫£nh
                    mailOptions.inlineImages[cid] = blob;
                    
                    // Th√™m th·∫ª <img> cho m·ªói ·∫£nh v√†o email
                    imageAttachmentHtml += `<img src="cid:${cid}" alt="H√¨nh ${index + 1}" style="max-width: 250px; height: auto; border: 1px solid #ddd; border-radius: 4px; margin: 5px; display: inline-block;">`;
                } catch(e) {
                    logAction("L·ªói x·ª≠ l√Ω 1 ·∫£nh YCBS", `ƒê∆°n ${data.so_don_hang}, ·∫¢nh s·ªë ${index + 1}, L·ªói: ${e.message}`);
                }
            }
        });

        imageAttachmentHtml += `</div>`;
    }
    // --- K·∫æT TH√öC LOGIC X·ª¨ L√ù NHI·ªÄU ·∫¢NH ---
    
    const note = "Anh/Ch·ªã vui l√≤ng chu·∫©n b·ªã l·∫°i h·ªì s∆° v√† s·ª≠ d·ª•ng ch·ª©c nƒÉng 'C·∫≠p nh·∫≠t/Thay th·∫ø h·ªì s∆°' tr√™n web ƒë·ªÉ g·ª≠i l·∫°i. C·∫£m ∆°n!" + imageAttachmentHtml;
    
    const bodyContent = createUnifiedEmailBody("Y√™u c·∫ßu xu·∫•t h√≥a ƒë∆°n c·∫ßn b·ªï sung th√¥ng tin!", tenTVBH, details, note, 'warning');
    const fullHtml = createFullHtmlEmail(subject, bodyContent);
    
    mailOptions.htmlBody = fullHtml;

    try {
        MailApp.sendEmail(mailOptions);
        logAction("G·ª≠i mail YCBS th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho ƒë∆°n ${data.so_don_hang}`);
    } catch (e) {
        logAction("L·ªói g·ª≠i mail YCBS", `Email: ${recipientEmail}, ƒê∆°n: ${data.so_don_hang}, L·ªói: ${e.message}`);
    }
}
function sendVinClubRequestEmail(mailSheet, data, reason, imagesBase64Json = null) {
    const tenTVBH = data.ten_ban_hang;
    const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);
    if (!recipientEmail) {
        logAction("L·ªói g·ª≠i mail Y/C VinClub", `Kh√¥ng t√¨m th·∫•y email cho TVBH '${tenTVBH}', ƒë∆°n ${data.so_don_hang}`);
        return;
    }

    const subject = `[C·∫¶N X·ª¨ L√ù] Y√™u c·∫ßu x√°c th·ª±c VinClub cho ƒêH ${data.so_don_hang}`;
    const details = {
        "S·ªë ƒë∆°n h√†ng": `<b>${data.so_don_hang}</b>`,
        "T√™n kh√°ch h√†ng": data.ten_khach_hang,
        "S·ªë VIN": `<b>${data.vin}</b>`,
        "Tr·∫°ng th√°i": "<b style='color: #8b5cf6;'>Y√™u c·∫ßu VinClub</b>",
        "N·ªôi dung y√™u c·∫ßu": `<b style="color: #dc3545;">${reason}</b>`
    };

    const historyLink = "https://srthuanan.github.io/ordermanagement/yeucaughepxe.html?tab=history";
    const note = `
        <p class="paragraph" style="border-left: 4px solid #8b5cf6; padding-left: 15px; background-color: #f5f3ff;">
            <strong>H∆Ø·ªöNG D·∫™N PH·∫¢N H·ªíI:</strong><br>
            Sau khi ho√†n t·∫•t, Anh/Ch·ªã vui l√≤ng truy c·∫≠p Web t·∫°i m·ª•c <strong>"L·ªãch S·ª≠ Gh√©p"</strong> v√† nh·∫•n n√∫t <strong>"X√°c Nh·∫≠n VinClub"</strong> tr√™n ƒë√∫ng d√≤ng ƒë∆°n h√†ng ƒë·ªÉ ho√†n t·∫•t.
        </p>
        <table width="100%" border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td align="center" style="padding: 20px 0;">
              <a href="${historyLink}" target="_blank" style="background-color: #4f46e5; color: #ffffff; padding: 12px 25px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
                ƒêi ƒë·∫øn L·ªãch S·ª≠ Gh√©p
              </a>
            </td>
          </tr>
        </table>
    `;

    const mailOptions = { to: recipientEmail, subject: subject, inlineImages: {} };
    let imageAttachmentHtml = '';
    let imagesArray = [];
    if (imagesBase64Json) {
        try { imagesArray = JSON.parse(imagesBase64Json); } catch(e) {}
    }
    
    if (Array.isArray(imagesArray) && imagesArray.length > 0) {
        imageAttachmentHtml = `<p style="color: #555; font-size: 16px; line-height: 1.6; margin: 15px 0 5px 0;"><strong>H√¨nh ·∫£nh ƒë√≠nh k√®m:</strong></p><div>`;
        imagesArray.forEach((base64string, index) => {
            try {
                const parts = base64string.split(',');
                const mimeType = parts[0].match(/:(.*?);/)[1];
                const decodedData = Utilities.base64Decode(parts[1]);
                const blob = Utilities.newBlob(decodedData, mimeType, `hinh_${index + 1}.png`);
                const cid = `pastedImage_${index}`;
                mailOptions.inlineImages[cid] = blob;
                imageAttachmentHtml += `<img src="cid:${cid}" alt="H√¨nh ${index + 1}" style="max-width: 250px; height: auto; border: 1px solid #ddd; border-radius: 4px; margin: 5px; display: inline-block;">`;
            } catch(e) {}
        });
        imageAttachmentHtml += `</div>`;
    }

    const finalNote = note + imageAttachmentHtml;
    const bodyContent = createUnifiedEmailBody("Y√™u c·∫ßu X√°c th·ª±c T√†i kho·∫£n VinClub", tenTVBH, details, finalNote, 'warning', true);
    const fullHtml = createFullHtmlEmail(subject, bodyContent);
    mailOptions.htmlBody = fullHtml;

    try {
        MailApp.sendEmail(mailOptions);
        logAction("G·ª≠i mail Y/C VinClub th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho ƒë∆°n ${data.so_don_hang}`);
    } catch (e) {
        logAction("L·ªói g·ª≠i mail Y/C VinClub", `Email: ${recipientEmail}, ƒê∆°n: ${data.so_don_hang}, L·ªói: ${e.message}`);
    }
}
function getDataVersion() {
  const scriptProperties = PropertiesService.getScriptProperties();
  return scriptProperties.getProperty('DATA_VERSION') || '0';
}


function incrementDataVersion() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const newVersion = new Date().getTime().toString(); // D√πng timestamp ƒë·ªÉ ƒë·∫£m b·∫£o duy nh·∫•t
  scriptProperties.setProperty('DATA_VERSION', newVersion);
  Logger.log(`Phi√™n b·∫£n d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh: ${newVersion}`);
  return newVersion;
}

function handleSheetChange(e) {
  // Ghi l·∫°i log ƒë·ªÉ bi·∫øt trigger ƒë√£ ch·∫°y v√† lo·∫°i thay ƒë·ªïi l√† g√¨
  Logger.log(`Trigger 'onChange' ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t. Lo·∫°i thay ƒë·ªïi: ${e.changeType}`);

  // Ch·ªâ tƒÉng phi√™n b·∫£n cho c√°c thay ƒë·ªïi quan tr·ªçng do ng∆∞·ªùi d√πng th·ª±c hi·ªán
  const changeTypesToUpdate = ["EDIT", "INSERT_ROW", "REMOVE_ROW", "INSERT_GRID", "REMOVE_GRID"];
  
  if (e.user && changeTypesToUpdate.includes(e.changeType)) {
    Logger.log("Ph√°t hi·ªán thay ƒë·ªïi c·∫•u tr√∫c quan tr·ªçng. ƒêang c·∫≠p nh·∫≠t phi√™n b·∫£n d·ªØ li·ªáu...");
    
    // G·ªçi h√†m tƒÉng phi√™n b·∫£n ƒë·ªÉ web app c√≥ th·ªÉ nh·∫≠n bi·∫øt
    incrementDataVersion();
  }
}
function verifyDepositInfo(customerName, depositDateString, cocXeSheet) {
  try {
    if (!customerName || !depositDateString) {
      return { success: false, message: "Vui l√≤ng cung c·∫•p ƒë·∫ßy ƒë·ªß T√™n kh√°ch h√†ng v√† Ng√†y c·ªçc." };
    }

    // 1. Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o
    const normalizedCustomerName = normalizeString(customerName);
    const inputDate = new Date(depositDateString);
    if (isNaN(inputDate.getTime())) {
      return { success: false, message: "Ng√†y c·ªçc kh√¥ng h·ª£p l·ªá." };
    }
    const inputDateStringYYYYMMDD = Utilities.formatDate(inputDate, "GMT+7", "yyyy-MM-dd");

    // 2. L·∫•y d·ªØ li·ªáu t·ª´ sheet CocXe
    const cocXeData = cocXeSheet.getDataRange().getValues();
    const cocXeHeaders = cocXeData[0];
    const nameCol = cocXeHeaders.indexOf("T√™n kh√°ch h√†ng");
    const dateCol = cocXeHeaders.indexOf("Ng√†y c·ªçc");
    const statusCol = cocXeHeaders.indexOf("Tr·∫°ng th√°i s·ª≠ d·ª•ng");

    if (nameCol === -1 || dateCol === -1 || statusCol === -1) {
      logAction("L·ªói c·∫•u h√¨nh sheet CocXe", "Sheet CocXe thi·∫øu c·ªôt: T√™n kh√°ch h√†ng, Ng√†y c·ªçc, ho·∫∑c Tr·∫°ng th√°i s·ª≠ d·ª•ng.");
      return { success: false, message: "L·ªói c·∫•u h√¨nh h·ªá th·ªëng (CocXe). Vui l√≤ng li√™n h·ªá Admin." };
    }

    // 3. T√¨m ki·∫øm b·∫£n ghi ph√π h·ª£p
    for (let i = 1; i < cocXeData.length; i++) {
      const row = cocXeData[i];
      const sheetCustomerName = normalizeString(String(row[nameCol] || ""));
      const sheetStatus = String(row[statusCol] || "").trim().toLowerCase();

      if (sheetCustomerName === normalizedCustomerName && sheetStatus !== 'ƒë√£ s·ª≠ d·ª•ng') {
        const sheetDateValue = row[dateCol];
        if (sheetDateValue instanceof Date && !isNaN(sheetDateValue.getTime())) {
          const sheetDateStringYYYYMMDD = Utilities.formatDate(sheetDateValue, "GMT+7", "yyyy-MM-dd");
          
          if (sheetDateStringYYYYMMDD === inputDateStringYYYYMMDD) {
            cocXeSheet.getRange(i + 1, statusCol + 1).setValue("ƒê√£ s·ª≠ d·ª•ng");
            logAction("X√°c th·ª±c c·ªçc th√†nh c√¥ng", `Kh√°ch h√†ng: ${customerName}, Ng√†y c·ªçc: ${inputDateStringYYYYMMDD}`);
            return { success: true };
          }
        }
      }
    }

    // 4. N·∫øu kh√¥ng t√¨m th·∫•y -> tr·∫£ v·ªÅ th√¥ng b√°o l·ªói m·ªõi theo y√™u c·∫ßu
    logAction("X√°c th·ª±c c·ªçc th·∫•t b·∫°i", `Sai UNC ho·∫∑c th√¥ng tin kh√¥ng kh·ªõp cho KH: ${customerName}, Ng√†y c·ªçc: ${inputDateStringYYYYMMDD}`);
    return { success: false, message: "Vui l√≤ng s·ª≠ d·ª•ng U·ª∑ nhi·ªám chi ƒë√∫ng cho Kh√°ch h√†ng ƒë√£ ƒë·∫∑t c·ªçc!" };

  } catch (error) {
    logAction("L·ªói trong verifyDepositInfo", `L·ªói: ${error.message}`);
    return { success: false, message: `L·ªói h·ªá th·ªëng khi x√°c th·ª±c: ${error.message}` };
  }
}
/**
 * [H√ÄM ƒê√É N√ÇNG C·∫§P] Ph√¢n t√≠ch d·ªØ li·ªáu ƒë·ªÉ x√°c ƒë·ªãnh ƒë·ªô ph·ªï bi·∫øn, t·ªìn kho,
 * v√† S·ªê L∆Ø·ª¢NG ƒêANG CH·ªú GH√âP c·ªßa c√°c lo·∫°i xe.
 * @returns {Object} M·ªôt ƒë·ªëi t∆∞·ª£ng ch·ª©a d·ªØ li·ªáu ph√¢n t√≠ch.
 */
function getVehicleAnalytics() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const daGhepSheet = ss.getSheetByName(DA_GHEP_SHEET_NAME);
  const chuaGhepSheet = ss.getSheetByName(CHUA_GHEP_SHEET_NAME);
  const stockSheet = ss.getSheetByName(STOCK_SHEET_NAME);

  const analytics = {
    requestFrequency: {}, // Gi·ªØ nguy√™n: T·∫ßn su·∫•t y√™u c·∫ßu (gh√©p v√† ch·ªù gh√©p)
    stockStatus: {},      // Gi·ªØ nguy√™n: T√¨nh tr·∫°ng t·ªìn kho
    // --- B·∫ÆT ƒê·∫¶U PH·∫¶N B·ªî SUNG ---
    pendingRequestCount: {} // M·ªöI: Ch·ªâ ƒë·∫øm s·ªë l∆∞·ª£ng y√™u c·∫ßu trong sheet "ChuaGhep"
    // --- K·∫æT TH√öC PH·∫¶N B·ªî SUNG ---
  };

  // H√†m helper ƒë·ªÉ t·∫°o key duy nh·∫•t t·ª´ d√≤ng xe, phi√™n b·∫£n v√† m√†u s·∫Øc
  const createVehicleKey = (dongXe, phienBan, ngoaiThat) => {
    if (!dongXe || !phienBan || !ngoaiThat) return null;
    return `${dongXe}|${phienBan}|${ngoaiThat}`.trim().toLowerCase();
  };

  // 1. Ph√¢n t√≠ch t·∫ßn su·∫•t y√™u c·∫ßu chung (gi·ªØ nguy√™n logic c≈©)
  const sheetsToAnalyze = [daGhepSheet, chuaGhepSheet];
  sheetsToAnalyze.forEach(sheet => {
    if (sheet && sheet.getLastRow() > 1) {
      const data = sheet.getDataRange().getValues();
      const headers = data[0];
      const dongXeCol = headers.indexOf("D√≤ng xe");
      const phienBanCol = headers.indexOf("Phi√™n b·∫£n");
      const ngoaiThatCol = headers.indexOf("Ngo·∫°i th·∫•t");

      if ([dongXeCol, phienBanCol, ngoaiThatCol].some(col => col === -1)) return;

      for (let i = 1; i < data.length; i++) {
        const key = createVehicleKey(data[i][dongXeCol], data[i][phienBanCol], data[i][ngoaiThatCol]);
        if (key) {
          analytics.requestFrequency[key] = (analytics.requestFrequency[key] || 0) + 1;
        }
      }
    }
  });

  // --- B·∫ÆT ƒê·∫¶U LOGIC M·ªöI: ƒê·∫øm c√°c y√™u c·∫ßu ƒëang ch·ªù trong "ChuaGhep" ---
  if (chuaGhepSheet && chuaGhepSheet.getLastRow() > 1) {
    const data = chuaGhepSheet.getDataRange().getValues();
    const headers = data[0];
    const dongXeCol = headers.indexOf("D√≤ng xe");
    const phienBanCol = headers.indexOf("Phi√™n b·∫£n");
    const ngoaiThatCol = headers.indexOf("Ngo·∫°i th·∫•t");

    if (![dongXeCol, phienBanCol, ngoaiThatCol].some(col => col === -1)) {
       for (let i = 1; i < data.length; i++) {
        const key = createVehicleKey(data[i][dongXeCol], data[i][phienBanCol], data[i][ngoaiThatCol]);
        if (key) {
          // Ch·ªâ tƒÉng b·ªô ƒë·∫øm cho c√°c y√™u c·∫ßu ƒëang ch·ªù
          analytics.pendingRequestCount[key] = (analytics.pendingRequestCount[key] || 0) + 1;
        }
      }
    }
  }
  // --- K·∫æT TH√öC LOGIC M·ªöI ---


  // 2. Ph√¢n t√≠ch t√¨nh tr·∫°ng t·ªìn kho t·ª´ sheet KhoXe (gi·ªØ nguy√™n logic c≈©)
  if (stockSheet && stockSheet.getLastRow() > 1) {
    const stockData = stockSheet.getDataRange().getValues();
    const stockHeaders = stockData[0];
    const dongXeCol = stockHeaders.indexOf("D√≤ng xe");
    const phienBanCol = stockHeaders.indexOf("Phi√™n b·∫£n");
    const ngoaiThatCol = stockHeaders.indexOf("Ngo·∫°i th·∫•t");
    const statusCol = stockHeaders.indexOf("Tr·∫°ng th√°i");
    const ngayNhapCol = stockHeaders.indexOf("Ng√†y nh·∫≠p");

    if ([dongXeCol, phienBanCol, ngoaiThatCol, statusCol, ngayNhapCol].some(col => col === -1)) return analytics;

    const ninetyDaysAgo = new Date();
    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

    for (let i = 1; i < stockData.length; i++) {
      const key = createVehicleKey(stockData[i][dongXeCol], stockData[i][phienBanCol], stockData[i][ngoaiThatCol]);
      const status = String(stockData[i][statusCol] || '').trim().toLowerCase();
      const ngayNhap = new Date(stockData[i][ngayNhapCol]);

      if (key && status === 'ch∆∞a gh√©p') {
        if (!analytics.stockStatus[key]) {
          analytics.stockStatus[key] = { count: 0, isSlowMoving: false };
        }
        analytics.stockStatus[key].count++;

        if (ngayNhap && ngayNhap < ninetyDaysAgo) {
          analytics.stockStatus[key].isSlowMoving = true;
        }
      }
    }
  }

  return analytics;
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈®]
function handleApproveRequestFromWebApp(orderNumber, actionId) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheets = getSheets(ss);
  const { daGhepSheet, nhatKyChinhSuaSheet } = sheets;
  const user = Session.getActiveUser().getEmail() || "Admin Web App";

  const daGhepData = daGhepSheet.getDataRange().getValues();
  const headers = daGhepData[0];
  const soDonHangCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
  const ketQuaCol = headers.indexOf("K·∫øt qu·∫£");
  const vinCol = headers.indexOf("VIN");
  const tvbhCol = headers.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng");

  for (let i = 1; i < daGhepData.length; i++) {
    if (String(daGhepData[i][soDonHangCol]).trim() === String(orderNumber).trim()) {
      const currentStatus = String(daGhepData[i][ketQuaCol]).trim();
      if (currentStatus === "Ch·ªù ph√™ duy·ªát" || currentStatus === "ƒê√£ b·ªï sung") {
        
        // S·ª¨ D·ª§NG H√ÄM M·ªöI
        updateCellAndLog(daGhepSheet, i + 1, ketQuaCol + 1, "ƒê√£ ph√™ duy·ªát", user, actionId, nhatKyChinhSuaSheet);

        const vin = daGhepData[i][vinCol];
        const tvbhName = daGhepData[i][tvbhCol];
        const message = `Y√™u c·∫ßu XHƒê cho ƒë∆°n h√†ng ${orderNumber} c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c Admin ph√™ duy·ªát.`;
        addNotification(message, 'success', 'xuatHoaDon', orderNumber, user, tvbhName);
        recordOrderHistory(orderNumber, vin, "Ph√™ duy·ªát XHƒê", `Y√™u c·∫ßu ƒë∆∞·ª£c ph√™ duy·ªát b·ªüi ${user}`);
        return createJsonResponse({ status: "SUCCESS", message: `ƒê√£ ph√™ duy·ªát th√†nh c√¥ng y√™u c·∫ßu cho ƒë∆°n h√†ng ${orderNumber}.` });
      } else {
        return createJsonResponse({ status: "ERROR", message: `Kh√¥ng th·ªÉ ph√™ duy·ªát. Tr·∫°ng th√°i hi·ªán t·∫°i l√† '${currentStatus}'.` });
      }
    }
  }
  return createJsonResponse({ status: "ERROR", message: `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} ƒë·ªÉ ph√™ duy·ªát.` });
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈®]
function handleRequestSupplementFromWebApp(orderNumber, reason, sheets, imagesBase64Json = null, actionId = null) {
  const { daGhepSheet, mailSheet, nhatKyChinhSuaSheet } = sheets;
  const user = Session.getActiveUser().getEmail() || "Admin Web App";
  const daGhepData = daGhepSheet.getDataRange().getValues();
  const headers = daGhepData[0];
  const soDonHangCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
  const ketQuaCol = headers.indexOf("K·∫øt qu·∫£");
  const vinCol = headers.indexOf("VIN");
  const tenKhachHangCol = headers.indexOf("T√™n kh√°ch h√†ng");
  const tvbhCol = headers.indexOf("T√™n t∆∞ v·∫•n b√°n h√†ng");
  for (let i = 1; i < daGhepData.length; i++) {
    if (String(daGhepData[i][soDonHangCol]).trim() === String(orderNumber).trim()) {
      const currentStatus = String(daGhepData[i][ketQuaCol]).trim();
      if (currentStatus === "Ch·ªù ph√™ duy·ªát" || currentStatus === "ƒê√£ b·ªï sung") {

        // S·ª¨ D·ª§NG H√ÄM M·ªöI
        updateCellAndLog(daGhepSheet, i + 1, ketQuaCol + 1, "Y√™u c·∫ßu b·ªï sung", user, actionId, nhatKyChinhSuaSheet);

        const orderData = {
           ten_ban_hang: daGhepData[i][tvbhCol],
            ten_khach_hang: daGhepData[i][tenKhachHangCol],
            so_don_hang: orderNumber,
            vin: daGhepData[i][vinCol]
        };
        sendSupplementRequestEmail(mailSheet, orderData, reason, imagesBase64Json);
        const tvbhName = daGhepData[i][tvbhCol];
        const message = `Admin y√™u c·∫ßu b·∫°n b·ªï sung h·ªì s∆° cho ƒêH ${orderNumber} v·ªõi l√Ω do: "${reason}"`;
        addNotification(message, 'warning', 'xuatHoaDon', orderNumber, user, tvbhName);
        recordOrderHistory(orderNumber, orderData.vin, "Y√™u c·∫ßu b·ªï sung XHƒê", `L√Ω do: ${reason}. Y√™u c·∫ßu b·ªüi: ${user}`);
        return createJsonResponse({ status: "SUCCESS", message: `ƒê√£ g·ª≠i y√™u c·∫ßu b·ªï sung cho ƒë∆°n h√†ng ${orderNumber}.` });
      } else {
        return createJsonResponse({ status: "ERROR", message: `Kh√¥ng th·ªÉ y√™u c·∫ßu b·ªï sung. Tr·∫°ng th√°i hi·ªán t·∫°i l√† '${currentStatus}'.` });
      }
    }
  }
  return createJsonResponse({ status: "ERROR", message: `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} ƒë·ªÉ y√™u c·∫ßu b·ªï sung.` });
}

function deleteCarFromStockLogic(vinToDelete, reason) {
  Logger.log(`DEBUG: B·∫Øt ƒë·∫ßu x√≥a xe ${vinToDelete} v·ªõi l√Ω do: "${reason}"`);

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const removedCarsLogSheet = getOrCreateSheet(ss, "removed_cars_log", SHEET_HEADERS["removed_cars_log"]);
  const userEmail = Session.getActiveUser().getEmail() || "Kh√¥ng x√°c ƒë·ªãnh";

  const stockData = stockSheet.getDataRange().getValues();
  const actualStockHeaders = stockData[0]; // [S·ª¨A L·ªñI] L·∫•y header th·ª±c t·∫ø t·ª´ sheet
  const vinColStock = actualStockHeaders.indexOf("VIN");

  if (vinColStock === -1) {
    return "L·ªói: Sheet KhoXe kh√¥ng c√≥ c·ªôt VIN.";
  }

  for (let i = 1; i < stockData.length; i++) {
    const currentRow = stockData[i];
    const currentVin = String(currentRow[vinColStock] || "").trim();

    if (currentVin === vinToDelete) {
      // [S·ª¨A L·ªñI] T·∫°o object chi ti·∫øt xe b·∫±ng c√°ch map header th·ª±c t·∫ø v·ªõi gi√° tr·ªã
      const carToRemoveDetails = {};
      actualStockHeaders.forEach((header, index) => {
        if(header) carToRemoveDetails[header] = currentRow[index];
      });

      const logEntry = [
        formatDateTimeForSheet(new Date()),
        userEmail,
        carToRemoveDetails["D√≤ng xe"],
        carToRemoveDetails["Phi√™n b·∫£n"],
        carToRemoveDetails["Ngo·∫°i th·∫•t"],
        carToRemoveDetails["N·ªôi th·∫•t"],
        vinToDelete,
        carToRemoveDetails["M√£ DMS"], // ƒê·ªçc ƒë√∫ng t·ª´ object chi ti·∫øt
        carToRemoveDetails["Tr·∫°ng th√°i"],
        carToRemoveDetails["Ng√†y nh·∫≠p"] ? formatDateTimeForSheet(new Date(carToRemoveDetails["Ng√†y nh·∫≠p"])) : "",
        carToRemoveDetails["ƒê√£ th√¥ng b√°o"],
        reason || "Kh√¥ng c√≥ l√Ω do"
      ];
      removedCarsLogSheet.appendRow(logEntry);

      stockSheet.deleteRow(i + 1);
      
      recordVehicleHistory(vinToDelete, "X√≥a Kh·ªèi Kho", `Xe ƒë√£ ƒë∆∞·ª£c x√≥a b·ªüi ${userEmail}. L√Ω do: ${reason}`);
      logAction("X√≥a Xe Th√†nh C√¥ng", `VIN ${vinToDelete} ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi KhoXe v√† ghi v√†o log.`);
      return `Xe v·ªõi VIN ${vinToDelete} ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng kh·ªèi kho!`;
    }
  }
  return `Kh√¥ng t√¨m th·∫•y xe v·ªõi VIN ${vinToDelete} trong KhoXe.`;
}

// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈®]
function restoreCarToStockLogic(vinToRestore) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const removedCarsLogSheet = getOrCreateSheet(ss, "removed_cars_log", SHEET_HEADERS["removed_cars_log"]);
  const userEmail = Session.getActiveUser().getEmail() || "Kh√¥ng x√°c ƒë·ªãnh";

  const stockDataCheck = stockSheet.getDataRange().getValues();
  const stockVinColCheck = SHEET_HEADERS["KhoXe"].indexOf("VIN");
  for (let k = 1; k < stockDataCheck.length; k++) {
    if (String(stockDataCheck[k][stockVinColCheck] || "").trim() === vinToRestore) {
      return `L·ªói: Xe v·ªõi VIN ${vinToRestore} ƒë√£ t·ªìn t·∫°i trong KhoXe.`;
    }
  }

  const logData = removedCarsLogSheet.getDataRange().getValues();
  const logHeaders = SHEET_HEADERS["removed_cars_log"];
  const vinColLog = logHeaders.indexOf("VIN");
  let carDataFromLog = null;

  for (let i = logData.length - 1; i >= 1; i--) {
    if (String(logData[i][vinColLog] || "").trim() === vinToRestore) {
      carDataFromLog = {};
      logHeaders.forEach((header, index) => {
        carDataFromLog[header] = logData[i][index];
      });
      break;
    }
  }

  if (!carDataFromLog) {
    return `Kh√¥ng t√¨m th·∫•y th√¥ng tin xe v·ªõi VIN ${vinToRestore} trong nh·∫≠t k√Ω xe ƒë√£ x√≥a.`;
  }

  // [S·ª¨A L·ªñI] X√¢y d·ª±ng m·∫£ng d·ªØ li·ªáu ƒë·ªÉ ghi d·ª±a tr√™n header th·ª±c t·∫ø c·ªßa sheet KhoXe
  const actualStockHeaders = stockSheet.getRange(1, 1, 1, stockSheet.getLastColumn()).getValues()[0];
  
  const newRowValues = actualStockHeaders.map(header => {
      switch (header) {
          case "D√≤ng xe": return carDataFromLog["D√≤ng xe"];
          case "Phi√™n b·∫£n": return carDataFromLog["Phi√™n b·∫£n"];
          case "Ngo·∫°i th·∫•t": return carDataFromLog["Ngo·∫°i th·∫•t"];
          case "N·ªôi th·∫•t": return carDataFromLog["N·ªôi th·∫•t"];
          case "VIN": return vinToRestore;
          case "M√£ DMS": return carDataFromLog["M√£ DMS (c≈©)"]; // L·∫•y ƒë√∫ng M√£ DMS t·ª´ log
          case "Tr·∫°ng th√°i": return "Ch∆∞a gh√©p";
          case "Ng√†y nh·∫≠p": return carDataFromLog["Ng√†y nh·∫≠p (c≈©)"] ? new Date(carDataFromLog["Ng√†y nh·∫≠p (c≈©)"]) : new Date();
          case "ƒê√£ th√¥ng b√°o": return carDataFromLog["ƒê√£ th√¥ng b√°o (c≈©)"] || "";
          default: return ""; // ƒê·ªÉ tr·ªëng cho c√°c c·ªôt kh√°c nh∆∞ checkbox, Ng∆∞·ªùi gi·ªØ xe...
      }
  });

  stockSheet.appendRow(newRowValues);
  
  // ƒê·ªãnh d·∫°ng l·∫°i c·ªôt ng√†y cho ƒë√∫ng
  const lastRow = stockSheet.getLastRow();
  const ngayNhapColIndex = actualStockHeaders.indexOf("Ng√†y nh·∫≠p");
  if(ngayNhapColIndex > -1) {
      stockSheet.getRange(lastRow, ngayNhapColIndex + 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");
  }

  recordVehicleHistory(vinToRestore, "Ph·ª•c H·ªìi V√†o Kho", `Xe ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi b·ªüi ${userEmail} t·ª´ Web App.`);
  logAction("Ph·ª•c H·ªìi Xe Th√†nh C√¥ng", `VIN ${vinToRestore} ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi v√†o KhoXe.`);
  return `Xe v·ªõi VIN ${vinToRestore} ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi th√†nh c√¥ng!`;
}

/**
 * [H√ÄM M·ªöI] - X·ª≠ l√Ω logic x√≥a ƒë∆°n h√†ng.
 * @param {string} orderNumber - S·ªë ƒë∆°n h√†ng c·∫ßn x√≥a.
 * @returns {string} - Th√¥ng b√°o k·∫øt qu·∫£.
 */
function deleteOrderLogic(orderNumber) {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const deletedBy = Session.getActiveUser().getEmail() || "Admin Web App";

    const e_simulated = {
        parameter: {
            orderNumber: orderNumber,
            reason: "X√≥a th·ªß c√¥ng t·ª´ Web App",
            fromUI: 'true',
            cancelledBy: deletedBy
        }
    };
    
    // G·ªçi l·∫°i h√†m handleCancelRequest v√¨ logic c∆° b·∫£n l√† gi·ªëng nhau
    const resultJson = handleCancelRequest(
        e_simulated,
        getOrCreateSheet(ss, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"]),
        getOrCreateSheet(ss, CHUA_GHEP_SHEET_NAME, SHEET_HEADERS["ChuaGhep"]),
        getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]),
        getOrCreateSheet(ss, CANCELLED_SHEET_NAME, SHEET_HEADERS["HuyGhep"]),
        getOrCreateSheet(ss, MAIL_SHEET_NAME, SHEET_HEADERS["Mail"]),
        getOrCreateSheet(ss, XUAT_HOA_DON_SHEET_NAME, SHEET_HEADERS["Xuathoadon"])
    );
    
    const result = JSON.parse(resultJson.getContent());
    return result.message;
}

/**
 * [H√ÄM M·ªöI] - X·ª≠ l√Ω logic x√≥a c√°c ƒë∆°n ƒë√£ gh√©p c·ªßa th√°ng tr∆∞·ªõc.
 * @returns {string} - Th√¥ng b√°o k·∫øt qu·∫£.
 */
function deleteMonthlyInvoicedOrdersFromDaGhepLogic() {
  Logger.log("--- B·∫ÆT ƒê·∫¶U: deleteMonthlyInvoicedOrdersFromDaGhepLogic ---");
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const daGhepSheet = getOrCreateSheet(ss, DA_GHEP_SHEET_NAME, SHEET_HEADERS["DaGhep"]);

  if (daGhepSheet.getLastRow() <= 1) {
    return "Sheet DaGhep kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ d·ªçn d·∫πp.";
  }

  const daGhepValues = daGhepSheet.getDataRange().getValues();
  const headers = daGhepValues[0];
  const ketQuaCol = headers.indexOf("K·∫øt qu·∫£");
  const ngayXuatHDCol = headers.indexOf("Ng√†y xu·∫•t h√≥a ƒë∆°n");

  if (ketQuaCol === -1 || ngayXuatHDCol === -1) {
    return "L·ªói: Kh√¥ng t√¨m th·∫•y c·ªôt 'K·∫øt qu·∫£' ho·∫∑c 'Ng√†y xu·∫•t h√≥a ƒë∆°n' trong sheet DaGhep.";
  }

  const today = new Date();
  let previousMonthDate = new Date(today.getFullYear(), today.getMonth(), 1);
  previousMonthDate.setDate(0);
  const targetYear = previousMonthDate.getFullYear();
  const targetMonth = previousMonthDate.getMonth(); // 0-indexed

  const rowIndicesToDelete = [];
  for (let i = 1; i < daGhepValues.length; i++) {
    const ketQua = String(daGhepValues[i][ketQuaCol] || "").trim();
    const ngayXuatHDValue = daGhepValues[i][ngayXuatHDCol];
    
    if (ketQua === "ƒê√£ xu·∫•t h√≥a ƒë∆°n" && ngayXuatHDValue && (ngayXuatHDValue instanceof Date)) {
      if (ngayXuatHDValue.getFullYear() === targetYear && ngayXuatHDValue.getMonth() === targetMonth) {
        rowIndicesToDelete.push(i + 1);
      }
    }
  }

  if (rowIndicesToDelete.length > 0) {
    rowIndicesToDelete.sort((a, b) => b - a).forEach(rowIndex => {
      daGhepSheet.deleteRow(rowIndex);
    });
    const successMsg = `ƒê√£ x√≥a vƒ©nh vi·ªÖn ${rowIndicesToDelete.length} ƒë∆°n h√†ng (ƒë√£ XHƒê th√°ng ${targetMonth + 1}/${targetYear}) kh·ªèi sheet DaGhep.`;
    logAction("X√≥a DaGhep (XHƒê Th√°ng Tr∆∞·ªõc)", successMsg);
    return successMsg;
  } else {
    return `Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o trong DaGhep ƒë√£ xu·∫•t h√≥a ƒë∆°n c·ªßa th√°ng ${targetMonth + 1}/${targetYear} ƒë·ªÉ x√≥a.`;
  }
}
function addCarToStockLogic(params) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const userEmail = Session.getActiveUser().getEmail() || "Admin Web App";

  // L·∫•y d·ªØ li·ªáu t·ª´ params g·ª≠i l√™n t·ª´ form
  const {
    vin,
    dongXe,
    phienBan,
    ngoaiThat,
    noiThat,
    maDMS
  } = params;

  // --- B∆Ø·ªöC 1: X√°c th·ª±c d·ªØ li·ªáu ƒë·∫ßu v√†o ---
  if (!vin || vin.trim().length !== 17) {
    return "L·ªói: S·ªë VIN kh√¥ng h·ª£p l·ªá. Ph·∫£i c√≥ ƒë·ªß 17 k√Ω t·ª±.";
  }
  const vinToAdd = vin.trim().toUpperCase();

  const stockData = stockSheet.getDataRange().getValues();
  const stockHeaders = SHEET_HEADERS["KhoXe"];
  const vinColStock = stockHeaders.indexOf("VIN");

  // Ki·ªÉm tra xem VIN ƒë√£ t·ªìn t·∫°i trong kho ch∆∞a
  for (let i = 1; i < stockData.length; i++) {
    if (String(stockData[i][vinColStock] || "").trim().toUpperCase() === vinToAdd) {
      return `L·ªói: Xe v·ªõi VIN ${vinToAdd} ƒë√£ t·ªìn t·∫°i trong KhoXe.`;
    }
  }

  // --- B∆Ø·ªöC 2: Chu·∫©n b·ªã d·ªØ li·ªáu cho d√≤ng m·ªõi ---
  const newCarRowValues = stockHeaders.map(header => {
    switch (header) {
      case "D√≤ng xe":       return dongXe || "";
      case "Phi√™n b·∫£n":      return phienBan || "";
      case "Ngo·∫°i th·∫•t":    return ngoaiThat || "";
      case "N·ªôi th·∫•t":       return noiThat || "";
      case "VIN":           return vinToAdd;
      case "M√£ DMS":        return maDMS || "";
      case "Tr·∫°ng th√°i":    return "Ch∆∞a gh√©p"; // Tr·∫°ng th√°i m·∫∑c ƒë·ªãnh khi xe m·ªõi v√†o kho
      case "Ng√†y nh·∫≠p":     return new Date(); // Ghi nh·∫≠n ng√†y gi·ªù hi·ªán t·∫°i
      case "ƒê√£ th√¥ng b√°o":  return ""; // M·∫∑c ƒë·ªãnh l√† ch∆∞a th√¥ng b√°o
      default:              return "";
    }
  });

  // --- B∆Ø·ªöC 3: Th√™m d√≤ng m·ªõi v√†o sheet v√† ghi log ---
  stockSheet.appendRow(newCarRowValues);
  // ƒê·ªãnh d·∫°ng l·∫°i c·ªôt ng√†y th√°ng cho ƒë√∫ng
  stockSheet.getRange(stockSheet.getLastRow(), stockHeaders.indexOf("Ng√†y nh·∫≠p") + 1).setNumberFormat("dd/MM/yyyy hh:mm:ss");

  // Ghi l·∫°i l·ªãch s·ª≠ ho·∫°t ƒë·ªông
  recordVehicleHistory(vinToAdd, "Nh·∫≠p Kho M·ªõi", `Xe ƒë√£ ƒë∆∞·ª£c th√™m v√†o kho b·ªüi ${userEmail} t·ª´ Web App.`);
  logAction("Th√™m Xe M·ªõi Th√†nh C√¥ng", `VIN ${vinToAdd} ƒë√£ ƒë∆∞·ª£c th√™m v√†o KhoXe.`);
  
  // Tr·∫£ v·ªÅ th√¥ng b√°o th√†nh c√¥ng
  return `Xe v·ªõi VIN ${vinToAdd} ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng v√†o kho!`;
}
// KH√îNG C·∫¶N THAY ƒê·ªîI G√å TRONG H√ÄM N√ÄY, N√ì ƒê√É G·ªåI H√ÄM getThongtinxeData() C√ì CACHE.
function getCarInfoFromMasterData(vin) {
  try {
    if (!vin || String(vin).trim().length !== 17) {
      return { status: "ERROR", message: "L·ªói: S·ªë VIN kh√¥ng h·ª£p l·ªá." };
    }
    const vinToFind = String(vin).trim().toUpperCase();

    // G·ªçi ƒë√∫ng t√™n h√†m m·ªõi c√≥ cache
    const data = getThongtinxeData(); 
    
    if (!data) {
        return { status: "ERROR", message: "L·ªói: Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu t·ª´ sheet Thongtinxe." };
    }
    const headers = data[0]; 
    
    const vinCol = headers.indexOf("S·ªë VIN");
    const moTaSanPhamCol = headers.indexOf("M√¥ t·∫£ s·∫£n ph·∫©m");
    const phienBanCol = headers.indexOf("Phi√™n b·∫£n");
    const ngoaiThatCol = headers.indexOf("M√†u ngo·∫°i th·∫•t xe");
    const noiThatCol = headers.indexOf("M√†u n·ªôi th·∫•t xe");
    const maDMSCol = headers.indexOf("Khu v·ª±c");
    for (let i = 1; i < data.length; i++) {
        if (String(data[i][vinCol] || "").trim().toUpperCase() === vinToFind) {
            const rawNgoaiThat = data[i][ngoaiThatCol] || '';
            const standardizedNgoaiThat = findMatchedValidColor(rawNgoaiThat) || rawNgoaiThat;
            const carData = {
                dongXe: data[i][moTaSanPhamCol] || '',
                phienBan: data[i][phienBanCol] || '',
                ngoaiThat: standardizedNgoaiThat,
                noiThat: data[i][noiThatCol] || '',
                maDMS: data[i][maDMSCol] || ''
            };
            const moTa = String(carData.dongXe).toUpperCase();
            if (moTa.includes("VF 3")) {
                carData.dongXe = "VF 3";
                carData.phienBan = "Base";
                carData.noiThat = "Black";
            } else if (moTa.includes("VF 5")) {
                carData.dongXe = "VF 5";
                carData.phienBan = "Plus";
                carData.noiThat = "Black";
            }
            return { status: "SUCCESS", data: carData };
        }
    }
    Logger.log(`Kh√¥ng t√¨m th·∫•y th√¥ng tin cho VIN ${vinToFind} trong Thongtinxe. S·∫Ω th√™m xe v·ªõi th√¥ng tin tr·ªëng.`);
    return { 
        status: "SUCCESS", 
        data: { dongXe: "", phienBan: "", ngoaiThat: "", noiThat: "", maDMS: "" } 
    };
  } catch (e) {
    Logger.log(`L·ªói trong getCarInfoFromMasterData: ${e.message}`);
    sendErrorAlert('getCarInfoFromMasterData', e);
    return { status: "ERROR", message: `L·ªói m√°y ch·ªß: ${e.message}` };
  }
}
// KH√îNG C·∫¶N THAY ƒê·ªîI TRONG H√ÄM N√ÄY, N√ì V·∫™N H·ªÆU √çCH CHO VI·ªÜC T√åM V√Ä TH√äM XE B·∫∞NG VIN
function findAndAddCarByVin(vin) {
  const carInfoResponse = getCarInfoFromMasterData(vin);
  if (carInfoResponse.status !== "SUCCESS") {
    return carInfoResponse.message;
  }

  const carData = carInfoResponse.data;
  const params = {
    vin: vin,
    dongXe: carData.dongXe,
    phienBan: carData.phienBan,
    ngoaiThat: carData.ngoaiThat,
    noiThat: carData.noiThat,
    maDMS: carData.maDMS
  };
  const resultMessage = addCarToStockLogic(params); // H√†m n√†y v·∫´n s·∫Ω ƒë∆∞·ª£c g·ªçi

  // T√≠ch h·ª£p th√¥ng b√°o
  if (!resultMessage.startsWith("L·ªói:")) {
    // N·∫øu xe ƒë∆∞·ª£c th√™m th√†nh c√¥ng (c√≥ th√¥ng tin ho·∫∑c kh√¥ng)
    const notificationMessage = carData.dongXe 
        ? `Xe ${carData.dongXe} (${vin}) ƒë√£ ƒë∆∞·ª£c th√™m v√†o kho.`
        : `Xe m·ªõi (${vin}) ƒë√£ ƒë∆∞·ª£c th√™m v√†o kho (ch·ªù c·∫≠p nh·∫≠t th√¥ng tin).`;
    addNotification(notificationMessage, 'success');
  } else {
    // N·∫øu c√≥ l·ªói (v√≠ d·ª•: xe ƒë√£ t·ªìn t·∫°i)
    addNotification(`Th√™m xe th·∫•t b·∫°i: ${resultMessage}`, 'danger');
  }

  return resultMessage;
}
// [ƒê√É S·ª¨A L·ªñI]
function syncMissingKhoXeInfo() {
  doReadWriteLock(() => {
    try {
        Logger.log("B·∫Øt ƒë·∫ßu qu√©t v√† ƒë·ªìng b·ªô th√¥ng tin cho KhoXe...");
        const ss = SpreadsheetApp.getActiveSpreadsheet();
        const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
        
        // T·∫°o m·ªôt Map t·ª´ sheet Thongtinxe ƒë·ªÉ tra c·ª©u th√¥ng tin nhanh ch√≥ng
        // S·ª¨A L·ªñI T·∫†I ƒê√ÇY: G·ªçi ƒë√∫ng t√™n h√†m m·ªõi l√† getThongtinxeData()
        const thongtinxeData = getThongtinxeData(); 
        
        if (!thongtinxeData) {
            logAction("L·ªói ƒë·ªìng b·ªô KhoXe", "Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ sheet Thongtinxe.");
            return;
        }

        const thongtinxeHeaders = thongtinxeData[0];
        const vinColThongtinxe = thongtinxeHeaders.indexOf("S·ªë VIN");
        const vinToInfoMap = new Map();

        for (let i = 1; i < thongtinxeData.length; i++) {
            const vin = String(thongtinxeData[i][vinColThongtinxe] || "").trim();
            if (vin) {
                vinToInfoMap.set(vin, thongtinxeData[i]);
            }
        }
        
         const stockData = stockSheet.getDataRange().getValues();
        const stockHeaders = SHEET_HEADERS["KhoXe"];
        const vinColStock = stockHeaders.indexOf("VIN");
        const dongXeColStock = stockHeaders.indexOf("D√≤ng xe");
        const phienBanColStock = stockHeaders.indexOf("Phi√™n b·∫£n");
        const ngoaiThatColStock = stockHeaders.indexOf("Ngo·∫°i th·∫•t");
        const noiThatColStock = stockHeaders.indexOf("N·ªôi th·∫•t");
        const maDMSColStock = stockHeaders.indexOf("M√£ DMS");

        let updatesMade = 0;
        for (let i = 1; i < stockData.length; i++) {
          const vin = String(stockData[i][vinColStock] || "").trim();
          const dongXe = String(stockData[i][dongXeColStock] || "").trim();

          // ƒêi·ªÅu ki·ªán ƒë·ªÉ c·∫≠p nh·∫≠t: c√≥ VIN nh∆∞ng ch∆∞a c√≥ "D√≤ng xe"
          if (vin && !dongXe) {
            const masterInfo = vinToInfoMap.get(vin);
            if (masterInfo) {
              const carData = getCarInfoFromMasterData(vin).data; // H√†m n√†y c≈©ng ƒë√£ ƒë∆∞·ª£c s·ª≠a ƒë·ªÉ g·ªçi getThongtinxeData()
              stockSheet.getRange(i + 1, dongXeColStock + 1).setValue(carData.dongXe);
              stockSheet.getRange(i + 1, phienBanColStock + 1).setValue(carData.phienBan);
              stockSheet.getRange(i + 1, ngoaiThatColStock + 1).setValue(carData.ngoaiThat);
              stockSheet.getRange(i + 1, noiThatColStock + 1).setValue(carData.noiThat);
              stockSheet.getRange(i + 1, maDMSColStock + 1).setValue(carData.maDMS);

              updatesMade++;
              recordVehicleHistory(vin, "ƒê·ªìng b·ªô th√¥ng tin", "T·ª± ƒë·ªông c·∫≠p nh·∫≠t th√¥ng tin xe t·ª´ sheet Thongtinxe.");
            }
          }
        }

        if (updatesMade > 0) {
            Logger.log(`ƒê·ªìng b·ªô ho√†n t·∫•t. ƒê√£ c·∫≠p nh·∫≠t ${updatesMade} d√≤ng trong KhoXe.`);
        } else {
            Logger.log("ƒê·ªìng b·ªô ho√†n t·∫•t. Kh√¥ng c√≥ d√≤ng n√†o c·∫ßn c·∫≠p nh·∫≠t.");
        }
    } catch (e) {
        Logger.log(`L·ªói nghi√™m tr·ªçng trong syncMissingKhoXeInfo: ${e.message}`);
        sendErrorAlert('syncMissingKhoXeInfo', e);
    }
  });
}
function setupKhoXeSyncTrigger() {
  // X√≥a c√°c trigger c≈© ƒë·ªÉ tr√°nh tr√πng l·∫∑p
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'syncMissingKhoXeInfo') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // T·∫°o trigger m·ªõi, ch·∫°y m·ªói 10 ph√∫t
  ScriptApp.newTrigger('syncMissingKhoXeInfo')
    .timeBased()
    .everyMinutes(10)
    .create();
  
  SpreadsheetApp.getUi().alert('ƒê√£ thi·∫øt l·∫≠p th√†nh c√¥ng trigger t·ª± ƒë·ªông c·∫≠p nh·∫≠t th√¥ng tin xe trong kho 10 ph√∫t m·ªôt l·∫ßn.');
}
function getThongtinxeDataWithCache() {
  const cache = CacheService.getScriptCache();
  const CACHE_KEY = 'THONGTINXE_DATA_V2'; // D√πng key m·ªõi ƒë·ªÉ tr√°nh xung ƒë·ªôt
  const cachedData = cache.get(CACHE_KEY);

  if (cachedData != null) {
    Logger.log("L·∫•y d·ªØ li·ªáu Thongtinxe t·ª´ CACHE.");
    return JSON.parse(cachedData);
  }

  Logger.log("L·∫•y d·ªØ li·ªáu Thongtinxe t·ª´ SHEET v√† l∆∞u v√†o cache.");
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const thongtinxeSheet = ss.getSheetByName(THONG_TIN_XE_SHEET_NAME);
  if (!thongtinxeSheet) return null;
  
  const data = thongtinxeSheet.getDataRange().getValues();
  // L∆∞u v√†o cache trong 1 gi·ªù (3600 gi√¢y)
  cache.put(CACHE_KEY, JSON.stringify(data), 3600); 
  return data;
}
function sendErrorAlert(functionName, error) {
  try {
    const subject = `[L·ªói H·ªá Th·ªëng] ƒê√£ x·∫£y ra l·ªói nghi√™m tr·ªçng trong h√†m: ${functionName}`;
    const body = `
      <p>M·ªôt l·ªói nghi√™m tr·ªçng ƒë√£ x·∫£y ra trong h·ªá th·ªëng qu·∫£n l√Ω xe.</p>
      <p><b>Th·ªùi gian:</b> ${new Date().toLocaleString('vi-VN')}</p>
      <p><b>H√†m b·ªã l·ªói:</b> ${functionName}</p>
      <p><b>Th√¥ng b√°o l·ªói:</b></p>
      <pre style="background-color: #fcecec; border: 1px solid #f0b6b6; padding: 10px; border-radius: 5px;">${error.message}</pre>
      <p><b>D·∫•u v·∫øt l·ªói (Stack Trace):</b></p>
      <pre style="background-color: #f1f1f1; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">${error.stack}</pre>
    `;
    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: subject,
      htmlBody: body
    });
  } catch (e) {
    Logger.log(`L·ªói khi ƒëang g·ª≠i email c·∫£nh b√°o l·ªói: ${e.message}`);
  }
}
// THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG H√ÄM N√ÄY
function addNotification(message, type = 'info', targetView = null, targetId = null, createdBy = 'H·ªá th·ªëng', recipientName = null) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    // THAY ƒê·ªîI: Th√™m c·ªôt 'Recipient' v√†o ti√™u ƒë·ªÅ
    const NOTIFICATION_HEADERS = ["Timestamp", "Message", "Type", "TargetView", "TargetID", "CreatedBy", "IsRead", "Recipient"];
    const notificationSheet = getOrCreateSheet(ss, NOTIFICATION_SHEET_NAME, NOTIFICATION_HEADERS);
    
    // Th√™m th√¥ng b√°o m·ªõi v√†o ƒë·∫ßu sheet (d√≤ng 2)
    notificationSheet.insertRowBefore(2);
    notificationSheet.getRange(2, 1, 1, NOTIFICATION_HEADERS.length).setValues([[
      new Date(), 
      message, 
      type,
      targetView,
      targetId,
      createdBy,
      'Ch∆∞a ƒë·ªçc',
      recipientName // <-- THAY ƒê·ªîI: Th√™m t√™n ng∆∞·ªùi nh·∫≠n v√†o ƒë√¢y
    ]]);
    // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng th√¥ng b√°o
    const maxNotifications = 200;
    if (notificationSheet.getLastRow() > maxNotifications + 1) {
      notificationSheet.deleteRows(maxNotifications + 2, notificationSheet.getLastRow() - (maxNotifications + 1));
    }
  } catch (e) {
    Logger.log(`L·ªói khi th√™m th√¥ng b√°o: ${e.message}`);
  }
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM markAllNotificationsAsRead C≈®]
function markAllNotificationsAsRead(e) {
  const currentUser = e.parameter.currentUser;
  const isAdmin = e.parameter.isAdmin === 'true'; // L·∫•y c·ªù x√°c ƒë·ªãnh vai tr√≤ Admin

  if (!currentUser) {
      return createJsonResponse({ status: 'ERROR', message: 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh ng∆∞·ªùi d√πng.' });
  }
  
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = getOrCreateSheet(ss, NOTIFICATION_SHEET_NAME, SHEET_HEADERS["ThongBaoWebApp"]);
  if (sheet.getLastRow() < 2) {
    return createJsonResponse({ status: 'SUCCESS', message: 'Kh√¥ng c√≥ th√¥ng b√°o ƒë·ªÉ ƒë√°nh d·∫•u.' });
  }

  const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn());
  const values = dataRange.getValues();
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  const isReadColIndex = headers.indexOf("IsRead");
  const recipientColIndex = headers.indexOf("Recipient");
  
  if (isReadColIndex === -1 || recipientColIndex === -1) {
      return createJsonResponse({ status: 'ERROR', message: 'L·ªói c·∫•u tr√∫c sheet th√¥ng b√°o.' });
  }

  let changesMade = false;
  for (let i = 0; i < values.length; i++) {
    const row = values[i];
    const isUnread = row[isReadColIndex] === 'Ch∆∞a ƒë·ªçc';
    if (!isUnread) continue; // B·ªè qua c√°c th√¥ng b√°o ƒë√£ ƒë·ªçc

    const recipient = String(row[recipientColIndex] || "").trim();
    
    let shouldMarkAsRead = false;
    if (isAdmin) {
        // N·∫øu l√† Admin, ch·ªâ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc c√°c th√¥ng b√°o chung (kh√¥ng c√≥ ng∆∞·ªùi nh·∫≠n) 
        // ho·∫∑c c√°c th√¥ng b√°o g·ª≠i ƒë√≠ch danh cho Admin.
        if (!recipient || recipient === ADMIN_EMAIL) {
            shouldMarkAsRead = true;
        }
    } else {
        // N·∫øu l√† TVBH, ch·ªâ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc c√°c th√¥ng b√°o g·ª≠i ƒë√≠ch danh cho TVBH ƒë√≥.
        if (recipient === currentUser) {
            shouldMarkAsRead = true;
        }
    }

    if (shouldMarkAsRead) {
        values[i][isReadColIndex] = 'ƒê√£ ƒë·ªçc';
        changesMade = true;
    }
  }

  if (changesMade) {
      dataRange.setValues(values);
  }

  return createJsonResponse({ status: 'SUCCESS', message: 'ƒê√£ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc.' });
}
function handleUpdateRowData(params, updatedBy) {
  return doReadWriteLock(() => {
    const { sheetName, primaryKeyColumn, primaryKeyValue, actionId } = params; // Th√™m actionId
    if (!sheetName || !primaryKeyColumn || !primaryKeyValue) {
      throw new Error("Thi·∫øu th√¥ng tin c·∫ßn thi·∫øt ƒë·ªÉ c·∫≠p nh·∫≠t.");
    }
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      throw new Error(`Kh√¥ng t√¨m th·∫•y sheet: ${sheetName}`);
    }
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const primaryKeyColIndex = headers.indexOf(primaryKeyColumn);
    if (primaryKeyColIndex === -1) {
      throw new Error(`Kh√¥ng t√¨m th·∫•y c·ªôt kh√≥a ch√≠nh '${primaryKeyColumn}'.`);
    }
    let rowIndexToUpdate = -1;
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][primaryKeyColIndex]).trim() === String(primaryKeyValue).trim()) {
        rowIndexToUpdate = i + 1;
        break;
      }
    }
    if (rowIndexToUpdate === -1) {
      throw new Error(`Kh√¥ng t√¨m th·∫•y b·∫£n ghi '${primaryKeyValue}'.`);
    }
    const nhatKyChinhSuaSheet = getOrCreateSheet(ss, "NhatKyChinhSua", SHEET_HEADERS["NhatKyChinhSua"]);
    let changesMade = 0;
    for (const key in params) {
      if (key !== 'action' && key !== 'sheetName' && key !== 'primaryKeyColumn' && key !== 'primaryKeyValue' && key !== 'updatedBy' && key !== 'actionId') { // B·ªè qua actionId
        const colIndex = headers.indexOf(key);
        if (colIndex !== -1) {
          const cellToUpdate = sheet.getRange(rowIndexToUpdate, colIndex + 1);
          const oldValue = cellToUpdate.getValue();
          let newValue = params[key];
           if (key.toLowerCase().includes('ng√†y') && newValue) {
                const d = new Date(newValue);
                if (!isNaN(d.getTime())) { newValue = d; }
           }
          if (String(oldValue) !== String(newValue)) {
            cellToUpdate.setValue(newValue);
            nhatKyChinhSuaSheet.appendRow([ new Date(), updatedBy, sheetName, cellToUpdate.getA1Notation(), oldValue, newValue, actionId, "" ]); // Ghi log v·ªõi actionId
            changesMade++;
          }
        }
      }
    }
    if (changesMade > 0) {
        logAction("C·∫≠p nh·∫≠t t·ª´ Web App", `Ng∆∞·ªùi d√πng ${updatedBy} ƒë√£ c·∫≠p nh·∫≠t ${changesMade} tr∆∞·ªùng cho '${primaryKeyValue}' trong sheet '${sheetName}'.`);
        return { message: `ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng ${changesMade} tr∆∞·ªùng d·ªØ li·ªáu.` };
    } else {
        return { message: "Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë∆∞·ª£c th·ª±c hi·ªán." };
    }
  });
}

function importCarsFromExcelLogic(carDataJson, importedBy) {
  try {
    const carData = JSON.parse(carDataJson);
    if (!Array.isArray(carData) || carData.length === 0) {
      return { status: "ERROR", message: "Kh√¥ng c√≥ d·ªØ li·ªáu xe h·ª£p l·ªá ƒë·ªÉ nh·∫≠p." };
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
    const stockData = stockSheet.getDataRange().getValues();
    const stockHeaders = SHEET_HEADERS["KhoXe"];
    const vinColStock = stockHeaders.indexOf("VIN");

    // T·∫°o m·ªôt Set ch·ª©a c√°c VIN ƒë√£ c√≥ ƒë·ªÉ ki·ªÉm tra tr√πng l·∫∑p nhanh h∆°n
    const existingVins = new Set(stockData.slice(1).map(row => String(row[vinColStock] || "").trim().toUpperCase()));

    let successCount = 0;
    let skippedCount = 0;
    let errorCount = 0;
    const newRowsToAppend = [];

    for (const car of carData) {
      const vin = String(car["S·ªê VIN"] || "").trim().toUpperCase();

      // X√°c th·ª±c d·ªØ li·ªáu
      if (!vin || vin.length !== 17) {
        errorCount++;
        logAction("L·ªói Nh·∫≠p Excel", `VIN kh√¥ng h·ª£p l·ªá ho·∫∑c b·ªã thi·∫øu: '${vin}'`);
        continue; // B·ªè qua d√≤ng n√†y
      }

      // Ki·ªÉm tra tr√πng l·∫∑p
      if (existingVins.has(vin)) {
        skippedCount++;
        continue; // B·ªè qua xe ƒë√£ t·ªìn t·∫°i
      }

      // Chu·∫©n b·ªã d√≤ng m·ªõi ƒë·ªÉ th√™m v√†o sheet
      const newRow = stockHeaders.map(header => {
        switch (header) {
          case "VIN":           return vin;
          case "D√≤ng xe":       return car["D√≤ng xe"] || "";
          case "Phi√™n b·∫£n":      return car["Phi√™n b·∫£n"] || "";
          case "Ngo·∫°i th·∫•t":    return car["Ngo·∫°i th·∫•t"] || "";
          case "N·ªôi th·∫•t":       return car["N·ªôi th·∫•t"] || "";
          case "M√£ DMS":        return car["M√£ DMS"] || "";
          case "Tr·∫°ng th√°i":    return "Ch∆∞a gh√©p";
          case "Ng√†y nh·∫≠p":     return new Date();
          case "ƒê√£ th√¥ng b√°o":  return "";
          default:              return "";
        }
      });
      
      newRowsToAppend.push(newRow);
      existingVins.add(vin); // Th√™m v√†o Set ƒë·ªÉ tr√°nh th√™m tr√πng l·∫∑p trong c√πng m·ªôt l·∫ßn nh·∫≠p
      successCount++;
    }

    // Th√™m t·∫•t c·∫£ c√°c d√≤ng h·ª£p l·ªá v√†o sheet m·ªôt l·∫ßn ƒë·ªÉ tƒÉng hi·ªáu su·∫•t
    if (newRowsToAppend.length > 0) {
      stockSheet.getRange(stockSheet.getLastRow() + 1, 1, newRowsToAppend.length, stockHeaders.length).setValues(newRowsToAppend);
      // Ghi l·ªãch s·ª≠ cho t·ª´ng xe ƒë∆∞·ª£c th√™m
      newRowsToAppend.forEach(row => {
          const addedVin = row[vinColStock];
          recordVehicleHistory(addedVin, "Nh·∫≠p Kho (Excel)", `Xe ƒë√£ ƒë∆∞·ª£c nh·∫≠p h√†ng lo·∫°t b·ªüi ${importedBy}.`);
      });
    }

    // T·∫°o th√¥ng b√°o k·∫øt qu·∫£
    let message = `Nh·∫≠p ho√†n t·∫•t! ƒê√£ th√™m th√†nh c√¥ng ${successCount} xe.`;
    if (skippedCount > 0) {
      message += ` B·ªè qua ${skippedCount} xe do ƒë√£ t·ªìn t·∫°i.`;
    }
    if (errorCount > 0) {
      message += ` C√≥ ${errorCount} d√≤ng b·ªã l·ªói (VIN kh√¥ng h·ª£p l·ªá).`;
    }

    logAction("Nh·∫≠p Excel Ho√†n T·∫•t", message);
    addNotification(`${importedBy} ƒë√£ nh·∫≠p ${successCount} xe t·ª´ file Excel.`, 'success', 'khoXe');
    
    return { status: "SUCCESS", message: message };

  } catch (e) {
    Logger.log(`L·ªói nghi√™m tr·ªçng trong importCarsFromExcelLogic: ${e.message}, Stack: ${e.stack}`);
    sendErrorAlert('importCarsFromExcelLogic', e);
    return { status: "ERROR", message: `L·ªói m√°y ch·ªß khi x·ª≠ l√Ω file: ${e.message}` };
  }
}

/**
 * [H√ÄM ƒê√É S·ª¨A ƒê·ªîI] - X·ª≠ l√Ω khi Admin chuy·ªÉn tr·∫°ng th√°i sang "Ch·ªù k√Ω h√≥a ƒë∆°n".
 * T·ª± ƒë·ªông ghi nh·∫≠n ng√†y xu·∫•t h√≥a ƒë∆°n v√† ƒë√°nh d·∫•u tick v√†o c·ªôt "B√ÅO B√ÅN".
 */
function handleMarkAsPendingSignature(orderNumber, userEmail, actionId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = getSheets(ss);
  const { daGhepSheet, xuathoadonSheet, nhatKyChinhSuaSheet } = sheets;

  const xuathoadonData = xuathoadonSheet.getDataRange().getValues();
  const xuathoadonHeaders = SHEET_HEADERS["Xuathoadon"];
  const soDonHangColXHD = xuathoadonHeaders.indexOf("S·ªê ƒê∆†N H√ÄNG");
  const vinColXHD = xuathoadonHeaders.indexOf("S·ªê VIN");
  const tvbhColXHD = xuathoadonHeaders.indexOf("T∆Ø V·∫§N B√ÅN H√ÄNG");
  const ngayXuatHDColXHD = xuathoadonHeaders.indexOf("NG√ÄY XU·∫§T H√ìA ƒê∆†N");
  
  // ----- D√íNG M·ªöI B·∫ÆT ƒê·∫¶U -----
  const baoBanColXHD = xuathoadonHeaders.indexOf("B√ÅO B√ÅN"); // L·∫•y ch·ªâ s·ªë c·ªôt "B√ÅO B√ÅN"
  // ----- D√íNG M·ªöI K·∫æT TH√öC -----

  let rowIndexInXuathoadon = -1;
  let vin = "";
  let tvbhName = "";

  for (let i = 1; i < xuathoadonData.length; i++) {
    if (String(xuathoadonData[i][soDonHangColXHD] || "").trim() === String(orderNumber).trim()) {
      rowIndexInXuathoadon = i + 1;
      vin = String(xuathoadonData[i][vinColXHD] || "").trim();
      tvbhName = String(xuathoadonData[i][tvbhColXHD] || "").trim();
      break;
    }
  }

  if (rowIndexInXuathoadon === -1) {
    throw new Error(`Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ${orderNumber} trong sheet Xuathoadon.`);
  }

  // Ghi nh·∫≠n ng√†y xu·∫•t h√≥a ƒë∆°n (logic c≈©, gi·ªØ nguy√™n)
  if (ngayXuatHDColXHD !== -1) {
    xuathoadonSheet.getRange(rowIndexInXuathoadon, ngayXuatHDColXHD + 1)
                   .setValue(new Date())
                   .setNumberFormat("dd/MM/yyyy");
    logAction("C·∫≠p nh·∫≠t Ng√†y XHƒê", `ƒê√£ t·ª± ƒë·ªông ghi nh·∫≠n ng√†y XHƒê cho ƒë∆°n h√†ng ${orderNumber} khi chuy·ªÉn sang 'Ch·ªù k√Ω Hƒê'.`);
  }

  // ----- KH·ªêI L·ªÜNH M·ªöI B·∫ÆT ƒê·∫¶U -----
  // T·ª± ƒë·ªông ƒë√°nh d·∫•u tick v√†o c·ªôt "B√ÅO B√ÅN"
  if (baoBanColXHD !== -1) {
    // L·∫•y √¥ c·∫ßn c·∫≠p nh·∫≠t v√† check v√†o ƒë√≥ (gi√° tr·ªã TRUE)
    xuathoadonSheet.getRange(rowIndexInXuathoadon, baoBanColXHD + 1).check();
    logAction("C·∫≠p nh·∫≠t B√°o B√°n", `ƒê√£ t·ª± ƒë·ªông tick B√ÅO B√ÅN cho ƒë∆°n h√†ng ${orderNumber}.`);
  }
  // ----- KH·ªêI L·ªÜNH M·ªöI K·∫æT TH√öC -----

  const daGhepData = sheets.daGhepSheet.getDataRange().getValues();
  const daGhepHeaders = SHEET_HEADERS["DaGhep"];
  const vinColDaghep = daGhepHeaders.indexOf("VIN");
  const ketQuaColDaghep = daGhepHeaders.indexOf("K·∫øt qu·∫£");

  for (let i = 1; i < daGhepData.length; i++) {
    if (String(daGhepData[i][vinColDaghep]).trim() === vin) {
      updateCellAndLog(daGhepSheet, i + 1, ketQuaColDaghep + 1, "Ch·ªù k√Ω h√≥a ƒë∆°n", userEmail, actionId, nhatKyChinhSuaSheet);
      break;
    }
  }

  recordOrderHistory(orderNumber, vin, "Chuy·ªÉn sang Ch·ªù k√Ω h√≥a ƒë∆°n", `K√≠ch ho·∫°t b·ªüi ${userEmail}`);
  recordVehicleHistory(vin, "Chuy·ªÉn sang Ch·ªù k√Ω h√≥a ƒë∆°n", `ƒê∆°n h√†ng ${orderNumber}`);
  return { success: true, message: `ƒê√£ chuy·ªÉn ƒë∆°n h√†ng ${orderNumber} sang tr·∫°ng th√°i "Ch·ªù k√Ω h√≥a ƒë∆°n".`, tvbhName: tvbhName };
}
function getFileBlobFromUrl(formulaString) {
  if (!formulaString || !formulaString.toUpperCase().startsWith("=HYPERLINK")) {
    return null;
  }
  try {
    const urlMatch = formulaString.match(/=HYPERLINK\("([^"]+)"/i);
    if (urlMatch && urlMatch[1]) {
      const url = urlMatch[1];
      const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9_-]{25,})|id=([a-zA-Z0-9_-]{25,})/);
      if (fileIdMatch) {
        const fileId = fileIdMatch[1] || fileIdMatch[2];
        if (fileId) {
          const file = DriveApp.getFileById(fileId);
          return file.getBlob();
        }
      }
    }
  } catch (e) {
    logAction("L·ªói getFileBlobFromUrl", `Kh√¥ng th·ªÉ l·∫•y file t·ª´ c√¥ng th·ª©c: ${formulaString}. L·ªói: ${e.message}`);
    return null;
  }
  return null;
}

function resendNotificationEmail(orderNumber, emailType, userEmail) {
¬† const ss = SpreadsheetApp.getActiveSpreadsheet();
¬† const sheets = getSheets(ss);
¬† const { daGhepSheet, xuathoadonSheet, stockSheet, mailSheet } = sheets;

¬† try {
¬† ¬† switch (emailType) {
¬† ¬† ¬† case 'match_success': {
¬† ¬† ¬† ¬† const rowData = findRowByKeyValue(daGhepSheet, "S·ªë ƒë∆°n h√†ng", orderNumber);
¬† ¬† ¬† ¬† if (!rowData) throw new Error("Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng trong sheet DaGhep.");
¬† ¬† ¬† ¬† const orderDataForEmail = {
¬† ¬† ¬† ¬† ¬† ten_ban_hang: rowData["T√™n t∆∞ v·∫•n b√°n h√†ng"],
¬† ¬† ¬† ¬† ¬† ten_khach_hang: rowData["T√™n kh√°ch h√†ng"],
¬† ¬† ¬† ¬† ¬† dong_xe: rowData["D√≤ng xe"], phien_ban: rowData["Phi√™n b·∫£n"],
¬† ¬† ¬† ¬† ¬† ngoai_that: rowData["Ngo·∫°i th·∫•t"], noi_that: rowData["N·ªôi th·∫•t"],
¬† ¬† ¬† ¬† ¬† so_don_hang: orderNumber, ngay_coc: rowData["Ng√†y c·ªçc"],
¬† ¬† ¬† ¬† ¬† thoi_gian_nhap: rowData["Th·ªùi gian nh·∫≠p"]
¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† const vin = rowData["VIN"];
¬† ¬† ¬† ¬† const stockRow = findRowByKeyValue(stockSheet, "VIN", vin);
¬† ¬† ¬† ¬† const maDMS = stockRow ? stockRow["M√£ DMS"] : "";
¬† ¬† ¬† ¬† const success = sendEmailNotification(mailSheet, orderDataForEmail, vin, maDMS, new Date());
¬† ¬† ¬† ¬† if (!success) throw new Error("L·ªói h·ªá th·ªëng khi c·ªë g·∫Øng g·ª≠i email.");
¬† ¬† ¬† ¬† recordOrderHistory(orderNumber, vin, "G·ª≠i l·∫°i Email Gh√©p Xe", `G·ª≠i l·∫°i b·ªüi ${userEmail}`);
¬† ¬† ¬† ¬† return { success: true, message: "ƒê√£ g·ª≠i l·∫°i email th√¥ng b√°o gh√©p xe th√†nh c√¥ng!" };
¬† ¬† ¬† }

¬† ¬† ¬† case 'invoice_issued': {
¬† ¬† ¬† ¬† const rowData = findRowByKeyValue(xuathoadonSheet, "S·ªê ƒê∆†N H√ÄNG", orderNumber);
¬† ¬† ¬† ¬† if (!rowData) throw new Error("Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng trong sheet Xuathoadon.");
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† const daGhepRowData = findRowByKeyValue(daGhepSheet, "S·ªë ƒë∆°n h√†ng", orderNumber);
¬† ¬† ¬† ¬† if (!daGhepRowData) throw new Error("Kh√¥ng t√¨m th·∫•y th√¥ng tin g·ªëc c·ªßa ƒë∆°n h√†ng trong DaGhep.");
¬† ¬† ¬† ¬† const invoiceFileBlob = getFileBlobFromUrl(rowData["URL H√≥a ƒê∆°n ƒê√£ Xu·∫•t"]);
¬† ¬† ¬† ¬† if (!invoiceFileBlob) throw new Error("Kh√¥ng t√¨m th·∫•y file h√≥a ƒë∆°n ƒë√≠nh k√®m tr√™n Drive. C√≥ th·ªÉ file ƒë√£ b·ªã x√≥a.");
¬† ¬† ¬† ¬† const orderDataForEmail = {
¬† ¬† ¬† ¬† ¬† ¬† so_don_hang: orderNumber,
¬† ¬† ¬† ¬† ¬† ¬† ten_khach_hang: daGhepRowData["T√™n kh√°ch h√†ng"],
¬† ¬† ¬† ¬† ¬† 	ten_tu_van_ban_hang: daGhepRowData["T√™n t∆∞ v·∫•n b√°n h√†ng"],
¬† ¬† ¬† ¬† ¬† 	vin: rowData["S·ªê VIN"],
¬† ¬† ¬† ¬† ¬† 	dong_xe: daGhepRowData["D√≤ng xe"],
¬† ¬† ¬† ¬† ¬† 	phien_ban: daGhepRowData["Phi√™n b·∫£n"],
¬† ¬† ¬† ¬† ¬† 	ngoai_that: daGhepRowData["Ngo·∫°i th·∫•t"],
¬† ¬† ¬† ¬† ¬† 	noi_that: daGhepRowData["N·ªôi th·∫•t"]
¬† ¬† ¬† ¬† };
¬† ¬† ¬† 	const rowIndexInXuathoadon = findRowIndexByKeyValue(xuathoadonSheet, "S·ªê ƒê∆†N H√ÄNG", orderNumber);
¬† ¬† ¬† 	const success = sendIssuedInvoiceWithAttachment(mailSheet, orderDataForEmail, invoiceFileBlob, xuathoadonSheet, rowIndexInXuathoadon);
¬† ¬† ¬† 	if (!success) throw new Error("L·ªói h·ªá th·ªëng khi c·ªë g·∫Øng g·ª≠i email.");
¬† ¬† ¬† 	recordOrderHistory(orderNumber, rowData["S·ªê VIN"], "G·ª≠i l·∫°i Email H√≥a ƒê∆°n", `G·ª≠i l·∫°i b·ªüi ${userEmail}`);
¬† ¬† ¬† 	return { success: true, message: "ƒê√£ g·ª≠i l·∫°i email h√≥a ƒë∆°n ƒë√£ ph√°t h√†nh th√†nh c√¥ng!" };
¬† ¬† 	}
¬† ¬† ¬† 
¬† ¬† 	case 'invoice_request_supplement': {
¬† ¬† ¬† 	const rowData = findRowByKeyValue(daGhepSheet, "S·ªë ƒë∆°n h√†ng", orderNumber);
¬† ¬† ¬† 	if (!rowData) throw new Error("Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng trong sheet DaGhep.");
¬† ¬† 	const orderData = {
¬† ¬† ¬† ¬† ¬† 	ten_ban_hang: rowData["T√™n t∆∞ v·∫•n b√°n h√†ng"],
¬† ¬† ¬† ¬† ¬† 	ten_khach_hang: rowData["T√™n kh√°ch h√†ng"],
¬† ¬† ¬† ¬† ¬† 	so_don_hang: orderNumber,
¬† ¬† ¬† ¬† ¬† 	vin: rowData["VIN"]
¬† ¬† ¬† 	};
¬† ¬† 	const reason = "[G·ª¨I L·∫†I] Vui l√≤ng ki·ªÉm tra v√† b·ªï sung h·ªì s∆° theo y√™u c·∫ßu tr∆∞·ªõc ƒë√≥.";
¬† ¬† 	sendSupplementRequestEmail(mailSheet, orderData, reason);
¬† ¬† ¬† 	recordOrderHistory(orderNumber, orderData.vin, "G·ª≠i l·∫°i Email YCBS", `G·ª≠i l·∫°i b·ªüi ${userEmail}`);
¬† ¬† 	return { success: true, message: "ƒê√£ g·ª≠i l·∫°i email y√™u c·∫ßu b·ªï sung h·ªì s∆°." };
¬† 	}

¬† ¬† 	case 'vc_request_received': {
¬† ¬† ¬† 	const yeuCauVcSheet = ss.getSheetByName(YEU_CAU_VC_SHEET_NAME);
¬† ¬† ¬† 	const rowData = findRowByKeyValue(yeuCauVcSheet, "S·ªë ƒë∆°n h√†ng", orderNumber);
¬† ¬† ¬† 	if (!rowData) throw new Error("Kh√¥ng t√¨m th·∫•y Y√™u c·∫ßu VinClub cho ƒë∆°n h√†ng n√†y trong sheet YeuCauVC.");

¬† ¬† ¬† 	const emailData = {
¬† ¬† ¬† ¬† 	ten_ban_hang: rowData["Ng∆∞·ªùi YC"],
¬† ¬† ¬† ¬† 	so_don_hang: orderNumber,
¬† ¬† ¬† ¬† 	ten_khach_hang: rowData["T√™n kh√°ch h√†ng"],
¬† ¬† ¬† ¬† 	vin: rowData["VIN"],
¬† ¬† ¬† ¬† 	customerType: rowData["Lo·∫°i YC"] === "C√° Nh√¢n" ? 'personal' : 'company',
¬† ¬† ¬† ¬† 	dmsCode: rowData["M√£ KH DMS"]
¬† ¬† 	};
¬† ¬† ¬† 	
¬† ¬† ¬† 	const success = sendVcRequestConfirmationEmailToTVBH(mailSheet, emailData);
¬† ¬† ¬† 	if (!success) throw new Error("L·ªói h·ªá th·ªëng khi c·ªë g·∫Øng g·ª≠i email.");
¬† ¬† ¬† 	
¬† ¬† ¬† 	recordOrderHistory(orderNumber, rowData["VIN"], "G·ª≠i l·∫°i Email Y/C VC", `G·ª≠i l·∫°i b·ªüi ${userEmail}`);
¬† ¬† ¬† 	return { success: true, message: "ƒê√£ g·ª≠i l·∫°i email x√°c nh·∫≠n y√™u c·∫ßu VinClub!" };
¬† ¬† 	}

¬† ¬† 	default:
¬† ¬† 		throw new Error(`Lo·∫°i email "${emailType}" kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ ƒë·ªÉ g·ª≠i l·∫°i.`);
¬† 	}
¬† } catch (e) {
¬† ¬† Logger.log(`L·ªói trong resendNotificationEmail: ${e.message}. Stack: ${e.stack}`);
¬† 	return { success: false, message: e.message };
¬† }
}
function findRowByKeyValue(sheet, keyColumn, keyValue) {
  const range = sheet.getDataRange();
  const values = range.getValues();
  const formulas = range.getFormulas(); // L·∫•y c·∫£ m·∫£ng c√¥ng th·ª©c
  
  if (values.length < 1) return null;

  const headers = values[0];
  const keyColIndex = headers.indexOf(keyColumn);

  if (keyColIndex === -1) {
    logAction("L·ªói findRowByKeyValue", `Kh√¥ng t√¨m th·∫•y c·ªôt kh√≥a '${keyColumn}' trong sheet '${sheet.getName()}'.`);
    return null;
  }

  for (let i = 1; i < values.length; i++) {
    if (String(values[i][keyColIndex] || "").trim() === String(keyValue).trim()) {
      const rowObject = {};
      headers.forEach((header, index) => {
        // ∆Øu ti√™n l·∫•y c√¥ng th·ª©c n·∫øu √¥ ƒë√≥ c√≥ c√¥ng th·ª©c.
        // N·∫øu kh√¥ng, l·∫•y gi√° tr·ªã hi·ªÉn th·ªã.
        if (formulas[i][index]) {
           rowObject[header] = formulas[i][index];
        } else {
           rowObject[header] = values[i][index];
        }
      });
      return rowObject;
    }
  }
  return null;
}
function sendUnmatchNotificationEmail(mailSheet, data, vin, reason, unmatchedBy) {
  const tenTVBH = data.ten_ban_hang;
  const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);
  if (!recipientEmail) {
    logAction("L·ªói g·ª≠i email H·ªßy Gh√©p", `Kh√¥ng t√¨m th·∫•y email cho ${tenTVBH}, ƒë∆°n ${data.so_don_hang}`);
    return false;
  }

  const subject = `[C·∫¢NH B√ÅO] ƒê∆°n h√†ng ${data.so_don_hang} ƒë√£ ƒë∆∞·ª£c h·ªßy gh√©p xe`;
  const details = {
    "S·ªë ƒë∆°n h√†ng": `<b>${data.so_don_hang}</b>`,
    "T√™n kh√°ch h√†ng": data.ten_khach_hang,
    "VIN ƒë√£ h·ªßy gh√©p": vin || "N/A",
    "L√Ω do": reason,
    "Ng∆∞·ªùi th·ª±c hi·ªán": unmatchedBy,
    "Tr·∫°ng th√°i m·ªõi": "ƒê√£ chuy·ªÉn v·ªÅ h√†ng ch·ªù"
  };
  const note = "ƒê∆°n h√†ng n√†y ƒë√£ ƒë∆∞·ª£c ƒë∆∞a tr·ªü l·∫°i danh s√°ch ch·ªù gh√©p. Vui l√≤ng ki·ªÉm tra l·∫°i ho·∫∑c li√™n h·ªá Admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ gh√©p xe kh√°c.";
  const bodyContent = createUnifiedEmailBody("M·ªôt ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c h·ªßy gh√©p:", tenTVBH, details, note, 'warning');
  const fullHtml = createFullHtmlEmail(subject, bodyContent);

  try {
    MailApp.sendEmail({ to: recipientEmail, subject: subject, htmlBody: fullHtml });
    logAction("G·ª≠i email H·ªßy Gh√©p th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho ƒë∆°n ${data.so_don_hang}`);
    return true;
  } catch (e) {
    logAction("L·ªói g·ª≠i email H·ªßy Gh√©p", `Email: ${recipientEmail}, ƒê∆°n: ${data.so_don_hang}, L·ªói: ${e.message}`);
    return false;
  }
}
function findRowIndexByKeyValue(sheet, keyColumn, keyValue) {
    const data = sheet.getDataRange().getValues();
    if (data.length < 1) return -1;
    
    const headers = data[0];
    const keyColIndex = headers.indexOf(keyColumn);

    if (keyColIndex === -1) {
        return -1;
    }

    for (let i = 1; i < data.length; i++) {
        if (String(data[i][keyColIndex] || "").trim() === String(keyValue).trim()) {
            return i + 1; // Tr·∫£ v·ªÅ ch·ªâ s·ªë d√≤ng 1-based
        }
    }
    return -1; // Kh√¥ng t√¨m th·∫•y
}
function getOrderHistory(orderNumber) {
  if (!orderNumber) {
    return [];
  }
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const historySheet = ss.getSheetByName("lichsu_donhang");
    if (!historySheet) return [];

    const data = historySheet.getDataRange().getValues();
    const headers = data[0];
    const orderColIndex = headers.indexOf("S·ªë ƒë∆°n h√†ng");

    if (orderColIndex === -1) return [];

    const filteredData = data.slice(1).filter(row => String(row[orderColIndex]).trim() === String(orderNumber).trim());

    // S·∫Øp x·∫øp theo th·ªùi gian t·ª´ c≈© nh·∫•t ƒë·∫øn m·ªõi nh·∫•t
    filteredData.sort((a, b) => new Date(a[0]) - new Date(b[0])); 

    const result = filteredData.map(row => {
      const rowObject = {};
      headers.forEach((header, index) => {
        rowObject[header] = row[index];
      });
      return rowObject;
    });

    return result;
  } catch (e) {
    logAction("L·ªói getOrderHistory", `L·ªói khi l·∫•y l·ªãch s·ª≠ cho ƒêH ${orderNumber}: ${e.message}`);
    return [];
  }
}
function handleAddDepositInfo(e) {
  try {
    const customerName = e.parameter.customerName;
    const depositDate = e.parameter.depositDate;
    const addedBy = e.parameter.addedBy || "Admin Web App";

    // 1. Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
    if (!customerName || !depositDate) {
      throw new Error("Vui l√≤ng cung c·∫•p ƒë·∫ßy ƒë·ªß T√™n kh√°ch h√†ng v√† Ng√†y c·ªçc.");
    }

    const dateObject = new Date(depositDate);
    if (isNaN(dateObject.getTime())) {
      throw new Error("Ng√†y c·ªçc kh√¥ng h·ª£p l·ªá.");
    }

    // 2. L·∫•y sheet v√† ghi d·ªØ li·ªáu
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID); //
    const cocXeSheet = getOrCreateSheet(ss, COC_XE_SHEET_NAME, SHEET_HEADERS["CocXe"]); //

    // 3. Chu·∫©n b·ªã d√≤ng m·ªõi v·ªõi c√°c thay ƒë·ªïi theo y√™u c·∫ßu
    
    // THAY ƒê·ªîI 1: Ch·ªâ l∆∞u Ng√†y/Th√°ng/NƒÉm
    const formattedDate = Utilities.formatDate(dateObject, "GMT+7", "dd/MM/yyyy");

    const newRow = [
      customerName.trim(),
      formattedDate,
      '' // THAY ƒê·ªîI 2: ƒê·ªÉ tr·ªëng tr·∫°ng th√°i s·ª≠ d·ª•ng
    ];

    // 4. Th√™m d√≤ng m·ªõi v√†o sheet
    cocXeSheet.appendRow(newRow);

    // 5. Ghi log v√† tr·∫£ v·ªÅ th√†nh c√¥ng
    logAction("Th√™m th√¥ng tin c·ªçc", `ƒê√£ th√™m c·ªçc cho KH: ${customerName} b·ªüi ${addedBy}`); //
    return createJsonResponse({ status: "SUCCESS", message: `ƒê√£ th√™m th√¥ng tin c·ªçc cho kh√°ch h√†ng '${customerName}' th√†nh c√¥ng!` }); //

  } catch (error) {
    Logger.log(`L·ªói trong handleAddDepositInfo: ${error.message}`);
    sendErrorAlert('handleAddDepositInfo', error); //
    return createJsonResponse({ status: "ERROR", message: `L·ªói m√°y ch·ªß: ${error.message}` });
  }
}
function handleAddBatchDeposits(e) {
  try {
    const depositsJson = e.parameter.deposits;
    const addedBy = e.parameter.addedBy || "Admin Web App";

    if (!depositsJson) {
      throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu c·ªçc ƒë∆∞·ª£c cung c·∫•p.");
    }

    const deposits = JSON.parse(depositsJson);
    if (!Array.isArray(deposits) || deposits.length === 0) {
      return createJsonResponse({ status: "SUCCESS", message: "Kh√¥ng c√≥ d√≤ng n√†o h·ª£p l·ªá ƒë·ªÉ th√™m." });
    }

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const cocXeSheet = getOrCreateSheet(ss, COC_XE_SHEET_NAME, SHEET_HEADERS["CocXe"]); //

    const rowsToAppend = [];
    let errorCount = 0;

    for (const deposit of deposits) {
      const customerName = deposit.customerName;
      const dateObject = new Date(deposit.depositDate);

      // B·ªè qua n·∫øu d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
      if (!customerName || isNaN(dateObject.getTime())) {
        errorCount++;
        continue;
      }
      
      const formattedDate = Utilities.formatDate(dateObject, "GMT+7", "dd/MM/yyyy");
      rowsToAppend.push([customerName, formattedDate, '']);
    }

    // Ghi t·∫•t c·∫£ c√°c d√≤ng h·ª£p l·ªá v√†o sheet trong m·ªôt l·∫ßn
    if (rowsToAppend.length > 0) {
      cocXeSheet.getRange(cocXeSheet.getLastRow() + 1, 1, rowsToAppend.length, 3).setValues(rowsToAppend);
    }

    // T·∫°o th√¥ng b√°o k·∫øt qu·∫£
    let message = `ƒê√£ th√™m th√†nh c√¥ng ${rowsToAppend.length} th√¥ng tin c·ªçc.`;
    if (errorCount > 0) {
      message += ` B·ªè qua ${errorCount} d√≤ng do l·ªói ƒë·ªãnh d·∫°ng.`;
    }

    logAction("Th√™m th√¥ng tin c·ªçc (H√†ng lo·∫°t)", message);
    return createJsonResponse({ status: "SUCCESS", message: message });

  } catch (error) {
    Logger.log(`L·ªói trong handleAddBatchDeposits: ${error.message}`);
    sendErrorAlert('handleAddBatchDeposits', error); //
    return createJsonResponse({ status: "ERROR", message: `L·ªói m√°y ch·ªß: ${error.message}` });
  }
}
function archiveFilesByMonth(year = null, month = null) {
  const FOLDER_ID_GOC = DRIVE_FOLDER_ID;
  Logger.log("B·∫Øt ƒë·∫ßu qu√° tr√¨nh l∆∞u tr·ªØ file v√† d·ªçn d·∫πp...");

  try {
    let namLuuTru, thangLuuTru;

    if (year === null || month === null) {
      Logger.log("Ch·∫°y ·ªü ch·∫ø ƒë·ªô t·ª± ƒë·ªông cho th√°ng tr∆∞·ªõc.");
      const homNay = new Date();
      const ngayDauThangNay = new Date(homNay.getFullYear(), homNay.getMonth(), 1);
      const ngayCuoiThangTruoc = new Date(ngayDauThangNay.getTime() - 1);
      namLuuTru = ngayCuoiThangTruoc.getFullYear();
      thangLuuTru = ngayCuoiThangTruoc.getMonth() + 1;
    } else {
      Logger.log(`Ch·∫°y ·ªü ch·∫ø ƒë·ªô TEST cho th√°ng ${month}/${year}.`);
      namLuuTru = year;
      thangLuuTru = month;
    }

    const tenThuMucNguon = `${namLuuTru}-${String(thangLuuTru).padStart(2, '0')}`;
    const tenThuMucLuuTru = `Archive_${tenThuMucNguon}`;

    Logger.log(`ƒêang t√¨m ki·∫øm th∆∞ m·ª•c ngu·ªìn: "${tenThuMucNguon}" ƒë·ªÉ l∆∞u tr·ªØ.`);

    const thuMucGoc = DriveApp.getFolderById(FOLDER_ID_GOC);
    const cacThuMucNguon = thuMucGoc.getFoldersByName(tenThuMucNguon);

    if (!cacThuMucNguon.hasNext()) {
      Logger.log(`Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c ngu·ªìn "${tenThuMucNguon}". K·∫øt th√∫c qu√° tr√¨nh.`);
      SpreadsheetApp.getUi().alert(`Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c ngu·ªìn "${tenThuMucNguon}" ƒë·ªÉ l∆∞u tr·ªØ.`);
      return;
    }
    const thuMucNguon = cacThuMucNguon.next();

    const thuMucLuuTru = getOrCreateSubFolder(thuMucGoc, tenThuMucLuuTru);
    const thuMucHoaDon = getOrCreateSubFolder(thuMucLuuTru, "H√≥a ƒë∆°n");
    const thuMucHDMB = getOrCreateSubFolder(thuMucLuuTru, "HƒêMB");
    const thuMucDNXHD = getOrCreateSubFolder(thuMucLuuTru, "ƒêNXHƒê");

    Logger.log(`ƒê√£ t·∫°o/x√°c nh·∫≠n c√°c th∆∞ m·ª•c l∆∞u tr·ªØ trong: "${tenThuMucLuuTru}"`);

    let thongKe = { daDiChuyen: 0, daBoQua: 0 };
    processFolderRecursively(thuMucNguon, thuMucHoaDon, thuMucHDMB, thuMucDNXHD, thongKe);

    // === PH·∫¶N M·ªöI: X√ìA TH∆Ø M·ª§C NGU·ªíN SAU KHI HO√ÄN T·∫§T ===
    try {
      if (thongKe.daDiChuyen > 0) { // Ch·ªâ x√≥a n·∫øu th·ª±c s·ª± c√≥ file ƒë∆∞·ª£c di chuy·ªÉn
        thuMucNguon.setTrashed(true);
        Logger.log(`ƒê√É X√ìA: Chuy·ªÉn th∆∞ m·ª•c ngu·ªìn "${tenThuMucNguon}" v√†o th√πng r√°c.`);
      } else {
        Logger.log(`B·ªé QUA X√ìA: Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c di chuy·ªÉn t·ª´ th∆∞ m·ª•c ngu·ªìn "${tenThuMucNguon}".`);
      }
    } catch (err) {
      Logger.log(`L·ªói khi c·ªë g·∫Øng x√≥a th∆∞ m·ª•c ngu·ªìn "${tenThuMucNguon}": ${err.toString()}`);
    }
    // =======================================================

    let noiDungBaoCao = `Qu√° tr√¨nh l∆∞u tr·ªØ file cho th√°ng ${thangLuuTru}/${namLuuTru} ƒë√£ ho√†n t·∫•t.\n\n- S·ªë file ƒë√£ di chuy·ªÉn: ${thongKe.daDiChuyen}\n- S·ªë file b·ªã b·ªè qua: ${thongKe.daBoQua}\n\nC√°c file ƒë√£ ƒë∆∞·ª£c chuy·ªÉn v√†o th∆∞ m·ª•c: "${tenThuMucLuuTru}".`;
    
    if (thongKe.daDiChuyen > 0) {
      noiDungBaoCao += `\n\nTh∆∞ m·ª•c ngu·ªìn "${tenThuMucNguon}" ƒë√£ ƒë∆∞·ª£c d·ªçn d·∫πp v√† chuy·ªÉn v√†o th√πng r√°c.`;
    }

    Logger.log(noiDungBaoCao);

    if (year === null) {
        MailApp.sendEmail(ADMIN_EMAIL,
            `[B√°o C√°o] Ho√†n t·∫•t L∆∞u tr·ªØ File th√°ng ${thangLuuTru}/${namLuuTru}`,
            noiDungBaoCao
        );
    }

  } catch (e) {
    Logger.log(`L·ªñI NGHI√äM TR·ªåNG trong qu√° tr√¨nh l∆∞u tr·ªØ file: ${e.toString()}`);
    sendErrorAlert('archiveFilesByMonth', e);
  }
}
function processFolderRecursively(thuMucHienTai, dichHoaDon, dichHDMB, dichDNXHD, thongKe) {
  // X·ª≠ l√Ω c√°c file trong th∆∞ m·ª•c hi·ªán t·∫°i
  const files = thuMucHienTai.getFiles();
  while (files.hasNext()) {
    const file = files.next();
    const tenFile = file.getName();
    let daDiChuyen = false;

    // Di chuy·ªÉn file d·ª±a v√†o t√™n
    if (tenFile.toLowerCase().startsWith('h√≥a ƒë∆°n')) {
      file.moveTo(dichHoaDon);
      thongKe.daDiChuyen++;
      daDiChuyen = true;
    } else if (tenFile.toLowerCase().startsWith('hƒëmb')) {
      file.moveTo(dichHDMB);
      thongKe.daDiChuyen++;
      daDiChuyen = true;
    } else if (tenFile.toLowerCase().startsWith('ƒënxhƒë')) {
      file.moveTo(dichDNXHD);
      thongKe.daDiChuyen++;
      daDiChuyen = true;
    } else {
      thongKe.daBoQua++;
    }

    if (daDiChuyen) {
      Logger.log(`ƒê√£ di chuy·ªÉn file: ${tenFile}`);
    }
  }

  // L·∫∑p l·∫°i quy tr√¨nh cho c√°c th∆∞ m·ª•c con
  const subFolders = thuMucHienTai.getFolders();
  while (subFolders.hasNext()) {
    const subFolder = subFolders.next();
    // B·ªè qua vi·ªác x√≥a th∆∞ m·ª•c r·ªóng ƒë·ªÉ gi·ªØ l·∫°i c·∫•u tr√∫c cho vi·ªác tra c·ª©u sau n√†y n·∫øu c·∫ßn
    processFolderRecursively(subFolder, dichHoaDon, dichHDMB, dichDNXHD, thongKe);
  }
}
function runFileArchiveManually() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'Ch·∫°y Ch·ª©c NƒÉng L∆∞u Tr·ªØ File',
    'Nh·∫≠p th√°ng c·∫ßn l∆∞u tr·ªØ theo ƒë·ªãnh d·∫°ng YYYY-MM (v√≠ d·ª•: 2025-04).\n\nƒê·ªÉ tr·ªëng v√† nh·∫•n OK ƒë·ªÉ t·ª± ƒë·ªông ch·∫°y cho th√°ng tr∆∞·ªõc.',
    ui.ButtonSet.OK_CANCEL
  );

  // D·ª´ng l·∫°i n·∫øu ng∆∞·ªùi d√πng nh·∫•n Cancel
  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const inputText = response.getResponseText().trim();

  if (inputText === "") {
    // CH·∫æ ƒê·ªò M·∫∂C ƒê·ªäNH: Ch·∫°y cho th√°ng tr∆∞·ªõc
    showToastOnSheet('B·∫Øt ƒë·∫ßu qu√° tr√¨nh l∆∞u tr·ªØ cho th√°ng tr∆∞·ªõc...', 'Vui l√≤ng ch·ªù');
    archiveFilesByMonth(); // G·ªçi h√†m ch√≠nh kh√¥ng c√≥ tham s·ªë
    showToastOnSheet('ƒê√£ ho√†n t·∫•t l∆∞u tr·ªØ cho th√°ng tr∆∞·ªõc!', 'Th√†nh c√¥ng', 10);
  } else {
    // CH·∫æ ƒê·ªò CH·ªà ƒê·ªäNH/TEST: Ch·∫°y cho th√°ng c·ª• th·ªÉ
    const formatRegex = /^\d{4}-(\d{2})$/;
    if (!formatRegex.test(inputText)) {
      ui.alert('ƒê·ªãnh d·∫°ng kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p l·∫°i theo ƒë√∫ng ƒë·ªãnh d·∫°ng YYYY-MM.');
      return;
    }

    const parts = inputText.split('-');
    const yearToTest = parseInt(parts[0], 10);
    const monthToTest = parseInt(parts[1], 10);

    if (monthToTest < 1 || monthToTest > 12) {
      ui.alert('Th√°ng kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p m·ªôt s·ªë t·ª´ 01 ƒë·∫øn 12.');
      return;
    }

    showToastOnSheet(`B·∫Øt ƒë·∫ßu ch·∫°y l∆∞u tr·ªØ cho th√°ng ${monthToTest}/${yearToTest}...`, 'Vui l√≤ng ch·ªù');
    archiveFilesByMonth(yearToTest, monthToTest); // G·ªçi h√†m ch√≠nh v·ªõi tham s·ªë nƒÉm v√† th√°ng
    showToastOnSheet(`ƒê√£ ho√†n t·∫•t l∆∞u tr·ªØ cho th√°ng ${monthToTest}/${yearToTest}.`, 'Th√†nh c√¥ng', 10);
  }
}
// TH√äM H√ÄM M·ªöI N√ÄY V√ÄO FILE CODE.TXT
function handleAddWaitingRequest(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const dangKyChoSheet = getOrCreateSheet(ss, DANG_KY_CHO_SHEET_NAME, SHEET_HEADERS["DangKyCho"]);
    const user = e.parameter.ten_ban_hang || "Kh√¥ng x√°c ƒë·ªãnh";
    const requestId = "YC-" + new Date().getTime(); // T·∫°o ID duy nh·∫•t
    const newRowData = {
      "ID Y√™u C·∫ßu": requestId,
      "Th·ªùi gian ƒëƒÉng k√Ω": new Date(),
      "T√™n TVBH": user,
      "T√™n kh√°ch h√†ng": e.parameter.ten_khach_hang,
      "D√≤ng xe": e.parameter.dong_xe,
      "Phi√™n b·∫£n": e.parameter.phien_ban,
      "Ngo·∫°i th·∫•t": e.parameter.ngoai_that,
      "N·ªôi th·∫•t": e.parameter.noi_that,
      "Tr·∫°ng th√°i": "ƒêang ch·ªù",
    
      "VIN g·ª£i √Ω": "",
      "Ghi ch√∫": e.parameter.ghi_chu || ""
    };
    const rowValues = SHEET_HEADERS["DangKyCho"].map(header => newRowData[header] || "");
    dangKyChoSheet.appendRow(rowValues);

    logAction("Th√™m Y√™u C·∫ßu Ch·ªù", `ƒê√£ th√™m y√™u c·∫ßu ch·ªù cho KH ${newRowData["T√™n kh√°ch h√†ng"]} b·ªüi ${user}`);
    
    // G·ª≠i th√¥ng b√°o Telegram khi c√≥ y√™u c·∫ßu ch·ªù m·ªõi
    const telegramMessageCho = `üîç <b>Y√™u C·∫ßu T√¨m Xe (ƒêƒÉng K√Ω Ch·ªù)</b>\n\n` +
                               `üë§ <b>TVBH:</b> ${newRowData["T√™n TVBH"]}\n` +
                               `üë® <b>Kh√°ch h√†ng:</b> ${newRowData["T√™n kh√°ch h√†ng"]}\n` +
                               `üöó <b>Lo·∫°i xe:</b> ${newRowData["D√≤ng xe"]} ${newRowData["Phi√™n b·∫£n"]}\n` +
                               `üé® <b>M√†u:</b> ${newRowData["Ngo·∫°i th·∫•t"]} / ${newRowData["N·ªôi th·∫•t"]}\n` +
                               `üìù <b>Ghi ch√∫:</b> ${newRowData["Ghi ch√∫"] || "Kh√¥ng c√≥"}`;
    sendTelegramNotification(telegramMessageCho);

    return createJsonResponse({ status: "SUCCESS", message: "ƒê√£ g·ª≠i y√™u c·∫ßu ƒëƒÉng k√Ω ch·ªù th√†nh c√¥ng!" });
  } catch (error) {
    Logger.log(`L·ªói trong handleAddWaitingRequest: ${error.message}`);
    sendErrorAlert('handleAddWaitingRequest', error);
    return createJsonResponse({ status: "ERROR", message: `L·ªói m√°y ch·ªß: ${error.message}` });
  }
}
// [THAY TH·∫æ TO√ÄN B·ªò H√ÄM sendCarAvailableNotification C≈®]
function sendCarAvailableNotification(mailSheet, orderData, carDetails) {
  const tenTVBH = orderData.ten_tvbh;
  const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);
  if (!recipientEmail) {
    logAction("L·ªói g·ª≠i mail b√°o c√≥ xe", `Kh√¥ng t√¨m th·∫•y email cho ${tenTVBH}, YC ID: ${orderData.request_id}`);
    return false;
  }

  const webAppUrl = ScriptApp.getService().getUrl();
  const pairingUrl = `https://srthuanan.github.io/ordermanagement/yeucaughepxe.html`;
  const subject = `[XE ƒê√É V·ªÄ] Th√¥ng b√°o c√≥ xe ph√π h·ª£p cho KH ${orderData.ten_khach_hang}`;
  const details = {
    "Kh√°ch h√†ng": `<b>${orderData.ten_khach_hang}</b>`,
    "Y√™u c·∫ßu ch·ªù": `${orderData.dong_xe} - ${orderData.phien_ban}`,
    "M√†u s·∫Øc": `${orderData.ngoai_that} / ${orderData.noi_that}`,
    "Ng√†y ƒëƒÉng k√Ω ch·ªù": orderData.ngay_dang_ky,
    "XE M·ªöI ƒê√É V·ªÄ": `<b>${carDetails.vin}</b>`,
    "Th√¥ng tin xe": `${carDetails.dong_xe} - ${carDetails.phien_ban}`,
    "M√†u s·∫Øc xe": `${carDetails.ngoai_that} / ${carDetails.noi_that}`
  };
  const note = `
    <p class="paragraph" style="text-align: center; margin-top: 25px;">
      M·ªôt chi·∫øc xe ph√π h·ª£p v·ªõi y√™u c·∫ßu c·ªßa Anh/Ch·ªã ƒë√£ v·ªÅ kho.
      <br>
      Vui l√≤ng nh·∫•p v√†o n√∫t b√™n d∆∞·ªõi ƒë·ªÉ t·∫°o y√™u c·∫ßu gh√©p xe ngay l·∫≠p t·ª©c.
    </p>
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td align="center" style="padding: 15px 0;">
          <a href="${pairingUrl}" target="_blank" style="background-color: #00509E; color: #ffffff; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;">
            T·∫°o Y√™u C·∫ßu Gh√©p Ngay
          </a>
        </td>
      </tr>
    </table>
  `;
  const bodyContent = createUnifiedEmailBody("Xe Ph√π H·ª£p ƒê√£ V·ªÅ Kho!", tenTVBH, details, note, 'info');
  const fullHtml = createFullHtmlEmail(subject, bodyContent);
  try {
    MailApp.sendEmail({ to: recipientEmail, subject: subject, htmlBody: fullHtml });
    logAction("G·ª≠i mail b√°o c√≥ xe th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho YC ID: ${orderData.request_id}, VIN ${carDetails.vin}`);
    
    // --- B·∫ÆT ƒê·∫¶U S·ª¨A L·ªñI ---
    const notificationMessage = `ƒê√£ c√≥ xe VIN ${carDetails.vin} ph√π h·ª£p v·ªõi y√™u c·∫ßu ch·ªù c·ªßa KH ${orderData.ten_khach_hang}.`;
    // G·ª≠i th√¥ng b√°o t·ªõi ƒë√∫ng TVBH ƒë√£ ƒëƒÉng k√Ω ch·ªù
    addNotification(notificationMessage, 'success', 'danhSachCho', orderData.request_id, 'H·ªá th·ªëng', tenTVBH);
    // --- K·∫æT TH√öC S·ª¨A L·ªñI ---

    return true;
  } catch (e) {
    logAction("L·ªói g·ª≠i mail b√°o c√≥ xe", `Email: ${recipientEmail}, YC ID: ${orderData.request_id}, L·ªói: ${e.message}`);
    return false;
  }
}
function normalizeForComparison(str) {
  if (!str) return "";
  return String(str)
    .trim() // X√≥a kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi
    .toLowerCase() // Chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng
    .replace(/\s+/g, ' ') // Thay th·∫ø nhi·ªÅu kho·∫£ng tr·∫Øng b·∫±ng m·ªôt
    .normalize('NFC'); // Chu·∫©n h√≥a Unicode cho ti·∫øng Vi·ªát
}
function findAndNotifyWaitingRequests(newCarDetails, userEmail) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = getSheets(ss);
  const { dangKyChoSheet, mailSheet } = sheets;
  if (!dangKyChoSheet || dangKyChoSheet.getLastRow() < 2) {
    return; // Kh√¥ng c√≥ y√™u c·∫ßu ch·ªù n√†o
  }

  const waitingData = dangKyChoSheet.getDataRange().getValues();
  const headers = SHEET_HEADERS["DangKyCho"];
  const idCol = headers.indexOf("ID Y√™u C·∫ßu");
  const tvbhCol = headers.indexOf("T√™n TVBH");
  const khachHangCol = headers.indexOf("T√™n kh√°ch h√†ng");
  const dongXeCol = headers.indexOf("D√≤ng xe");
  const phienBanCol = headers.indexOf("Phi√™n b·∫£n");
  const ngoaiThatCol = headers.indexOf("Ngo·∫°i th·∫•t");
  const noiThatCol = headers.indexOf("N·ªôi th·∫•t");
  const statusCol = headers.indexOf("Tr·∫°ng th√°i");
  const vinCol = headers.indexOf("VIN g·ª£i √Ω");
  const ngayDKCol = headers.indexOf("Th·ªùi gian ƒëƒÉng k√Ω");
  
  const carDongXe = normalizeForComparison(newCarDetails.dong_xe);
  const carPhienBan = normalizeForComparison(newCarDetails.phien_ban);
  const carNgoaiThat = normalizeForComparison(newCarDetails.ngoai_that);
  const carNoiThat = normalizeForComparison(newCarDetails.noi_that);

  for (let i = 1; i < waitingData.length; i++) {
    const request = waitingData[i];
    const currentStatus = String(request[statusCol] || "").trim();

    if (currentStatus === "ƒêang ch·ªù") {
      const orderDongXe = normalizeForComparison(request[dongXeCol]);
      const orderPhienBan = normalizeForComparison(request[phienBanCol]);
      const orderNgoaiThat = normalizeForComparison(request[ngoaiThatCol]);
      const orderNoiThat = normalizeForComparison(request[noiThatCol]);
      
      if (carDongXe === orderDongXe && 
          carPhienBan === orderPhienBan && 
          carNgoaiThat === orderNgoaiThat && 
          orderNoiThat.includes(carNoiThat)) {
        
        const requestId = request[idCol];
        const tvbhName = request[tvbhCol];
        
        dangKyChoSheet.getRange(i + 1, statusCol + 1).setValue("ƒê√£ c√≥ xe");
        dangKyChoSheet.getRange(i + 1, vinCol + 1).setValue(newCarDetails.vin);
        
        const orderDataForEmail = {
            request_id: requestId,
            ten_tvbh: tvbhName,
            ten_khach_hang: request[khachHangCol],
            dong_xe: request[dongXeCol],
            phien_ban: request[phienBanCol],
            ngoai_that: request[ngoaiThatCol],
            noi_that: request[noiThatCol],
            ngay_dang_ky: formatDateTimeForSheet(new Date(request[ngayDKCol]))
        };
        sendCarAvailableNotification(mailSheet, orderDataForEmail, newCarDetails);
        
        // TH√îNG B√ÅO M·ªöI
        const notificationMessage = `ƒê√£ c√≥ xe VIN ${newCarDetails.vin} ph√π h·ª£p v·ªõi y√™u c·∫ßu ch·ªù c·ªßa KH ${orderDataForEmail.ten_khach_hang}.`;
        addNotification(notificationMessage, 'success', 'danhSachCho', requestId, userEmail);

        break; 
      }
    }
  }
}
// D√ÅN H√ÄM M·ªöI N√ÄY V√ÄO FILE CODE.TXT
function sendAdminReplyNotification(mailSheet, requestData) {
  const tenTVBH = requestData.ten_tvbh;
  const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);

  if (!recipientEmail) {
    logAction("L·ªói g·ª≠i mail ph·∫£n h·ªìi Admin", `Kh√¥ng t√¨m th·∫•y email cho TVBH '${tenTVBH}', YC ID: ${requestData.id}`);
    return false;
  }

  const subject = `[PH·∫¢N H·ªíI] Admin ƒë√£ c√≥ ghi ch√∫ v·ªÅ Y√™u C·∫ßu Ch·ªù c·ªßa KH ${requestData.ten_khach_hang}`;
  
  const details = {
    "Kh√°ch h√†ng": `<b>${requestData.ten_khach_hang}</b>`,
    "Y√™u c·∫ßu ch·ªù": `${requestData.dong_xe} - ${requestData.phien_ban}`,
    "Ghi ch√∫ t·ª´ Admin": `<b style="color: #00509E;">${requestData.admin_note}</b>`
  };
  
  const note = "Anh/Ch·ªã vui l√≤ng xem ghi ch√∫ tr√™n v√† x·ª≠ l√Ω n·∫øu c·∫ßn. Tr√¢n tr·ªçng!";
  
  const bodyContent = createUnifiedEmailBody("Admin Ph·∫£n H·ªìi Y√™u C·∫ßu Ch·ªù Xe", tenTVBH, details, note, 'info');
  const fullHtml = createFullHtmlEmail(subject, bodyContent);

  try {
    MailApp.sendEmail({ to: recipientEmail, subject: subject, htmlBody: fullHtml });
    logAction("G·ª≠i mail ph·∫£n h·ªìi Admin th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho YC ID: ${requestData.id}`);
    return true;
  } catch (e) {
    logAction("L·ªói g·ª≠i mail ph·∫£n h·ªìi Admin", `Email: ${recipientEmail}, YC ID: ${requestData.id}, L·ªói: ${e.message}`);
    return false;
  }
}
// THAY TH·∫æ TO√ÄN B·ªò H√ÄM C≈® B·∫∞NG H√ÄM N√ÄY
function handleUpdateWaitingRequestNote(e) {
  try {
    const requestId = e.parameter.requestId;
    const adminNote = e.parameter.note;
    const adminUser = e.parameter.adminUser || "Admin";
    if (!requestId || !adminNote) {
      throw new Error("Thi·∫øu ID y√™u c·∫ßu ho·∫∑c n·ªôi dung ghi ch√∫.");
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = getSheets(ss);
    const { dangKyChoSheet, mailSheet } = sheets;
    const data = dangKyChoSheet.getDataRange().getValues();
    const headers = SHEET_HEADERS["DangKyCho"];
    const idCol = headers.indexOf("ID Y√™u C·∫ßu");
    const ghiChuCol = headers.indexOf("Ghi ch√∫");
    let rowIndexToUpdate = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][idCol] === requestId) {
        rowIndexToUpdate = i + 1;
        break;
      }
    }

    if (rowIndexToUpdate === -1) {
      throw new Error(`Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu ch·ªù v·ªõi ID: ${requestId}`);
    }

    dangKyChoSheet.getRange(rowIndexToUpdate, ghiChuCol + 1).setValue(adminNote);
    
    const updatedRowData = dangKyChoSheet.getRange(rowIndexToUpdate, 1, 1, headers.length).getValues()[0];
    const tenTVBH = updatedRowData[headers.indexOf("T√™n TVBH")];
    const tenKH = updatedRowData[headers.indexOf("T√™n kh√°ch h√†ng")];
    const requestDataForNotif = {
      id: requestId,
      ten_tvbh: tenTVBH,
      ten_khach_hang: tenKH,
      dong_xe: updatedRowData[headers.indexOf("D√≤ng xe")],
      phien_ban: updatedRowData[headers.indexOf("Phi√™n b·∫£n")],
      admin_note: adminNote
    };
    sendAdminReplyNotification(mailSheet, requestDataForNotif);
    
    // <-- THAY ƒê·ªîI B·∫ÆT ƒê·∫¶U -->
    const notificationMessage = `Admin ƒë√£ ph·∫£n h·ªìi YC ch·ªù c·ªßa KH ${tenKH}: "${adminNote}"`;
    addNotification(notificationMessage, 'info', 'cho-xe', requestId, adminUser, tenTVBH);
    // <-- THAY ƒê·ªîI K·∫æT TH√öC -->
    
    logAction("Admin tr·∫£ l·ªùi YC ch·ªù (Web)", `Admin ${adminUser} ƒë√£ tr·∫£ l·ªùi YC ID ${requestId}: "${adminNote}"`);
    return createJsonResponse({ status: "SUCCESS", message: "ƒê√£ g·ª≠i ph·∫£n h·ªìi th√†nh c√¥ng!" });
  } catch (error) {
    Logger.log(`L·ªói trong handleUpdateWaitingRequestNote: ${error.message}`);
    sendErrorAlert('handleUpdateWaitingRequestNote', error);
    return createJsonResponse({ status: "ERROR", message: `L·ªói m√°y ch·ªß: ${error.message}` });
  }
}
function callGeminiAPI(prompt) {
  // L·∫•y API key ƒë√£ l∆∞u m·ªôt c√°ch an to√†n
  const API_KEY = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
  if (!API_KEY) {
    throw new Error("Ch∆∞a c·∫•u h√¨nh GEMINI_API_KEY trong Script Properties.");
  }

  const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`; // <-- THAY ƒê·ªîI ·ªû ƒê√ÇY

  // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i ƒëi
  const payload = {
    "contents": [{
      "parts": [{
        "text": prompt
      }]
    }],
    "generationConfig": {
      "temperature": 0.7, // TƒÉng s·ª± s√°ng t·∫°o
      "topK": 1,
      "topP": 1,
      "maxOutputTokens": 2048, // Gi·ªõi h·∫°n ƒë·ªô d√†i ƒë·∫ßu ra
    },
     "safetySettings": [ // C√†i ƒë·∫∑t an to√†n
            { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" },
            { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE" },
            { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" },
            { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }
        ]
  };

  const options = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(payload),
    'muteHttpExceptions': true // ƒê·ªÉ c√≥ th·ªÉ b·∫Øt l·ªói chi ti·∫øt
  };

  const response = UrlFetchApp.fetch(API_URL, options);
  const responseCode = response.getResponseCode();
  const responseBody = response.getContentText();

  if (responseCode === 200) {
    const jsonResponse = JSON.parse(responseBody);
    // Tr√≠ch xu·∫•t n·ªôi dung text t·ª´ c·∫•u tr√∫c tr·∫£ v·ªÅ c·ªßa Gemini
    return jsonResponse.candidates[0].content.parts[0].text;
  } else {
    // Ghi l·∫°i l·ªói ƒë·ªÉ debug
    console.error(`L·ªói Gemini API: ${responseCode} - ${responseBody}`);
    throw new Error(`Kh√¥ng th·ªÉ l·∫•y ph·∫£n h·ªìi t·ª´ Tr·ª£ l√Ω AI. L·ªói: ${responseCode}`);
  }
}
function findRelevantData(prompt, sheets) {
    const lowerPrompt = prompt.toLowerCase();
    const { daGhepSheet, chuaGhepSheet, stockSheet, xuathoadonSheet, huyGhepSheet } = sheets;

    const allData = {
        DaGhep: daGhepSheet.getLastRow() > 1 ? daGhepSheet.getDataRange().getValues() : [],
        ChuaGhep: chuaGhepSheet.getLastRow() > 1 ? chuaGhepSheet.getDataRange().getValues() : [],
        KhoXe: stockSheet.getLastRow() > 1 ? stockSheet.getDataRange().getValues() : [],
        Xuathoadon: xuathoadonSheet.getLastRow() > 1 ? xuathoadonSheet.getDataRange().getValues() : [],
        HuyGhep: huyGhepSheet ? (huyGhepSheet.getLastRow() > 1 ? huyGhepSheet.getDataRange().getValues() : []) : []
    };

    const results = {};
    let foundSpecificData = false;

    // ∆Øu ti√™n 1: T√¨m theo S·ªë ƒê∆°n H√†ng (v√≠ d·ª•: SO-123456)
    const orderMatch = prompt.match(/\b(SO-\w+)\b/i);
    if (orderMatch) {
        const orderNumber = orderMatch[1].toUpperCase();
        for (const sheetName in allData) {
            const data = allData[sheetName];
            if (data.length > 1) {
                const headers = data[0];
                const orderCol = headers.findIndex(h => h.toUpperCase().includes('S·ªê ƒê∆†N H√ÄNG'));
                if (orderCol !== -1) {
                    const foundRows = data.slice(1).filter(row => String(row[orderCol]).toUpperCase() === orderNumber);
                    if (foundRows.length > 0) {
                        results[sheetName] = foundRows.map(row => Object.fromEntries(headers.map((key, i) => [key, row[i]])));
                        foundSpecificData = true;
                    }
                }
            }
        }
    }

    // ∆Øu ti√™n 2: T√¨m theo S·ªë VIN (17 k√Ω t·ª±)
    const vinMatch = prompt.match(/\b([A-Z0-9]{17})\b/i);
    if (vinMatch && !foundSpecificData) {
        const vin = vinMatch[1].toUpperCase();
        for (const sheetName in allData) {
            const data = allData[sheetName];
            if (data.length > 1) {
                const headers = data[0];
                const vinCol = headers.findIndex(h => h.toUpperCase().includes('VIN'));
                if (vinCol !== -1) {
                    const foundRows = data.slice(1).filter(row => String(row[vinCol]).toUpperCase() === vin);
                     if (foundRows.length > 0) {
                        results[sheetName] = foundRows.map(row => Object.fromEntries(headers.map((key, i) => [key, row[i]])));
                        foundSpecificData = true;
                    }
                }
            }
        }
    }

    // ∆Øu ti√™n 3: T√¨m theo t·ª´ kh√≥a chung (t√™n xe, m√†u s·∫Øc, tr·∫°ng th√°i...)
    if (!foundSpecificData) {
        const keywords = lowerPrompt.split(/\s+/).filter(word => word.length > 2); // T√°ch c√¢u h·ªèi th√†nh c√°c t·ª´ kh√≥a
        for (const sheetName in allData) {
            const data = allData[sheetName];
            if (data.length > 1) {
                const headers = data[0];
                const foundRows = data.slice(1).filter(row => {
                    const rowText = row.join(' ').toLowerCase();
                    return keywords.every(kw => rowText.includes(kw));
                });
                if (foundRows.length > 0 && foundRows.length <= 10) { // Gi·ªõi h·∫°n 10 k·∫øt qu·∫£ ƒë·ªÉ tr√°nh qu√° t·∫£i
                    results[sheetName] = foundRows.map(row => Object.fromEntries(headers.map((key, i) => [key, row[i]])));
                    foundSpecificData = true;
                }
            }
        }
    }
    
    // N·∫øu kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c·ª• th·ªÉ, tr·∫£ v·ªÅ b·∫£n t√≥m t·∫Øt chung
    if (!foundSpecificData) {
        return {
            summary: "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c·ª• th·ªÉ. ƒê√¢y l√† t√≥m t·∫Øt to√†n b·ªô h·ªá th·ªëng:",
            KhoXe: `${allData.KhoXe.length - 1} xe`,
            ChuaGhep: `${allData.ChuaGhep.length - 1} ƒë∆°n ch·ªù gh√©p`,
            DaGhep: `${allData.DaGhep.length - 1} ƒë∆°n ƒë√£ gh√©p`,
            HuyGhep: `${allData.HuyGhep.length - 1} ƒë∆°n ƒë√£ h·ªßy`
        };
    }

    return results;
}
/**
 * H√ÄM D·ªåN D·∫∏P
 * Ch·∫°y h√†m n√†y m·ªôt l·∫ßn ƒë·ªÉ x√≥a c√°c thu·ªôc t√≠nh "lastEdit..." kh√¥ng c·∫ßn thi·∫øt.
 */
function cleanupLastEditProperties() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const allKeys = scriptProperties.getKeys();
  let deletedCount = 0;

  for (const key of allKeys) {
    if (key.startsWith('lastEdit_')) {
      scriptProperties.deleteProperty(key);
      deletedCount++;
    }
  }
  
  const message = `D·ªçn d·∫πp ho√†n t·∫•t! ƒê√£ x√≥a ${deletedCount} thu·ªôc t√≠nh "lastEdit...". B√¢y gi·ªù b·∫°n c√≥ th·ªÉ l√†m m·ªõi trang C√†i ƒë·∫∑t ƒë·ªÉ ch·ªânh s·ª≠a.`;
  Logger.log(message);
  SpreadsheetApp.getUi().alert(message);
}
/**
 * [H√ÄM M·ªöI] - Nh·∫≠n prompt t·ª´ client-side, g·ªçi Gemini API m·ªôt c√°ch an to√†n, v√† tr·∫£ v·ªÅ k·∫øt qu·∫£.
 * @param {string} userMessage - Tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng t·ª´ chatbot.
 * @param {string} pageContext - To√†n b·ªô n·ªôi dung vƒÉn b·∫£n c·ªßa trang web l√†m b·ªëi c·∫£nh.
 * @returns {string} - C√¢u tr·∫£ l·ªùi t·ª´ Gemini ho·∫∑c m·ªôt th√¥ng b√°o l·ªói.
 */
function getGeminiChatResponse(userMessage, pageContext) {
  try {
    if (!userMessage || !pageContext) {
      throw new Error("Tin nh·∫Øn ho·∫∑c b·ªëi c·∫£nh trang kh√¥ng ƒë∆∞·ª£c cung c·∫•p.");
    }

    // X√¢y d·ª±ng prompt chi ti·∫øt cho Gemini
    const finalPrompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω ·∫£o am hi·ªÉu v·ªÅ c√°c ch√≠nh s√°ch c·ªßa VinFast ƒë∆∞·ª£c cung c·∫•p trong ng·ªØ c·∫£nh sau. D·ª±a v√†o n·ªôi dung d∆∞·ªõi ƒë√¢y ƒë·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng m·ªôt c√°ch ng·∫Øn g·ªçn, ch√≠nh x√°c v√† th√¢n thi·ªán. Kh√¥ng t·ª± b·ªãa ra th√¥ng tin kh√¥ng c√≥ trong vƒÉn b·∫£n.

    --- B·ªëi c·∫£nh ch√≠nh s√°ch ---
    ${pageContext}
    --- H·∫øt b·ªëi c·∫£nh ---

    C√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng: "${userMessage}"`;

    // G·ªçi h√†m callGeminiAPI ƒë√£ c√≥ s·∫µn trong code c·ªßa b·∫°n
    const response = callGeminiAPI(finalPrompt); [cite_start]// [cite: 2088]
    return response;

  } catch (e) {
    Logger.log(`L·ªói trong getGeminiChatResponse: ${e.message}`);
    // Tr·∫£ v·ªÅ m·ªôt th√¥ng b√°o l·ªói th√¢n thi·ªán cho ng∆∞·ªùi d√πng
    return "Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi tr·ª£ l√Ω AI. Vui l√≤ng th·ª≠ l·∫°i sau.";
  }
}
/**
 * T√¨m v√† x√≥a sheet c√≥ t√™n l√† "CocXe" kh·ªèi spreadsheet hi·ªán t·∫°i.
 */
function deleteCocXeSheet() {
  try {
    [cite_start]// L·∫•y spreadsheet ƒëang ho·∫°t ƒë·ªông b·∫±ng ID ƒë√£ ƒë∆∞·ª£c khai b√°o [cite: 1]
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID); 
    
    [cite_start]// L·∫•y sheet c·∫ßn x√≥a b·∫±ng t√™n ƒë√£ ƒë∆∞·ª£c khai b√°o [cite: 2]
    const sheetToDelete = ss.getSheetByName(COC_XE_SHEET_NAME); 

    // Ki·ªÉm tra xem sheet c√≥ t·ªìn t·∫°i kh√¥ng
    if (sheetToDelete) {
      // N·∫øu c√≥, th·ª±c hi·ªán x√≥a sheet
      ss.deleteSheet(sheetToDelete);
      
      // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng cho ng∆∞·ªùi d√πng
      SpreadsheetApp.getUi().alert(`Sheet "${COC_XE_SHEET_NAME}" ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!`);
      Logger.log(`Sheet '${COC_XE_SHEET_NAME}' ƒë√£ ƒë∆∞·ª£c x√≥a.`);
    } else {
      // N·∫øu kh√¥ng t√¨m th·∫•y, th√¥ng b√°o cho ng∆∞·ªùi d√πng
      SpreadsheetApp.getUi().alert(`Kh√¥ng t√¨m th·∫•y sheet v·ªõi t√™n "${COC_XE_SHEET_NAME}".`);
      Logger.log(`Kh√¥ng t√¨m th·∫•y sheet '${COC_XE_SHEET_NAME}' ƒë·ªÉ x√≥a.`);
    }
  } catch (e) {
    // B·∫Øt v√† ghi l·∫°i b·∫•t k·ª≥ l·ªói n√†o x·∫£y ra trong qu√° tr√¨nh
    Logger.log(`ƒê√£ x·∫£y ra l·ªói khi x√≥a sheet 'CocXe': ${e.message}`);
    
    [cite_start]// G·ª≠i email b√°o l·ªói cho qu·∫£n tr·ªã vi√™n [cite: 185, 1795]
    sendErrorAlert('deleteCocXeSheet', e); 
    
    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói cho ng∆∞·ªùi d√πng
    SpreadsheetApp.getUi().alert(`ƒê√£ x·∫£y ra l·ªói khi c·ªë g·∫Øng x√≥a sheet: ${e.message}`);
  }
}
function holdCar(vin, userEmail) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const data = stockSheet.getDataRange().getValues();
  const headers = data[0];
  const vinCol = headers.indexOf("VIN");
  const statusCol = headers.indexOf("Tr·∫°ng th√°i");
  const holderCol = headers.indexOf("Ng∆∞·ªùi Gi·ªØ Xe");
  const expiryCol = headers.indexOf("Th·ªùi Gian H·∫øt H·∫°n Gi·ªØ");

  for (let i = 1; i < data.length; i++) {
    if (String(data[i][vinCol]).trim() === vin) {
      const currentStatus = String(data[i][statusCol]).trim();
      const currentHolder = String(data[i][holderCol] || "").trim();
      const currentExpiry = data[i][expiryCol];
      if (currentStatus !== "Ch∆∞a gh√©p") {
        throw new Error(`Xe n√†y ƒëang ·ªü tr·∫°ng th√°i '${currentStatus}', kh√¥ng th·ªÉ gi·ªØ.`);
      }
      if (currentHolder && currentExpiry && new Date(currentExpiry) > new Date()) {
        throw new Error(`Xe ƒë√£ ƒë∆∞·ª£c gi·ªØ b·ªüi ${currentHolder}.`);
      }

      const expiryTime = new Date();
      expiryTime.setHours(expiryTime.getHours() + HOLD_DURATION_HOURS);
      stockSheet.getRange(i + 1, statusCol + 1).setValue("ƒêang gi·ªØ");
      
      stockSheet.getRange(i + 1, holderCol + 1).setValue(userEmail);
      stockSheet.getRange(i + 1, expiryCol + 1).setValue(expiryTime).setNumberFormat("dd/MM/yyyy HH:mm:ss");
      
      const expiryFormatted = formatDateTimeForSheet(expiryTime);
      addNotification(`B·∫°n ƒë√£ gi·ªØ th√†nh c√¥ng xe ${vin} ƒë·∫øn ${expiryFormatted}.`, 'success', 'khoXe', vin, userEmail, userEmail);
      logAction("Gi·ªØ Xe Th√†nh C√¥ng", `${userEmail} ƒë√£ gi·ªØ xe ${vin}`);

      const telegramMessage = `üöó <b>Xe ƒê√£ ƒê∆∞·ª£c Gi·ªØ</b>\n\n` +
                            `üë§ <b>Ng∆∞·ªùi gi·ªØ:</b> ${userEmail}\n` +
                            `üî¢ <b>VIN:</b> <code>${vin}</code>\n` +
                            `‚è≥ <b>H·∫øt h·∫°n:</b> ${expiryFormatted}`;
      sendTelegramNotification(telegramMessage);

      return { status: "SUCCESS", message: `ƒê√£ gi·ªØ xe ${vin} th√†nh c√¥ng ƒë·∫øn ${expiryFormatted}.` };
    }
  }
  throw new Error(`Kh√¥ng t√¨m th·∫•y xe v·ªõi VIN: ${vin}.`);
}

function releaseCar(vin, userEmail) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const data = stockSheet.getDataRange().getValues();
  const headers = data[0];
  const vinCol = headers.indexOf("VIN");
  const holderCol = headers.indexOf("Ng∆∞·ªùi Gi·ªØ Xe");
  const expiryCol = headers.indexOf("Th·ªùi Gian H·∫øt H·∫°n Gi·ªØ");
  const statusCol = headers.indexOf("Tr·∫°ng th√°i");

  for (let i = 1; i < data.length; i++) {
    if (String(data[i][vinCol]).trim() === vin) {
      const currentHolder = String(data[i][holderCol] || "").trim();
      if (userEmail !== ADMIN_EMAIL && userEmail !== currentHolder) {
        throw new Error("B·∫°n kh√¥ng c√≥ quy·ªÅn h·ªßy l∆∞·ª£t gi·ªØ xe n√†y.");
      }
      if (!currentHolder) {
        return { status: "SUCCESS", message: "Xe n√†y kh√¥ng c√≥ ai gi·ªØ."
        };
      }

      stockSheet.getRange(i + 1, statusCol + 1).setValue("Ch∆∞a gh√©p");
      stockSheet.getRange(i + 1, holderCol + 1).setValue("");
      stockSheet.getRange(i + 1, expiryCol + 1).setValue("");
      
      addNotification(`B·∫°n ƒë√£ h·ªßy gi·ªØ xe ${vin}.`, 'warning', 'khoXe', vin, userEmail, userEmail);
      if (userEmail !== currentHolder) { 
         addNotification(`L∆∞·ª£t gi·ªØ xe ${vin} c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c Admin h·ªßy.`, 'danger', 'khoXe', vin, userEmail, currentHolder);
      }
      logAction("H·ªßy Gi·ªØ Xe", `${userEmail} ƒë√£ h·ªßy gi·ªØ xe ${vin}`);

      const telegramMessage = `‚úÖ <b>ƒê√£ H·ªßy Gi·ªØ Xe</b>\n\n` +
                            `üë§ <b>Ng∆∞·ªùi h·ªßy:</b> ${userEmail}\n` +
                            `üî¢ <b>VIN:</b> <code>${vin}</code>`;
      sendTelegramNotification(telegramMessage);

      return { status: "SUCCESS", message: `ƒê√£ h·ªßy gi·ªØ xe ${vin} th√†nh c√¥ng.` };
    }
  }
  throw new Error(`Kh√¥ng t√¨m th·∫•y xe v·ªõi VIN: ${vin}.`);
}

function autoReleaseExpiredHolds() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const stockSheet = getOrCreateSheet(ss, STOCK_SHEET_NAME, SHEET_HEADERS["KhoXe"]);
  const data = stockSheet.getDataRange().getValues();
  const headers = data[0];
  const vinCol = headers.indexOf("VIN");
  const holderCol = headers.indexOf("Ng∆∞·ªùi Gi·ªØ Xe");
  const expiryCol = headers.indexOf("Th·ªùi Gian H·∫øt H·∫°n Gi·ªØ");
  // === THAY ƒê·ªîI B·∫ÆT ƒê·∫¶U T·∫†I ƒê√ÇY ===
  const statusCol = headers.indexOf("Tr·∫°ng th√°i"); // Th√™m d√≤ng n√†y
  // === K·∫æT TH√öC THAY ƒê·ªîI ===
  const now = new Date();
  for (let i = 1; i < data.length; i++) {
    const holder = String(data[i][holderCol] || "").trim();
    const expiryTime = data[i][expiryCol];

    if (holder && expiryTime && new Date(expiryTime) < now) {
      const vin = String(data[i][vinCol]).trim();
      // === THAY ƒê·ªîI B·∫ÆT ƒê·∫¶U T·∫†I ƒê√ÇY ===
      stockSheet.getRange(i + 1, statusCol + 1).setValue("Ch∆∞a gh√©p"); // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i
      // === K·∫æT TH√öC THAY ƒê·ªîI ===
      stockSheet.getRange(i + 1, holderCol + 1).setValue("");
      stockSheet.getRange(i + 1, expiryCol + 1).setValue("");
      const message = `L∆∞·ª£t gi·ªØ xe ${vin} c·ªßa b·∫°n ƒë√£ t·ª± ƒë·ªông h·∫øt h·∫°n.`;
      addNotification(message, 'info', 'khoXe', vin, 'H·ªá th·ªëng', holder);
      logAction("T·ª± ƒê·ªông H·ªßy Gi·ªØ Xe", message);
    }
  }
}

function setupAutoReleaseTrigger() {
  ScriptApp.getProjectTriggers().forEach(trigger => {
    if (trigger.getHandlerFunction() === 'autoReleaseExpiredHolds') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  ScriptApp.newTrigger('autoReleaseExpiredHolds')
    .timeBased()
    .everyHours(1)
    .create();
  SpreadsheetApp.getUi().alert('ƒê√£ c√†i ƒë·∫∑t th√†nh c√¥ng trigger t·ª± ƒë·ªông h·ªßy gi·ªØ xe 1 ti·∫øng m·ªôt l·∫ßn.');
}

function revertLastActionById(actionId, userEmail) {
  if (!actionId) {
    throw new Error("Kh√¥ng c√≥ h√†nh ƒë·ªông n√†o ƒë·ªÉ ho√†n t√°c.");
  }

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const logSheet = getOrCreateSheet(ss, "NhatKyChinhSua", SHEET_HEADERS["NhatKyChinhSua"]);
  const logData = logSheet.getDataRange().getValues();
  const headers = logData[0];
  const actionIdCol = headers.indexOf("Action ID");
  const statusCol = headers.indexOf("Tr·∫°ng th√°i Log");

  const rowsToRevert = [];
  for (let i = logData.length - 1; i >= 1; i--) {
    // T√¨m c√°c log kh·ªõp v·ªõi Action ID v√† ch∆∞a b·ªã ho√†n t√°c
    if (logData[i][actionIdCol] === actionId && logData[i][statusCol] !== "ƒê√£ ho√†n t√°c") {
      rowsToRevert.push({
        sheetName: logData[i][headers.indexOf("T√™n Sheet")],
        cellA1: logData[i][headers.indexOf("√î")],
        oldValue: logData[i][headers.indexOf("Gi√° tr·ªã c≈©")],
        newValue: logData[i][headers.indexOf("Gi√° tr·ªã m·ªõi")],
        logRowIndex: i + 1 // 1-based index
      });
    }
  }

  if (rowsToRevert.length === 0) {
    throw new Error("Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ cho h√†nh ƒë·ªông n√†y ho·∫∑c n√≥ ƒë√£ ƒë∆∞·ª£c ho√†n t√°c.");
  }

  let revertedCount = 0;
  // Th·ª±c hi·ªán ho√†n t√°c (ƒë·∫£o ng∆∞·ª£c l·∫°i)
  for (const item of rowsToRevert) {
    const targetSheet = ss.getSheetByName(item.sheetName);
    if (targetSheet) {
      targetSheet.getRange(item.cellA1).setValue(item.oldValue);
      // ƒê√°nh d·∫•u log l√† ƒë√£ ƒë∆∞·ª£c ho√†n t√°c
      logSheet.getRange(item.logRowIndex, statusCol + 1).setValue("ƒê√£ ho√†n t√°c");
      revertedCount++;
    }
  }
  
  logAction("Ho√†n t√°c h√†nh ƒë·ªông", `Ng∆∞·ªùi d√πng ${userEmail} ƒë√£ ho√†n t√°c h√†nh ƒë·ªông ID ${actionId}, kh√¥i ph·ª•c ${revertedCount} thay ƒë·ªïi.`);
  return { message: `Ho√†n t√°c th√†nh c√¥ng ${revertedCount} thay ƒë·ªïi.` };
}
/**
 * [H√ÄM H·ªñ TR·ª¢ M·ªöI] - C·∫≠p nh·∫≠t gi√° tr·ªã m·ªôt √¥ v√† ghi l·∫°i v√†o nh·∫≠t k√Ω v·ªõi Action ID.
 */
function updateCellAndLog(sheet, row, col, newValue, user, actionId, nhatKyChinhSuaSheet) {
  const cell = sheet.getRange(row, col);
  const oldValue = cell.getValue();
  const oldValueStr = oldValue !== undefined ? String(oldValue) : "[√î tr·ªëng]";
  const newValueStr = newValue !== undefined ? String(newValue) : "[√î tr·ªëng]";

  if (oldValueStr !== newValueStr) {
    cell.setValue(newValue);
    if (nhatKyChinhSuaSheet) {
      nhatKyChinhSuaSheet.appendRow([
        new Date(), user, sheet.getName(), cell.getA1Notation(),
        oldValueStr, newValueStr, actionId, ""
      ]);
    }
  }
}
/**
 * [H√ÄM M·ªöI] - T√¨m v√† ho√†n t√°c tr·∫°ng th√°i g·∫ßn nh·∫•t c·ªßa m·ªôt ƒë∆°n h√†ng d·ª±a tr√™n nh·∫≠t k√Ω ch·ªânh s·ª≠a.
 * @param {string} orderNumber - S·ªë ƒë∆°n h√†ng c·∫ßn ho√†n t√°c.
 * @param {string} userEmail - Email c·ªßa ng∆∞·ªùi th·ª±c hi·ªán.
 * @returns {object} - ƒê·ªëi t∆∞·ª£ng ch·ª©a th√¥ng b√°o k·∫øt qu·∫£.
 */
function revertOrderStatusByOrderNumber(orderNumber, userEmail) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheets = getSheets(ss);
  const { daGhepSheet, nhatKyChinhSuaSheet } = sheets;

  // 1. T√¨m ƒë∆°n h√†ng trong sheet DaGhep
  const daGhepData = daGhepSheet.getDataRange().getValues();
  const daGhepHeaders = daGhepData[0];
  const orderCol = daGhepHeaders.indexOf("S·ªë ƒë∆°n h√†ng");
  const ketQuaCol = daGhepHeaders.indexOf("K·∫øt qu·∫£");

  let rowIndex = -1;
  for (let i = 1; i < daGhepData.length; i++) {
    if (String(daGhepData[i][orderCol]).trim() === orderNumber) {
      rowIndex = i + 1; // 1-based index
      break;
    }
  }

  if (rowIndex === -1) {
    throw new Error(`Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng "${orderNumber}" trong sheet DaGhep.`);
  }

  // 2. T√¨m trong nh·∫≠t k√Ω ch·ªânh s·ª≠a (NhatKyChinhSua)
  const logData = nhatKyChinhSuaSheet.getDataRange().getValues();
  const logHeaders = logData[0];
  const sheetNameColLog = logHeaders.indexOf("T√™n Sheet");
  const cellColLog = logHeaders.indexOf("√î");
  const oldValueColLog = logHeaders.indexOf("Gi√° tr·ªã c≈©");
  const newValueColLog = logHeaders.indexOf("Gi√° tr·ªã m·ªõi");

  const targetCellA1 = daGhepSheet.getRange(rowIndex, ketQuaCol + 1).getA1Notation();
  let lastStatusChangeLog = null;

  // Duy·ªát ng∆∞·ª£c t·ª´ cu·ªëi ƒë·ªÉ t√¨m l·∫ßn thay ƒë·ªïi tr·∫°ng th√°i g·∫ßn nh·∫•t
  for (let i = logData.length - 1; i >= 1; i--) {
    if (logData[i][sheetNameColLog] === DA_GHEP_SHEET_NAME && logData[i][cellColLog] === targetCellA1) {
      lastStatusChangeLog = {
        oldValue: logData[i][oldValueColLog],
        newValue: logData[i][newValueColLog]
      };
      break;
    }
  }

  if (!lastStatusChangeLog) {
    throw new Error(`Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ thay ƒë·ªïi tr·∫°ng th√°i cho ƒë∆°n h√†ng "${orderNumber}".`);
  }

  const currentStatus = daGhepSheet.getRange(rowIndex, ketQuaCol + 1).getValue();
  if (currentStatus !== lastStatusChangeLog.newValue) {
      throw new Error(`Tr·∫°ng th√°i hi·ªán t·∫°i (${currentStatus}) kh√¥ng kh·ªõp v·ªõi l·ªãch s·ª≠ g·∫ßn nh·∫•t. Vui l√≤ng ki·ªÉm tra l·∫°i.`);
  }

  const statusToRevertTo = lastStatusChangeLog.oldValue;
  if (!statusToRevertTo || statusToRevertTo === "[√î tr·ªëng]") {
      throw new Error("Kh√¥ng th·ªÉ ho√†n t√°c v·ªÅ m·ªôt tr·∫°ng th√°i tr·ªëng.");
  }

  // 3. Th·ª±c hi·ªán ho√†n t√°c v√† ghi log m·ªõi
  const actionId = `revert-status-${new Date().getTime()}`;
  updateCellAndLog(daGhepSheet, rowIndex, ketQuaCol + 1, statusToRevertTo, userEmail, actionId, nhatKyChinhSuaSheet);

  logAction("Ho√†n t√°c Tr·∫°ng th√°i ƒê∆°n h√†ng", `Ng∆∞·ªùi d√πng ${userEmail} ƒë√£ ho√†n t√°c tr·∫°ng th√°i ƒêH ${orderNumber} t·ª´ "${currentStatus}" v·ªÅ "${statusToRevertTo}".`);
  addNotification(`Tr·∫°ng th√°i ƒêH ${orderNumber} ƒë√£ ƒë∆∞·ª£c ho√†n t√°c v·ªÅ "${statusToRevertTo}".`, 'success', 'daGhep', orderNumber, userEmail, ADMIN_EMAIL);

  return { message: `ƒê√£ ho√†n t√°c tr·∫°ng th√°i c·ªßa ƒë∆°n h√†ng ${orderNumber} v·ªÅ "${statusToRevertTo}" th√†nh c√¥ng.` };
}
/**
 * [H√ÄM M·ªöI] - X·ª≠ l√Ω vi·ªác ƒë√°nh d·∫•u m·ªôt th√¥ng b√°o c·ª• th·ªÉ l√† ƒë√£ ƒë·ªçc.
 * @param {object} e - ƒê·ªëi t∆∞·ª£ng s·ª± ki·ªán t·ª´ doPost, ch·ª©a tham s·ªë 'timestamp'.
 * @returns {ContentService.TextOutput} - Ph·∫£n h·ªìi JSON.
 */
function handleMarkNotificationAsRead(e) {
  try {
    const timestampToMark = e.parameter.timestamp;
    if (!timestampToMark) {
      throw new Error("Kh√¥ng c√≥ timestamp ƒë∆∞·ª£c cung c·∫•p.");
    }

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID); [cite_start]// [cite: 1]
    const sheet = getOrCreateSheet(ss, NOTIFICATION_SHEET_NAME, SHEET_HEADERS["ThongBaoWebApp"]); [cite_start]// [cite: 1, 6]
    if (sheet.getLastRow() < 2) {
      return createJsonResponse({ status: 'SUCCESS', message: 'Kh√¥ng c√≥ th√¥ng b√°o.' });
    }

    const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn());
    const values = dataRange.getValues();
    const headers = SHEET_HEADERS["ThongBaoWebApp"]; [cite_start]// [cite: 6]
    const timestampCol = headers.indexOf("Timestamp");
    const isReadCol = headers.indexOf("IsRead");

    if (timestampCol === -1 || isReadCol === -1) {
      throw new Error("L·ªói c·∫•u tr√∫c sheet ThongBaoWebApp.");
    }
    
    // Chuy·ªÉn ƒë·ªïi timestamp t·ª´ request th√†nh ƒë·ªëi t∆∞·ª£ng Date ƒë·ªÉ so s√°nh ch√≠nh x√°c
    const targetDate = new Date(timestampToMark);

    for (let i = 0; i < values.length; i++) {
      const rowDate = new Date(values[i][timestampCol]);
      // So s√°nh th·ªùi gian ch√≠nh x√°c
      if (rowDate.getTime() === targetDate.getTime()) {
        if (values[i][isReadCol] !== 'ƒê√£ ƒë·ªçc') {
          sheet.getRange(i + 2, isReadCol + 1).setValue('ƒê√£ ƒë·ªçc');
          logAction("ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc (ƒê∆°n l·∫ª)", `ƒê√£ ƒë√°nh d·∫•u th√¥ng b√°o l√∫c ${timestampToMark} l√† ƒë√£ ƒë·ªçc.`);
        }
        break; // D·ª´ng l·∫°i khi ƒë√£ t√¨m th·∫•y v√† c·∫≠p nh·∫≠t
      }
    }
    
    return createJsonResponse({ status: 'SUCCESS', message: 'Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† ƒë√£ ƒë·ªçc.' });

  } catch (err) {
    Logger.log(`L·ªói trong handleMarkNotificationAsRead: ${err.message}`);
    return createJsonResponse({ status: 'ERROR', message: err.message });
  }
}

function handleDeleteWaitingRequest(e) {
  const requestId = e.parameter.requestId;
  const deletedBy = e.parameter.deletedBy || "Admin Web App";

  if (!requestId) {
    throw new Error("Kh√¥ng c√≥ ID Y√™u C·∫ßu ƒë∆∞·ª£c cung c·∫•p ƒë·ªÉ x√≥a.");
  }

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = getOrCreateSheet(ss, DANG_KY_CHO_SHEET_NAME, SHEET_HEADERS["DangKyCho"]);
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const idCol = headers.indexOf("ID Y√™u C·∫ßu");

  if (idCol === -1) {
    throw new Error("L·ªói c·∫•u tr√∫c sheet 'DangKyCho': Thi·∫øu c·ªôt 'ID Y√™u C·∫ßu'.");
  }

  for (let i = data.length - 1; i >= 1; i--) {
    if (String(data[i][idCol]).trim() === requestId) {
      const customerName = data[i][headers.indexOf("T√™n kh√°ch h√†ng")];
      sheet.deleteRow(i + 1);
      logAction("X√≥a Y√™u C·∫ßu Ch·ªù", `ƒê√£ x√≥a YC c·ªßa KH '${customerName}' (ID: ${requestId}) b·ªüi ${deletedBy}.`);
      addNotification(`Y√™u c·∫ßu ch·ªù c·ªßa KH ${customerName} ƒë√£ ƒë∆∞·ª£c x√≥a b·ªüi ${deletedBy}.`, 'danger', null, null, deletedBy);
      return createJsonResponse({ status: "SUCCESS", message: `ƒê√£ x√≥a th√†nh c√¥ng y√™u c·∫ßu ch·ªù c·ªßa kh√°ch h√†ng ${customerName}.` });
    }
  }

  throw new Error(`Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu ch·ªù v·ªõi ID: ${requestId}.`);
}
function sendTelegramNotification(message) {
  const TELEGRAM_BOT_TOKEN = "8444242103:AAGupLJ1RJS3b3LD5LMEYIWMfwCFW3mzhB4";
  const TELEGRAM_CHAT_ID = "5812034168";
  
  if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
    Logger.log("L·ªói: Ch∆∞a c·∫•u h√¨nh TELEGRAM_BOT_TOKEN ho·∫∑c TELEGRAM_CHAT_ID.");
    return;
  }

  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  const payload = {
    chat_id: TELEGRAM_CHAT_ID,
    text: message,
    parse_mode: 'HTML'
  };

  const options = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(payload),
    'muteHttpExceptions': true
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    Logger.log(`Telegram API response: ${response.getContentText()}`);
  } catch (e) {
    Logger.log(`L·ªói khi g·ª≠i th√¥ng b√°o Telegram: ${e.message}`);
  }
}
/**
 * [H√ÄM M·ªöI] G·ª≠i m·ªôt file (d·∫°ng Blob) k√®m theo ch√∫ th√≠ch ƒë·∫øn k√™nh Telegram.
 * @param {Blob} fileBlob - ƒê·ªëi t∆∞·ª£ng Blob c·ªßa file c·∫ßn g·ª≠i.
 * @param {string} caption - Ch√∫ th√≠ch cho file, h·ªó tr·ª£ ƒë·ªãnh d·∫°ng HTML.
 */
function sendTelegramDocument(fileBlob, caption = "") {
  const TELEGRAM_BOT_TOKEN = "8444242103:AAGupLJ1RJS3b3LD5LMEYIWMfwCFW3mzhB4";
  const TELEGRAM_CHAT_ID = "5812034168";
  if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
    Logger.log("L·ªói: Ch∆∞a c·∫•u h√¨nh TELEGRAM_BOT_TOKEN ho·∫∑c TELEGRAM_CHAT_ID.");
    return;
  }

  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument`;
  
  // Khi g·ª≠i file, payload kh√¥ng ph·∫£i l√† JSON m√† l√† m·ªôt ƒë·ªëi t∆∞·ª£ng ch·ª©a c√°c ph·∫ßn c·ªßa form.
  // UrlFetchApp s·∫Ω t·ª± ƒë·ªông m√£ h√≥a n√≥ th√†nh multipart/form-data.
  const payload = {
    chat_id: TELEGRAM_CHAT_ID,
    document: fileBlob, // G√°n tr·ª±c ti·∫øp ƒë·ªëi t∆∞·ª£ng Blob v√†o ƒë√¢y
    caption: caption,
    parse_mode: 'HTML'
  };

  const options = {
    'method': 'post',
    'payload': payload, // Kh√¥ng c·∫ßn JSON.stringify
    'muteHttpExceptions': true
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    Logger.log(`Telegram API (sendDocument) response: ${response.getContentText()}`);
  } catch (e) {
    Logger.log(`L·ªói khi g·ª≠i t√†i li·ªáu qua Telegram: ${e.message}`);
  }
}
function sendTelegramMessage(message, keyboard = null, chatId = null) {
  const TELEGRAM_BOT_TOKEN = "8444242103:AAGupLJ1RJS3b3LD5LMEYIWMfwCFW3mzhB4";
  const TELEGRAM_CHAT_ID = "5812034168";
  if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
    Logger.log("L·ªói: Ch∆∞a c·∫•u h√¨nh TELEGRAM_BOT_TOKEN ho·∫∑c TELEGRAM_CHAT_ID.");
    return;
  }

  const targetChatId = chatId || TELEGRAM_CHAT_ID;
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  const payload = {
    chat_id: targetChatId,
    text: message,
    parse_mode: 'HTML'
  };

  if (keyboard) {
    payload.reply_markup = JSON.stringify({
      inline_keyboard: keyboard
    });
  }

  const options = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(payload),
    'muteHttpExceptions': true
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    Logger.log(`Telegram API response (sendMessage): ${response.getContentText()}`);
  } catch (e) {
    Logger.log(`L·ªói khi g·ª≠i th√¥ng b√°o Telegram: ${e.message}`);
  }
}
function editTelegramMessage(chatId, messageId, newText, newKeyboard = null) {
  const TELEGRAM_BOT_TOKEN = "8444242103:AAGupLJ1RJS3b3LD5LMEYIWMfwCFW3mzhB4";
  if (!TELEGRAM_BOT_TOKEN) return;

  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/editMessageText`;
  const payload = {
    chat_id: chatId,
    message_id: messageId,
    text: newText,
    parse_mode: 'HTML'
  };

  if (newKeyboard) {
    payload.reply_markup = JSON.stringify({
      inline_keyboard: newKeyboard
    });
  }

  const options = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(payload),
    'muteHttpExceptions': true
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    Logger.log(`Telegram API response (editMessageText): ${response.getContentText()}`);
  } catch (e) {
    Logger.log(`L·ªói khi s·ª≠a tin nh·∫Øn Telegram: ${e.message}`);
  }
}
function handleTelegramFileUpload(fileInfo, user, orderNumber, chatId) {
  const TELEGRAM_BOT_TOKEN = "8444242103:AAGupLJ1RJS3b3LD5LMEYIWMfwCFW3mzhB4";
  try {
    sendTelegramMessage(`ƒêang x·ª≠ l√Ω file cho ƒë∆°n h√†ng <b>${orderNumber}</b>...`, null, chatId);

    const fileId = fileInfo.file_id;
    const getFilePathUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getFile?file_id=${fileId}`;
    const filePathResponse = UrlFetchApp.fetch(getFilePathUrl);
    const filePathResult = JSON.parse(filePathResponse.getContentText());

    if (!filePathResult.ok) {
      throw new Error("Kh√¥ng th·ªÉ l·∫•y th√¥ng tin file t·ª´ Telegram.");
    }

    const filePath = filePathResult.result.file_path;
    const fileUrl = `https://api.telegram.org/file/bot${TELEGRAM_BOT_TOKEN}/${filePath}`;
    const fileBlob = UrlFetchApp.fetch(fileUrl).getBlob();

    const originalFileName = fileInfo.file_name || `hoa_don_${orderNumber}.${filePath.split('.').pop()}`;
    fileBlob.setName(originalFileName);

    const e_simulated = {
      parameter: {
        orderNumber: orderNumber,
        uploadedBy: user.username || user.first_name,
        invoiceFileName: originalFileName,
        invoiceFileBase64: Utilities.base64Encode(fileBlob.getBytes()),
        invoiceMimeType: fileBlob.getContentType()
      }
    };

    const uploadResult = handleUploadIssuedInvoice(e_simulated);
    const resultObject = JSON.parse(uploadResult.getContent());

    if (resultObject.status === "SUCCESS") {
      sendTelegramMessage(`‚úÖ ƒê√£ t·∫£i l√™n h√≥a ƒë∆°n v√† c·∫≠p nh·∫≠t th√†nh c√¥ng cho ƒë∆°n h√†ng <b>${orderNumber}</b>!`, null, chatId);
    } else {
      throw new Error(resultObject.message);
    }

  } catch (error) {
    Logger.log(`L·ªói trong handleTelegramFileUpload: ${error.message}`);
    sendTelegramMessage(`‚ùå ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω file cho ƒë∆°n h√†ng <b>${orderNumber}</b>:\n\n<i>${error.message}</i>`, null, chatId);
    sendErrorAlert('handleTelegramFileUpload', error);
  }
}
function handleTelegramSupplementRequest(reason, photos, user, orderNumber, chatId) {
  const TELEGRAM_BOT_TOKEN = "8444242103:AAGupLJ1RJS3b3LD5LMEYIWMfwCFW3mzhB4";
  try {
    sendTelegramMessage(`ƒêang x·ª≠ l√Ω y√™u c·∫ßu b·ªï sung cho ƒë∆°n h√†ng <b>${orderNumber}</b>...`, null, chatId);

    let imagesBase64Array = [];
    if (photos && Array.isArray(photos)) {
      photos.forEach(photoSizeArray => {
        const bestPhoto = photoSizeArray[photoSizeArray.length - 1]; // L·∫•y ·∫£nh ch·∫•t l∆∞·ª£ng cao nh·∫•t
        const fileId = bestPhoto.file_id;
        const getFilePathUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getFile?file_id=${fileId}`;
        const filePathResponse = UrlFetchApp.fetch(getFilePathUrl);
        const filePathResult = JSON.parse(filePathResponse.getContentText());

        if (filePathResult.ok) {
          const filePath = filePathResult.result.file_path;
          const fileUrl = `https://api.telegram.org/file/bot${TELEGRAM_BOT_TOKEN}/${filePath}`;
          const fileBlob = UrlFetchApp.fetch(fileUrl).getBlob();
          const base64Data = Utilities.base64Encode(fileBlob.getBytes());
          imagesBase64Array.push(`data:${fileBlob.getContentType()};base64,${base64Data}`);
        }
      });
    }

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheets = getSheets(ss);
    const actionId = `telegram-req_supp-${new Date().getTime()}`;
    const imagesBase64Json = imagesBase64Array.length > 0 ? JSON.stringify(imagesBase64Array) : null;
    
    const resultJson = handleRequestSupplementFromWebApp(orderNumber, reason, sheets, imagesBase64Json, actionId);
    const resultObject = JSON.parse(resultJson.getContent());

    if (resultObject.status === "SUCCESS") {
      sendTelegramMessage(`‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu b·ªï sung th√†nh c√¥ng cho ƒë∆°n h√†ng <b>${orderNumber}</b>!`, null, chatId);
      // C·∫≠p nh·∫≠t l·∫°i tin nh·∫Øn g·ªëc trong nh√≥m chat (n·∫øu c√≥ th·ªÉ)
      const telegramMessage = `‚ö†Ô∏è <b>ƒê√£ Y√™u C·∫ßu B·ªï Sung</b>\n\n` +
                              `üë§ <b>Admin:</b> ${user.first_name}\n` +
                              `üìÑ <b>SƒêH:</b> <code>${orderNumber}</code>\n` +
                              `üìù <b>L√Ω do:</b> ${reason}`;
      sendTelegramMessage(telegramMessage); // G·ª≠i tin nh·∫Øn m·ªõi v√†o group chung
    } else {
      throw new Error(resultObject.message);
    }

  } catch (error) {
    Logger.log(`L·ªói trong handleTelegramSupplementRequest: ${error.message}`);
    sendTelegramMessage(`‚ùå ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu b·ªï sung cho <b>${orderNumber}</b>:\n\n<i>${error.message}</i>`, null, chatId);
    sendErrorAlert('handleTelegramSupplementRequest', error);
  }
}
/**
 * [H√ÄM M·ªöI] - X·ª≠ l√Ω vi·ªác t·∫£i l√™n nhi·ªÅu h√≥a ƒë∆°n c√πng l√∫c.
 * @param {object} e - ƒê·ªëi t∆∞·ª£ng s·ª± ki·ªán t·ª´ doPost, ch·ª©a chu·ªói JSON c·ªßa c√°c file.
 * @returns {ContentService.TextOutput} - Ph·∫£n h·ªìi JSON v·ªÅ k·∫øt qu·∫£.
 */
function handleBulkUploadIssuedInvoices(e) {
  try {
    const filesDataJson = e.parameter.filesData;
    const uploadedBy = e.parameter.uploadedBy || "Admin";

    if (!filesDataJson) {
      throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu file ƒë∆∞·ª£c g·ª≠i l√™n.");
    }

    const filesData = JSON.parse(filesDataJson);
    if (!Array.isArray(filesData) || filesData.length === 0) {
      return createJsonResponse({ status: "SUCCESS", message: "Kh√¥ng c√≥ file n√†o ƒë·ªÉ x·ª≠ l√Ω." });
    }

    let successCount = 0;
    let errorCount = 0;
    const errorDetails = [];

    filesData.forEach(fileInfo => {
      try {
        // T·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng s·ª± ki·ªán gi·∫£ l·∫≠p `e` ƒë·ªÉ t√°i s·ª≠ d·ª•ng h√†m `handleUploadIssuedInvoice`
        const e_simulated = {
          parameter: {
            orderNumber: fileInfo.orderNumber,
            uploadedBy: uploadedBy,
            invoiceFileName: fileInfo.fileName,
            invoiceFileBase64: fileInfo.base64Data,
            invoiceMimeType: fileInfo.mimeType
          }
        };

        // G·ªçi h√†m x·ª≠ l√Ω ƒë∆°n l·∫ª cho t·ª´ng file
        const uploadResult = handleUploadIssuedInvoice(e_simulated);
        const resultObject = JSON.parse(uploadResult.getContent());

        if (resultObject.status === "SUCCESS") {
          successCount++;
        } else {
          errorCount++;
          errorDetails.push(`- ${fileInfo.orderNumber}: ${resultObject.message}`);
        }
      } catch (err) {
        errorCount++;
        errorDetails.push(`- ${fileInfo.orderNumber}: ${err.message}`);
        logAction("L·ªói nghi√™m tr·ªçng trong Bulk Upload", `ƒê∆°n h√†ng ${fileInfo.orderNumber}: ${err.toString()}`);
      }
    });

    // T·∫°o th√¥ng b√°o k·∫øt qu·∫£ cu·ªëi c√πng
    let message = `T·∫£i l√™n h√†ng lo·∫°t ho√†n t·∫•t! Th√†nh c√¥ng: ${successCount}. Th·∫•t b·∫°i: ${errorCount}.`;
    if (errorCount > 0) {
      message += "\n\nChi ti·∫øt l·ªói:\n" + errorDetails.join("\n");
    }

    addNotification(`${uploadedBy} ƒë√£ t·∫£i l√™n h√†ng lo·∫°t ${successCount} h√≥a ƒë∆°n.`, 'success', 'xuatHoaDon', null, uploadedBy, ADMIN_EMAIL);

    return createJsonResponse({ status: "SUCCESS", message: message });

  } catch (err) {
    Logger.log(`L·ªói nghi√™m tr·ªçng trong handleBulkUploadIssuedInvoices: ${err.message}. Stack: ${err.stack}`);
    sendErrorAlert('handleBulkUploadIssuedInvoices', err);
    return createJsonResponse({ status: 'ERROR', message: `L·ªói m√°y ch·ªß khi x·ª≠ l√Ω h√†ng lo·∫°t: ${err.message}` });
  }
}

function getAllSheetDataWithHyperlink(sheet) {
  if (!sheet || sheet.getLastRow() < 2) {
    return [];
  }
  
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  const formulas = dataRange.getFormulas();
  const headers = values[0].map(header => header.trim());
  const data = [];

  for (let i = 1; i < values.length; i++) {
    const rowObject = {};
    for (let j = 0; j < headers.length; j++) {
      const headerName = headers[j];
      const formula = formulas[i][j];
      if (formula && formula.toUpperCase().startsWith("=HYPERLINK")) {
        const urlMatch = formula.match(/=HYPERLINK\("([^"]+)"/i);
        rowObject[headerName] = urlMatch ? urlMatch[1] : "";
      } else {
        rowObject[headerName] = values[i][j];
      }
    }
    data.push(rowObject);
  }
  
  return data;
}




function handlePerformOcr(e) {
  try {
    const base64Data = e.parameter.base64Data;
    const mimeType = e.parameter.mimeType;
    if (!base64Data || !mimeType) {
      throw new Error("D·ªØ li·ªáu ·∫£nh kh√¥ng h·ª£p l·ªá.");
    }

    // 1. Chuy·ªÉn ƒë·ªïi Base64 th√†nh Blob
    const decodedData = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, "temp_ocr_file");

    // 2. T·∫£i file l√™n Drive v·ªõi t√πy ch·ªçn OCR
    // File s·∫Ω ƒë∆∞·ª£c t·∫°o t·∫°m th·ªùi v√† x√≥a ngay sau ƒë√≥.
    const resource = {
      title: "temp_ocr_file",
      mimeType: mimeType
    };
    const optionalArgs = {
      ocr: true,
      ocrLanguage: 'vi,en' // H·ªó tr·ª£ c·∫£ ti·∫øng Vi·ªát v√† ti·∫øng Anh
    };
    const tempFile = Drive.Files.insert(resource, blob, optionalArgs);
    
    // 3. L·∫•y vƒÉn b·∫£n ƒë√£ ƒë∆∞·ª£c OCR
    const recognizedText = DocumentApp.openById(tempFile.id).getBody().getText();

    // 4. X√≥a file t·∫°m
    Drive.Files.remove(tempFile.id);
    
    // 5. Ph√¢n t√≠ch vƒÉn b·∫£n ƒë·ªÉ t√¨m ng√†y th√°ng (s·ª≠ d·ª•ng logic t·ª´ file HTML)
    const extractedDate = findDateInText(recognizedText);

    if (extractedDate) {
      return createJsonResponse({ status: "SUCCESS", date: extractedDate });
    } else {
      return createJsonResponse({ status: "NOT_FOUND", message: "Kh√¥ng t√¨m th·∫•y ng√†y gi·ªù." });
    }

  } catch (error) {
    Logger.log(`L·ªói nghi√™m tr·ªçng trong handlePerformOcr: ${error.message}. Stack: ${error.stack}`);
    // Kh√¥ng c·∫ßn g·ª≠i email b√°o l·ªói cho t√°c v·ª• n√†y
    return createJsonResponse({ status: "ERROR", message: `L·ªói m√°y ch·ªß khi x·ª≠ l√Ω ·∫£nh: ${error.message}` });
  }
}
function forceSyncVinData() {
  const ui = SpreadsheetApp.getUi();
  
  // H·ªôp tho·∫°i y√™u c·∫ßu ng∆∞·ªùi d√πng nh·∫≠p VIN
  const response = ui.prompt(
    'ƒê·ªìng b·ªô d·ªØ li·ªáu xe',
    'Vui l√≤ng nh·∫≠p ch√≠nh x√°c s·ªë VIN c·∫ßn s·ª≠a v√† ƒë·ªìng b·ªô h√≥a:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK || !response.getResponseText()) {
    ui.alert('ƒê√£ h·ªßy thao t√°c.');
    return;
  }
  
  const vinToFix = response.getResponseText().trim().toUpperCase();
  if (vinToFix.length !== 17) {
    ui.alert('L·ªói', `S·ªë VIN "${vinToFix}" kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.`, ui.ButtonSet.OK);
    return;
  }

  const SPREADSHEET_ID = "1CzYUfDAcwt4D64UIZIUC77lZ2lOYQ257xlmVXy2nZG0";
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  
  // L·∫•y c√°c sheet c·∫ßn thi·∫øt
  const thongtinxeSheet = ss.getSheetByName("Thongtinxe");
  const khoXeSheet = ss.getSheetByName("KhoXe");
  const daGhepSheet = ss.getSheetByName("DaGhep");

  if (!thongtinxeSheet || !khoXeSheet || !daGhepSheet) {
    ui.alert('L·ªói', 'Kh√¥ng t√¨m th·∫•y m·ªôt trong c√°c sheet c·∫ßn thi·∫øt (Thongtinxe, KhoXe, DaGhep).', ui.ButtonSet.OK);
    return;
  }

  // --- B∆Ø·ªöC 1: L·∫§Y D·ªÆ LI·ªÜU G·ªêC T·ª™ THONGTINXE ---
  const thongtinxeData = thongtinxeSheet.getDataRange().getValues();
  const thongtinxeHeaders = thongtinxeData[0];
  const vinColMaster = thongtinxeHeaders.indexOf("S·ªë VIN");
  let masterData = null;

  for (let i = 1; i < thongtinxeData.length; i++) {
    if (String(thongtinxeData[i][vinColMaster]).trim().toUpperCase() === vinToFix) {
      masterData = thongtinxeData[i];
      break;
    }
  }

  if (!masterData) {
    ui.alert('L·ªói', `Kh√¥ng t√¨m th·∫•y s·ªë VIN "${vinToFix}" trong sheet d·ªØ li·ªáu g·ªëc 'Thongtinxe'.`, ui.ButtonSet.OK);
    return;
  }

  // Tr√≠ch xu·∫•t d·ªØ li·ªáu chu·∫©n
  const correctInfo = {
    dongXe: masterData[thongtinxeHeaders.indexOf("M√¥ t·∫£ s·∫£n ph·∫©m")] || "",
    phienBan: masterData[thongtinxeHeaders.indexOf("Phi√™n b·∫£n")] || "",
    ngoaiThat: masterData[thongtinxeHeaders.indexOf("M√†u ngo·∫°i th·∫•t xe")] || "",
    noiThat: masterData[thongtinxeHeaders.indexOf("M√†u n·ªôi th·∫•t xe")] || "",
    maDMS: masterData[thongtinxeHeaders.indexOf("Khu v·ª±c")] || ""
  };
  
  let fixesMade = [];

  // --- B∆Ø·ªöC 2: S·ª¨A D·ªÆ LI·ªÜU TRONG KHOXE ---
  const khoXeData = khoXeSheet.getDataRange().getValues();
  const khoXeHeaders = khoXeData[0];
  const vinColKhoXe = khoXeHeaders.indexOf("VIN");
  for (let i = 1; i < khoXeData.length; i++) {
    if (String(khoXeData[i][vinColKhoXe]).trim().toUpperCase() === vinToFix) {
      khoXeSheet.getRange(i + 1, khoXeHeaders.indexOf("D√≤ng xe") + 1).setValue(correctInfo.dongXe);
      khoXeSheet.getRange(i + 1, khoXeHeaders.indexOf("Phi√™n b·∫£n") + 1).setValue(correctInfo.phienBan);
      khoXeSheet.getRange(i + 1, khoXeHeaders.indexOf("Ngo·∫°i th·∫•t") + 1).setValue(correctInfo.ngoaiThat);
      khoXeSheet.getRange(i + 1, khoXeHeaders.indexOf("N·ªôi th·∫•t") + 1).setValue(correctInfo.noiThat);
      khoXeSheet.getRange(i + 1, khoXeHeaders.indexOf("M√£ DMS") + 1).setValue(correctInfo.maDMS);
      fixesMade.push("KhoXe");
      break;
    }
  }

  // --- B∆Ø·ªöC 3: S·ª¨A D·ªÆ LI·ªÜU TRONG DAGHEP ---
  const daGhepData = daGhepSheet.getDataRange().getValues();
  const daGhepHeaders = daGhepData[0];
  const vinColDaGhep = daGhepHeaders.indexOf("VIN");
  for (let i = 1; i < daGhepData.length; i++) {
    if (String(daGhepData[i][vinColDaGhep]).trim().toUpperCase() === vinToFix) {
      daGhepSheet.getRange(i + 1, daGhepHeaders.indexOf("D√≤ng xe") + 1).setValue(correctInfo.dongXe);
      daGhepSheet.getRange(i + 1, daGhepHeaders.indexOf("Phi√™n b·∫£n") + 1).setValue(correctInfo.phienBan);
      daGhepSheet.getRange(i + 1, daGhepHeaders.indexOf("Ngo·∫°i th·∫•t") + 1).setValue(correctInfo.ngoaiThat);
      daGhepSheet.getRange(i + 1, daGhepHeaders.indexOf("N·ªôi th·∫•t") + 1).setValue(correctInfo.noiThat);
      fixesMade.push("DaGhep");
      break;
    }
  }

  if (fixesMade.length > 0) {
     ui.alert('Th√†nh c√¥ng', `ƒê√£ ƒë·ªìng b·ªô h√≥a v√† s·ª≠a ch·ªØa d·ªØ li·ªáu cho VIN "${vinToFix}" trong c√°c sheet: ${fixesMade.join(', ')}. Vui l√≤ng th·ª≠ l·∫°i thao t√°c tr√™n web.`, ui.ButtonSet.OK);
  } else {
     ui.alert('Th√¥ng b√°o', `Kh√¥ng t√¨m th·∫•y VIN "${vinToFix}" trong 'KhoXe' ho·∫∑c 'DaGhep' ƒë·ªÉ s·ª≠a. D·ªØ li·ªáu g·ªëc ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.`, ui.ButtonSet.OK);
  }
}
/**
 * H√†m ti·ªán √≠ch ƒë·ªÉ chu·∫©n h√≥a t√™n m·ªôt c√°ch m·∫°nh m·∫Ω.
 * X√≥a kho·∫£ng tr·∫Øng th·ª´a, chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng v√† chu·∫©n h√≥a Unicode.
 * @param {string} name T√™n c·∫ßn chu·∫©n h√≥a.
 * @returns {string} T√™n ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a.
 */
function normalizeNameGas(name) {
  if (typeof name !== 'string' || !name) {
    return "";
  }
  return name
    .trim()             // 1. X√≥a kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi
    .replace(/\s+/g, ' ') // 2. G·ªôp nhi·ªÅu kho·∫£ng tr·∫Øng th√†nh m·ªôt
    .toLowerCase()      // 3. Chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng
    .normalize('NFC');  // 4. Chu·∫©n h√≥a Unicode
}

function getPaginatedData(params) {
  try {
    const currentUser = params.currentUser;
    const isAdmin = params.isAdmin === 'true';
    const filtersParam = params.filters ? JSON.parse(params.filters) : {};
    const usersToView = filtersParam.usersToView || [];

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const daGhepSheet = ss.getSheetByName(DA_GHEP_SHEET_NAME);
    const chuaGhepSheet = ss.getSheetByName(CHUA_GHEP_SHEET_NAME);

    // --- B·∫ÆT ƒê·∫¶U KHU V·ª∞C S·ª¨A L·ªñI ---
    let daGhepData = [];
    if (daGhepSheet) {
      // 1. L·∫•y t√™n header c·ªßa c·ªôt M (ch·ªâ s·ªë 12)
      const daGhepHeaders = daGhepSheet.getRange(1, 1, 1, daGhepSheet.getLastColumn()).getValues()[0];
      const vcStatusHeaderFromColM = daGhepHeaders[12];

      // 2. S·ª≠ d·ª•ng l·∫°i h√†m g·ªëc ƒë·ªÉ l·∫•y d·ªØ li·ªáu, tr√°nh l·ªói type
      const daGhepDataObjects = getAllSheetData(daGhepSheet);

      // 3. C·∫≠p nh·∫≠t tr·∫°ng th√°i VC b·∫±ng gi√° tr·ªã t·ª´ c·ªôt M
      daGhepData = daGhepDataObjects.map(row => {
        let vcStatus = "";
        if (vcStatusHeaderFromColM && row[vcStatusHeaderFromColM]) {
          vcStatus = row[vcStatusHeaderFromColM];
        } else if (row["Tr·∫°ng th√°i VC"]) {
          vcStatus = row["Tr·∫°ng th√°i VC"];
        }
        row["Tr·∫°ng th√°i VC"] = vcStatus; // Ghi ƒë√® l·∫°i tr·∫°ng th√°i VC trong object
        return row;
      });
    }
    // --- K·∫æT TH√öC KHU V·ª∞C S·ª¨A L·ªñI ---

    const chuaGhepData = getAllSheetData(chuaGhepSheet);
    let combinedData = [...daGhepData, ...chuaGhepData];
    
    // Ph·∫ßn logic c√≤n l·∫°i c·ªßa h√†m ƒë∆∞·ª£c gi·ªØ nguy√™n
    let filteredData;
    if (isAdmin) {
      filteredData = combinedData;
    } else if (usersToView && usersToView.length > 0) {
      const usersSet = new Set(usersToView.map(normalizeNameGas));
      filteredData = combinedData.filter(row => {
        const tvbhName = normalizeNameGas(row["T√™n t∆∞ v·∫•n b√°n h√†ng"]);
        return usersSet.has(tvbhName);
      });
    } else {
      const currentUserNormalized = normalizeNameGas(currentUser);
      filteredData = combinedData.filter(row => {
         const tvbhName = normalizeNameGas(row["T√™n t∆∞ v·∫•n b√°n h√†ng"]);
         return tvbhName === currentUserNormalized;
      });
    }

    const sortBy = params.sortBy || 'Th·ªùi gian nh·∫≠p';
    const sortOrder = params.sortOrder || 'desc';
    filteredData.sort((a, b) => {
      let valA = a[sortBy] ?? "";
      let valB = b[sortBy] ?? "";
      if (['Ng√†y c·ªçc', 'Th·ªùi gian nh·∫≠p', 'Th·ªùi gian gh√©p'].includes(sortBy)) {
        valA = valA ? new Date(valA).getTime() : 0;
        valB = valB ? new Date(valB).getTime() : 0;
      }
      if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
      if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
      return 0;
    });
    
    const page = parseInt(params.page, 10) || 1;
    const pageSize = parseInt(params.pageSize, 10) || 50;
    const totalItems = filteredData.length;
    const totalPages = Math.ceil(totalItems / pageSize);
    const startIndex = (page - 1) * pageSize;
    const paginatedData = filteredData.slice(startIndex, startIndex + pageSize);
    
    const totalDataForAllUsers = [...daGhepData, ...chuaGhepData];
    const summary = { topCar: "N/A", topAdvisor: "N/A" };
    if (totalDataForAllUsers.length > 0) {
        const carCounts = totalDataForAllUsers.reduce((acc, row) => {
            if (row["D√≤ng xe"]) acc[row["D√≤ng xe"]] = (acc[row["D√≤ng xe"]] || 0) + 1;
            return acc;
        }, {});
        const topCarEntry = Object.entries(carCounts).sort((a, b) => b[1] - a[1])[0];
        if (topCarEntry) summary.topCar = `${topCarEntry[0]} (${topCarEntry[1]})`;
        const advisorCounts = totalDataForAllUsers.reduce((acc, row) => {
            if (row["T√™n t∆∞ v·∫•n b√°n h√†ng"]) acc[row["T√™n t∆∞ v·∫•n b√°n h√†ng"]] = (acc[row["T√™n t∆∞ v·∫•n b√°n h√†ng"]] || 0) + 1;
            return acc;
        }, {});
        const topAdvisorEntry = Object.entries(advisorCounts).sort((a, b) => b[1] - a[1])[0];
        if (topAdvisorEntry) summary.topAdvisor = `${topAdvisorEntry[0]} (${topAdvisorEntry[1]})`;
    }

    return createJsonResponse({
      status: "SUCCESS",
      data: paginatedData,
      totalItems: totalItems,
      totalPages: totalPages,
      currentPage: page,
      summary: summary
    });
  } catch (e) {
    Logger.log(`L·ªói trong getPaginatedData: ${e.message}, Stack: ${e.stack}`);
    sendErrorAlert('getPaginatedData', e);
    return createJsonResponse({ status: "ERROR", message: `L·ªói m√°y ch·ªß khi l·∫•y d·ªØ li·ªáu: ${e.message}` });
  }
}
// [THAY TH·∫æ] - To√†n b·ªô h√†m getArchivedDataPage c≈© b·∫±ng phi√™n b·∫£n c√≥ l·ªçc theo ng∆∞·ªùi d√πng
function getArchivedDataPage(params) {
  try {
    const page = parseInt(params.page, 10) || 1;
    const pageSize = 100;
    let currentArchiveName = params.archiveSheetName;

    // [N√ÇNG C·∫§P] - L·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ request
    const currentUser = params.currentUser;
    const isAdmin = params.isAdmin === 'true';
    
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const allSheets = ss.getSheets();
    const archiveSheetRegex = /^LuuTru_\d{4}_\d{2}$/;

    const sortedArchiveSheets = allSheets
      .filter(sheet => archiveSheetRegex.test(sheet.getName()))
      .sort((a, b) => b.getName().localeCompare(a.getName()));

    if (sortedArchiveSheets.length === 0) {
      return createJsonResponse({ status: "SUCCESS", data: [], isLastArchive: true });
    }

    if (!currentArchiveName) {
      currentArchiveName = sortedArchiveSheets[0].getName();
    }

    const currentArchiveSheet = ss.getSheetByName(currentArchiveName);
    if (!currentArchiveSheet) {
      throw new Error(`Kh√¥ng t√¨m th·∫•y sheet l∆∞u tr·ªØ: ${currentArchiveName}`);
    }

    const rawArchiveData = getAllSheetData(currentArchiveSheet);
    
    // [N√ÇNG C·∫§P] - L·ªçc d·ªØ li·ªáu n·∫øu ng∆∞·ªùi d√πng kh√¥ng ph·∫£i l√† Admin
    let filteredData = rawArchiveData;
    if (!isAdmin && currentUser) {
        const normalizedCurrentUser = normalizeString(currentUser);
        filteredData = rawArchiveData.filter(row => {
            const tvbh = row["T∆Ø V·∫§N B√ÅN H√ÄNG"] || "";
            return normalizeString(tvbh) === normalizedCurrentUser;
        });
    }

    // Chu·∫©n h√≥a d·ªØ li·ªáu sau khi ƒë√£ l·ªçc
    const archiveData = filteredData.map(row => {
      return {
        "T√™n kh√°ch h√†ng": row["T√äN KH√ÅCH H√ÄNG"],
        "S·ªë ƒë∆°n h√†ng": row["S·ªê ƒê∆†N H√ÄNG"],
        "T√™n t∆∞ v·∫•n b√°n h√†ng": row["T∆Ø V·∫§N B√ÅN H√ÄNG"],
        "D√≤ng xe": row["D√íNG XE"],
        "Phi√™n b·∫£n": row["PHI√äN B·∫¢N"],
        "Ngo·∫°i th·∫•t": row["NGO·∫†I TH·∫§T"],
        "N·ªôi th·∫•t": row["N·ªòI TH·∫§T"],
        "VIN": row["S·ªê VIN"],
        "K·∫øt qu·∫£": "ƒê√£ xu·∫•t h√≥a ƒë∆°n",
        "Ng√†y xu·∫•t h√≥a ƒë∆°n": row["NG√ÄY XU·∫§T H√ìA ƒê∆†N"],
        "Th·ªùi gian nh·∫≠p": row["NG√ÄY Y√äU C·∫¶U XHƒê"],
      };
    });

    const totalItemsInArchive = archiveData.length;
    const totalPagesInArchive = Math.ceil(totalItemsInArchive / pageSize);
    const startIndex = (page - 1) * pageSize;
    const paginatedData = archiveData.slice(startIndex, startIndex + pageSize);

    let nextArchiveSheetName = null;
    let isLastPageOfCurrentArchive = (page >= totalPagesInArchive);
    let isLastArchiveOverall = false;

    if (isLastPageOfCurrentArchive) {
      const currentIndex = sortedArchiveSheets.findIndex(s => s.getName() === currentArchiveName);
      if (currentIndex > -1 && currentIndex + 1 < sortedArchiveSheets.length) {
        nextArchiveSheetName = sortedArchiveSheets[currentIndex + 1].getName();
      } else {
        isLastArchiveOverall = true;
      }
    }

    return createJsonResponse({
      status: "SUCCESS",
      data: paginatedData,
      currentArchiveSheetName: currentArchiveName,
      nextArchiveSheetName: nextArchiveSheetName,
      isLastArchive: isLastArchiveOverall && isLastPageOfCurrentArchive
    });

  } catch (e) {
    Logger.log(`L·ªói trong getArchivedDataPage: ${e.message}`);
    return createJsonResponse({ status: "ERROR", message: e.message });
  }
}
/**
 * [S·ª¨A L·ªñI TRI·ªÜT ƒê·ªÇ] L·∫•y to√†n b·ªô d·ªØ li·ªáu l∆∞u tr·ªØ cho ng∆∞·ªùi d√πng.
 * - S·ª≠a l·ªói "toLowerCase" b·∫±ng c√°ch √©p bu·ªôc t·∫•t c·∫£ c√°c gi√° tr·ªã tr·∫£ v·ªÅ th√†nh chu·ªói (string).
 * - V·∫´n ∆∞u ti√™n l·∫•y tr·∫°ng th√°i VC t·ª´ c·ªôt U c·ªßa c√°c sheet LuuTru.
 */
function getAllArchivedDataForUser(params) {
  try {
    const currentUser = params.currentUser;
    const isAdmin = params.isAdmin === 'true';

    if (!currentUser || isAdmin) {
      return createJsonResponse({ status: "SUCCESS", data: [] });
    }

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const allSheets = ss.getSheets();
    const archiveSheetRegex = /^LuuTru_\d{4}_\d{2}$/;
    const sortedArchiveSheets = allSheets
      .filter(sheet => archiveSheetRegex.test(sheet.getName()))
      .sort((a, b) => b.getName().localeCompare(a.getName()));
    
    if (sortedArchiveSheets.length === 0) {
      return createJsonResponse({ status: "SUCCESS", data: [] });
    }

    let allUserArchives = [];
    const normalizedCurrentUser = normalizeString(currentUser);
    
    for (const sheet of sortedArchiveSheets) {
      if (sheet.getLastRow() < 2) continue;

      // L·∫•y headers v√† d·ªØ li·ªáu b·∫±ng h√†m g·ªëc ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn
      const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      const vcStatusHeaderFromColU = headers[20]; // Header c·ªßa C·ªôt U
      const rawArchiveData = getAllSheetDataWithHyperlink(sheet);
      
      const filteredData = rawArchiveData.filter(row => {
        const tvbh = row["T∆Ø V·∫§N B√ÅN H√ÄNG"] || "";
        return normalizeString(String(tvbh)) === normalizedCurrentUser; // Chuy·ªÉn tvbh th√†nh string tr∆∞·ªõc khi so s√°nh
      });

      // --- B·∫ÆT ƒê·∫¶U KHU V·ª∞C S·ª¨A L·ªñI QUAN TR·ªåNG ---
      // √Ånh x·∫° l·∫°i d·ªØ li·ªáu, ƒë·∫£m b·∫£o M·ªåI TR∆Ø·ªúNG ƒë·ªÅu l√† chu·ªói (string)
      const mappedData = filteredData.map(row => {
        let vcStatus = "";
        if (vcStatusHeaderFromColU && row[vcStatusHeaderFromColU]) {
          vcStatus = row[vcStatusHeaderFromColU];
        } else if (row["Tr·∫°ng th√°i VC"]) {
          vcStatus = row["Tr·∫°ng th√°i VC"];
        }

        return {
          "T√™n kh√°ch h√†ng": String(row["T√äN KH√ÅCH H√ÄNG"] || ""),
          "S·ªë ƒë∆°n h√†ng": String(row["S·ªê ƒê∆†N H√ÄNG"] || ""),
          "T√™n t∆∞ v·∫•n b√°n h√†ng": String(row["T∆Ø V·∫§N B√ÅN H√ÄNG"] || ""),
          "D√≤ng xe": String(row["D√íNG XE"] || ""),
          "Phi√™n b·∫£n": String(row["PHI√äN B·∫¢N"] || ""),
          "Ngo·∫°i th·∫•t": String(row["NGO·∫†I TH·∫§T"] || ""),
          "N·ªôi th·∫•t": String(row["N·ªòI TH·∫§T"] || ""),
          "VIN": String(row["S·ªê VIN"] || ""),
          "K·∫øt qu·∫£": "ƒê√£ xu·∫•t h√≥a ƒë∆°n",
          "Tr·∫°ng th√°i VC": String(vcStatus || ""),
          "Ng√†y xu·∫•t h√≥a ƒë∆°n": String(row["NG√ÄY XU·∫§T H√ìA ƒê∆†N"] || ""),
          "Th·ªùi gian nh·∫≠p": String(row["NG√ÄY Y√äU C·∫¶U XHƒê"] || ""),
          "LinkHoaDonDaXuat": String(row["URL H√≥a ƒê∆°n ƒê√£ Xu·∫•t"] || "")
        };
      });
      // --- K·∫æT TH√öC KHU V·ª∞C S·ª¨A L·ªñI QUAN TR·ªåNG ---

      if (mappedData.length > 0) {
        allUserArchives.push(...mappedData);
      }
    }

    return createJsonResponse({ status: "SUCCESS", data: allUserArchives });
  } catch (e) {
    Logger.log(`L·ªói trong getAllArchivedDataForUser: ${e.message} Stack: ${e.stack}`);
    return createJsonResponse({ status: "ERROR", message: e.message });
  }
}
function handleGetTestDriveSchedule() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(TEST_DRIVE_SHEET_NAME);
  if (!sheet) {
    throw new Error(`Kh√¥ng t√¨m th·∫•y trang t√≠nh "${TEST_DRIVE_SHEET_NAME}". Vui l√≤ng ch·∫°y h√†m setupTestDriveSheet.`);
  }
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) {
    return { status: 'SUCCESS', data: [] };
  }
  
  const headers = data[0];
  const spreadsheetTimeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();
  
  const schedule = data.slice(1).map(row => {
    const booking = {};
    headers.forEach((header, index) => {
      const cellValue = row[index];
      if (cellValue instanceof Date) {
        if (['thoiGianKhoiHanh', 'thoiGianTroVe'].includes(header)) {
          booking[header] = Utilities.formatDate(cellValue, spreadsheetTimeZone, "HH:mm");
        } else {
          booking[header] = Utilities.formatDate(cellValue, spreadsheetTimeZone, "yyyy-MM-dd");
        }
      } else {
        booking[header] = cellValue;
      }
    });
    return booking;
  });

  return { status: 'SUCCESS', data: schedule };
}

function handleSaveTestDriveBooking(params) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(TEST_DRIVE_SHEET_NAME);
  if (!sheet) {
    throw new Error(`Kh√¥ng t√¨m th·∫•y trang t√≠nh "${TEST_DRIVE_SHEET_NAME}".`);
  }
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  const newRow = headers.map(header => {
    const value = params[header] || '';
    if ((header === 'dienThoai' || header === 'gplxSo') && value) {
      return "'" + value; 
    }
    return value;
  });

  sheet.appendRow(newRow);
  
  const newRecord = {};
  headers.forEach((header, index) => {
    newRecord[header] = params[header] || '';
  });

  return { status: 'SUCCESS', message: 'L·ªãch l√°i th·ª≠ ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng.', newRecord: newRecord };
}

function handleUpdateTestDriveCheckin(data) {
  // S·ª≠a l·ªói: S·ª≠ d·ª•ng 'soPhieu' thay v√¨ 'id' ƒë·ªÉ kh·ªõp v·ªõi d·ªØ li·ªáu t·ª´ frontend.
  const {
    soPhieu,
    odoBefore,
    odoAfter,
    imagesBefore,
    imagesAfter
  } = data;

  if (!soPhieu) {
    return createJsonResponse({
      success: false,
      message: 'Thi·∫øu S·ªë Phi·∫øu c·ªßa l·ªãch h·∫πn.'
    });
  }

  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(TEST_DRIVE_SHEET_NAME);
    if (!sheet) {
      throw new Error(`Kh√¥ng t√¨m th·∫•y trang t√≠nh "${TEST_DRIVE_SHEET_NAME}".`);
    }
    
    const dataRange = sheet.getDataRange();
    const values = dataRange.getValues();
    const headers = values[0];
    const spreadsheetTimeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();

    // S·ª≠a l·ªói: T√¨m c·ªôt 'soPhieu' thay v√¨ 'ID'.
    const soPhieuColIndex = headers.indexOf('soPhieu');
    if (soPhieuColIndex === -1) {
      throw new Error("Kh√¥ng t√¨m th·∫•y c·ªôt 'soPhieu' trong trang t√≠nh.");
    }

    const rowIndex = values.findIndex(row => String(row[soPhieuColIndex]) === String(soPhieu));

    if (rowIndex === -1) {
      return createJsonResponse({
        success: false,
        message: 'Kh√¥ng t√¨m th·∫•y l·ªãch h·∫πn v·ªõi S·ªë Phi·∫øu: ' + soPhieu
      });
    }

    const rowNumber = rowIndex + 1; // rowNumber l√† ch·ªâ s·ªë 1-based cho getRange
    const rowData = values[rowIndex];

    // C·∫£i ti·∫øn: T·∫°o th∆∞ m·ª•c l∆∞u ·∫£nh c√≥ c·∫•u tr√∫c ƒë·ªÉ d·ªÖ qu·∫£n l√Ω.
    const tenTuVan = rowData[headers.indexOf('tenTuVan')];
    const tenKhachHang = rowData[headers.indexOf('tenKhachHang')];
    const ngayThuXe = new Date(rowData[headers.indexOf('ngayThuXe')]);
    const formattedDate = Utilities.formatDate(ngayThuXe, spreadsheetTimeZone, "yyyy-MM-dd");
    
    const folderPath = `${sanitizeFolderName(tenTuVan)}/${formattedDate}_${sanitizeFolderName(tenKhachHang)}`;
    const rootFolder = DriveApp.getFolderById(TEST_DRIVE_IMAGE_FOLDER_ID);
    const targetFolder = getOrCreateFolderByPath(rootFolder, folderPath);

    // S·ª≠a l·ªói: T√¨m v·ªã tr√≠ c·ªôt ƒë·ªông thay v√¨ d√πng v·ªã tr√≠ c·ªë ƒë·ªãnh.
    const updateCell = (headerName, value) => {
      const colIndex = headers.indexOf(headerName);
      if (value !== undefined && value !== null && colIndex !== -1) {
        sheet.getRange(rowNumber, colIndex + 1).setValue(value);
      }
    };

    const appendImages = (headerName, newImagesJson) => {
      const colIndex = headers.indexOf(headerName);
      if (newImagesJson && colIndex !== -1) {
        const existingImagesJson = sheet.getRange(rowNumber, colIndex + 1).getValue();
        let existingUrls = [];
        if (existingImagesJson && typeof existingImagesJson === 'string' && existingImagesJson.trim().startsWith('[')) {
          try {
            existingUrls = JSON.parse(existingImagesJson);
          } catch (e) {
            Logger.log(`L·ªói parse JSON ·∫£nh c≈© (${headerName}) cho soPhieu ${soPhieu}: ${e.toString()}`);
          }
        }
        
        // S·ª≠a l·ªói: G·ªçi h√†m saveBase64FilesToDrive v·ªõi ƒë√∫ng tham s·ªë.
        const newUrlsJsonString = saveBase64FilesToDrive(targetFolder, newImagesJson);
        const newUrls = JSON.parse(newUrlsJsonString);
        
        const combinedUrls = [...existingUrls, ...newUrls];
        sheet.getRange(rowNumber, colIndex + 1).setValue(JSON.stringify(combinedUrls));
      }
    };

    updateCell('odoBefore', odoBefore);
    updateCell('odoAfter', odoAfter);
    appendImages('imagesBefore', imagesBefore);
    appendImages('imagesAfter', imagesAfter);
    
    // C·∫£i ti·∫øn: Tr·∫£ v·ªÅ b·∫£n ghi ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ frontend c√≥ th·ªÉ l√†m m·ªõi giao di·ªán.
    const updatedRowData = sheet.getRange(rowNumber, 1, 1, headers.length).getValues()[0];
    const updatedRecord = {};
    headers.forEach((header, index) => {
        const cellValue = updatedRowData[index];
        if (cellValue instanceof Date) {
            if (['thoiGianKhoiHanh', 'thoiGianTroVe'].includes(header)) {
                updatedRecord[header] = Utilities.formatDate(cellValue, spreadsheetTimeZone, "HH:mm");
            } else {
                updatedRecord[header] = Utilities.formatDate(cellValue, spreadsheetTimeZone, "yyyy-MM-dd");
            }
        } else {
            updatedRecord[header] = cellValue;
        }
    });

    return {
      success: true,
      message: 'C·∫≠p nh·∫≠t check-in th√†nh c√¥ng.',
      updatedRecord: updatedRecord
    };

  } catch (e) {
    Logger.log('L·ªói nghi√™m tr·ªçng trong handleUpdateTestDriveCheckin: ' + e.toString() + (e.stack ? '\n' + e.stack : ''));
    return createJsonResponse({
      success: false,
      message: 'ƒê√£ x·∫£y ra l·ªói h·ªá th·ªëng nghi√™m tr·ªçng: ' + e.toString()
    });
  }
}

function handleDeleteTestDriveRequest(params) {
¬† const { soPhieu } = params;
¬† if (!soPhieu) {
¬† ¬† throw new Error("Thi·∫øu 's·ªë phi·∫øu' ƒë·ªÉ th·ª±c hi·ªán x√≥a.");
¬† }

¬† const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(TEST_DRIVE_SHEET_NAME);
¬† if (!sheet) throw new Error(`Kh√¥ng t√¨m th·∫•y trang t√≠nh "${TEST_DRIVE_SHEET_NAME}".`);

¬† const data = sheet.getDataRange().getValues();
¬† const headers = data[0];
¬† const soPhieuColIndex = headers.indexOf('soPhieu');
¬† if (soPhieuColIndex === -1) throw new Error("Kh√¥ng t√¨m th·∫•y c·ªôt 'soPhieu'.");

¬† const rowIndex = data.findIndex(row => String(row[soPhieuColIndex]) === String(soPhieu));
¬† if (rowIndex === -1) throw new Error(`Kh√¥ng t√¨m th·∫•y phi·∫øu l√°i th·ª≠ v·ªõi s·ªë: ${soPhieu}`);

¬† const rowNumber = rowIndex + 1;
¬† const rowData = data[rowIndex];

¬† // L·∫•y danh s√°ch ƒë·ªëi t∆∞·ª£ng ·∫£nh tr∆∞·ªõc khi x√≥a
¬† const imagesBeforeData = JSON.parse(rowData[headers.indexOf('imagesBefore')] || '[]');
¬† const imagesAfterData = JSON.parse(rowData[headers.indexOf('imagesAfter')] || '[]');
¬† const allImageData = [...imagesBeforeData, ...imagesAfterData];

¬† // === S·ª¨A ƒê·ªîI T·∫†I ƒê√ÇY ===
¬† // X√≥a file ·∫£nh tr√™n Google Drive b·∫±ng c√°ch truy c·∫≠p v√†o thu·ªôc t√≠nh 'url' c·ªßa m·ªói ƒë·ªëi t∆∞·ª£ng.
¬† allImageData.forEach(imageObj => {
¬† ¬† if (imageObj && imageObj.url) { // Ki·ªÉm tra xem ƒë·ªëi t∆∞·ª£ng v√† thu·ªôc t√≠nh url c√≥ t·ªìn t·∫°i kh√¥ng
¬† ¬† ¬† try {
¬† ¬† ¬† ¬† const fileId = imageObj.url.match(/id=([^&]+)/)[1];
¬† ¬† ¬† ¬† if (fileId) {
¬† ¬† ¬† ¬† ¬† DriveApp.getFileById(fileId).setTrashed(true);
¬† ¬† ¬† ¬† ¬† Logger.log(`ƒê√£ x√≥a file c√≥ ID: ${fileId}`);
¬† ¬† ¬† ¬† }
¬† ¬† ¬† } catch (e) {
¬† ¬† ¬† ¬† Logger.log(`Kh√¥ng th·ªÉ x√≥a file t·ª´ URL: ${imageObj.url}. L·ªói: ${e.message}`);
¬† ¬† ¬† }
¬† ¬† }
¬† });

¬† // X√≥a d√≤ng trong trang t√≠nh
¬† sheet.deleteRow(rowNumber);

¬† return { status: 'SUCCESS', success: true, message: `ƒê√£ x√≥a th√†nh c√¥ng y√™u c·∫ßu l√°i th·ª≠ c√≥ s·ªë phi·∫øu: ${soPhieu}` };
}

// M·ªöI: H√†m x·ª≠ l√Ω th√™m ·∫£nh v√†o y√™u c·∫ßu l√°i th·ª≠ ƒë√£ t·ªìn t·∫°i
function handleAddTestDriveImages(params) {
  const { soPhieu, imagesBefore, imagesAfter } = params;
  if (!soPhieu) throw new Error("Thi·∫øu 's·ªë phi·∫øu' ƒë·ªÉ c·∫≠p nh·∫≠t ·∫£nh.");
  if (!imagesBefore && !imagesAfter) throw new Error("Kh√¥ng c√≥ ·∫£nh m·ªõi ƒë·ªÉ th√™m.");

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(TEST_DRIVE_SHEET_NAME);
  if (!sheet) throw new Error(`Kh√¥ng t√¨m th·∫•y trang t√≠nh "${TEST_DRIVE_SHEET_NAME}".`);

  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const soPhieuColIndex = headers.indexOf('soPhieu');
  if (soPhieuColIndex === -1) throw new Error("Kh√¥ng t√¨m th·∫•y c·ªôt 'soPhieu'.");
  
  const rowIndex = data.findIndex(row => String(row[soPhieuColIndex]) === String(soPhieu));
  if (rowIndex === -1) throw new Error(`Kh√¥ng t√¨m th·∫•y phi·∫øu l√°i th·ª≠ v·ªõi s·ªë: ${soPhieu}`);

  const rowNumber = rowIndex + 1;
  const rowData = data[rowIndex];
  const spreadsheetTimeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();
  
  const tenTuVan = rowData[headers.indexOf('tenTuVan')];
  const tenKhachHang = rowData[headers.indexOf('tenKhachHang')];
  const ngayThuXe = new Date(rowData[headers.indexOf('ngayThuXe')]);
  const formattedDate = Utilities.formatDate(ngayThuXe, spreadsheetTimeZone, "yyyy-MM-dd");
  
  const folderPath = `${sanitizeFolderName(tenTuVan)}/${formattedDate}_${sanitizeFolderName(tenKhachHang)}`;
  const rootFolder = DriveApp.getFolderById(TEST_DRIVE_IMAGE_FOLDER_ID);
  const targetFolder = getOrCreateFolderByPath(rootFolder, folderPath);

  // X·ª≠ l√Ω ·∫£nh tr∆∞·ªõc
  if (imagesBefore) {
    const imagesBeforeColIndex = headers.indexOf('imagesBefore');
    const existingUrls = JSON.parse(rowData[imagesBeforeColIndex] || '[]');
    const newUrlsJson = saveBase64FilesToDrive(targetFolder, imagesBefore);
    const newUrls = JSON.parse(newUrlsJson);
    const combinedUrls = JSON.stringify([...existingUrls, ...newUrls]);
    sheet.getRange(rowNumber, imagesBeforeColIndex + 1).setValue(combinedUrls);
  }

  // X·ª≠ l√Ω ·∫£nh sau
  if (imagesAfter) {
    const imagesAfterColIndex = headers.indexOf('imagesAfter');
    const existingUrls = JSON.parse(rowData[imagesAfterColIndex] || '[]');
    const newUrlsJson = saveBase64FilesToDrive(targetFolder, imagesAfter);
    const newUrls = JSON.parse(newUrlsJson);
    const combinedUrls = JSON.stringify([...existingUrls, ...newUrls]);
    sheet.getRange(rowNumber, imagesAfterColIndex + 1).setValue(combinedUrls);
  }
  
  // Tr·∫£ v·ªÅ b·∫£n ghi ƒë√£ c·∫≠p nh·∫≠t
  const updatedRowData = sheet.getRange(rowNumber, 1, 1, headers.length).getValues()[0];
  const updatedRecord = {};
  headers.forEach((header, index) => {
    const cellValue = updatedRowData[index];
    if (cellValue instanceof Date) {
      if (['thoiGianKhoiHanh', 'thoiGianTroVe'].includes(header)) {
        updatedRecord[header] = Utilities.formatDate(cellValue, spreadsheetTimeZone, "HH:mm");
      } else {
        updatedRecord[header] = Utilities.formatDate(cellValue, spreadsheetTimeZone, "yyyy-MM-dd");
      }
    } else {
      updatedRecord[header] = cellValue;
    }
  });

  return { status: 'SUCCESS', success: true, message: 'C·∫≠p nh·∫≠t ·∫£nh th√†nh c√¥ng.', updatedRecord: updatedRecord };
}


// =================================================================
//   C√ÅC H√ÄM TI·ªÜN √çCH
// =================================================================

function getOrCreateFolderByPath(rootFolder, path) {
  let currentFolder = rootFolder;
  path.split('/').forEach(part => {
    if (part) {
      const iterator = currentFolder.getFoldersByName(part);
      currentFolder = iterator.hasNext() ? iterator.next() : currentFolder.createFolder(part);
    }
  });
  return currentFolder;
}

function sanitizeFolderName(name) {
  return name ? name.replace(/[\\/]/g, '_') : 'unknown';
}

function saveBase64FilesToDrive(targetFolder, filesDataJsonString) {
  if (!filesDataJsonString) return '[]';

  if (TEST_DRIVE_IMAGE_FOLDER_ID === 'YOUR_FOLDER_ID_HERE' || !TEST_DRIVE_IMAGE_FOLDER_ID) {
    throw new Error('Ch∆∞a c·∫•u h√¨nh TEST_DRIVE_IMAGE_FOLDER_ID trong Google Apps Script.');
  }

  const filesData = JSON.parse(filesDataJsonString);
  if (!Array.isArray(filesData) || filesData.length === 0) return '[]';

  const fileDetails = filesData.map(fileInfo => {
    if (!fileInfo || !fileInfo.data || !fileInfo.type || !fileInfo.name) {
      Logger.log("B·ªè qua m·ªôt m·ª•c file v√¨ thi·∫øu th√¥ng tin c·∫ßn thi·∫øt (data, type, ho·∫∑c name).");
      return null;
    }

    let base64Data;
    if (fileInfo.data.startsWith('data:')) {
      const parts = fileInfo.data.split(',');
      if (parts.length === 2) {
        base64Data = parts[1];
      } else {
        throw new Error(`Chu·ªói Data URL kh√¥ng h·ª£p l·ªá cho file: ${fileInfo.name}`);
      }
    } else {
      base64Data = fileInfo.data;
    }

    try {
      const decoded = Utilities.base64Decode(base64Data, Utilities.Charset.UTF_8);
      const blob = Utilities.newBlob(decoded, fileInfo.type, fileInfo.name);
      const file = targetFolder.createFile(blob);

      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

      const fileId = file.getId();

      // === S·ª¨A ƒê·ªîI T·∫†I ƒê√ÇY ===
      // Tr·∫£ v·ªÅ m·ªôt chu·ªói URL thumbnail c·ªßa ·∫£nh.
      return `https://drive.google.com/thumbnail?id=${fileId}`;
      
    } catch (e) {
      Logger.log(`L·ªói nghi√™m tr·ªçng khi gi·∫£i m√£ ho·∫∑c t·∫°o blob cho file "${fileInfo.name}": ${e.message}`);
      throw new Error(`Kh√¥ng th·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu cho file "${fileInfo.name}". C√≥ th·ªÉ d·ªØ li·ªáu base64 b·ªã h·ªèng.`);
    }
  }).filter(detail => detail != null);

  return JSON.stringify(fileDetails);
}

function createFullHtmlEmail(emailTitle, bodyContent) {
  return `<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${emailTitle}</title>
    <style>
        /* --- BASE STYLES --- */
        body, table, td, th { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; font-family: 'Roboto', Arial, sans-serif; }
        table { border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; }
        body { margin: 0; padding: 0; width: 100%; height: 100% !important; background-color: #f0f8ff; }
        img { -ms-interpolation-mode: bicubic; border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; }

        /* --- WINTER THEME COLORS --- */
        :root {
            --deep-blue: #0A638D;
            --light-blue: #5AC3E2;
            --background-icy: #e0f2f7;
            --text-color-dark: #3a4750;
            --highlight-icy: #C8E6F0;
            --dark-icy: #0A638D;
        }
        
        .email-wrapper { 
            background-color: #e0f2f7;
            padding: 40px 10px;
        }
        
        .email-container { 
            max-width: 600px; 
            margin: 0 auto; 
            border-radius: 12px;
            overflow: hidden; 
            box-shadow: 0 10px 25px rgba(10, 99, 141, 0.2);
            border: 1px solid #B3E5FC;
            
            /* --- C·∫¨P NH·∫¨T H√åNH N·ªÄN T·∫†I ƒê√ÇY --- */
            background-image: url('https://wallpapershome.com/images/pages/pic_v/26912.jpg');
            background-repeat: no-repeat;
            background-position: center top;
            background-size: cover; 
            background-color: #ffffff; /* M√†u d·ª± ph√≤ng */
        }
        
        .header-cell { 
            /* N·ªÅn t·ªëi b√°n trong su·ªët ƒë·ªÉ l√†m n·ªïi b·∫≠t ti√™u ƒë·ªÅ tr√™n n·ªÅn ·∫£nh */
            background-color: rgba(10, 99, 141, 0.92);
            color: #ffffff; 
            padding: 30px 25px; 
            text-align: center; 
            border-bottom: 4px solid #5AC3E2;
        }
        
        .header-title { 
            margin: 0; 
            font-size: 22px; 
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        
        .content-cell { 
            padding: 30px 25px; 
            /* N·ªÅn tr·∫Øng trong su·ªët 90% ƒë·ªÉ ch·ªØ d·ªÖ ƒë·ªçc ƒë√® l√™n ·∫£nh n·ªÅn */
            background-color: rgba(255, 255, 255, 0.90);
        }
        
        .content-title { 
            color: #0A638D; 
            font-size: 20px; 
            margin-top: 0; 
            margin-bottom: 20px;
            border-left: 4px solid #5AC3E2;
            padding-left: 12px;
        }
        
        .paragraph { 
            color: #3a4750; 
            font-size: 16px; 
            line-height: 1.6; 
            margin: 0 0 20px 0; 
        }
        
        .details-table { 
            width: 100%; 
            border: 1px solid #B3E5FC; 
            border-radius: 8px; 
            margin-bottom: 25px; 
            overflow: hidden;
            border-collapse: separate;
            border-spacing: 0;
            /* N·ªÅn b·∫£ng tr·∫Øng ho√†n to√†n ƒë·ªÉ d·ªØ li·ªáu r√µ r√†ng nh·∫•t */
            background-color: #ffffff; 
        }
        
        .details-row td { border-bottom: 1px solid #E1F5FE; }
        .details-row:last-child td { border-bottom: none; }
        
        .key-cell { 
            padding: 12px 15px; 
            color: #0A638D; 
            font-weight: 600; 
            width: 150px; 
            background-color: #f8fcff;
            vertical-align: top; 
            border-right: 1px solid #E1F5FE;
        }
        
        .value-cell { 
            padding: 12px 15px; 
            color: #333; 
            vertical-align: top; 
            background-color: #ffffff;
        }
        
        /* Highlight VIN */
        .vin-highlight td { background-color: #C8E6F0 !important; }
        .vin-highlight .key-cell { color: #0A638D; background-color: transparent; border-right: 1px solid #a9d4e6;}
        .vin-highlight .value-cell { color: #0A638D; font-weight: 800; background-color: transparent; }
        
        .footer-cell { 
            /* Footer t·ªëi m√†u b√°n trong su·ªët */
            background-color: rgba(10, 99, 141, 0.95);
            padding: 25px; 
            text-align: center; 
            font-size: 13px; 
            color: #ffffff; 
            border-top: 1px solid #ECEFF1;
        }
        
        .snowflake-greeting { 
            margin-top: 15px; 
            font-size: 14px; 
            color: #ffffff; 
            font-weight: bold; 
        }
        .snowflake { font-size: 18px; margin: 0 5px; color: #5AC3E2; }
        
        /* Utility Classes */
        .warning { color: #d32f2f; border-left-color: #d32f2f; }
        .info { color: #0A638D; border-left-color: #5AC3E2; }
        
    </style>
</head>
<body>
    ${bodyContent}
</body>
</html>`;
}

function removeVietnameseTones(str) {
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').replace(/ƒê/g, 'D');
}

function generateUsernameFromName(fullName) {
  if (!fullName) return '';
  const nameWithoutTones = removeVietnameseTones(fullName.toLowerCase().trim());
  const nameParts = nameWithoutTones.split(/\s+/);
  if (nameParts.length === 1) return nameParts[0];
  const lastName = nameParts[nameParts.length - 1];
  const initials = nameParts.slice(0, -1).map(part => part.charAt(0)).join('');
  return lastName + initials;
}

function generateRandomPassword(length) {
  const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  return Array.from({length}, () => charset.charAt(Math.floor(Math.random() * charset.length))).join('');
}

function hashPassword(password) {
  const hash = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, password);
  return hash.map(byte => ('0' + (byte & 0xFF).toString(16)).slice(-2)).join('');
}

function findUserBy(sheet, columnIndex, value) {
  if (!value) return null;
  const data = sheet.getDataRange().getValues();
  const normalizedValue = value.toLowerCase().trim();
  for (let i = 1; i < data.length; i++) {
    const cellValue = data[i][columnIndex];
    if (cellValue && cellValue.toString().toLowerCase().trim() === normalizedValue) {
      return {
        row: i + 1,
        username: data[i][0],
        passwordHash: data[i][1],
        fullName: data[i][2],
        role: data[i][3],
        email: data[i][4]
      };
    }
  }
  return null;
}

function findUserByUsername(sheet, username) {
  return findUserBy(sheet, 0, username); // Column A for Username
}

function findUserByEmail(sheet, email) {
  return findUserBy(sheet, 4, email); // Column E for Email
}
/**
 * [H√ÄM M·ªöI] - X·ª≠ l√Ω c·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt cho m·ªôt ƒë∆°n h√†ng ƒë√£ t·ªìn t·∫°i.
 * T·ª± ƒë·ªông ki·ªÉm tra v√† ch·∫°y l·∫°i thu·∫≠t to√°n gh√©p xe n·∫øu c·∫ßn.
 */
function handleUpdateOrderDetails(e, sheets, updatedBy) {
  const { orderNumber } = e.parameter;
  const newDetails = e.parameter; // L·∫•y t·∫•t c·∫£ c√°c tham s·ªë kh√°c l√†m chi ti·∫øt m·ªõi
  
  if (!orderNumber) {
    throw new Error("Kh√¥ng c√≥ S·ªë ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c cung c·∫•p.");
  }

  const { daGhepSheet, chuaGhepSheet, stockSheet, mailSheet, nhatKyChinhSuaSheet } = sheets;
  const actionId = `update-${new Date().getTime()}`;

  // 1. T√¨m ƒë∆°n h√†ng trong c·∫£ hai sheet
  let orderInfo = findOrderInSheetSimple(orderNumber, [daGhepSheet, chuaGhepSheet]);
  if (!orderInfo) {
    throw new Error(`Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng "${orderNumber}" trong c·∫£ sheet ƒê√£ Gh√©p v√† Ch·ªù Gh√©p.`);
  }

  const { sheet, rowIndex, rowData } = orderInfo;
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  // 2. X√°c ƒë·ªãnh xem c√≥ thay ƒë·ªïi th√¥ng tin xe (critical) kh√¥ng
  const criticalFields = ["D√≤ng xe", "Phi√™n b·∫£n", "Ngo·∫°i th·∫•t", "N·ªôi th·∫•t"];
  let hasCriticalChange = false;
  
  // T·∫°o m·ªôt b·∫£n sao c·ªßa d·ªØ li·ªáu h√†ng c≈© ƒë·ªÉ c·∫≠p nh·∫≠t
  const newRowObject = { ...rowData }; 
  
  for (const key in newDetails) {
    if (key !== 'action' && key !== 'orderNumber' && key !== 'updatedBy' && headers.includes(key)) {
      if (newDetails[key] !== rowData[key]) {
        newRowObject[key] = newDetails[key]; // C·∫≠p nh·∫≠t gi√° tr·ªã m·ªõi
        if (criticalFields.includes(key)) {
          hasCriticalChange = true;
        }
      }
    }
  }

  // 3. X·ª≠ l√Ω logic d·ª±a tr√™n sheet t√¨m th·∫•y
  
  // ----- TR∆Ø·ªúNG H·ª¢P 1: ƒê∆†N H√ÄNG ƒê√É GH√âP XE (DaGhep) -----
  if (sheet.getName() === DA_GHEP_SHEET_NAME) {
    if (hasCriticalChange) {
      // KH√îNG cho ph√©p thay ƒë·ªïi th√¥ng tin xe khi ƒë√£ gh√©p
      throw new Error("Kh√¥ng th·ªÉ thay ƒë·ªïi th√¥ng tin xe ƒë√£ ƒë∆∞·ª£c gh√©p. Vui l√≤ng 'H·ªßy Gh√©p' tr∆∞·ªõc khi c·∫≠p nh·∫≠t.");
    }
    
    // Ch·ªâ c·∫≠p nh·∫≠t th√¥ng tin ph·ª• (t√™n KH, ng√†y c·ªçc,...)
    updateRowInSheet(sheet, rowIndex, headers, newRowObject, rowData, updatedBy, actionId, nhatKyChinhSuaSheet);
    recordOrderHistory(orderNumber, rowData["VIN"], "C·∫≠p nh·∫≠t th√¥ng tin", `C·∫≠p nh·∫≠t chi ti·∫øt ƒë∆°n h√†ng (v√≠ d·ª•: t√™n KH) b·ªüi ${updatedBy}`, newRowObject);
    return { status: "SUCCESS", message: `ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin cho ƒë∆°n h√†ng ${orderNumber}.` };
  }

  // ----- TR∆Ø·ªúNG H·ª¢P 2: ƒê∆†N H√ÄNG CH∆ØA GH√âP XE (ChuaGhep) -----
  if (sheet.getName() === CHUA_GHEP_SHEET_NAME) {
    // Lu√¥n c·∫≠p nh·∫≠t th√¥ng tin tr√™n sheet 'ChuaGhep' tr∆∞·ªõc
    updateRowInSheet(sheet, rowIndex, headers, newRowObject, rowData, updatedBy, actionId, nhatKyChinhSuaSheet);
    
    // N·∫øu th√¥ng tin xe thay ƒë·ªïi, th·ª≠ ch·∫°y l·∫°i thu·∫≠t to√°n gh√©p xe
    if (hasCriticalChange) {
      Logger.log(`Ph√°t hi·ªán thay ƒë·ªïi th√¥ng tin xe cho ƒêH ${orderNumber}. ƒêang th·ª≠ t√¨m xe m·ªõi...`);
      const matchedCarInfo = matchCarAutomatically(newRowObject["D√≤ng xe"], newRowObject["Phi√™n b·∫£n"], newRowObject["Ngo·∫°i th·∫•t"], newRowObject["N·ªôi th·∫•t"], stockSheet);

      if (matchedCarInfo) {
        // T√åM TH·∫§Y XE! Chuy·ªÉn ƒë∆°n h√†ng t·ª´ 'ChuaGhep' sang 'DaGhep'
        Logger.log(`ƒê√£ t√¨m th·∫•y VIN ${matchedCarInfo.vin} ph√π h·ª£p. ƒêang chuy·ªÉn sang DaGhep...`);
        
        const daGhepHeaders = SHEET_HEADERS["DaGhep"];
        const finalDaGhepRow = {};
        const currentTime = new Date();
        
        daGhepHeaders.forEach(header => {
            finalDaGhepRow[header] = newRowObject[header] || ""; // L·∫•y t·ª´ d·ªØ li·ªáu ƒë√£ c·∫≠p nh·∫≠t
        });
        
        finalDaGhepRow["VIN"] = matchedCarInfo.vin;
        finalDaGhepRow["K·∫øt qu·∫£"] = "ƒê√£ gh√©p";
        finalDaGhepRow["Th·ªùi gian gh√©p"] = formatDateTimeForSheet(currentTime);
        const targetRow = daGhepSheet.getLastRow() + 1;
        finalDaGhepRow["S·ªë ng√†y gh√©p"] = `=IFERROR(DATEDIF(K${targetRow};TODAY();"D"))`; // Gi·∫£ s·ª≠ K l√† c·ªôt Th·ªùi gian gh√©p

        // G·ª≠i email
        const emailData = {
          ten_ban_hang: finalDaGhepRow["T√™n t∆∞ v·∫•n b√°n h√†ng"],
          ten_khach_hang: finalDaGhepRow["T√™n kh√°ch h√†ng"],
          dong_xe: finalDaGhepRow["D√≤ng xe"], phien_ban: finalDaGhepRow["Phi√™n b·∫£n"],
          ngoai_that: finalDaGhepRow["Ngo·∫°i th·∫•t"], noi_that: finalDaGhepRow["N·ªôi th·∫•t"],
          so_don_hang: orderNumber, ngay_coc: finalDaGhepRow["Ng√†y c·ªçc"],
          thoi_gian_nhap: finalDaGhepRow["Th·ªùi gian nh·∫≠p"]
        };
        const emailSent = sendEmailNotification(mailSheet, emailData, matchedCarInfo.vin, matchedCarInfo.maDMS, currentTime);
        finalDaGhepRow["Tr·∫°ng th√°i g·ª≠i mail"] = emailSent ? "ƒê√£ g·ª≠i" : "L·ªói g·ª≠i";

        // Th√™m v√†o DaGhep v√† X√≥a kh·ªèi ChuaGhep
        daGhepSheet.appendRow(daGhepHeaders.map(header => finalDaGhepRow[header] || ""));
        chuaGhepSheet.deleteRow(rowIndex);
        
        recordOrderHistory(orderNumber, matchedCarInfo.vin, "C·∫≠p nh·∫≠t & T·ª± ƒë·ªông gh√©p", `ƒêH ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√† gh√©p t·ª± ƒë·ªông b·ªüi ${updatedBy}`, finalDaGhepRow);
        recordVehicleHistory(matchedCarInfo.vin, "Gh√©p t·ª± ƒë·ªông (Sau C·∫≠p nh·∫≠t)", `Gh√©p v·ªõi ƒë∆°n h√†ng ${orderNumber}`);
        addNotification(`ƒêH ${orderNumber} ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√† gh√©p th√†nh c√¥ng v·ªõi xe ${matchedCarInfo.vin}.`, 'success', 'daGhep', orderNumber, updatedBy, emailData.ten_ban_hang);

        return { status: "SUCCESS", message: `ƒê√£ c·∫≠p nh·∫≠t ƒë∆°n h√†ng ${orderNumber} v√† t·ª± ƒë·ªông gh√©p th√†nh c√¥ng v·ªõi VIN ${matchedCarInfo.vin}!` };
      }
    }
    
    // N·∫øu kh√¥ng c√≥ thay ƒë·ªïi quan tr·ªçng, ho·∫∑c c√≥ thay ƒë·ªïi nh∆∞ng kh√¥ng t√¨m th·∫•y xe m·ªõi
    recordOrderHistory(orderNumber, "", "C·∫≠p nh·∫≠t th√¥ng tin", `C·∫≠p nh·∫≠t chi ti·∫øt ƒë∆°n h√†ng b·ªüi ${updatedBy} (v·∫´n ƒëang ch·ªù)`, newRowObject);
    return { status: "SUCCESS", message: `ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin cho ƒë∆°n h√†ng ${orderNumber}. (ƒê∆°n h√†ng v·∫´n ·ªü h√†ng ch·ªù).` };
  }
  
  throw new Error("ƒê√£ x·∫£y ra l·ªói logic kh√¥ng x√°c ƒë·ªãnh.");
}
/**
 * [H√ÄM H·ªñ TR·ª¢ M·ªöI] - T√¨m m·ªôt ƒë∆°n h√†ng trong danh s√°ch c√°c sheet.
 * Tr·∫£ v·ªÅ th√¥ng tin chi ti·∫øt v·ªÅ v·ªã tr√≠ v√† d·ªØ li·ªáu c·ªßa h√†ng.
 */
function findOrderInSheetSimple(orderNumber, sheetsToSearch) {
  const normalizedOrder = String(orderNumber).trim();
  for (const sheet of sheetsToSearch) {
    if (!sheet) continue;
    
    const data = sheet.getDataRange().getValues();
    if (data.length < 2) continue;
    
    const headers = data[0];
    const orderCol = headers.indexOf("S·ªë ƒë∆°n h√†ng");
    if (orderCol === -1) continue;

    for (let i = 1; i < data.length; i++) {
      if (String(data[i][orderCol]).trim() === normalizedOrder) {
        // T√¨m th·∫•y! Tr·∫£ v·ªÅ ƒë·ªëi t∆∞·ª£ng ƒë·∫ßy ƒë·ªß
        const rowData = {};
        headers.forEach((header, index) => {
          rowData[header] = data[i][index];
        });
        
        return {
          sheet: sheet,
          rowIndex: i + 1, // 1-based index
          rowData: rowData // D·ªØ li·ªáu h√†ng d∆∞·ªõi d·∫°ng object
        };
      }
    }
  }
  return null; // Kh√¥ng t√¨m th·∫•y
}

/**
 * [H√ÄM H·ªñ TR·ª¢ M·ªöI] - C·∫≠p nh·∫≠t m·ªôt h√†ng trong sheet v√† ghi l·∫°i nh·∫≠t k√Ω.
 * H√†m n√†y thay th·∫ø vi·ªác l·∫∑p l·∫°i logic ghi ƒë√® v√† ghi log.
 */
function updateRowInSheet(sheet, rowIndex, headers, newRowObject, oldRowData, user, actionId, nhatKyChinhSuaSheet) {
  const newRowValues = [];
  const changesToLog = [];
  
  // X√¢y d·ª±ng m·∫£ng gi√° tr·ªã m·ªõi theo ƒë√∫ng th·ª© t·ª± c·ªßa header
  headers.forEach((header, index) => {
    const newValue = newRowObject[header];
    const oldValue = oldRowData[header];
    newRowValues.push(newValue);
    
    // Chu·∫©n b·ªã log thay ƒë·ªïi
    if (String(oldValue) !== String(newValue)) {
      changesToLog.push({
        cellA1: sheet.getRange(rowIndex, index + 1).getA1Notation(),
        oldValue: oldValue,
        newValue: newValue
      });
    }
  });

  // Ghi ƒë√® to√†n b·ªô h√†ng b·∫±ng d·ªØ li·ªáu m·ªõi
  sheet.getRange(rowIndex, 1, 1, headers.length).setValues([newRowValues]);

  // Ghi l·∫°i t·ª´ng thay ƒë·ªïi v√†o nh·∫≠t k√Ω
  const timestamp = new Date();
  const logEntries = changesToLog.map(change => [
    timestamp,
    user,
    sheet.getName(),
    change.cellA1,
    String(change.oldValue),
    String(change.newValue),
    actionId,
    ""
  ]);
  
  if (logEntries.length > 0) {
    nhatKyChinhSuaSheet.getRange(nhatKyChinhSuaSheet.getLastRow() + 1, 1, logEntries.length, logEntries[0].length).setValues(logEntries);
  }
}
function sendVcRequestConfirmationEmailToTVBH(mailSheet, data) {
¬† const tenTVBH = data.ten_ban_hang;
¬† const recipientEmail = getEmailForAdvisor(mailSheet, tenTVBH);
¬† if (!recipientEmail) {
¬† ¬† logAction("L·ªói g·ª≠i mail x√°c nh·∫≠n Y/C VC", `Kh√¥ng t√¨m th·∫•y email cho TVBH '${tenTVBH}', ƒë∆°n ${data.so_don_hang}`);
¬† ¬† return false;
¬† }

¬† const subject = `[X√ÅC NH·∫¨N] ƒê√£ ti·∫øp nh·∫≠n Y√™u c·∫ßu c·∫•p VinClub cho ƒêH ${data.so_don_hang}`;
¬†¬†
¬† const details = {
¬† ¬† "S·ªë ƒë∆°n h√†ng": `<b>${data.so_don_hang}</b>`,
¬† ¬† "T√™n kh√°ch h√†ng": data.ten_khach_hang,
¬† ¬† "S·ªë VIN": `<b>${data.vin}</b>`,
¬† ¬† "Lo·∫°i YC": data.customerType === 'personal' ? "C√° Nh√¢n" : "C√¥ng Ty",
¬† ¬† "M√£ KH DMS": data.dmsCode || "N/A",
¬† ¬† "Tr·∫°ng th√°i m·ªõi": "<b>Ch·ªù Admin duy·ªát</b>"
¬† };
¬†¬†
¬† const note = "Y√™u c·∫ßu c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn Admin ƒë·ªÉ ph√™ duy·ªát. H·ªá th·ªëng s·∫Ω c√≥ th√¥ng b√°o ti·∫øp theo khi y√™u c·∫ßu ƒë∆∞·ª£c x·ª≠ l√Ω.";
¬† const bodyContent = createUnifiedEmailBody("Y√™u c·∫ßu c·∫•p VinClub ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!", tenTVBH, details, note, 'info');
¬† const fullHtml = createFullHtmlEmail(subject, bodyContent);

¬† try {
¬† ¬† MailApp.sendEmail({ to: recipientEmail, subject: subject, htmlBody: fullHtml });
¬† ¬† logAction("G·ª≠i mail x√°c nh·∫≠n Y/C VC th√†nh c√¥ng", `T·ªõi ${recipientEmail} cho ƒë∆°n ${data.so_don_hang}`);
¬† ¬† return true;
¬† } catch (e) {
¬† ¬† logAction("L·ªói g·ª≠i mail x√°c nh·∫≠n Y/C VC", `Email: ${recipientEmail}, ƒê∆°n: ${data.so_don_hang}, L·ªói: ${e.message}`);
¬† ¬† return false;
¬† }
}
const PRESENCE_EXPIRY_MINUTES = 5; // Ng∆∞·ªùi d√πng ƒë∆∞·ª£c coi l√† offline sau 5 ph√∫t
const PRESENCE_PREFIX = 'presence_'; // Ti·ªÅn t·ªë ƒë·ªÉ nh·∫≠n di·ªán key

/**
 * [H√ÄM M·ªöI] Ghi l·∫°i "heartbeat" c·ªßa ng∆∞·ªùi d√πng.
 * H√†m n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi t·ª´ client-side (web app c·ªßa b·∫°n).
 */
function recordUserPresence(userEmail) {
  if (!userEmail) return;
  try {
    // S·ª≠ d·ª•ng ScriptProperties ƒë·ªÉ l∆∞u tr·ªØ chung cho to√†n b·ªô script
    const scriptProperties = PropertiesService.getScriptProperties();
    const key = PRESENCE_PREFIX + userEmail;
    // Ghi ƒë√® d·∫•u th·ªùi gian m·ªõi nh·∫•t
    scriptProperties.setProperty(key, new Date().toISOString());
  } catch (e) {
    Logger.log(`L·ªói khi ghi l·∫°i s·ª± hi·ªán di·ªán c·ªßa ${userEmail}: ${e.message}`);
  }
}

/**
 * [H√ÄM M·ªöI] L·∫•y danh s√°ch ng∆∞·ªùi d√πng ƒëang ho·∫°t ƒë·ªông (cho Admin).
 * [ƒê√É N√ÇNG C·∫§P] - Tr·∫£ v·ªÅ c·∫£ t√™n ƒë·∫ßy ƒë·ªß (FullName) thay v√¨ ch·ªâ email.
 */
function getActiveUsers() {
  try {
    // ----- B·∫ÆT ƒê·∫¶U N√ÇNG C·∫§P -----
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const userSheet = ss.getSheetByName(USER_SHEET_NAME); // L·∫•y sheet Users [cite: 4]
    if (!userSheet) {
      throw new Error("Kh√¥ng t√¨m th·∫•y User Sheet.");
    }
    // ----- K·∫æT TH√öC N√ÇNG C·∫§P -----

    const scriptProperties = PropertiesService.getScriptProperties();
    const allKeys = scriptProperties.getKeys();
    const now = new Date().getTime();
    const expiryMs = PRESENCE_EXPIRY_MINUTES * 60 * 1000;
    const activeUsers = [];
    const keysToDelete = [];

    for (const key of allKeys) {
      if (key.startsWith(PRESENCE_PREFIX)) { // [cite: 2898]
        const email = key.replace(PRESENCE_PREFIX, ''); // ƒê√¢y l√† email
        const lastSeenIso = scriptProperties.getProperty(key);
        const lastSeenTime = new Date(lastSeenIso).getTime();
        
        if (now - lastSeenTime < expiryMs) {
          // V·∫´n c√≤n ho·∫°t ƒë·ªông
          
          // ----- B·∫ÆT ƒê·∫¶U N√ÇNG C·∫§P -----
          const user = findUserByEmail(userSheet, email); // T√¨m th√¥ng tin user [cite: 2836]
          const fullName = user ? user.fullName : null; // L·∫•y t√™n ƒë·∫ßy ƒë·ªß
          
          activeUsers.push({
            email: email,
            fullName: fullName, // Tr·∫£ v·ªÅ th√™m fullName
            lastSeen: lastSeenIso
          });
          // ----- K·∫æT TH√öC N√ÇNG C·∫§P -----
        } else {
          // H·∫øt h·∫°n, th√™m v√†o danh s√°ch d·ªçn d·∫πp
          keysToDelete.push(key);
        }
      }
    }
    
    // D·ªçn d·∫πp c√°c key ƒë√£ h·∫øt h·∫°n (ch·ªâ khi c√≥ key ƒë·ªÉ x√≥a)
    if (keysToDelete.length > 0) {
      scriptProperties.deleteProperties(keysToDelete);
      Logger.log(`D·ªçn d·∫πp ${keysToDelete.length} key "presence" ƒë√£ h·∫øt h·∫°n.`);
    }

    return { status: "SUCCESS", users: activeUsers };
  } catch (e) {
    Logger.log(`L·ªói khi l·∫•y danh s√°ch ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông: ${e.message}`);
    return { status: "ERROR", message: e.message };
  }
}
/**
 * H√†m n√†y d√πng ƒë·ªÉ l·∫•y c√°c sheet c·∫ßn thi·∫øt v√† g·ªçi h√†m syncKhoxeStatus.
 * Ch·ªâ n√™n ch·∫°y th·ªß c√¥ng (Manual Run) ho·∫∑c ƒë·∫∑t l√†m Trigger ƒë·ªãnh k·ª≥.
 */
function runSyncKhoxeStatus() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // L·∫•y c√°c Sheet b·∫±ng t√™n (d·ª±a tr√™n c√°c h·∫±ng s·ªë ƒë√£ ƒë·ªãnh nghƒ©a trong m√£ c·ªßa b·∫°n)
  const daghepSheet = ss.getSheetByName(DA_GHEP_SHEET_NAME);
  const khoxeSheet = ss.getSheetByName(STOCK_SHEET_NAME);
  const xuathoadonSheet = ss.getSheetByName(XUAT_HOA_DON_SHEET_NAME);

  // Ki·ªÉm tra xem c√°c sheet c√≥ t·ªìn t·∫°i kh√¥ng
  if (!daghepSheet || !khoxeSheet || !xuathoadonSheet) {
    Logger.log("L·ªñI: Kh√¥ng t√¨m th·∫•y ƒë·ªß c√°c Sheet c·∫ßn thi·∫øt (DaGhep, KhoXe, Xuathoadon).");
    return; // D·ª´ng n·∫øu thi·∫øu sheet
  }
  
  // G·ªçi h√†m chu·∫©n h√≥a tr·∫°ng th√°i
  syncKhoxeStatus(daghepSheet, khoxeSheet, xuathoadonSheet);
  
  Logger.log("ƒê√£ ch·∫°y h√†m syncKhoxeStatus th√†nh c√¥ng.");
  
  // (T√πy ch·ªçn) N·∫øu b·∫°n ƒëang s·ª≠ d·ª•ng h√†m getSheets, b·∫°n c√≥ th·ªÉ g·ªçi:
  // const sheets = getSheets(ss);
  // syncKhoxeStatus(sheets.daGhepSheet, sheets.stockSheet, sheets.xuathoadonSheet);
}
function setupAlwaysCorrectSync() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === "runSyncKhoxeStatus") {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // T·∫°o trigger ch·∫°y m·ªói 1 ph√∫t ƒë·ªÉ qu√©t tr·∫°ng th√°i
  ScriptApp.newTrigger("runSyncKhoxeStatus")
    .timeBased()
    .everyMinutes(1)
    .create();
    
  SpreadsheetApp.getUi().alert("ƒê√£ c√†i ƒë·∫∑t t√≠nh nƒÉng t·ª± ƒë·ªông ƒë·ªìng b·ªô tr·∫°ng th√°i m·ªói ph√∫t.");
}